<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title id="pageTitle"></title>
  <link rel="icon" type="image/png" id="dynamicFavicon" href="default-icon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="script.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-arabic@1.0.0/dist/jspdf-arabic.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, set, update, get, query, orderByChild, equalTo, runTransaction, remove, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAF9nwrWjUwdSs2P12L3B4hOnY4EfXwbDc",
      authDomain: "broker-94a9d.firebaseapp.com",
      databaseURL: "https://broker-94a9d-default-rtdb.firebaseio.com",
      projectId: "broker-94a9d",
      storageBucket: "broker-94a9d.appspot.com",
      messagingSenderId: "1084195654856",
      appId: "1:1084195654856:web:f2f442380c37dda7b769fd",
      measurementId: "G-BPMF7PRG0G"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////// داله حفظ بينات PC /////////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    let currentEditingDeviceType = null
    window.addDeviceData = async function () {
      const newType = document.getElementById("deviceTypeInput").value.trim();
      const models = document.getElementById("deviceModelsInput").value
        .split(',')
        .map(m => m.trim())
        .filter(Boolean);

      if (!newType || models.length === 0) {
        alert("❌ يرجى إدخال نوع الجهاز والموديلات.");
        return;
      }

      if (currentEditingDeviceType && newType !== currentEditingDeviceType) {
        await remove(ref(database, "devices/" + currentEditingDeviceType));
      }

      await set(ref(database, "devices/" + newType), {
        models: models
      });

      alert(currentEditingDeviceType ? "✅ تم حفظ بيانات الجهاز." : "✅ تم إضافة الجهاز بنجاح.");
      document.getElementById("deviceTypeInput").value = "";
      document.getElementById("deviceModelsInput").value = "";
      document.getElementById("updateDeviceButton").textContent = "إضافة";
      document.getElementById("deleteDeviceButton").style.display = "none";
      currentEditingDeviceType = null;
      loadDeviceTable();
      populateDeviceTypeOptions();
    };

    window.editDeviceType = function (type) {
      const modelsRef = ref(database, "devices/" + type + "/models");

      get(modelsRef).then(snapshot => {
        const models = snapshot.val();

        if (Array.isArray(models)) {
          document.getElementById("deviceTypeInput").value = type;
          document.getElementById("deviceModelsInput").value = models.join(', ');
          currentEditingDeviceType = type;
          document.getElementById("updateDeviceButton").textContent = "تحديث";
          document.getElementById("deleteDeviceButton").style.display = "inline-block";
        }
      }).catch(e => {
        alert("❌ خطأ في جلب بيانات الموديلات: " + e.message);
      });
    };

    function loadDeviceTable() {
      const tableBody = document.querySelector("#deviceTable tbody");
      const deviceRef = ref(database, "devices");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        tableBody.innerHTML = "";

        for (const type in data) {
          const models = data[type].models;
          const row = document.createElement("tr");

          row.innerHTML = `
                <td>${type}</td>
                <td>${models.join(', ')}</td>
            `;

          row.addEventListener("click", () => {
            fetchDeviceData(type);
          });

          tableBody.appendChild(row);
        }
      }, {
        onlyOnce: true
      });
    }

    function populateDeviceTypeOptions() {
      const deviceTypeSelect = document.getElementById("deviceType1");
      const queryDeviceType = document.getElementById("queryDeviceType");
      const deviceRef = ref(database, "devices");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        const defaultOption = '<option value="">-- اختر نوع الجهاز --</option>';
        deviceTypeSelect.innerHTML = defaultOption;
        queryDeviceType.innerHTML = defaultOption;

        if (!data) return;

        Object.keys(data).forEach(type => {
          const option1 = document.createElement("option");
          option1.value = type;
          option1.textContent = type;
          const option2 = option1.cloneNode(true);
          deviceTypeSelect.appendChild(option1);
          queryDeviceType.appendChild(option2);
        });

      }, {
        onlyOnce: true
      });
    }

    document.getElementById("deviceType1").addEventListener("change", (e) => {
      const selectedType = e.target.value;
      const modelSelect = document.getElementById("deviceModel");

      modelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

      if (selectedType) {
        const modelsRef = ref(database, "devices/" + selectedType + "/models");
        onValue(modelsRef, (snapshot) => {
          const models = snapshot.val();
          if (Array.isArray(models)) {
            models.forEach(model => {
              const opt = document.createElement("option");
              opt.value = model;
              opt.textContent = model;
              modelSelect.appendChild(opt);
            });
          }
        });
      }
    });
    loadDeviceTable();
    populateDeviceTypeOptions();

    function loadCompaniesIntoSelect() {
      const companySelect = document.getElementById("companySelect");
      const queryCompanySelect = document.getElementById("queryCompanySelect");
      const selectedCompanyCode = document.getElementById("selectedCompanyCode");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }

    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelect);

    document.getElementById("pcUserCode").addEventListener("input", async function () {
      let code = this.value.trim();
      if (!code) {
        document.getElementById("pcUser").value = "";
        return;
      }

      try {
        const snapshot = await get(ref(database, "hrEmployees/" + code));
        if (snapshot.exists()) {
          document.getElementById("pcUser").value = snapshot.val().fullName || "❌ غير مسجل";
        } else {
          document.getElementById("pcUser").value = "❌ غير مسجل";
        }
      } catch (err) {
        console.error("خطأ أثناء جلب البيانات:", err);
      }
    });

    async function loadEmployeeNames() {
      try {
        const snapshot = await get(ref(database, "hrEmployees"));
        if (snapshot.exists()) {
          let employees = snapshot.val();
          let dataList = document.getElementById("usersList");
          dataList.innerHTML = "";

          Object.values(employees).forEach(emp => {
            if (emp.fullName) {
              let option = document.createElement("option");
              option.value = emp.fullName;
              dataList.appendChild(option);
            }
          });
        }
      } catch (err) {
        console.error("خطأ أثناء تحميل الأسماء:", err);
      }
    }

    document.getElementById("pcUser").addEventListener("change", async function () {
      let name = this.value.trim();
      if (!name) return;

      try {
        const snapshot = await get(ref(database, "hrEmployees"));
        if (snapshot.exists()) {
          let employees = snapshot.val();
          let found = Object.values(employees).find(emp => emp.fullName === name);

          if (found) {
            document.getElementById("pcUserCode").value = found.code;
          } else {
            document.getElementById("pcUserCode").value = "❌ غير موجود";
          }
        }
      } catch (err) {
        console.error("خطأ أثناء البحث بالاسم:", err);
      }
    });

    loadEmployeeNames();
    window.saveData = function () {
      const canSave = localStorage.getItem('canSave') === 'true';
      const canEdit = localStorage.getItem('canEdit') === 'true';
      const dataId = document.getElementById("pcNum").getAttribute("data-id");

      if (!dataId && !canSave) return alert("❌ ليس لديك صلاحية إضافة بيانات جديدة.");
      if (dataId && !canEdit) return alert("❌ ليس لديك صلاحية تعديل البيانات.");

      const pcNumInput = document.getElementById("pcNum").value.trim();
      const pcLocation = document.getElementById("pcLocation").value.trim();
      const pcUser = document.getElementById("pcUser").value.trim();
      const note = document.getElementById("note").value.trim();
      const dateAdded = document.getElementById("dateAdded").value.trim();
      const pcStatus = document.getElementById("pcStatus").value;
      const brandMB = document.getElementById("brandMB").value.trim();
      const configMB = document.getElementById("configMB").value.trim();
      const snMB = document.getElementById("snMB").value.trim();
      const PROCESSOR = document.getElementById("PROCESSOR").value.trim();
      const configPROCESSOR = document.getElementById("configPROCESSOR").value.trim();
      const snPROCESSOR = document.getElementById("snPROCESSOR").value.trim();
      const HDD = document.getElementById("H.D.D").value.trim();
      const configHDD = document.getElementById("configH.D.D").value.trim();
      const snHDD = document.getElementById("snH.D.D").value.trim();
      const SDD = document.getElementById("S.D.D").value.trim();
      const configSDD = document.getElementById("configS.D.D").value.trim();
      const snSDD = document.getElementById("snS.D.D").value.trim();
      const MONITOE = document.getElementById("MONITOE").value.trim();
      const configMONITOE = document.getElementById("configMONITOE").value.trim();
      const snMONITOE = document.getElementById("snMONITOE").value.trim();
      const DVD = document.getElementById("DVD").value.trim();
      const configDVD = document.getElementById("configDVD").value.trim();
      const snDVD = document.getElementById("snDVD").value.trim();
      const KEYBORD = document.getElementById("KEYBORD").value.trim();
      const configKEYBORD = document.getElementById("configKEYBORD").value.trim();
      const snKEYBORD = document.getElementById("snKEYBORD").value.trim();
      const MOUSE = document.getElementById("MOUSE").value.trim();
      const configMOUSE = document.getElementById("configMOUSE").value.trim();
      const snMOUSE = document.getElementById("snMOUSE").value.trim();
      const USBMODEM = document.getElementById("USBMODEM").value.trim();
      const configUSBMODEM = document.getElementById("configUSBMODEM").value.trim();
      const snUSBMODEM = document.getElementById("snUSBMODEM").value.trim();
      const ACCESSORIES = document.getElementById("ACCESSORIES").value.trim();
      const configACCESSORIES = document.getElementById("configACCESSORIES").value.trim();
      const snACCESSORIES = document.getElementById("snACCESSORIES").value.trim();
      const SYSAPPS = document.getElementById("SYSAPPS").value.trim();
      const configSYSAPPS = document.getElementById("configSYSAPPS").value.trim();
      const snSYSAPPS = document.getElementById("snSYSAPPS").value.trim();
      const deviceType = document.getElementById("deviceType1").value.trim();
      const deviceModel = document.getElementById("deviceModel").value.trim();
      const companyCode = document.getElementById("companySelect").value.trim();

      if (!pcLocation || !pcUser || !pcStatus || !dateAdded || !deviceType || !deviceModel || !companyCode) {
        return alert("❌ يرجى ملء جميع الحقول الأساسية!");
      }
      if (!pcNumInput && !dataId) {
        return alert("❌ يرجى إدخال رقم الجهاز أو تركه فارغًا ليتم التوليد تلقائيًا.");
      }

      const generatePcNum = (manualNum = null) => {
        return new Promise((resolve, reject) => {
          get(ref(database, "computers")).then(snapshot => {
            const existingNums = new Set();
            snapshot.forEach(child => {
              const num = parseInt(child.val().pcNum);
              if (!isNaN(num)) existingNums.add(num);
            });

            if (manualNum !== null && manualNum !== "") {
              const parsed = parseInt(manualNum);
              if (isNaN(parsed)) return reject(new Error("⚠️ الرقم المدخل غير صالح."));
              if (existingNums.has(parsed) && !dataId) return reject(new Error("⚠️ الرقم موجود مسبقًا."));
              return resolve(parsed);
            } else {
              let next = 1;
              while (existingNums.has(next)) next++;
              resolve(next);
            }
          }).catch(reject);
        });
      };
      const saveOrUpdate = (pcNum, companyData = {}) => {
        const data = {
          pcNum, pcLocation, pcUser, note, pcStatus, dateAdded, deviceType, deviceModel,
          brandMB, configMB, snMB, companyCode,
          PROCESSOR, configPROCESSOR, snPROCESSOR,
          HDD, configHDD, snHDD,
          SDD, configSDD, snSDD,
          MONITOE, configMONITOE, snMONITOE,
          DVD, configDVD, snDVD,
          KEYBORD, configKEYBORD, snKEYBORD,
          MOUSE, configMOUSE, snMOUSE,
          USBMODEM, configUSBMODEM, snUSBMODEM,
          ACCESSORIES, configACCESSORIES, snACCESSORIES,
          SYSAPPS, configSYSAPPS, snSYSAPPS,
          company: companyData
        };

        document.getElementById("pcNum").setAttribute("readonly", true);
        const showAndClear = () => {
          showHandoverInvoiceCombutr(data);
          clearForm();
        };

        if (dataId) {
          const pcRef = ref(database, "computers/" + dataId);
          get(pcRef).then(snapshot => {
            if (snapshot.exists() && snapshot.val().deleted) {
              alert("⚠️ الجهاز محذوف ولا يمكن تعديله!");
            } else {
              update(pcRef, data)
                .then(() => {
                  alert("✅ تم التحديث");
                  showAndClear();
                })
                .catch(e => alert("❌ خطأ في التحديث: " + e.message));
            }
          });
        } else {
          push(ref(database, "computers"), data)
            .then(() => {
              alert("✅ تم الحفظ بنجاح!");
              showAndClear();
            })
            .catch(e => alert("❌ خطأ في الحفظ: " + e.message));
        }
      };

      generatePcNum(pcNumInput).then(async pcNum => {
        const companyCode = document.getElementById("companySelect").value.trim();
        let companyData = null;
        if (companyCode) {
          try {
            const companyRef = ref(database, "companySettings/" + companyCode);
            const snapshot = await get(companyRef);
            if (snapshot.exists()) {
              companyData = snapshot.val();
              console.log("✅ تم جلب بيانات الشركة:", companyData);
            } else {
              alert("⚠️ لم يتم العثور على بيانات الشركة المحددة");
              console.log("❌ No company data found for code:", companyCode);
            }

          } catch (error) {
            alert("❌ خطأ أثناء تحميل بيانات الشركة: " + error.message);
            console.error("Error loading company data:", error);
          }
        } else {
          alert("⚠️ لم يتم اختيار شركة!");
          console.log("No company selected.");
        }
        saveOrUpdate(pcNum, companyData || {});
      })
        .catch((err) => {
          alert(err.message);
        });
    };

    function clearForm() {
      const fields = [
        "pcNum", "pcLocation", "pcUser", "note", "dateAdded", "pcStatus",
        "brandMB", "configMB", "snMB",
        "PROCESSOR", "configPROCESSOR", "snPROCESSOR",
        "H.D.D", "configH.D.D", "snH.D.D",
        "S.D.D", "configS.D.D", "snS.D.D",
        "MONITOE", "configMONITOE", "snMONITOE",
        "DVD", "configDVD", "snDVD",
        "KEYBORD", "configKEYBORD", "snKEYBORD",
        "MOUSE", "configMOUSE", "snMOUSE",
        "USBMODEM", "configUSBMODEM", "snUSBMODEM",
        "ACCESSORIES", "configACCESSORIES", "snACCESSORIES",
        "SYSAPPS", "configSYSAPPS", "snSYSAPPS",
        "deviceType", "deviceModel", "companySelect"
      ];
      fields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.value = "";
        }
      });
      const pcNumInput = document.getElementById("pcNum");
      if (pcNumInput) {
        pcNumInput.removeAttribute("readonly");
        pcNumInput.removeAttribute("data-id");
      }
    }

    window.searchData = async function () {
      const canQuery = localStorage.getItem('canQuery') === 'true';
      const dataId = document.getElementById("queryPcNum").getAttribute("data-id");

      if (!dataId && !canQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }

      const queryPcNum = document.getElementById("queryPcNum").value.trim().toLowerCase();
      const queryPcUser = document.getElementById("queryPcUser").value.trim().toLowerCase();
      const queryPcLocation = document.getElementById("queryPcLocation").value.trim().toLowerCase();
      const querydateAdded = document.getElementById("querydateAdded").value.trim().toLowerCase();
      const queryDeviceType = document.getElementById("queryDeviceType").value.trim().toLowerCase();
      const generalSearch = document.getElementById("generalSearch").value.trim().toLowerCase();
      const queryCompanySelect = document.getElementById("queryCompanySelect").value.trim().toLowerCase();
      const resultsContainer = document.getElementById("queryResults");
      resultsContainer.innerHTML = "⏳ جاري البحث...";

      const dbRef = ref(database, "computers");

      try {
        const snapshot = await get(dbRef);
        if (!snapshot.exists()) {
          resultsContainer.innerHTML = "❌ لا توجد بيانات مطابقة!";
          return;
        }

        const computersData = snapshot.val();
        const companySnap = await get(ref(database, "companies"));
        const companyMap = {};
        if (companySnap.exists()) {
          companySnap.forEach(child => {
            const c = child.val();
            if (c.code && c.name) {
              companyMap[c.code.toLowerCase()] = c.name;
            }
          });
        }

        let filteredData = Object.keys(computersData).map(key => ({
          id: key,
          ...computersData[key]
        })).filter(item =>
          (queryPcNum === "" || String(item.pcNum || "").toLowerCase().includes(queryPcNum)) &&
          (queryPcUser === "" || String(item.pcUser || "").toLowerCase().includes(queryPcUser)) &&
          (queryPcLocation === "" || String(item.pcLocation || "").toLowerCase().includes(queryPcLocation)) &&
          (querydateAdded === "" || String(item.dateAdded || "").toLowerCase().includes(querydateAdded)) &&
          (queryCompanySelect === "" || String(item.companyCode || "").toLowerCase().includes(queryCompanySelect)) &&
          (queryDeviceType === "" || String(item.deviceType || "").toLowerCase().includes(queryDeviceType))
        );

        if (generalSearch !== "") {
          filteredData = filteredData.filter(item =>
            Object.values(item).some(value =>
              String(value).toLowerCase().includes(generalSearch)
            )
          );
        }

        filteredData = filteredData.map(item => ({
          ...item,
          companyName: companyMap[item.companyCode?.toLowerCase()] || "❓ غير معروف"
        }));

        filteredData.sort((a, b) => (parseInt(a.pcNum) || 0) - (parseInt(b.pcNum) || 0));

        if (filteredData.length === 0) {
          resultsContainer.innerHTML = "❌ لم يتم العثور على بيانات";
          return;
        }

        let table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        table.style.textAlign = "center";

        let thead = document.createElement("thead");
        let headerRow = "<tr>";

        selectedColumns.forEach(col => {
          const label = col === "companyCode" ? "اسم الشركة" : (allColumns[col] || col);
          headerRow += `<th>${label}</th>`;
        });

        headerRow += "</tr>";
        thead.innerHTML = headerRow;
        thead.style.position = "sticky";
        thead.style.top = "0";
        thead.style.backgroundColor = "#fff";
        table.appendChild(thead);

        let tbody = document.createElement("tbody");

        filteredData.forEach(item => {
          const allNull = selectedColumns.every(col => {
            const value = item[col];
            return value === null || value === undefined || String(value).trim() === "";
          });

          if (allNull) return;

          let row = document.createElement("tr");
          if (item.deleted) {
            row.style.color = "red";
            row.style.backgroundColor = "#ffe6e6";
          }

          let rowHtml = "";
          selectedColumns.forEach(col => {
            const displayValue = col === "companyCode" ? item.companyName : item[col] || "null";
            rowHtml += `<td>${displayValue}</td>`;
          });

          row.innerHTML = rowHtml;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        resultsContainer.innerHTML = "";
        resultsContainer.appendChild(table);

      } catch (err) {
        resultsContainer.innerHTML = "❌ حدث خطأ أثناء البحث: " + err.message;
      }
    };

    const allColumns = {
      companyCode: "company",
      pcNum: "PC Number",
      deviceType: "Device Type",
      deviceModel: "Device Model",
      pcUser: "User",
      pcLocation: "Location",
      pcStatus: "Status",
      dateAdded: "Date Added",
      brandMB: "Brand MB",
      configMB: "Config MB",
      snMB: "S/N MB",
      HDD: "Brand HDD",
      snHDD: "S/N HDD",
      configHDD: "Config HDD",
      PROCESSOR: "Brand Processor",
      snPROCESSOR: "S/N Processor",
      configPROCESSOR: "Config Processor",
      SDD: "Brand SDD",
      configSDD: "Config SDD",
      snSDD: "S/N SDD",
      MONITOE: "Brand Monitor",
      configMONITOE: "Config Monitor",
      snMONITOE: "S/N Monitor",
      DVD: "Brand DVD",
      configDVD: "Config DVD",
      snDVD: "S/N DVD",
      KEYBORD: "Brand Keyboard",
      configKEYBORD: "Config Keyboard",
      snKEYBORD: "S/N Keyboard",
      MOUSE: "Brand Mouse",
      configMOUSE: "Config Mouse",
      snMOUSE: "S/N Mouse",
      USBMODEM: "Brand USB Modem",
      configUSBMODEM: "Config USB Modem",
      snUSBMODEM: "S/N USB Modem",
      ACCESSORIES: "Accessories",
      configACCESSORIES: "Config Accessories",
      snACCESSORIES: "S/N Accessories",
      SYSAPPS: "System Apps",
      configSYSAPPS: "Config System Apps",
      snSYSAPPS: "S/N System Apps",
      note: "Note"
    };

    window.applyColumnFilter = function () {
      selectedColumns = Array.from(document.querySelectorAll('.columnCheckbox:checked')).map(cb => cb.value);
      document.getElementById("columnFilterBox").style.display = "none";
      searchData();
    }
    let selectedColumns = Object.keys(allColumns);

    window.toggleColumnFilter = function () {
      const box = document.getElementById("columnFilterBox");
      const container = document.getElementById("columnCheckboxes");
      box.style.display = box.style.display === "none" ? "block" : "none";

      if (container.innerHTML === "") {
        Object.keys(allColumns).forEach(key => {
          container.innerHTML += `
                <label><input type="checkbox" class="columnCheckbox" value="${key}" checked> ${allColumns[key]}</label>
            `;
        });
      }
    }

    window.printTable = function () {
      const resultsContainer = document.getElementById("queryResults");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة الأجهزة</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcel = function () {
      const table = document.querySelector("#queryResults table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "PC Data" });
      XLSX.writeFile(workbook, "PC_Data.xlsx");
    };

    window.showHandoverInvoiceCombutr = function (data) {
      const company = data.company || {};
      const rows = [
        { name: "اللوحة الأم", config: data.configMB, sn: data.snMB },
        { name: "المعالج", config: data.configPROCESSOR, sn: data.snPROCESSOR },
        { name: "القرص الصلب HDD", config: data.configHDD, sn: data.snHDD },
        { name: "القرص الصلب SSD", config: data.configSDD, sn: data.snSDD },
        { name: "الشاشة", config: data.configMONITOE, sn: data.snMONITOE },
        { name: "DVD", config: data.configDVD, sn: data.snDVD },
        { name: "لوحة المفاتيح", config: data.configKEYBORD, sn: data.snKEYBORD },
        { name: "الفأرة", config: data.configMOUSE, sn: data.snMOUSE },
        { name: "مودم USB", config: data.configUSBMODEM, sn: data.snUSBMODEM },
        { name: "ملحقات إضافية", config: data.configACCESSORIES, sn: data.snACCESSORIES },
        { name: "البرمجيات", config: data.configSYSAPPS, sn: data.snSYSAPPS },
      ].filter(row => row.config || row.sn);

      const rowsHtml = rows.map((item, index) => `
      <tr style="border-bottom:1px solid #ccc;">
        <td style="text-align:center;">${index + 1}</td>
        <td style="text-align:center;">${item.name}</td>
        <td style="text-align:center;">${item.config || '-'}</td>
       <td style="text-align:center;">${item.sn || '-'}</td>
      </tr>
      `).join('');

      const html = `
      <html dir="rtl">
        <head>
          <title>نموذج عهدة</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              direction: rtl;
              padding: 30px;
              line-height: 1.6;
              color: #333;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
            }
            th, td {
              padding: 6px;
              border: 1px solid #ccc;
              font-size: 14px;
              text-align: center;
            }
          </style>
        </head>
        <body>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div style="text-align: right; font-size: 14px; line-height: 1.6;">
              <div><strong style="font-size: 18px;">${company.name || 'اسم غير معروف'}</strong></div>
              <div>${company.address || 'العنوان غير محدد'}</div>
              <div>${company.phone || 'رقم غير متوفر'}</div>
              <div> ${company.email ? ' - ' + company.email : ''}</div>
            </div>
            <div style="text-align: left;">
              ${company.logoUrl ? `<img src="${company.logoUrl}" style="height: 80px;" onerror="this.style.display='none'">` : ''}
            </div>
          </div>

          <h2 style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 10px;">
            نموذج استلام عهدة موظف
          </h2>

          <table style="margin-bottom: 20px; font-size: 15px;">
            <tr>
              <td><strong>اسم الموظف:</strong> ${data.pcUser}</td>
              <td><strong>الموقع:</strong> ${data.pcLocation}</td>
            </tr>
            <tr>
              <td><strong>رقم الجهاز:</strong> ${data.pcNum}</td>
              <td><strong>تاريخ الإضافة:</strong> ${data.dateAdded}</td>
            </tr>
            <tr>
              <td><strong>نوع الجهاز:</strong> ${data.deviceType}</td>
              <td><strong>موديل الجهاز:</strong> ${data.deviceModel}</td>
            </tr>
            <tr>
              <td colspan="2"><strong>ملاحظات:</strong> ${data.note || '-'}</td>
            </tr>
          </table>

          <h3 style="background: #2196f3; color: #fff; text-align: center; padding: 10px;">تفاصيل المكونات</h3>
          <table>
            <thead style="background: #eee;">
              <tr>
                <th>م</th>
                <th>المكون</th>
                <th>المواصفات</th>
                <th>الرقم التسلسلي</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>

          <p style="margin-top: 30px; font-size: 16px;">
            أقر أنا الموظف أعلاه باستلام كافة الأجهزة والمكونات الموضحة، وأتعهد بالحفاظ عليها واستخدامها في الأغراض المخصصة لها فقط، وأتحمل المسؤولية الكاملة عنها.
          </p>

          <div style="display: flex; justify-content: space-between; margin-top: 60px;">
            <div style="width: 45%; text-align: center;">
              <p>توقيع الموظف</p>
              <div style="height: 60px; border-bottom: 1px solid #000;"></div>
            </div>
            <div style="width: 45%; text-align: center;">
              <p>توقيع مسؤول العهدة</p>
              <div style="height: 60px; border-bottom: 1px solid #000;"></div>
            </div>
          </div>
        </body>
      </html>
      `;

      const printWindow = window.open("", "_blank");
      if (printWindow) {
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
      } else {
        alert("❌ لم يتم فتح نافذة الطباعة. الرجاء السماح بالنوافذ المنبثقة (Pop-ups) في المتصفح.");
      }

    };

    //////////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////// الحذفه  ///////////////////////////////////////////////////////      
    window.deleteDocument = async function () {
      const canDelete = localStorage.getItem('canDelete') === 'true';
      if (!canDelete) {
        alert("❌ ليس لديك صلاحية حذف المستندات.");
        return;
      }

      const visibleSection = [
        "computerForm", "phoneForm", "printForm", "RouterForm", "lineForm", "orderAmendment", "deliveryAmendment", "maintenanceAmendment",
        "AddAProductAdditionForm", "AddProductDisbursement", "editTemporaryForm", "screenForm", "computerSettings", "phoneSettings", "lineSettings",
        "editUserSection", "screenSettings", "printerSettings", "definitionCompanies", "fixedAssetsDepreciation", "gpsForm", "gpsSettings", "deptCode", "empCode"
      ].find(id => document.getElementById(id)?.offsetParent !== null);

      if (!visibleSection) {
        alert("❌ هذا القسم ليس  للحذف .");
        return;
      }
      if (visibleSection === "editUserSection") {
        const isAdmin = localStorage.getItem('userRole') === 'admin';
        if (!isAdmin) {
          alert("❌ ليس لديك صلاحية حذف المستخدمين.");
          return;
        }

        const userId = document.getElementById("editUserId").value;
        const username = document.getElementById("editUsername").value;

        if (!userId) {
          alert("❌ يجب اختيار مستخدم أولاً.");
          return;
        }

        const confirmDeleteUser = confirm(`⚠️ هل تريد حذف المستخدم "${username}" نهائيًا؟`);
        if (!confirmDeleteUser) return;

        try {
          await remove(ref(database, `users/${userId}`));
          alert(`✅ تم حذف المستخدم "${username}" بنجاح.`);
          document.getElementById("editUserSection").style.display = "none";
          if (typeof loadUsersTable === "function") loadUsersTable();
          return;
        } catch (error) {
          console.error("❌ خطأ أثناء حذف المستخدم:", error);
          alert("❌ حدث خطأ أثناء حذف المستخدم. راجع الكونسول.");
          return;
        }
      }
      const button = document.getElementById("deleteButton");
      const id = button.getAttribute("data-id");
      const type = button.getAttribute("data-type");

      if (!id || !type) {
        alert("❌يجب جلب البيانات من رقم المستند اولا.");
        return
      }

      const confirmDelete = confirm("⚠️ هل أنت متأكد أنك تريد حذف هذا المستند؟");
      if (!confirmDelete) return;

      const docRef = ref(database, `${type}/${id}`);
      try {
        const snap = await get(docRef);
        if (!snap.exists()) {
          alert("❌ المستند غير موجود.");
          return;
        }

        if (type === "devices") {
          await remove(docRef);
          alert("✅ تم حذف انواع الكمبيوترات  نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "Phone") {
          await remove(docRef);
          alert("✅ تم حذف انواع الهواتف  نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "Line") {
          await remove(docRef);
          alert("✅ تم حذف بقات الخط بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "Screen") {
          await remove(docRef);
          alert("✅ تم حذف انواع الشاشات   بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "Printer") {
          await remove(docRef);
          alert("✅ تم حذف انواع الطابعات بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "Camera") {
          await remove(docRef);
          alert("✅ تم حذف انواع الكاميرات بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "companies") {
          await remove(docRef);
          alert("✅ تم حذف الشركه بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "fixedAssets") {
          await remove(docRef);
          alert("✅ تم حذف الاهلاك بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "GPSS") {
          await remove(docRef);
          alert("✅ تم حذف GPS بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "departments") {
          await remove(docRef);
          alert("✅ تم حذف القسم  بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        if (type === "employees") {
          await remove(docRef);
          alert("✅ تم حذف الموظفين  بنجاح نهائيًا بنجاح.");
          if (typeof clearFormFields === "function") clearFormFields();
          return;
        }
        const doc = snap.val();

        if (doc.deleted === true) {
          alert("⚠️ تم حذف هذا المستند مسبقًا ولا يمكن حذفه مرة أخرى.");
          return;
        }

        const stockRef = ref(database, "stock");
        const stockSnap = await get(stockRef);
        const stock = stockSnap.exists() ? stockSnap.val() : {};

        let updateOriginal = {};

        if (type === "purchaseOrders" && doc.disbursementDocNumber) {
          const disbNum = doc.disbursementDocNumber.toString();
          const disbRef = ref(database, `documentsAddition/${disbNum}`);
          const disbSnap = await get(disbRef);
          if (disbSnap.exists()) {
            const disbDoc = disbSnap.val();
            const items = Array.isArray(disbDoc.items)
              ? disbDoc.items
              : Object.values(disbDoc.items);
            items.forEach((item) => {
              const code = item.itemCode;
              const qty = parseFloat(item.itemQuantity) || 0;
              stock[code] = (stock[code] || 0) - qty;
            });

            await set(stockRef, stock);
            await update(disbRef, {
              deleted: true,
              deletionDate: new Date().toISOString(),
            });
            updateOriginal.disbursementDocNumber = null;
          }
        }

        if (type === "deliveryRequests" && doc.disbursementDocNumber) {
          const disbNum = doc.disbursementDocNumber.toString();
          const disbRef = ref(database, `documentsDisbursement/${disbNum}`);
          const disbSnap = await get(disbRef);
          if (disbSnap.exists()) {
            const disbDoc = disbSnap.val();
            const items = Array.isArray(disbDoc.items)
              ? disbDoc.items
              : Object.values(disbDoc.items);
            items.forEach((item) => {
              const code = item.itemCode;
              const qty = parseFloat(item.itemQuantity) || 0;
              stock[code] = (stock[code] || 0) - qty;
            });

            await set(stockRef, stock);
            await update(disbRef, {
              deleted: true,
              deletionDate: new Date().toISOString(),
            });
            updateOriginal.disbursementDocNumber = null;
          }
        }

        await update(docRef, {
          ...updateOriginal,
          deleted: true,
          deletionDate: new Date().toISOString(),
        });

        alert("✅ تم حذف المستند بنجاح.");

        if (typeof clearFormFields === "function") clearFormFields();

      } catch (error) {
        console.error("❌ خطأ أثناء الحذف:", error);
        alert("❌ حدث خطأ أثناء حذف المستند. راجع الكونسول.");
      }
    };

    function clearFormFields() {
      const inputs = document.querySelectorAll("input, textarea, select");
      inputs.forEach((input) => {
        if (input.hasAttribute("readonly")) {
          input.removeAttribute("readonly");
        }
        input.value = "";
      });
    }

    document.addEventListener("keydown", async function (e) {
      if (e.ctrlKey && e.key === "Delete") {
        e.preventDefault();

        const canDelete = localStorage.getItem('canDelete') === 'true';
        const isAdmin = localStorage.getItem('userRole') === 'admin';
        if (!canDelete || !isAdmin) {
          alert("❌ الحذف النهائي متاح فقط للمسؤول.");
          return;
        }

        const button = document.getElementById("deleteButton");
        const id = button?.getAttribute("data-id");
        const type = button?.getAttribute("data-type");

        if (!id || !type) {
          alert("❌ يجب تحديد رقم المستند أولاً.");
          return;
        }

        const confirmDelete = confirm("⚠️ هل تريد حذف هذا المستند نهائيًا من قاعدة البيانات؟ (بدون إمكانية استرجاع)");
        if (!confirmDelete) return;

        try {
          const docRef = ref(database, `${type}/${id}`);
          const snap = await get(docRef);

          if (!snap.exists()) {
            alert("❌ المستند غير موجود.");
            return;
          }

          const doc = snap.val();

          const stockRef = ref(database, "stock");
          const stockSnap = await get(stockRef);
          const stock = stockSnap.exists() ? stockSnap.val() : {};

          if (doc.disbursementDocNumber && type === "deliveryRequests") {
            const disbRef = ref(database, `documentsDisbursement/${doc.disbursementDocNumber}`);
            const disbSnap = await get(disbRef);
            if (disbSnap.exists()) {
              const disbDoc = disbSnap.val();
              const items = Array.isArray(disbDoc.items) ? disbDoc.items : Object.values(disbDoc.items);
              items.forEach(item => {
                const code = item.itemCode;
                const qty = parseFloat(item.itemQuantity) || 0;
                stock[code] = (stock[code] || 0) - qty;
              });
              await set(stockRef, stock);
              await remove(disbRef);
            }
          }

          if (doc.disbursementDocNumber && type === "purchaseOrders") {
            const addRef = ref(database, `documentsAddition/${doc.disbursementDocNumber}`);
            const addSnap = await get(addRef);
            if (addSnap.exists()) {
              const addDoc = addSnap.val();
              const items = Array.isArray(addDoc.items) ? addDoc.items : Object.values(addDoc.items);
              items.forEach(item => {
                const code = item.itemCode;
                const qty = parseFloat(item.itemQuantity) || 0;
                stock[code] = (stock[code] || 0) - qty;
              });
              await set(stockRef, stock);
              await remove(addRef);
            }
          }

          await remove(docRef);
          alert("✅ تم حذف المستند والمستندات المرتبطة نهائيًا.");
          if (typeof clearFormFields === "function") clearFormFields();

        } catch (error) {
          console.error("❌ خطأ أثناء الحذف النهائي:", error);
          alert("❌ حدث خطأ أثناء الحذف النهائي. راجع الكونسول.");
        }
      }
    });

    document.addEventListener("keydown", async function (e) {
      if (e.ctrlKey && e.key.toLowerCase() === "y") {
        e.preventDefault();

        const isAdmin = localStorage.getItem('userRole') === 'admin';
        if (!isAdmin) {
          alert("❌ فقط المسؤول يمكنه فك الترحيل.");
          return;
        }

        const orderVisible = document.getElementById('orderAmendment')?.style.display !== "none";
        const deliveryVisible = document.getElementById('deliveryAmendment')?.style.display !== "none";

        if (orderVisible) {
          const purchaseId = document.getElementById('documentNumberOrder')?.value?.trim();
          if (!purchaseId) {
            alert("❌ يرجى إدخال رقم الطلب أولاً.");
            return;
          }

          const orderRef = ref(database, `purchaseOrders/${purchaseId}`);
          const orderSnap = await get(orderRef);

          if (!orderSnap.exists()) {
            alert("❌ الطلب غير موجود.");
            return;
          }

          const orderData = orderSnap.val();

          if (!orderData.migrated || !orderData.disbursementDocNumber) {
            alert("⚠️ هذا الطلب غير مرحل، لا حاجة لفك الترحيل.");
            return;
          }

          const confirmUnpost = confirm("⚠️ هل تريد فك ترحيل هذا الطلب؟ سيتم حذف إذن الإضافة وتعديل المخزون.");
          if (!confirmUnpost) return;

          try {
            const additionId = orderData.disbursementDocNumber.toString();
            const additionRef = ref(database, `documentsAddition/${additionId}`);
            const additionSnap = await get(additionRef);

            if (!additionSnap.exists()) {
              alert("❌ لم يتم العثور على إذن الإضافة المرتبط.");
              return;
            }

            const additionData = additionSnap.val();
            const stockRef = ref(database, "stock");
            const stockSnap = await get(stockRef);
            let stock = stockSnap.exists() ? stockSnap.val() : {};

            const items = Array.isArray(additionData.items)
              ? additionData.items
              : Object.values(additionData.items);

            items.forEach(item => {
              const code = item.itemCode;
              const qty = parseFloat(item.quantity) || 0;
              stock[code] = (stock[code] || 0) - qty;
            });

            await set(stockRef, stock);
            await remove(additionRef);
            await update(orderRef, { migrated: false });

            alert("✅ تم فك الترحيل بنجاح.");
          } catch (error) {
            console.error("❌ خطأ أثناء فك الترحيل:", error);
            alert("❌ حدث خطأ أثناء محاولة فك الترحيل.");
          }

        } else if (deliveryVisible) {
          const documentNumber = document.getElementById('documentNumberDelivery')?.value.trim();
          if (!documentNumber) {
            alert("❌ يرجى إدخال رقم الطلب أولاً.");
            return;
          }

          const deliveryRef = ref(database, `deliveryRequests/${documentNumber}`);
          const deliverySnap = await get(deliveryRef);

          if (!deliverySnap.exists()) {
            alert("❌ الطلب غير موجود.");
            return;
          }

          const deliveryData = deliverySnap.val();

          if (!deliveryData.migrated || !deliveryData.disbursementDocNumber) {
            alert("⚠️ هذا الطلب غير مرحل.");
            return;
          }

          const confirmUnpost = confirm("⚠️ هل تريد فك الترحيل؟ سيتم حذف إذن الصرف وتحديث المخزون.");
          if (!confirmUnpost) return;

          try {
            const disbId = deliveryData.disbursementDocNumber.toString();
            const disbRef = ref(database, `documentsDisbursement/${disbId}`);
            const disbSnap = await get(disbRef);

            if (!disbSnap.exists()) {
              alert("❌ لم يتم العثور على إذن الصرف.");
              return;
            }

            const disbData = disbSnap.val();
            const stockRef = ref(database, "stock");
            const stockSnap = await get(stockRef);
            let stock = stockSnap.exists() ? stockSnap.val() : {};

            const items = Array.isArray(disbData.items)
              ? disbData.items
              : Object.values(disbData.items);

            items.forEach(item => {
              const code = item.itemCode;
              const qty = parseFloat(item.itemQuantity) || 0;
              stock[code] = (stock[code] || 0) - qty;
            });

            await set(stockRef, stock);
            await remove(disbRef);
            await update(deliveryRef, { migrated: false });

            alert("✅ تم فك الترحيل بنجاح.");
          } catch (error) {
            console.error("❌ خطأ أثناء فك الترحيل:", error);
            alert("❌ حدث خطأ أثناء فك الترحيل.");
          }
        } else {
          alert("⚠️ لا توجد صفحة نشطة لفك الترحيل.");
        }
      }
    });

    //////////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////// داله البحث عن المستندات  /////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    window.fetchData = function () {
      let fetched = false;
      const isComputerFormVisible = document.getElementById("computerForm")?.offsetParent !== null;
      const isPhoneFormVisible = document.getElementById("phoneForm")?.offsetParent !== null;
      const isprintFormVisible = document.getElementById("printForm")?.offsetParent !== null;
      const isRouterFormVisible = document.getElementById("RouterForm")?.offsetParent !== null;
      const isLineFormVisible = document.getElementById("lineForm")?.offsetParent !== null;
      const isOrderFormVisible = document.getElementById("orderAmendment")?.offsetParent !== null;
      const isDeliveryFormVisible = document.getElementById("deliveryAmendment")?.offsetParent !== null;
      const isMaintenanceFormVisible = document.getElementById("maintenanceAmendment")?.offsetParent !== null;
      const isAddAProductAdditionFormVisible = document.getElementById("AddAProductAdditionForm")?.offsetParent !== null;
      const isAddProductDisbursementVisible = document.getElementById("AddProductDisbursement")?.offsetParent !== null;
      const isEditTemporaryFormVisible = document.getElementById("editTemporaryForm")?.offsetParent !== null;
      const isEditScreenFormVisible = document.getElementById("screenForm")?.offsetParent !== null;
      const isEditComputerSettingsVisible = document.getElementById("computerSettings")?.offsetParent !== null;
      const isEditPhoneSettingsVisible = document.getElementById("phoneSettings")?.offsetParent !== null;
      const isEditLineSettingsVisible = document.getElementById("lineSettings")?.offsetParent !== null;
      const isEditScreenSettingsVisible = document.getElementById("screenSettings")?.offsetParent !== null;
      const isEditPrinterSettingsVisible = document.getElementById("printerSettings")?.offsetParent !== null;
      const isEditCameraSettingsVisible = document.getElementById("cameraSettings")?.offsetParent !== null;
      const isEditCameraFormVisible = document.getElementById("cameraForm")?.offsetParent !== null;
      const isEditdefinitionCompanies = document.getElementById("definitionCompanies")?.offsetParent !== null;
      const isEditFixed = document.getElementById("fixedAssetsDepreciation")?.offsetParent !== null;
      const isEditGPS = document.getElementById("gpsForm")?.offsetParent !== null;
      const isEditGpsSettings = document.getElementById("gpsSettings")?.offsetParent !== null;
      const isEditHrForm = document.getElementById("HrForm")?.offsetParent !== null;
      const isDeptFormVisible = document.getElementById("FunctionalStructure")?.offsetParent !== null;
      const isEmpFormVisible = document.getElementById("FunctionalStructure")?.offsetParent !== null;
      const deptCode = document.getElementById("deptCode")?.value.trim() || "";
      const empCode = document.getElementById("empCode")?.value.trim() || "";

      if (isEditGPS) { fetchGpsData(); fetched = true; }
      if (isEditGpsSettings) { fetchGpsSettingsData(); fetched = true; }
      if (isComputerFormVisible) { fetchComputerData(); fetched = true; }
      if (isEditdefinitionCompanies) { fetchCompanyData(); fetched = true; }
      if (isPhoneFormVisible) { fetchPhoneData(); fetched = true; }
      if (isprintFormVisible) { fetchPrintData(); fetched = true; }
      if (isRouterFormVisible) { fetchRouterData(); fetched = true; }
      if (isLineFormVisible) { fetchLineData(); fetched = true; }
      if (isOrderFormVisible) { fetchOrderData(); fetched = true; }
      if (isDeliveryFormVisible) { fetchDeliveryData(); fetched = true; }
      if (isMaintenanceFormVisible) { fetchMaintenanceData(); fetched = true; }
      if (isAddAProductAdditionFormVisible) { fetchAProductAdditionData(); fetched = true; }
      if (isAddProductDisbursementVisible) { fetchProductDisbursementData(); fetched = true; }
      if (isEditTemporaryFormVisible) { fetchTemporaryData(); fetched = true; }
      if (isEditScreenFormVisible) { fetchScreenData(); fetched = true; }
      if (isEditComputerSettingsVisible) { fetchDeviceData(); fetched = true; }
      if (isEditPhoneSettingsVisible) { fetchDeviceDataPhone(); fetched = true; }
      if (isEditLineSettingsVisible) { fetchDeviceDataLine(); fetched = true; }
      if (isEditScreenSettingsVisible) { fetchDeviceDataScreen(); fetched = true; }
      if (isEditPrinterSettingsVisible) { fetchDeviceDataPrinter(); fetched = true; }
      if (isEditCameraSettingsVisible) { fetchDeviceDataCamera(); fetched = true; }
      if (isEditCameraFormVisible) { fetchCameraData(); fetched = true; }
      if (isEditFixed) { fetchFixedAssetsDepreciationData(); fetched = true; }
      if (isEditHrForm) { fetchHrFormData(); fetched = true; }
      if (isDeptFormVisible && deptCode) {
        fetchDeptFormData(deptCode);
        fetched = true;
      }
      if (isEmpFormVisible && empCode) {
        fetchEmpFormData(empCode);
        fetched = true;
      }
      if (!fetched) {
        if (isDeptFormVisible || isEmpFormVisible) {
          alert("❌ يرجى إدخال كود القسم أو الموظف !");
        } else {
          alert("❌ هذا القسم ليس لديه رقم مستند لجلب البيانات");
        }
      }
    };

    async function fetchEmpFormData() {
      const code = document.getElementById("empCode").value.trim();

      if (!code) {
        alert("❌ يرجى إدخال كود الموظف !");
        return;
      }

      const dbRef = ref(database, "employees");

      try {
        const snapshot = await get(dbRef);
        if (!snapshot.exists()) {
          alert("❌ لا توجد بيانات الموظف !");
          return;
        }

        const data = snapshot.val();
        let found = null;

        for (const key in data) {
          if (data[key].code === code) {
            found = { id: key, ...data[key] };
            break;
          }
        }

        if (!found) {
          alert("❌ لا يوجد الموظف بهذا الكود!");
          return;
        }

        document.getElementById("empCode").value = found.code || "";
        document.getElementById("empName").value = found.name || "";
        document.getElementById("empTitle").value = found.title || "";
        document.getElementById("empDept").value = found.deptId || "";
        const deleteBtn = document.getElementById("deleteButton");
        deleteBtn.style.display = "inline-block";
        deleteBtn.setAttribute("data-id", found.id);
        deleteBtn.setAttribute("data-type", "employees");

        alert("✅ تم جلب بيانات الموظف بنجاح! يمكنك الآن تعديلها وحفظها.");
      } catch (error) {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchDeptFormData() {
      const code = document.getElementById("deptCode").value.trim();

      if (!code) {
        alert("❌ يرجى إدخال كود القسم !");
        return;
      }

      const dbRef = ref(database, "departments");

      try {
        const snapshot = await get(dbRef);
        if (!snapshot.exists()) {
          alert("❌ لا توجد بيانات القسم !");
          return;
        }

        const data = snapshot.val();
        let found = null;

        for (const key in data) {
          if (data[key].code === code) {
            found = { id: key, ...data[key] };
            break;
          }
        }

        if (!found) {
          alert("❌ لا يوجد القسم بهذا الكود!");
          return;
        }

        document.getElementById("deptCode").value = found.code || "";
        document.getElementById("deptName").value = found.name || "";
        document.getElementById("parentDept").value = found.parent || "";
        refreshDeptLists();
        document.getElementById("parentDept").value = found.parent || "";
        const deleteBtn = document.getElementById("deleteButton");
        deleteBtn.style.display = "inline-block";
        deleteBtn.setAttribute("data-id", found.id);
        deleteBtn.setAttribute("data-type", "departments");

        alert("✅ تم جلب بيانات القسم بنجاح! يمكنك الآن تعديلها وحفظها.");
      } catch (error) {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchHrFormData() {
      const employeeCode = String(document.getElementById("employeeCode").value || "").trim();

      if (!employeeCode) {
        alert("❌ يرجى إدخال كود الموظف!");
        return;
      }

      try {
        const snap = await get(ref(database, `hrEmployees/${employeeCode}`));
        if (!snap.exists()) {
          alert("❌ لا يوجد موظف بهذا الكود!");
          return;
        }

        const data = snap.val();

        ["employeeForm", "educationForm", "skillsForm", "financeForm", "insuranceForm", "jobForm", "reportsForm"]
          .forEach(id => { const f = document.getElementById(id); if (f && typeof f.reset === "function") f.reset(); });

        const setVal = (id, value) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.value = (value === undefined || value === null) ? "" : value;
        };

        setVal("employeeCode", data.code ?? employeeCode);
        setVal("fullName", data.fullName ?? "");
        setVal("governorate", data.governorate ?? "");
        setVal("city", data.city ?? "");
        setVal("street", data.street ?? "");
        setVal("dob", data.dob ?? "");
        setVal("birthPlace", data.birthPlace ?? "");
        setVal("nid", data.nid ?? "");
        setVal("religion", data.religion ?? "");
        setVal("maritalStatus", data.maritalStatus ?? "");
        setVal("gender", data.gender ?? "");
        setVal("numberEmployess", data.numberEmployess ?? "");

        if (data.education) {
          setVal("qualification", data.education.qualification ?? "");
          setVal("specialization", data.education.specialization ?? "");
          setVal("university", data.education.university ?? "");
          setVal("graduationYear", data.education.graduationYear ?? "");
          setVal("grade", data.education.grade ?? "");
          setVal("courses", data.education.courses ?? "");
        }

        if (data.skills) {
          setVal("skillName", data.skills.skillName ?? "");
          setVal("skillLevel", data.skills.skillLevel ?? "");
        }

        if (data.finance) {
          setVal("employeeCostCenter", data.finance.employeeCostCenter ?? "");
          setVal("allowances", data.finance.allowances ?? "");
          setVal("salary", data.finance.salary ?? "");
          setVal("salary2", data.finance.incentives ?? data.finance.salary2 ?? "");
        }

        if (data.social) {
          setVal("insuranceNumber", data.social.insuranceNumber ?? "");
          setVal("basicInsuranceStatus", data.social.basicInsuranceStatus ?? "");
          setVal("insuranceStart", data.social.insuranceStart ?? "");
          setVal("insuranceSalary", data.social.insuranceSalary ?? "");
          setVal("employeeShare", data.social.employeeShare ?? "");
          setVal("companyShare", data.social.companyShare ?? "");
          setVal("employeeDeduction", data.social.employeeDeduction ?? "");
          setVal("totalContribution", data.social.totalContribution ?? "");
          setVal("linkedInsuranceOffice", data.social.linkedInsuranceOffice ?? "");
          setVal("linkedInsuranceOfficeNumber", data.social.linkedInsuranceOfficeNumber ?? "");
        }

        if (data.job) {
          setVal("jobDept", data.job.dept ?? "");
          setVal("jobTitle", data.job.jobTitle ?? "");
          setVal("jobStatus", data.job.status ?? "");
          setVal("employmentType", data.job.employmentType ?? "");
          setVal("jobGrade", data.job.jobGrade ?? "");
          setVal("hireDate", data.job.hireDate ?? "");
          setVal("contractStart", data.job.contractStart ?? "");
          setVal("contractEnd", data.job.contractEnd ?? "");
          setVal("previousJob", data.job.previousJob ?? "");
          setVal("currentJob", data.job.currentJob ?? "");
          setVal("lastPromotionDate", data.job.lastPromotionDate ?? "");
          setVal("workHours", data.job.workHours ?? "");
          setVal("shiftType", data.job.shiftType ?? "");
          setVal("workLocation", data.job.workLocation ?? "");
        }

        if (data.reports) {
          setVal("generalReport", data.reports.generalReport ?? data.reports.notes ?? "");
          setVal("performanceRating", data.reports.performanceRating ?? "");
          setVal("reportDate", data.reports.reportDate ?? "");
        }

        const deleteBtn = document.getElementById("deleteButton");
        if (deleteBtn) {
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", employeeCode);
          deleteBtn.setAttribute("data-type", "hrEmployee");
        }

        isEditMode = true;
        alert("✅ تم جلب بيانات الموظف بنجاح!");
      } catch (error) {
        console.error("fetchHrFormData error:", error);
        alert("❌ خطأ أثناء جلب البيانات: " + (error && error.message ? error.message : error));
      }
    }


    async function fetchFixedAssetsDepreciationData() {
      const assetCode = document.getElementById("assetCode").value.trim();

      if (!assetCode) {
        alert("❌ يرجى إدخال كود الأصل!");
        return;
      }

      const dbRef = ref(database, "fixedAssets");

      try {
        const snapshot = await get(dbRef);
        if (!snapshot.exists()) {
          alert("❌ لا توجد بيانات أصول!");
          return;
        }

        const data = snapshot.val();
        let found = null;

        for (const key in data) {
          if (data[key].assetCode === assetCode) {
            found = { id: key, ...data[key] };
            break;
          }
        }

        if (!found) {
          alert("❌ لا يوجد أصل بهذا الكود!");
          return;
        }

        document.getElementById("assetId").value = found.id;
        document.getElementById("assetCode").value = found.assetCode || "";
        document.getElementById("description").value = found.description || "";
        document.getElementById("assetCostCenter").value = found.costCenter || "";
        document.getElementById("deviceType").value = found.deviceType || "";
        document.getElementById("cost").value = found.cost || "";
        document.getElementById("residual").value = found.residual || "";
        document.getElementById("purchaseDate").value = found.purchaseDate || "";
        document.getElementById("usefulLife").value = found.usefulLife || "";
        document.getElementById("depMethod").value = found.depreciationMethod || "";
        document.getElementById("depRate").value = found.depreciationRate || "";
        await loadLinkedDevicesFor(found.deviceType || "أخرى", found.linkedCode || "");
        document.getElementById("linkedDevice").value = found.linkedCode || "";
        document.getElementById("outAccum").textContent = found.accumulatedDep || "0.00";
        document.getElementById("outNBV").textContent = found.netBookValue || "0.00";
        document.getElementById("outAsOf").textContent = found.lastCalcDate || "—";
        const deleteBtn = document.getElementById("deleteButton");
        deleteBtn.style.display = "inline-block";
        deleteBtn.setAttribute("data-id", found.id);
        deleteBtn.setAttribute("data-type", "fixedAssets");
        alert("✅ تم جلب بيانات الأصل بنجاح!");
      } catch (error) {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    function fetchCompanyData() {
      const companyCode1 = document.getElementById("companyCode1").value.trim();

      if (!companyCode1) {
        alert("❌ يرجى إدخال كود الشركة!");
        return;
      }

      const dbRef = ref(database, "companies");

      get(dbRef).then((snapshot) => {
        if (!snapshot.exists()) {
          alert("❌ لا توجد بيانات شركات!");
          return;
        }

        const data = snapshot.val();
        let found = null;

        for (const key in data) {
          if (data[key].code === companyCode1) {
            found = { id: key, ...data[key] };
            break;
          }
        }

        if (!found) {
          alert("❌ لا توجد شركة بهذا الكود!");
          return;
        }

        document.getElementById("companyCode1").value = found.code || "";
        document.getElementById("name1").value = found.name || "";
        document.getElementById("field1").value = found.field || "";
        document.getElementById("description1").value = found.description || "";
        document.getElementById("website1").value = found.website || "";
        const deleteBtn = document.getElementById("deleteButton");
        deleteBtn.style.display = "inline-block";
        deleteBtn.setAttribute("data-id", found.id);
        deleteBtn.setAttribute("data-type", "companies");
        alert("✅ تم جلب بيانات الشركة بنجاح!");
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchCameraData() {
      const documentNumberCamera = document.getElementById("documentNumberCamera").value.trim();

      if (!documentNumberCamera) {
        alert("❌ يرجى إدخال رقم مستند الكاميرات!");
        return;
      }

      const dbRef = ref(database, "cameras");
      get(dbRef).then((snapshot) => {
        if (!snapshot.exists()) {
          alert("❌ لا توجد بيانات للكاميرات!");
          return;
        }

        const data = snapshot.val();
        let found = null;

        for (const key in data) {
          if (parseInt(data[key].documentNumberCamera) === parseInt(documentNumberCamera)) {
            found = { id: key, ...data[key] };
            break;
          }
        }

        if (!found) {
          alert("❌ لا توجد كاميرا بهذا الرقم!");
          return;
        }

        document.getElementById("documentNumberCamera").value = found.documentNumberCamera || "";
        document.getElementById("dateCamera").value = found.dateCamera || "";
        document.getElementById("cameraLocation").value = found.cameraLocation || "";
        document.getElementById("cameraCondition").value = found.cameraCondition || "";
        document.getElementById("cameraLens").value = found.cameraLens || "";
        document.getElementById("serialCamera").value = found.serialCamera || "";
        document.getElementById("infrared").value = found.infrared || "";
        document.getElementById("cameraResolution").value = found.cameraResolution || "";
        document.getElementById("connectionType").value = found.connectionType || "";
        document.getElementById("notesCamera").value = found.notesCamera || "";
        document.getElementById("documentNumberCamera").setAttribute("data-id", found.id);
        if (found.company) {
          const cameraCompanySelect = document.getElementById("cameraCompanySelect");
          const companyCode = found.company.code || "";
          const companyName = found.company.name || "";

          let optionExists = false;
          for (let option of cameraCompanySelect.options) {
            if (option.value === companyCode) {
              optionExists = true;
              break;
            }
          }
          if (!optionExists && companyCode && companyName) {
            const opt = document.createElement("option");
            opt.value = companyCode;
            opt.textContent = companyName;
            cameraCompanySelect.appendChild(opt);
          }
          cameraCompanySelect.value = companyCode;
        }
        const cameraType = document.getElementById("cameraType");
        const cameraModel = document.getElementById("cameraModel");
        const selectedType = found.cameraType || "";
        const selectedModelValue = found.cameraModel || "";
        cameraType.value = selectedType;
        if (selectedType) {
          const modelsRef = ref(database, "Camera/" + selectedType + "/models");
          get(modelsRef).then((snapshot) => {
            const models = snapshot.val();
            cameraModel.innerHTML = '<option value="">-- اختر الموديل --</option>';

            if (Array.isArray(models)) {
              models.forEach((model) => {
                const opt = document.createElement("option");
                opt.value = model;
                opt.textContent = model;
                cameraModel.appendChild(opt);
              });
              cameraModel.value = selectedModelValue;
            }
          }).catch(err => {
            console.error("❌ فشل تحميل الموديلات:", err);
          });
        } else {
          cameraModel.innerHTML = '<option value="">-- اختر الموديل --</option>';
        }
        const deleteBtn = document.getElementById("deleteButton");
        const canDelete = localStorage.getItem('canDelete') === 'true';
        if (deleteBtn && canDelete) {
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", found.id);
          deleteBtn.setAttribute("data-type", "cameras");
        }

        alert("✅ تم جلب بيانات الكاميرا بنجاح!");
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    async function fetchDeviceDataCamera() {
      const deviceType = document.getElementById("cameraTypeInput").value.trim();

      if (!deviceType) {
        alert("❌ يرجى إدخال نوع الكاميرا  !");
        return;
      }

      try {
        const deviceRef = ref(database, "Camera/" + deviceType);
        const snapshot = await get(deviceRef);

        if (snapshot.exists()) {
          const deviceData = snapshot.val();

          document.getElementById("cameraModelsInput").value = deviceData.models.join(", ");

          currentEditingCameraType = deviceType;
          const deleteBtn = document.getElementById("deleteButton");
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", deviceType);
          deleteBtn.setAttribute("data-type", "Camera");
          alert("✅ تم جلب بيانات نوع الكاميرا بنجاح!");
        } else {
          alert("❌ لم يتم العثور على نوع الكاميرا بهذا النوع.");
        }
      } catch (error) {
        alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchGpsSettingsData() {
      const deviceType = document.getElementById("GPSTypeInput").value.trim();

      if (!deviceType) {
        alert("❌ يرجى إدخال نوع GPS  !");
        return;
      }

      try {
        const deviceRef = ref(database, "GPS/" + deviceType);
        const snapshot = await get(deviceRef);

        if (snapshot.exists()) {
          const deviceData = snapshot.val();

          document.getElementById("GPSModelsInput").value = deviceData.models.join(", ");
          currentEditingGpsType = deviceType;
          const deleteBtn = document.getElementById("deleteButton");
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", deviceType);
          deleteBtn.setAttribute("data-type", "GPS");
          alert("✅ تم جلب بيانات نوع GPS بنجاح!");
        } else {
          alert("❌ لم يتم العثور على نوع GPS بهذا النوع.");
        }
      } catch (error) {
        alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchDeviceDataPrinter() {
      const deviceType = document.getElementById("deviceTypeInputPrint").value.trim();

      if (!deviceType) {
        alert("❌ يرجى إدخال نوع الطابعات  !");
        return;
      }

      try {
        const deviceRef = ref(database, "Printer/" + deviceType);
        const snapshot = await get(deviceRef);

        if (snapshot.exists()) {
          const deviceData = snapshot.val();

          document.getElementById("deviceModelsInputPrinter").value = deviceData.models.join(", ");
          currentEditingPrinterType = deviceType;
          const deleteBtn = document.getElementById("deleteButton");
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", deviceType);
          deleteBtn.setAttribute("data-type", "Printer");
          alert("✅ تم جلب بيانات نوع الطابعات بنجاح!");
        } else {
          alert("❌ لم يتم العثور على نوع الطابعات بهذا النوع.");
        }
      } catch (error) {
        alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchDeviceDataScreen() {
      const deviceType = document.getElementById("screenTypeInput").value.trim();

      if (!deviceType) {
        alert("❌ يرجى إدخال نوع الشاشه  !");
        return;
      }

      try {
        const deviceRef = ref(database, "Screen/" + deviceType);
        const snapshot = await get(deviceRef);

        if (snapshot.exists()) {
          const deviceData = snapshot.val();

          document.getElementById("screenModelsInput").value = deviceData.models.join(", ");
          currentEditingScreenType = deviceType;
          const deleteBtn = document.getElementById("deleteButton");
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", deviceType);
          deleteBtn.setAttribute("data-type", "Screen");
          alert("✅ تم جلب بيانات نوع الشاشه بنجاح!");
        } else {
          alert("❌ لم يتم العثور على نوع الشاشه بهذا النوع.");
        }
      } catch (error) {
        alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchDeviceDataLine() {
      const deviceType = document.getElementById("companyInput").value.trim();

      if (!deviceType) {
        alert("❌ يرجى إدخال بقات  الخط!");
        return;
      }

      try {
        const deviceRef = ref(database, "Line/" + deviceType);
        const snapshot = await get(deviceRef);

        if (snapshot.exists()) {
          const deviceData = snapshot.val();

          document.getElementById("plansInput").value = deviceData.models.join(", ");
          currentEditingDeviceTypeLine = deviceType;
          const deleteBtn = document.getElementById("deleteButton");
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", deviceType);
          deleteBtn.setAttribute("data-type", "Line");
          alert("✅ تم جلب بيانات الخط بنجاح!");
        } else {
          alert("❌ لم يتم العثور على الخط بهذا النوع.");
        }
      } catch (error) {
        alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchDeviceDataPhone() {
      const deviceType = document.getElementById("deviceTypePhone").value.trim();

      if (!deviceType) {
        alert("❌ يرجى إدخال نوع الجهاز!");
        return;
      }

      try {
        const deviceRef = ref(database, "Phone/" + deviceType);
        const snapshot = await get(deviceRef);

        if (snapshot.exists()) {
          const deviceData = snapshot.val();

          document.getElementById("deviceModelsPhone").value = deviceData.models.join(", ");
          currentEditingDeviceTypePhone = deviceType;
          const deleteBtn = document.getElementById("deleteButton");
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", deviceType);
          deleteBtn.setAttribute("data-type", "Phone");
          alert("✅ تم جلب بيانات الجهاز بنجاح!");
        } else {
          alert("❌ لم يتم العثور على جهاز بهذا النوع.");
        }
      } catch (error) {
        alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    async function fetchDeviceData() {
      const deviceType = document.getElementById("deviceTypeInput").value.trim();

      if (!deviceType) {
        alert("❌ يرجى إدخال نوع الجهاز!");
        return;
      }

      try {
        const deviceRef = ref(database, "devices/" + deviceType);
        const snapshot = await get(deviceRef);

        if (snapshot.exists()) {
          const deviceData = snapshot.val();

          document.getElementById("deviceModelsInput").value = deviceData.models.join(", ");
          currentEditingDeviceType = deviceType;
          const deleteBtn = document.getElementById("deleteButton");
          deleteBtn.style.display = "inline-block";
          deleteBtn.setAttribute("data-id", deviceType);
          deleteBtn.setAttribute("data-type", "devices");
          alert("✅ تم جلب بيانات الجهاز بنجاح!");
        } else {
          alert("❌ لم يتم العثور على جهاز بهذا النوع.");
        }
      } catch (error) {
        alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }

    function fetchScreenData() {
      const documentNumberScreen = document.getElementById("documentNumberScreen").value.trim();
      if (!documentNumberScreen) {
        alert("❌يرجى إدخال رقم مستند  الشاشه   !");
        return;
      }
      const dbRef = ref(database, "screens");
      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].documentNumberScreen) === parseInt(documentNumberScreen)) {
              found = { id: key, ...data[key] };
              break;
            }
          }
          if (found) {
            document.getElementById("documentNumberScreen").value = found.documentNumberScreen || "";
            document.getElementById("screenLocation").value = found.screenLocation || "";
            document.getElementById("dateScreen").value = found.dateScreen || "";
            document.getElementById("screen").value = found.screen || "";
            document.getElementById("serial").value = found.serial || "";
            document.getElementById("size").value = found.size || "";
            document.getElementById("resolution").value = found.resolution || "";
            document.getElementById("ports").value = found.ports || "";
            document.getElementById("condition").value = found.condition || "";
            document.getElementById("notesScreen").value = found.notesScreen || "";
            if (found.screen === "كمبيوتر") {
              document.getElementById("pcFields").style.display = "block";
              const linkedPC = found.linkedPC || {};
              document.getElementById("screenPCName").value = linkedPC.pcNumber || "";
              document.getElementById("linkedEmployeeName").value = linkedPC.employee || "";
              document.getElementById("linkedDeviceType").value = linkedPC.deviceType || "";
              document.getElementById("linkedDeviceModel").value = linkedPC.deviceModel || "";
            } else {
              document.getElementById("pcFields").style.display = "none";
              document.getElementById("screenPCName").value = "";
              document.getElementById("linkedEmployeeName").value = "";
              document.getElementById("linkedDeviceType").value = "";
              document.getElementById("linkedDeviceModel").value = "";
            }
            document.getElementById("documentNumberScreen").setAttribute("data-id", found.id);
            document.getElementById("documentNumberScreen").setAttribute("readonly", true);
            if (found.company) {
              const screenCompanySelect = document.getElementById("screenCompanySelect");
              const companyCode = found.company.code || "";
              const companyName = found.company.name || "";

              let optionExists = false;
              for (let option of screenCompanySelect.options) {
                if (option.value === companyCode) {
                  optionExists = true;
                  break;
                }
              }

              if (!optionExists && companyCode && companyName) {
                const opt = document.createElement("option");
                opt.value = companyCode;
                opt.textContent = companyName;
                screenCompanySelect.appendChild(opt);
              }

              screenCompanySelect.value = companyCode;
            }

            const screenTypeSelect = document.getElementById("screenType");
            const screenModelSelect = document.getElementById("screenModel");
            const selectedType = found.screenType || "";
            const selectedModel = found.screenModel || "";
            screenTypeSelect.value = selectedType;

            if (selectedType) {
              const modelsRef = ref(database, "Screen/" + selectedType + "/models");
              get(modelsRef).then((snapshot) => {
                const models = snapshot.val();
                screenModelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

                if (Array.isArray(models)) {
                  models.forEach((model) => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    screenModelSelect.appendChild(opt);
                  });
                  screenModelSelect.value = selectedModel;
                }
              }).catch(err => {
                console.error("❌ فشل تحميل الموديلات:", err);
              });
            } else {
              screenModelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';
            }

            const deleteBtn = document.getElementById("deleteButton");
            const canDelete = localStorage.getItem('canDelete') === 'true';
            if (canDelete) {
              deleteBtn.style.display = "inline-block";
              deleteBtn.setAttribute("data-id", found.id);
              deleteBtn.setAttribute("data-type", "screens");
            }
            alert("✅ تم جلب بيانات الشاشة بنجاح!");
          }
        } else {
          alert("❌ لا توجد بيانات  الشاشات !");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchTemporaryData() {
      const documentNumberTemporary = document.getElementById("editDocumentNumberTemporary").value.trim();

      if (!documentNumberTemporary) {
        alert("❌يرجى إدخال رقم مستند العهده المؤقته   !");
        return;
      }

      const dbRef = ref(database, "temporaryAssets");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].documentNumber) === parseInt(documentNumberTemporary)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("editDocumentNumberTemporary").value = found.documentNumber || "";
            document.getElementById("editHandoverDate").value = found.handoverDate || "";
            document.getElementById("editEmployeeName").value = found.employeeName || "";
            document.getElementById("editReturnDate").value = found.expectedReturn || "";
            document.getElementById("editEquipmentType").value = found.equipmentType || "";
            document.getElementById("editNotesTemporary").value = found.notes || "";
            document.getElementById("editDocumentNumberTemporary").setAttribute("data-id", found.id);
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "temporaryAssets");
            alert("✅ تم جلب بيانات العهده المؤقت  بنجاح!");
          } else {
            alert("❌ لم يتم العثور على العهده المؤقت  بهذا المستند!");
          }
        } else {
          alert("❌ لا توجد بيانات العهده المؤقت !");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchProductDisbursementData() {
      const additionDocNumDisbursement = document.getElementById('documentNumberDisbursement').value.trim();

      if (!additionDocNumDisbursement) {
        alert("❌يرجى إدخال رقم مستند اذن صرف   !");
        return;
      }

      const dbRef = ref(database, "documentsDisbursement");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].documentNumberDisbursement) === parseInt(additionDocNumDisbursement)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("documentNumberDisbursement").value = found.documentNumberDisbursement || "";
            document.getElementById("documentDateDisbursement").value = found.documentDateDisbursement || "";
            document.getElementById("notesDisbursement").value = found.notesDisbursement || "";
            document.getElementById("locationDisbursement").value = found.locationDisbursement || "";
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "documentsDisbursement");
            addedItemsDisbursement = found.items || [];
            updateItemsTableDisbursement();
            alert("✅ تم جلب بيانات اذن صرف بنجاح!");
          } else {
            alert("❌ لم يتم العثور على اذن صرف بهذا المستند!");
          }
        } else {
          alert("❌ لا توجد بيانات اذن صرف!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchAProductAdditionData() {
      const additionDocNum = document.getElementById('documentNumberAddition').value.trim();

      if (!additionDocNum) {
        alert("❌يرجى إدخال رقم مستند اذن لاضافه   !");
        return;
      }

      const dbRef = ref(database, "documentsAddition");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].documentNumberAddition) === parseInt(additionDocNum)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("documentNumberAddition").value = found.documentNumberAddition || "";
            document.getElementById("documentDateAddition").value = found.documentDateAddition || "";
            document.getElementById("notesAddition").value = found.notesAddition || "";
            document.getElementById("supplierCode").value = found.supplierCode || "";
            document.getElementById("SupplierName").value = found.supplierName || "";
            document.getElementById("locationAddition").value = found.locationAddition || "";
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "documentsAddition");
            addedItems = found.items || [];
            updateItemsTable();

            alert("✅ تم جلب بيانات اذن لاضافه بنجاح!");
          } else {
            alert("❌ لم يتم العثور على اذن لاضافه بهذا المستند!");
          }
        } else {
          alert("❌ لا توجد بيانات اذن لاضافه!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchMaintenanceData() {

      const maintenanceId = document.getElementById("editDocumentNumber").value.trim();

      if (!maintenanceId) {
        alert("❌يرجى إدخال رقم مستند طلب الصيانه   !");
        return;
      }

      const dbRef = ref(database, "maintenance");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].maintenanceId) === parseInt(maintenanceId)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("editDocumentNumber").value = found.maintenanceId || "";
            document.getElementById("editDevice").value = found.device || "";
            document.getElementById("editMaintenanceDate").value = found.maintenanceDate || "";
            document.getElementById("editName").value = found.name || "";
            document.getElementById("editDescription").value = found.description || "";
            document.getElementById("editPrice2").value = found.price || "";
            document.getElementById("editFixDetails2").value = found.fixDetails || "";
            document.getElementById("editFixDate2").value = found.repairDate || "";
            document.getElementById("status2").value = found.status || "";
            document.getElementById("editDocumentNumber").setAttribute("data-id", maintenanceId);
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "maintenance");
            dataFetched = true;
            if (found.company) {
              const CompanySelectMaintenance2 = document.getElementById("CompanySelectMaintenance2");
              const companyCode = found.company.code || "";
              const companyName = found.company.name || "";

              let optionExists = false;
              for (let option of CompanySelectMaintenance2.options) {
                if (option.value === companyCode) {
                  optionExists = true;
                  break;
                }
              }
              if (!optionExists && companyCode && companyName) {
                const opt = document.createElement("option");
                opt.value = companyCode;
                opt.textContent = companyName;
                CompanySelectMaintenance2.appendChild(opt);
              }
              CompanySelectMaintenance2.value = companyCode;
            }
            alert("✅ تم جلب بيانات طلب الصيانه بنجاح!");
          } else {
            alert("❌ لم يتم العثور على طلب الصيانه بهذا الرقم!");
          }
        } else {
          alert("❌ لا توجد بيانات طلب الصيانه!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchDeliveryData() {
      const documentNumberDelivery = document.getElementById("documentNumberDelivery").value.trim();

      if (!documentNumberDelivery) {
        alert("❌يرجى إدخال رقم مستند موافقه تسليم   !");
        return;
      }

      const dbRef = ref(database, "deliveryRequests");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].documentNumberDelivery) === parseInt(documentNumberDelivery)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("documentNumberDelivery").value = found.documentNumberDelivery || "";
            document.getElementById("LocationDelivery2").value = found.location || "";
            document.getElementById("requestDelivery2").value = found.requester || "";
            document.getElementById("reasonDelivery2").value = found.reason || "";
            document.getElementById("approvalDateDelivery2").value = found.approvalDate || "";
            document.getElementById("documentNumberDelivery").setAttribute("data-id", found.id);
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "deliveryRequests");
            const tbody = document.getElementById("deliveryItemsTable");
            tbody.innerHTML = "";
            addedItemsDelivery = [];
            if (found.company) {
              const cameraCompanySelect = document.getElementById("CompanySelectDelivery2");
              const companyCode = found.company.code || "";
              const companyName = found.company.name || "";

              let optionExists = false;
              for (let option of cameraCompanySelect.options) {
                if (option.value === companyCode) {
                  optionExists = true;
                  break;
                }
              }

              if (!optionExists && companyCode && companyName) {
                const opt = document.createElement("option");
                opt.value = companyCode;
                opt.textContent = companyName;
                cameraCompanySelect.appendChild(opt);
              }
              cameraCompanySelect.value = companyCode;
            }

            if (found.items && Array.isArray(found.items)) {
              found.items.forEach((item, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.itemCode}</td>
                    <td>${item.itemName}</td>
                    <td>${item.quantity}</td>
                    <td>${item.beneficiary || ''}</td>
                    <td>${item.notes || ''}</td>
                    <td><button type="button" onclick="removeDeliveryItem(${index})">❌</button></td>
                `;
                tbody.appendChild(row);
                addedItemsDelivery.push(item);
              });
            } else {
              tbody.innerHTML = `<tr><td colspan="6">لا توجد أصناف مضافة</td></tr>`;
            }
            alert("✅ تم جلب بيانات موفقه تسليم بنجاح!");
          } else {
            alert("❌ لم يتم العثور موفقه تسليم  بهذا المستند!");
          }
        } else {
          alert("❌ لا توجد بيانات موفقه تسليم!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchOrderData() {
      const docNumber = document.getElementById('documentNumberOrder').value.trim();

      if (!docNumber) {
        alert("❌ يرجى إدخال رقم مستند طلب الشراء !");
        return;
      }

      const dbRef = ref(database, "purchaseOrders");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].documentNumberOrder) === parseInt(docNumber)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("documentNumberOrder").value = found.documentNumberOrder || "";
            document.getElementById("purchaseDateOrder").value = found.purchaseDate || "";
            document.getElementById("purchaseReasonOrder").value = found.purchaseReason || "";
            document.getElementById("purchaseNotesOrder").value = found.notesPurchase || "";
            document.getElementById("purchaseRequesterOrder").value = found.purchaseRequester || "";
            document.getElementById("purchaseLocationOrder").value = found.locationPurchase || "";
            document.getElementById("supplierCodeOrder2").value = found.supplierCodeOrder || "";
            document.getElementById("SupplierNameOrder2").value = found.SupplierNameOrder || "";
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "purchaseOrders");
            addedItemsPurchase = found.items || [];
            updateItemsTablePurchase2();
            if (found.company) {
              const cameraCompanySelect = document.getElementById("purchaseCompanySelectOrder");
              const companyCode = found.company.code || "";
              const companyName = found.company.name || "";

              let optionExists = false;
              for (let option of cameraCompanySelect.options) {
                if (option.value === companyCode) {
                  optionExists = true;
                  break;
                }
              }

              if (!optionExists && companyCode && companyName) {
                const opt = document.createElement("option");
                opt.value = companyCode;
                opt.textContent = companyName;
                cameraCompanySelect.appendChild(opt);
              }
              cameraCompanySelect.value = companyCode;
            }
            alert("✅ تم جلب بيانات طلب الشراء بنجاح!");
          } else {
            alert("❌ لم يتم العثور على بيانات طلب الشراء بهذا المستند!");
          }
        } else {
          alert("❌ لا توجد بيانات طلب الشراء!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchLineData() {
      const documentNumberLine = document.getElementById("documentNumberLine").value.trim();

      if (!documentNumberLine) {
        alert("❌ يرجى إدخال رقم مستندو الخط !");
        return;
      }

      const dbRef = ref(database, "lines");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].documentNumberLine) === parseInt(documentNumberLine)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("employeeNameLine").value = found.employeeName || "";
            document.getElementById("phoneNumberLine").value = found.phoneNumber || "";
            document.getElementById("dateLine").value = found.date || "";
            document.getElementById("locationLine").value = found.location || "";
            document.getElementById("companyLine").value = found.company || "";
            document.getElementById("packageTypeLine").value = found.packageType || "";
            document.getElementById("packageSize").value = found.packageSize || "";
            document.getElementById("simNumberLine").value = found.simNumber || "";
            document.getElementById("startDateLine").value = found.startDate || "";
            document.getElementById("packageDuration").value = found.packageDuration || "";
            document.getElementById("selectedCompanyCodeLine").value = found.selectedCompanyCode || "";
            document.getElementById("companySelectLine").value = found.selectedCompanyCode || "";
            document.getElementById("endDate").value = found.endDate || "";
            document.getElementById("notesLine").value = found.notes || "";
            document.getElementById("documentNumberLine").setAttribute("data-id", found.id);
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "lines");
            document.getElementById("companyLine").dispatchEvent(new Event("change"));
            const phoneTypeSelect = document.getElementById("companyLine");
            const phoneModelSelect = document.getElementById("plansLine");
            phoneTypeSelect.value = found.company || "";
            phoneModelSelect.innerHTML = '<option value="">-- اختر الباقات --</option>';

            if (found.company) {
              const modelsRef = ref(database, "Line/" + found.company + "/models");
              get(modelsRef).then((snapshot) => {
                const models = snapshot.val();
                if (Array.isArray(models)) {
                  models.forEach((model) => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    phoneModelSelect.appendChild(opt);
                  });
                  phoneModelSelect.value = found.plans || "";
                }
              });
            }
            alert("✅ تم جلب بيانات الخطوط بنجاح.");
          } else {
            alert("❌ لم يتم العثور على الخطوط بهذا المستند!");
          }
        } else {
          alert("❌ لا توجد بيانات الخطوط!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchRouterData() {
      const docNumberRouter = document.getElementById("docNumberRouter").value.trim();

      if (!docNumberRouter) {
        alert("❌ يرجى إدخال رقم مستند جهاز رواتر !");
        return;
      }

      const dbRef = ref(database, "routers");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].docNumber) === parseInt(docNumberRouter)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("date").value = found.date || "";
            document.getElementById("locationRouter").value = found.location || "";
            document.getElementById("deviceStatusRouter").value = found.deviceStatus || "";
            document.getElementById("deviceTypeRouter").value = found.deviceTypeRouter || "";
            document.getElementById("routerModel").value = found.routerModel || "";
            document.getElementById("serialNumber").value = found.serialNumber || "";
            document.getElementById("ipAddress").value = found.ipAddress || "";
            document.getElementById("ssid").value = found.ssid || "";
            document.getElementById("wifiPassword").value = found.wifiPassword || "";
            document.getElementById("providerCompany").value = found.providerCompany || "";
            document.getElementById("geoLocation").value = found.geoLocation || "";
            document.getElementById("notes").value = found.notes || "";
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "routers");
            if (found.deviceTypeRouter === "متنقل") {
              document.getElementById("phoneNumberRouter").value = found.phoneNumberRouter || "";
              document.getElementById("userNameRouter").value = found.userNameRouter || "";
              document.getElementById("simNumberRouter").value = found.simNumberRouter || "";
              console.log("simNumberRouter field after set:", document.getElementById("simNumberRouter").value);
              console.log("simNumberRouter value before set:", found.simNumberRouter);
              document.getElementById("mobileFieldsRouter").style.display = "block";
              document.getElementById("fixedFieldsRouter").style.display = "none";
              document.getElementById("otherFieldsRouter").style.display = "none";
            } else if (found.deviceTypeRouter === "ثابت") {
              document.getElementById("macAddress").value = found.macAddress || "";
              document.getElementById("landlineNumber").value = found.landlineNumber || "";
              document.getElementById("mobileFieldsRouter").style.display = "none";
              document.getElementById("fixedFieldsRouter").style.display = "block";
              document.getElementById("otherFieldsRouter").style.display = "none";
            } else {
              document.getElementById("deviceDescription").value = found.deviceDescription || "";
              document.getElementById("mobileFieldsRouter").style.display = "none";
              document.getElementById("fixedFieldsRouter").style.display = "none";
              document.getElementById("otherFieldsRouter").style.display = "block";
            }
            if (found.routerModel === "آخر") {
              document.getElementById("customRouterModelRouter").style.display = "block";
              document.getElementById("otherRouterModel").value = found.otherRouterModel || "";
            } else {
              document.getElementById("customRouterModelRouter").style.display = "none";
            }
            const companySelect = document.getElementById("CompanySelectRouter");
            const selectedCode = document.getElementById("selectedCompanyCodeRouter");
            if (found.companyCode) {
              companySelect.value = found.companyCode;
              selectedCode.value = found.companyCode;
            }
            const docField = document.getElementById("docNumberRouter");
            docField.setAttribute("data-id", found.id);
            isEditingRouter = true;
            editingRouterId = found.id;
            alert("✅ تم جلب بيانات الراوتر بنجاح.");

          } else {
            alert("❌ لم يتم العثور على الراوتر بهذا المستند!");
          }
        } else {
          alert("❌ لا توجد بيانات أجهزة!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchPrintData() {
      const docNumberPrinter = document.getElementById("doc_number").value.trim();

      if (!docNumberPrinter) {
        alert("❌ يرجى إدخال رقم مستند طابعات !");
        return;
      }

      const dbRef = ref(database, "printers");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].doc_number) === parseInt(docNumberPrinter)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("doc_number").value = found.doc_number || "";
            document.getElementById("doc_date").value = found.doc_date || "";
            document.getElementById("locationPrint").value = found.location || "";
            document.getElementById("printer_name").value = found.printer_name || "";
            document.getElementById("printer_type").value = found.printer_type || "";
            document.getElementById("serial_number").value = found.serial_number || "";
            document.getElementById("ip_address").value = found.ip_address || "";
            document.getElementById("statusPrint").value = found.status || "";
            document.getElementById("notesPrint").value = found.notes || "";
            document.getElementById("doc_number").setAttribute("data-id", found.id);
            if (found.company) {
              const screenCompanySelect = document.getElementById("printerCompanySelect");
              const companyCode = found.company.code || "";
              const companyName = found.company.name || "";

              let optionExists = false;
              for (let option of screenCompanySelect.options) {
                if (option.value === companyCode) {
                  optionExists = true;
                  break;
                }
              }
              if (!optionExists && companyCode && companyName) {
                const opt = document.createElement("option");
                opt.value = companyCode;
                opt.textContent = companyName;
                screenCompanySelect.appendChild(opt);
              }

              screenCompanySelect.value = companyCode;
            }
            const screenTypeSelect = document.getElementById("printer_name");
            const screenModelSelect = document.getElementById("printer_model");
            const selectedType = found.printer_name || "";
            const selectedModel = found.printer_model || "";
            screenTypeSelect.value = selectedType;

            if (selectedType) {
              const modelsRef = ref(database, "Printer/" + selectedType + "/models");
              get(modelsRef).then((snapshot) => {
                const models = snapshot.val();
                screenModelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

                if (Array.isArray(models)) {
                  models.forEach((model) => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    screenModelSelect.appendChild(opt);
                  });
                  screenModelSelect.value = selectedModel;
                }
              }).catch(err => {
                console.error("❌ فشل تحميل الموديلات:", err);
              });
            } else {
              screenModelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';
            }
            const deleteBtn = document.getElementById("deleteButton");
            const canDelete = localStorage.getItem('canDelete') === 'true';
            if (canDelete) {
              deleteBtn.style.display = "inline-block";
              deleteBtn.setAttribute("data-id", found.id);
              deleteBtn.setAttribute("data-type", "printers");
            }

            alert("✅ تم جلب بيانات الجهاز بنجاح!");
          } else {
            alert("❌ لم يتم العثور على جهاز بهذا الرقم!");
          }
        } else {
          alert("❌ لا توجد بيانات أجهزة!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchComputerData() {
      const pcNum = document.getElementById("pcNum").value.trim();

      if (!pcNum) {
        alert("❌ يرجى إدخال رقم جهاز الكمبيوتر!");
        return;
      }

      const dbRef = ref(database, "computers");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].pcNum) === parseInt(pcNum)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("pcNum").value = found.pcNum || "";
            document.getElementById("pcLocation").value = found.pcLocation || "";
            document.getElementById("pcUser").value = found.pcUser || "";
            document.getElementById("note").value = found.note || "";
            document.getElementById("pcStatus").value = found.pcStatus || "";
            document.getElementById("dateAdded").value = found.dateAdded || "";
            document.getElementById("brandMB").value = found.brandMB || "";
            document.getElementById("configMB").value = found.configMB || "";
            document.getElementById("snMB").value = found.snMB || "";
            document.getElementById("PROCESSOR").value = found.PROCESSOR || "";
            document.getElementById("configPROCESSOR").value = found.configPROCESSOR || "";
            document.getElementById("snPROCESSOR").value = found.snPROCESSOR || "";
            document.getElementById("H.D.D").value = found.HDD || "";
            document.getElementById("configH.D.D").value = found.configHDD || "";
            document.getElementById("snH.D.D").value = found.snHDD || "";
            document.getElementById("S.D.D").value = found.SDD || "";
            document.getElementById("configS.D.D").value = found.configSDD || "";
            document.getElementById("snS.D.D").value = found.snSDD || "";
            document.getElementById("MONITOE").value = found.MONITOE || "";
            document.getElementById("configMONITOE").value = found.configMONITOE || "";
            document.getElementById("snMONITOE").value = found.snMONITOE || "";
            document.getElementById("DVD").value = found.DVD || "";
            document.getElementById("configDVD").value = found.configDVD || "";
            document.getElementById("snDVD").value = found.snDVD || "";
            document.getElementById("KEYBORD").value = found.KEYBORD || "";
            document.getElementById("configKEYBORD").value = found.configKEYBORD || "";
            document.getElementById("snKEYBORD").value = found.snKEYBORD || "";
            document.getElementById("MOUSE").value = found.MOUSE || "";
            document.getElementById("configMOUSE").value = found.configMOUSE || "";
            document.getElementById("snMOUSE").value = found.snMOUSE || "";
            document.getElementById("USBMODEM").value = found.USBMODEM || "";
            document.getElementById("configUSBMODEM").value = found.configUSBMODEM || "";
            document.getElementById("snUSBMODEM").value = found.snUSBMODEM || "";
            document.getElementById("ACCESSORIES").value = found.ACCESSORIES || "";
            document.getElementById("configACCESSORIES").value = found.configACCESSORIES || "";
            document.getElementById("snACCESSORIES").value = found.snACCESSORIES || "";
            document.getElementById("SYSAPPS").value = found.SYSAPPS || "";
            document.getElementById("configSYSAPPS").value = found.configSYSAPPS || "";
            document.getElementById("snSYSAPPS").value = found.snSYSAPPS || "";
            document.getElementById("companySelect").value = found.companyCode || "";
            document.getElementById("pcNum").setAttribute("data-id", found.id);
            const deviceTypeSelect = document.getElementById("deviceType1");
            const deviceModelSelect = document.getElementById("deviceModel");
            const selectedType = found.deviceType || "";
            const selectedModel = found.deviceModel || "";
            deviceTypeSelect.value = selectedType;
            if (selectedType) {
              const modelsRef = ref(database, "devices/" + selectedType + "/models");
              get(modelsRef).then((snapshot) => {
                const models = snapshot.val();
                deviceModelSelect.innerHTML = '<option value="">-- Select model --</option>';

                if (Array.isArray(models)) {
                  models.forEach((model) => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    deviceModelSelect.appendChild(opt);
                  });
                  deviceModelSelect.value = selectedModel;
                }
              });
            } else {
              deviceModelSelect.innerHTML = '<option value="">-- Select model --</option>';
            }

            const deleteBtn = document.getElementById("deleteButton");
            const canDelete = localStorage.getItem('canDelete') === 'true';

            if (canDelete) {
              deleteBtn.style.display = "inline-block";
              deleteBtn.setAttribute("data-id", found.id);
              deleteBtn.setAttribute("data-type", "computers");
            }
            alert("✅ تم جلب بيانات الجهاز بنجاح!");
          } else {
            alert("❌ لم يتم العثور على جهاز بهذا الرقم!");
          }
        } else {
          alert("❌ لا توجد بيانات أجهزة!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchGpsData() {
      const docNumberGPS = document.getElementById("docNumberGPS").value.trim();

      if (!docNumberGPS) {
        alert("❌ يرجى إدخال رقم جهاز GPS!");
        return;
      }

      const dbRef = ref(database, "GPSS");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (parseInt(data[key].docNumberGPS) === parseInt(docNumberGPS)) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found) {
            document.getElementById("docNumberGPS").value = found.docNumberGPS || "";
            document.getElementById("locationGPS").value = found.locationGPS || "";
            document.getElementById("installDateGPS").value = found.installDateGPS || "";
            document.getElementById("carLicenseGPS").value = found.carLicenseGPS || "";
            document.getElementById("carTypeGPS").value = found.carTypeGPS || "";
            document.getElementById("imeiGPS").value = found.imeiGPS || "";
            document.getElementById("GPSType").value = found.GPSType || "";
            document.getElementById("GPSModel").value = found.GPSModel || "";
            document.getElementById("employeeNameGPS").value = found.employeeNameGPS || "";
            document.getElementById("lineNumberGPS").value = found.lineNumberGPS || "";
            document.getElementById("simNumberGPS").value = found.simNumberGPS || "";
            document.getElementById("snPROCESSOR").value = found.snPROCESSOR || "";
            document.getElementById("statusGPS").value = found.statusGPS || "";
            document.getElementById("notesGPS").value = found.notesGPS || "";
            document.getElementById("companySelect2").value = found.companyCode || "";
            document.getElementById("docNumberGPS").setAttribute("data-id", found.id);
            const deviceTypeSelect = document.getElementById("GPSType");
            const deviceModelSelect = document.getElementById("GPSModel");
            const selectedType = found.GPSType || "";
            const selectedModel = found.GPSModel || "";
            deviceTypeSelect.value = selectedType;
            if (selectedType) {
              const modelsRef = ref(database, "GPS/" + selectedType + "/models");
              get(modelsRef).then((snapshot) => {
                const models = snapshot.val();
                deviceModelSelect.innerHTML = '<option value="">-- Select model --</option>';

                if (Array.isArray(models)) {
                  models.forEach((model) => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    deviceModelSelect.appendChild(opt);
                  });
                  deviceModelSelect.value = selectedModel;
                }
              });
            } else {
              deviceModelSelect.innerHTML = '<option value="">-- Select model --</option>';
            }

            const deleteBtn = document.getElementById("deleteButton");
            const canDelete = localStorage.getItem('canDelete') === 'true';

            if (canDelete) {
              deleteBtn.style.display = "inline-block";
              deleteBtn.setAttribute("data-id", found.id);
              deleteBtn.setAttribute("data-type", "GPSS");
            }
            alert("✅ تم جلب بيانات الجهاز بنجاح!");
          } else {
            alert("❌ لم يتم العثور على جهاز بهذا الرقم!");
          }
        } else {
          alert("❌ لا توجد بيانات أجهزة!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    function fetchPhoneData() {
      const documentNumberPhone = document.getElementById("documentNumberPhone").value.trim();

      if (!documentNumberPhone) {
        alert("❌ يرجى إدخال رقم مستند الهاتف!");
        return;
      }

      const dbRef = ref(database, "phones");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          let found = null;

          for (const key in data) {
            if (data[key].documentNumberPhone === documentNumberPhone) {
              found = { id: key, ...data[key] };
              break;
            }
          }

          if (found && found.documentNumberPhone) {
            document.getElementById("documentNumberPhone").value = found.documentNumberPhone || "";
            document.getElementById("employeeNamePhone").value = found.employeeNamePhone || "";
            document.getElementById("datePhone").value = found.datePhone || "";
            document.getElementById("locationPhone").value = found.locationPhone || "";
            document.getElementById("ram").value = found.ram || "";
            document.getElementById("storage").value = found.storage || "";
            document.getElementById("imeiNumber").value = found.imeiNumber || "";
            document.getElementById("simNumberPhone").value = found.simNumberPhoe || "";
            document.getElementById("phoneStatus").value = found.phoneStatus || "";
            document.getElementById("notesPhone").value = found.notesPhone || "";
            document.getElementById("selectedCompanyCodePhone").value = found.companyCode || "";
            document.getElementById("companySelectPhone").value = found.companyCode || "";
            document.getElementById("documentNumberPhone").setAttribute("data-id", found.id);
            const deleteBtn = document.getElementById("deleteButton");
            deleteBtn.style.display = "inline-block";
            deleteBtn.setAttribute("data-id", found.id);
            deleteBtn.setAttribute("data-type", "phones");
            const phoneTypeSelect = document.getElementById("phoneType");
            const phoneModelSelect = document.getElementById("phoneModel");
            phoneTypeSelect.value = found.phoneType || "";
            phoneModelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

            if (found.phoneType) {
              const modelsRef = ref(database, "Phone/" + found.phoneType + "/models");
              get(modelsRef).then((snapshot) => {
                const models = snapshot.val();
                if (Array.isArray(models)) {
                  models.forEach((model) => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    phoneModelSelect.appendChild(opt);
                  });
                  phoneModelSelect.value = found.phoneModel || "";
                }
              });
            }

            alert("✅ تم جلب بيانات الهاتف بنجاح!");
          } else {
            alert("❌ لم يتم العثور على هاتف بهذا الرقم!");
          }
        } else {
          alert("❌ لا توجد بيانات هواتف!");
        }
      }).catch((error) => {
        alert("❌ خطأ أثناء جلب البيانات: " + error.message);
      });
    }

    ///////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////////////////// طلب الشراء   ///////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////////////////////////////
    function loadCompaniesIntoSelectOrder() {
      const companySelect = document.getElementById("CompanySelectOrder");
      const purchaseCompanySelect = document.getElementById("purchaseCompanySelectOrder");
      const queryCompanySelect = document.getElementById("queryCompanySelectOrder");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeOrder");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (purchaseCompanySelect) purchaseCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
          if (purchaseCompanySelect) {
            const option3 = document.createElement("option");
            option3.value = company.code;
            option3.textContent = company.name;
            purchaseCompanySelect.appendChild(option3);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectOrder);

    let addedItemsPurchase = [];

    window.saveOrder = async function () {
      const OrderSave = localStorage.getItem('OrderSave') === 'true';
      if (!OrderSave) {
        alert("❌ ليس لديك صلاحية حفظ البيانات.");
        return;
      }

      const purchaseDate = document.getElementById('purchaseDate22').value.trim();
      const notesPurchase = document.getElementById('purchaseNotes').value.trim();
      const locationPurchase = document.getElementById('purchaseLocation').value.trim();
      const purchaseReason = document.getElementById('purchaseReason').value.trim();
      const purchaseRequester = document.getElementById('purchaseRequester').value.trim();
      const SupplierNameOrder = document.getElementById('SupplierNameOrder').value.trim();
      const supplierCodeOrder = document.getElementById('supplierCodeOrder').value.trim();
      const companyCode = document.getElementById("CompanySelectOrder").value;
      const companyName = document.getElementById("CompanySelectOrder").selectedOptions[0]?.textContent || "";

      let documentNumberOrder;
      if (!purchaseDate) {
        alert("❌ يرجى إدخال تاريخ الطلب.");
        return;
      }
      if (addedItemsPurchase.length === 0) {
        alert("لا يمكن الحفظ بدون أصناف. يرجى إضافة صنف واحد على الأقل.");
        return;
      }

      const hasInvalidItem = addedItemsPurchase.some(item => !item.itemCode || item.itemCode.trim() === "");
      if (hasInvalidItem) {
        alert("❌ يوجد صنف بدون كود. يرجى التحقق من كل الأصناف قبل الحفظ.");
        return;
      }

      try {
        const itemsRef = ref(database, 'items');
        const itemsSnap = await get(itemsRef);
        if (!itemsSnap.exists()) {
          alert("❌ لم يتم العثور على قاعدة بيانات الأصناف.");
          return;
        }

        const allItems = itemsSnap.val();
        const validItemCodes = new Set(Object.values(allItems).map(item => item.itemCode.toString().trim()));

        const invalidItems = addedItemsPurchase.filter(item => !validItemCodes.has(item.itemCode.toString().trim()));
        if (invalidItems.length > 0) {
          let invalidNames = invalidItems.map(item => item.itemName || item.itemCode).join(", ");
          alert(`❌ بعض الأصناف غير موجودة في قاعدة البيانات: ${invalidNames}`);
          return;
        }

        if (!supplierCodeOrder || !SupplierNameOrder) {
          alert("❌ يرجى إدخال بيانات المورد كاملة.");
          return;
        }

        const resRef = ref(database, 'resources');
        const resSnap = await get(resRef);
        if (!resSnap.exists()) {
          alert("❌ لا يمكن التحقق من المورد. قاعدة الموردين غير موجودة.");
          return;
        }

        const allResources = resSnap.val();
        const isValidSupplier = Object.values(allResources).some(resource => {
          return resource.code.toString().trim() === supplierCodeOrder && resource.name.trim() === SupplierNameOrder;
        });

        if (!isValidSupplier) {
          alert(`❌ المورد غير موجود أو بياناته غير صحيحة: ${SupplierNameOrder} (${supplierCodeOrder})`);
          return;
        }

        const docCounterRef = ref(database, 'documentNumberOrder');
        const docSnapshot = await get(docCounterRef);
        documentNumberOrder = docSnapshot.exists() ? docSnapshot.val() + 1 : 1;

        const documentData = {
          documentNumberOrder,
          purchaseDate,
          purchaseReason,
          purchaseRequester,
          notesPurchase,
          locationPurchase,
          supplierCodeOrder,
          supplierId: supplierCodeOrder,
          SupplierNameOrder,
          items: addedItemsPurchase,
          company: {
            code: companyCode,
            name: companyName
          }
        };

        const documentRef = ref(database, `purchaseOrders/${documentNumberOrder}`);
        await set(documentRef, documentData);
        await set(docCounterRef, documentNumberOrder);

        alert("✅ تم حفظ طلب الشراء بنجاح!");

        const invoiceData = {
          siteLocation: locationPurchase,
          documentNumber: documentNumberOrder,
          approvalDate: purchaseDate,
          reason: purchaseReason,
          requestBy: purchaseRequester,
          SupplierNameOrder,
          orders: addedItemsPurchase.map(item => ({
            itemName: item.itemName,
            quantity: item.itemQuantity,
            unitPrice: item.unitPrice,
            totalPrice: item.totalPrice,
            notes: item.itemNotes || ''
          })),
          company: {
            code: companyCode,
            name: companyName
          }
        };

        showInvoice(invoiceData);

        document.getElementById('purchaseDate').value = '';
        document.getElementById('purchaseNotes').value = '';
        document.getElementById('purchaseLocation').value = '';
        document.getElementById('purchaseReason').value = '';
        document.getElementById('purchaseRequester').value = '';
        document.getElementById('SupplierNameOrder').value = '';
        document.getElementById('supplierCodeOrder').value = '';
        document.getElementById('CompanySelectOrder').value = '';

        addedItemsPurchase = [];
        updateItemsTablePurchase();

      } catch (error) {
        console.error("❌ خطأ أثناء الحفظ:", error);
        alert("❌ حدث خطأ أثناء حفظ البيانات.");
      }
    };

    window.fetchItemDetailsOrder = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('itemCodeOrder').value.trim()
        : document.getElementById('itemNameOrder').value.trim();

      if (!searchValue) return;
      const itemsRef = ref(database, 'items');
      get(itemsRef).then(snapshot => {
        if (snapshot.exists()) {
          const itemsData = snapshot.val();
          let foundItem = null;
          let matchingItems = [];

          for (const key in itemsData) {
            if (itemsData.hasOwnProperty(key)) {
              const item = itemsData[key];

              if (type === 'code' && item.itemCode.toString() === searchValue) {
                foundItem = item;
                break;
              } else if (type === 'name' && item.itemName.toLowerCase().includes(searchValue.toLowerCase())) {
                matchingItems.push({ name: item.itemName, code: item.itemCode });
              }
            }
          }

          if (type === 'code') {
            if (foundItem) {
              document.getElementById('itemCodeOrder').value = foundItem.itemCode;
              document.getElementById('itemNameOrder').value = foundItem.itemName;
            } else {
              alert("⚠️ الصنف غير موجود.");
            }
          } else if (type === 'name') {
            let dataList = document.getElementById('itemSuggestionsOrder');
            dataList.innerHTML = "";
            matchingItems.forEach(item => {
              let option = document.createElement("option");
              option.value = item.name;
              option.dataset.code = item.code;
              dataList.appendChild(option);
            });
          }
        }
      }).catch(error => {
        console.error("❌ خطأ أثناء جلب بيانات الأصناف:", error);
      });
    };

    document.getElementById('itemNameOrder').addEventListener('input', function () {
      let selectedName = this.value;
      let options = document.querySelectorAll('#itemSuggestionsOrder option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('itemCodeOrder').value = option.dataset.code;
        }
      });
    });

    function loadItemsSuggestionsOrder() {
      const itemsRef = ref(database, 'items');
      get(itemsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('itemSuggestionsOrder');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(item => {
            let option = document.createElement("option");
            option.value = item.itemName;
            option.dataset.code = item.itemCode;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الأصناف:", err));
    }

    function loadSuppliersSuggestionsOrser() {
      const resourcesRef = ref(database, 'resources');
      get(resourcesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('resourceSuggestionsOrder');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(resource => {
            let option = document.createElement("option");
            option.value = resource.name;
            option.dataset.code = resource.code;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الموردين:", err));
    }

    window.fetchResourceDetailsOrder = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('supplierCodeOrder').value.trim()
        : document.getElementById('SupplierNameOrder').value.trim();

      if (!searchValue) {
        return;
      }

      const resourcesRef = ref(database, 'resources');

      get(resourcesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const resourcesData = snapshot.val();
          let foundResource = null;
          let matchingResources = [];

          for (const key in resourcesData) {
            if (resourcesData.hasOwnProperty(key)) {
              const resource = resourcesData[key];

              if (type === 'code' && resource.code.toString() === searchValue) {
                foundResource = resource;
                break;
              }
              else if (type === 'name') {
                if (resource.name.toLowerCase() === searchValue.toLowerCase()) {
                  foundResource = resource; // تطابق دقيق
                  break;
                } else if (resource.name.toLowerCase().includes(searchValue.toLowerCase())) {
                  matchingResources.push({ name: resource.name, code: resource.code });
                }
              }
            }
          }

          if (foundResource) {
            document.getElementById('supplierCodeOrder').value = foundResource.code;
            document.getElementById('SupplierNameOrder').value = foundResource.name;
          } else if (type === 'code') {
            alert("⚠️ المورد غير موجود.");
          } else if (type === 'name') {
            let dataList = document.getElementById('resourceSuggestionsOrder');
            dataList.innerHTML = "";

            matchingResources.forEach(resource => {
              let option = document.createElement("option");
              option.value = resource.name;
              option.dataset.code = resource.code;
              dataList.appendChild(option);
            });
          }
        }
      }).catch((error) => {
        console.error("❌ خطأ أثناء جلب بيانات المورد:", error);
      });
    };

    document.getElementById('SupplierNameOrder').addEventListener('input', function () {
      let selectedName = this.value;
      let options = document.querySelectorAll('#resourceSuggestionsOrder option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('supplierCodeOrder').value = option.dataset.code;
        }
      });
    });

    window.onload = function () {
      loadItemsSuggestionsOrder();
      loadSuppliersSuggestionsOrser();
    };

    window.addItemToPurchase = function () {
      const itemCode = document.getElementById('itemCodeOrder').value.trim();
      const itemName = document.getElementById('itemNameOrder').value.trim();
      const itemQuantity = document.getElementById('purchaseItemQuantity').value.trim();
      const unitPrice = document.getElementById('purchaseItemUnitPrice').value.trim();
      const itemNotes = document.getElementById('purchaseItemNotes').value.trim();

      if (!itemCode || !itemName || !itemQuantity || !unitPrice) {
        alert("يرجى إدخال جميع بيانات الصنف.");
        return;
      }

      if (isNaN(itemQuantity) || parseFloat(itemQuantity) <= 0) {
        alert("⚠️ يرجى إدخال كمية صحيحة.");
        return;
      }

      if (isNaN(unitPrice) || parseFloat(unitPrice) <= 0) {
        alert("⚠️ يرجى إدخال سعر وحدة صحيح.");
        return;
      }

      const existingItem = addedItemsPurchase.find(item => item.itemCode === itemCode);
      if (existingItem) {
        existingItem.itemQuantity = parseFloat(existingItem.itemQuantity) + parseFloat(itemQuantity);
        existingItem.unitPrice = parseFloat(unitPrice);
        existingItem.totalPrice = existingItem.itemQuantity * existingItem.unitPrice;
        existingItem.itemNotes = itemNotes;
      } else {
        addedItemsPurchase.push({
          itemCode,
          itemName,
          itemQuantity: parseFloat(itemQuantity),
          unitPrice: parseFloat(unitPrice),
          totalPrice: parseFloat(itemQuantity) * parseFloat(unitPrice),
          itemNotes
        });
      }

      updateItemsTablePurchase();

      document.getElementById('itemCodeOrder').value = '';
      document.getElementById('itemNameOrder').value = '';
      document.getElementById('purchaseItemQuantity').value = '';
      document.getElementById('purchaseItemUnitPrice').value = '';
      document.getElementById('purchaseItemNotes').value = '';
    };

    function updateItemsTablePurchase() {
      const tableBody = document.getElementById('purchaseItemsTable');
      tableBody.innerHTML = "";

      if (addedItemsPurchase.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7">لا توجد أصناف مضافة</td></tr>';
        return;
      }

      addedItemsPurchase.forEach((item, index) => {
        const row = `<tr>
            <td>${item.itemCode}</td>
            <td>${item.itemName}</td>
            <td>${item.itemQuantity}</td>
            <td>${item.unitPrice.toFixed(2)}</td>
            <td>${item.totalPrice.toFixed(2)}</td>
            <td>${item.itemNotes || ''}</td>
            <td><button onclick="removeItemPurchase(${index})">❌ حذف</button></td>
        </tr>`;
        tableBody.innerHTML += row;
      });
    }

    window.removeItemPurchase = function (index) {
      addedItemsPurchase.splice(index, 1);
      updateItemsTablePurchase();
    };

    window.postToAddition = async function () {
      const additionDate = document.getElementById('purchaseDateOrder').value.trim();
      const location = document.getElementById('purchaseLocationOrder').value.trim();
      const reason = document.getElementById('purchaseReasonOrder').value.trim();
      const requester = document.getElementById('purchaseRequesterOrder').value.trim();
      const notes = document.getElementById('purchaseNotesOrder').value.trim();
      const supplier = document.getElementById('SupplierNameOrder2').value.trim();
      const purchaseId = document.getElementById('documentNumberOrder').value.trim();
      const supplierCode = document.getElementById('supplierCodeOrder2').value.trim();
      const companyCode = document.getElementById("purchaseCompanySelectOrder").value;
      const companyName = document.getElementById("purchaseCompanySelectOrder").selectedOptions[0]?.textContent || "";

      if (!additionDate || !location || !reason || !requester) {
        alert("❗ يرجى تعبئة جميع الحقول وإضافة أصناف.");
        return;
      }

      if (addedItemsPurchase.length === 0) {
        alert("❗لا يمكن الترحيل بدون أصناف.");
        return;
      }

      try {
        const deliveryRef = ref(database, `purchaseOrders/${purchaseId}`);
        const deliverySnap = await get(deliveryRef);

        let existingDisbNum = null;

        if (deliverySnap.exists()) {
          const orderData = deliverySnap.val();

          if (orderData.deleted === true) {
            alert("❌ لا يمكن ترحيل الطلب لأنه تم حذفه.");
            return;
          }

          if (orderData.migrated === true) {
            alert("❗تم ترحيل هذا الطلب مسبقًا ولا يمكن ترحيله مرة أخرى.");
            return;
          }

          if (orderData.disbursementDocNumber) {
            existingDisbNum = orderData.disbursementDocNumber;
          }
        }

        const docCounterRef = ref(database, 'documentNumberAddition');
        const counterSnap = await get(docCounterRef);

        let newAdditionNumber = existingDisbNum || (counterSnap.exists() ? counterSnap.val() + 1 : 1);

        const additionsSnapshot = await get(ref(database, 'documentsAddition'));
        let lastPrices = {};
        let stock = {};

        if (additionsSnapshot.exists()) {
          additionsSnapshot.forEach(doc => {
            const docData = doc.val();
            if (docData.deleted === true) return;

            const docNumber = parseInt(docData.documentNumberAddition) || 0;
            const items = Array.isArray(docData.items) ? docData.items : Object.values(docData.items);

            items.forEach(item => {
              const code = item.itemCode;
              const price = parseFloat(item.price) || 0;
              const qty = parseFloat(item.quantity) || 0;

              if (!lastPrices[code] || docNumber > lastPrices[code].docNumber) {
                lastPrices[code] = { price, docNumber };
              }

              stock[code] = (stock[code] || 0) + qty;
            });
          });
        }

        for (let item of addedItemsPurchase) {
          const code = item.itemCode;
          const requestedQty = parseFloat(item.quantity) || 0;
          const availableQty = stock[code] || 0;

          if (requestedQty > availableQty) {
            alert(`❌ الكمية المطلوبة للصنف ${item.itemName} (${code}) هي ${requestedQty}، بينما الكمية المتوفرة ${availableQty}. لا يمكن الترحيل.`);
            return;
          }
        }

        const OrderData = {
          documentNumberOrder: purchaseId,
          purchaseDate: additionDate,
          locationPurchase: location,
          purchaseReason: reason,
          purchaseRequester: requester,
          SupplierNameOrder: supplier,
          supplierCodeOrder: supplierCode,
          supplierId: supplierCode,
          items: addedItemsPurchase,
          disbursementDocNumber: newAdditionNumber,
          migrated: true,
          deleted: false,
          company: {
            code: companyCode,
            name: companyName
          }
        };

        await set(deliveryRef, OrderData);

        let totalSum = 0;
        const additionItems = addedItemsPurchase.map(item => {
          const quantity = parseFloat(item.itemQuantity) || 0;
          let price = parseFloat(item.unitPrice);
          if (isNaN(price) || price === 0) {
            price = lastPrices[item.itemCode]?.price || 0;
          }
          const itemTotal = quantity * price;
          totalSum += itemTotal;
          return {
            itemCode: item.itemCode,
            itemName: item.itemName,
            quantity,
            price,
            itemTotal,
            notes: item.itemNotes || ''
          };
        });

        const additionDoc = {
          documentNumberAddition: newAdditionNumber,
          documentDateAddition: additionDate,
          locationAddition: location,
          supplierName: supplier,
          notesAddition: notes,
          reasonAddition: reason,
          requester: requester,
          items: additionItems,
          totalSum,
          company: {
            code: companyCode,
            name: companyName
          }
        };

        await set(ref(database, `documentsAddition/${newAdditionNumber}`), additionDoc);

        if (!existingDisbNum) {
          await set(docCounterRef, newAdditionNumber);
        }

        alert(`✅ تم ترحيل الطلب إلى إذن إضافة بنجاح! رقم الإذن: ${newAdditionNumber}`);

        document.getElementById('purchaseDateOrder').value = '';
        document.getElementById('purchaseLocationOrder').value = '';
        document.getElementById('purchaseReasonOrder').value = '';
        document.getElementById('purchaseRequesterOrder').value = '';
        document.getElementById('purchaseNotesOrder').value = '';
        document.getElementById('SupplierNameOrder2').value = '';
        document.getElementById('supplierCodeOrder2').value = '';
        document.getElementById('purchaseCompanySelectOrder').value = '';

        addedItemsPurchase = [];
        updateItemsTablePurchase2();

      } catch (error) {
        console.error("❌ خطأ أثناء الترحيل:", error);
        alert("❌ حدث خطأ أثناء ترحيل إذن الإضافة.");
      }
    };

    window.updateOrder = async function () {
      const OrderEdit = localStorage.getItem('OrderEdit') === 'true';
      const dataId = document.getElementById("documentNumberOrder").getAttribute("data-id");

      if (dataId && !OrderEdit) return alert("❌ ليس لديك صلاحية تعديل البيانات.");

      const documentNumberOrder = document.getElementById('documentNumberOrder').value.trim();
      const purchaseDate = document.getElementById('purchaseDateOrder').value.trim();
      const notesPurchase = document.getElementById('purchaseNotesOrder').value.trim();
      const locationPurchase = document.getElementById('purchaseLocationOrder').value.trim();
      const purchaseReason = document.getElementById('purchaseReasonOrder').value.trim();
      const purchaseRequester = document.getElementById('purchaseRequesterOrder').value.trim();
      const SupplierNameOrder2 = document.getElementById('SupplierNameOrder2').value.trim();
      const supplierCodeOrder2 = document.getElementById('supplierCodeOrder2').value.trim();
      const companyCode = document.getElementById("purchaseCompanySelectOrder").value;
      const companyName = document.getElementById("purchaseCompanySelectOrder").selectedOptions[0]?.textContent || "";

      if (!documentNumberOrder) {
        alert("❗يرجى إدخال رقم المستند.");
        return;
      }

      if (!purchaseDate) {
        alert("❗يرجى إدخال التاريخ.");
        return;
      }

      if (addedItemsPurchase.length === 0) {
        alert("❗لا يمكن حفظ الطلب بدون أصناف.");
        return;
      }

      try {
        const docRef = ref(database, `purchaseOrders/${documentNumberOrder}`);
        const docSnap = await get(docRef);

        if (docSnap.exists()) {
          const existingData = docSnap.val();

          if (existingData.deleted === true) {
            alert("❌ لا يمكن تعديل هذا الطلب لأنه محذوف.");
            return;
          }

          if (existingData.migrated === true) {
            alert("❌ لا يمكن تعديل هذا الطلب لأنه مرحل.");
            return;
          }
        }

        const documentData = {
          documentNumberOrder: parseInt(documentNumberOrder),
          purchaseDate,
          notesPurchase,
          locationPurchase,
          purchaseReason,
          purchaseRequester,
          supplierCodeOrder2,
          SupplierNameOrder2,
          items: addedItemsPurchase,
          company: {
            code: companyCode,
            name: companyName
          },
          deleted: false,
          migrated: false
        };

        await set(docRef, documentData);

        alert("✅ تم تعديل وحفظ الطلب بنجاح!");
        showInvoice2(documentData);

        addedItemsPurchase = [];
        updateItemsTablePurchase2();

        clearOrderFormFields();

      } catch (err) {
        console.error("❌ خطأ أثناء التحديث:", err);
        alert("⚠️ حدث خطأ أثناء تحديث الطلب.");
      }
    };

    function clearOrderFormFields() {
      document.getElementById('documentNumberOrder').value = '';
      document.getElementById('purchaseDateOrder').value = '';
      document.getElementById('purchaseNotesOrder').value = '';
      document.getElementById('purchaseLocationOrder').value = '';
      document.getElementById('purchaseReasonOrder').value = '';
      document.getElementById('purchaseRequesterOrder').value = '';
      document.getElementById('SupplierNameOrder2').value = '';
      document.getElementById('supplierCodeOrder2').value = '';
    }

    function updateItemsTablePurchase2() {
      const tableBody = document.getElementById("purchaseItemsTable2");
      tableBody.innerHTML = "";

      if (addedItemsPurchase.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7">لا توجد أصناف مضافة</td></tr>`;
        return;
      }

      addedItemsPurchase.forEach((item, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${item.itemCode || ''}</td>
            <td>${item.itemName || ''}</td>
            <td>${item.itemQuantity || 0}</td>
            <td>${item.unitPrice || 0}</td>
            <td>${item.totalPrice || 0}</td>
            <td>${item.itemNotes || ''}</td>
            <td><button onclick="removePurchaseItem(${index})">❌ حذف </button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    window.removePurchaseItem = function (index) {
      addedItemsPurchase.splice(index, 1);
      updateItemsTablePurchase2();
    };

    window.fetchItemDetailsOrder2 = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('itemCodeOrder2').value.trim()
        : document.getElementById('itemNameOrder2').value.trim();

      if (!searchValue) return;

      const itemsRef = ref(database, 'items');
      get(itemsRef).then(snapshot => {
        if (snapshot.exists()) {
          const itemsData = snapshot.val();
          let foundItem = null;
          let matchingItems = [];

          for (const key in itemsData) {
            if (itemsData.hasOwnProperty(key)) {
              const item = itemsData[key];

              if (type === 'code' && item.itemCode.toString() === searchValue) {
                foundItem = item;
                break;
              } else if (type === 'name' && item.itemName.toLowerCase().includes(searchValue.toLowerCase())) {
                matchingItems.push({ name: item.itemName, code: item.itemCode });
              }
            }
          }

          if (type === 'code') {
            if (foundItem) {
              document.getElementById('itemCodeOrder2').value = foundItem.itemCode;
              document.getElementById('itemNameOrder2').value = foundItem.itemName;
            } else {
              alert("⚠️ الصنف غير موجود.");
            }
          } else if (type === 'name') {
            let dataList = document.getElementById('itemSuggestionsOrder2');
            dataList.innerHTML = "";
            matchingItems.forEach(item => {
              let option = document.createElement("option");
              option.value = item.name;
              option.dataset.code = item.code;
              dataList.appendChild(option);
            });
          }
        }
      }).catch(error => {
        console.error("❌ خطأ أثناء جلب بيانات الأصناف:", error);
      });
    };

    document.getElementById('itemNameOrder2').addEventListener('input', function () {
      let selectedName = this.value;
      let options = document.querySelectorAll('#itemSuggestionsOrder2 option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('itemCodeOrder2').value = option.dataset.code;
        }
      });
    });

    function loadItemsSuggestionsOrder2() {
      const itemsRef = ref(database, 'items');
      get(itemsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('itemSuggestionsOrder2');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(item => {
            let option = document.createElement("option");
            option.value = item.itemName;
            option.dataset.code = item.itemCode;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الأصناف:", err));
    }

    function loadSuppliersSuggestionsOrser2() {
      const resourcesRef = ref(database, 'resources');
      get(resourcesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('resourceSuggestionsOrder2');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(resource => {
            let option = document.createElement("option");
            option.value = resource.name;
            option.dataset.code = resource.code;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الموردين:", err));
    }

    window.fetchResourceDetailsOrder2 = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('supplierCodeOrder2').value.trim()
        : document.getElementById('SupplierNameOrder2').value.trim();

      if (!searchValue) {
        return;
      }

      const resourcesRef = ref(database, 'resources');

      get(resourcesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const resourcesData = snapshot.val();
          let foundResource = null;
          let matchingResources = [];

          for (const key in resourcesData) {
            if (resourcesData.hasOwnProperty(key)) {
              const resource = resourcesData[key];

              if (type === 'code' && resource.code.toString() === searchValue) {
                foundResource = resource;
                break;
              }
              else if (type === 'name') {
                if (resource.name.toLowerCase() === searchValue.toLowerCase()) {
                  foundResource = resource; // تطابق دقيق
                  break;
                } else if (resource.name.toLowerCase().includes(searchValue.toLowerCase())) {
                  matchingResources.push({ name: resource.name, code: resource.code });
                }
              }
            }
          }

          if (foundResource) {
            document.getElementById('supplierCodeOrder2').value = foundResource.code;
            document.getElementById('SupplierNameOrder2').value = foundResource.name;
          } else if (type === 'code') {
            alert("⚠️ المورد غير موجود.");
          } else if (type === 'name') {
            let dataList = document.getElementById('resourceSuggestionsOrder2');
            dataList.innerHTML = "";

            matchingResources.forEach(resource => {
              let option = document.createElement("option");
              option.value = resource.name;
              option.dataset.code = resource.code;
              dataList.appendChild(option);
            });
          }
        }
      }).catch((error) => {
        console.error("❌ خطأ أثناء جلب بيانات المورد:", error);
      });
    };

    document.getElementById('SupplierNameOrder2').addEventListener('input', function () {
      let selectedName = this.value;
      let options = document.querySelectorAll('#resourceSuggestionsOrder2 option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('supplierCodeOrder2').value = option.dataset.code;
        }
      });
    });

    window.onload = function () {
      loadItemsSuggestionsOrder2();
      loadSuppliersSuggestionsOrser2();
    };

    window.addItemToPurchase2 = function () {
      const itemCode = document.getElementById('itemCodeOrder2').value.trim();
      const itemName = document.getElementById('itemNameOrder2').value.trim();
      const itemQuantity = document.getElementById('purchaseItemQuantity2').value.trim();
      const unitPrice = document.getElementById('purchaseItemUnitPrice2').value.trim();
      const itemNotes = document.getElementById('purchaseItemNotes2').value.trim();

      if (!itemCode || !itemName || !itemQuantity || !unitPrice) {
        alert("يرجى إدخال جميع بيانات الصنف.");
        return;
      }

      if (isNaN(itemQuantity) || parseFloat(itemQuantity) <= 0) {
        alert("⚠️ يرجى إدخال كمية صحيحة.");
        return;
      }

      if (isNaN(unitPrice) || parseFloat(unitPrice) <= 0) {
        alert("⚠️ يرجى إدخال سعر وحدة صحيح.");
        return;
      }

      const existingItem = addedItemsPurchase.find(item => item.itemCode === itemCode);
      if (existingItem) {
        existingItem.itemQuantity = parseFloat(existingItem.itemQuantity) + parseFloat(itemQuantity);
        existingItem.unitPrice = parseFloat(unitPrice);
        existingItem.totalPrice = existingItem.itemQuantity * existingItem.unitPrice;
        existingItem.itemNotes = itemNotes;
      } else {
        addedItemsPurchase.push({
          itemCode,
          itemName,
          itemQuantity: parseFloat(itemQuantity),
          unitPrice: parseFloat(unitPrice),
          totalPrice: parseFloat(itemQuantity) * parseFloat(unitPrice),
          itemNotes
        });
      }

      updateItemsTablePurchase2();

      document.getElementById('itemCodeOrder2').value = '';
      document.getElementById('itemNameOrder2').value = '';
      document.getElementById('purchaseItemQuantity2').value = '';
      document.getElementById('purchaseItemUnitPrice2').value = '';
      document.getElementById('purchaseItemNotes2').value = '';
    };


    window.searchDataOrder = async function () {
      const OrderQuery = localStorage.getItem('OrderQuery') === 'true';
      const dataId = document.getElementById("queryDocNum").getAttribute("data-id");

      if (!dataId && !OrderQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }

      const queryDate = document.getElementById("queryDate").value.trim();
      const queryDocNum = document.getElementById("queryDocNum").value.trim();
      const queryLocation = document.getElementById("queryLocation").value.trim();
      const generalSearch = document.getElementById("generalSearchOrder").value.trim().toLowerCase();
      const queryItme = document.getElementById("queryItme").value.trim().toLowerCase();
      const filterItemCode = document.getElementById("filterItemOrder").value.trim();
      const filterSupplierId = document.getElementById("filterSupplierOrder").value.trim();
      const queryCompanyName = document.getElementById("queryCompanySelectOrder").value.trim().toLowerCase();

      const queryResultsOrder = document.getElementById("queryResultsOrder");
      queryResultsOrder.innerHTML = "⌛ جاري البحث...";

      try {
        const snap = await get(ref(database, "purchaseOrders"));
        if (!snap.exists()) {
          queryResultsOrder.innerHTML = "<tr><td colspan='11'>❌ لا توجد نتائج</td></tr>";
          return;
        }

        let allOrders = Object.entries(snap.val()).map(([key, val]) => ({
          id: key,
          ...val
        }));

        let filteredOrders = allOrders.filter(order => {
          return (
            (queryDocNum === "" ||
              (order.documentNumberOrder && order.documentNumberOrder.toString().includes(queryDocNum)))
            &&
            (queryDate === "" || (order.purchaseDate && order.purchaseDate === queryDate))
            &&
            (queryLocation === "" || (order.locationPurchase && order.locationPurchase.includes(queryLocation)))
            &&
            (filterSupplierId === "" || (order.supplierCodeOrder && order.supplierCodeOrder === filterSupplierId))
            &&
            (queryItme === "" || (order.items && order.items.some(item => item.itemName && item.itemName.toLowerCase().includes(queryItme))))
            &&
            (filterItemCode === "" || (order.items && order.items.some(item => item.itemCode && item.itemCode === filterItemCode)))
            &&
            (queryCompanyName === "" || (order.company && order.company.name.toLowerCase().includes(queryCompanyName)))
          );
        });

        if (generalSearch) {
          filteredOrders = filteredOrders.filter(order =>
            Object.values(order).some(val => String(val).toLowerCase().includes(generalSearch))
          );
        }

        filteredOrders.sort((a, b) =>
          (parseInt(a.documentNumberOrder) || 0) - (parseInt(b.documentNumberOrder) || 0)
        );

        if (filteredOrders.length === 0) {
          queryResultsOrder.innerHTML = "<tr><td colspan='11'>❌ لا توجد نتائج</td></tr>";
          return;
        }

        let rowsHtml = '';
        let totalGlobalSum = 0;
        let totalGlobalQuantity = 0;

        filteredOrders.forEach(order => {
          const isDeleted = !!order.deleted;
          let docTotal = 0;
          let docQuantity = 0;

          (order.items || []).forEach(item => {
            const qty = parseFloat(item.itemQuantity) || 0;
            const price = parseFloat(item.unitPrice) || 0;
            const sum = parseFloat(item.totalPrice) || qty * price;

            if (!isDeleted) {
              docTotal += sum;
              docQuantity += qty;
              totalGlobalSum += sum;
              totalGlobalQuantity += qty;
            }

            rowsHtml += `
          <tr style="${isDeleted ? 'background-color:#f8d7da;color:#721c24;' : ''}">
            <td ondblclick="showOrderInvoice(this)" data-order='${JSON.stringify(order).replace(/'/g, "&apos;")}'>
              ${order.documentNumberOrder}
            </td>
            <!-- استخدمنا الآن order.company.name بدل order.companyName -->
            <td>${order.company ? order.company.name : ''}</td>
            <td>${order.purchaseDate || ''}</td>
            <td>${order.locationPurchase || ''}</td>
            <td>${order.purchaseRequester || ''}</td>
            <td>${order.purchaseReason || ''}</td>
            <td>${order.SupplierNameOrder || ''} (${order.supplierCodeOrder || ''})</td>
            <td>${item.itemName || ''} (${item.itemCode || ''})</td>
            <td>${qty}</td>
            <td>${price.toFixed(2)}</td>
            <td>${sum.toFixed(2)}</td>
          </tr>
        `;
          });

          rowsHtml += `
        <tr style="font-weight:bold;background-color:${isDeleted ? '#f8d7da' : '#f1f1f1'};">
          <td colspan="8" style="text-align:right;">
            إجمالي المستند رقم ${order.documentNumberOrder}${isDeleted ? ' (محذوف)' : ''}:
          </td>
          <td>${isDeleted ? '-' : docQuantity}</td>
          <td></td>
          <td colspan="2">${isDeleted ? '-' : docTotal.toFixed(2)}</td>
        </tr>
      `;
        });

        queryResultsOrder.innerHTML = `
      <table border="1" style="width:100%;border-collapse:collapse;text-align:center;">
        <thead style="background-color:#f2f2f2;">
          <tr>
            <th>رقم المستند</th>
            <th>اسم الشركة</th>
            <th>التاريخ</th>
            <th>الموقع</th>
            <th>مقدم الطلب</th>
            <th>السبب</th>
            <th>المورد (الكود)</th>
            <th>العنصر (الكود)</th>
            <th>الكمية</th>
            <th>السعر</th>
            <th>الإجمالي</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
        <tfoot>
          <tr style="font-weight:bold;background-color:#dff0d8;">
            <td colspan="8" style="text-align:right;">الإجمالي الكلي لكل المستندات:</td>
            <td>${totalGlobalQuantity}</td>
            <td></td>
            <td colspan="2">${totalGlobalSum.toFixed(2)}</td>
          </tr>
        </tfoot>
      </table>
    `;

      } catch (err) {
        console.error("❌ خطأ أثناء البحث:", err);
        queryResultsOrder.innerHTML = "<tr><td colspan='11'>⚠️ حدث خطأ أثناء تحميل البيانات</td></tr>";
      }
    };


    window.showOrderInvoice = function (tdElement) {
      try {
        const rawData = tdElement
          .getAttribute("data-order").replace(/&apos;/g, "'");
        const order = JSON.parse(rawData);
        const invoiceData = {
          siteLocation: order.locationPurchase || '',
          documentNumber: order.documentNumberOrder || '',
          approvalDate: order.purchaseDate || '',
          reason: order.purchaseReason || '',
          requestBy: order.purchaseRequester || '',
          SupplierNameOrder: order.SupplierNameOrder || '',
          orders: (order.items || []).map(item => ({
            itemName: item.itemName || '',
            quantity: parseFloat(item.itemQuantity) || 0,
            unitPrice: parseFloat(item.unitPrice) || 0,
            totalPrice: parseFloat(item.totalPrice) || 0,
            notes: item.itemNotes || ''
          })),
          company: {
            code: order.company?.code || '',
            name: order.company?.name || ''
          }
        };
        showInvoice(invoiceData);
      } catch (err) {
        console.error("❌ حدث خطأ أثناء عرض الفاتورة:", err);
        alert("⚠️ لا يمكن عرض الفاتورة حاليًا.");
      }
    };

    async function loadItemsToSelect() {
      const itemsRef = ref(database, 'items');
      try {
        const snapshot = await get(itemsRef);
        const select = document.getElementById('filterItemOrder');
        select.innerHTML = '<option value="">- اختر الصنف -</option>';

        if (snapshot.exists()) {
          const items = snapshot.val();

          Object.values(items).forEach(item => {
            const option = document.createElement('option');
            option.value = item.itemCode;
            option.textContent = `${item.itemName} - ${item.itemCode}`;
            select.appendChild(option);
          });
        } else {
          console.warn("⚠️ لا توجد أصناف في قاعدة البيانات.");
        }
      } catch (error) {
        console.error("❌ خطأ أثناء تحميل الأصناف:", error);
      }
    }
    window.loadSuppliersToDropdown = async function () {
      const suppliersRef = ref(database, 'resources');
      const dropdown = document.getElementById('filterSupplierOrder');

      try {
        const snapshot = await get(suppliersRef);

        if (snapshot.exists()) {
          const data = snapshot.val();

          dropdown.innerHTML = '<option value="">- اختر المورد -</option>';

          Object.keys(data).forEach((key) => {
            const supplier = data[key];
            const option = document.createElement('option');
            option.value = supplier.id;
            option.textContent = supplier.name;
            dropdown.appendChild(option);
          });
        } else {
          console.log("لا توجد بيانات موردين.");
        }
      } catch (error) {
        console.error("❌ خطأ أثناء تحميل الموردين:", error);
        alert("❌ حدث خطأ أثناء تحميل الموردين");
      }
    };

    window.addEventListener("DOMContentLoaded", () => {
      loadItemsToSelect();
      loadSuppliersToDropdown();

    });

    window.printTableOrder = function () {
      const resultsContainer = document.getElementById("queryResultsOrder");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة الأجهزة</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelOeder = function () {
      const table = document.querySelector("#queryResultsOrder table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "order Data" });
      XLSX.writeFile(workbook, "order_Data.xlsx");
    };

    window.showInvoice = async function (orderData) {
      try {
        const settingsRef = ref(
          database,
          `companySettings/${orderData.company.code}`
        );
        const snapshot = await get(settingsRef);

        if (!snapshot.exists()) {
          alert("❌ إعدادات الشركة غير موجودة");
          return;
        }

        const settings = snapshot.val();

        const template = `
        <div id="invoiceBody"
             style="font-family:'Arial',sans-serif;direction:rtl;padding:40px;position:relative;background:#fff;border:1px solid #ccc;">
          
          <!-- العلامة المائية -->
          <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-50deg);
            opacity:0.05;font-size:100px;font-weight:bold;color:#000;white-space:nowrap;">
            ${settings.watermark}
          </div>

          <!-- رأس الفاتورة -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div style="text-align:left;line-height:1.6;">
              <div style="font-weight:bold;font-size:18px;">${settings.name}</div>
              <div style="font-size:14px;">${settings.address}</div>
              <div style="font-size:14px;">${settings.phone}</div>
              <div style="font-size:14px;">${settings.email}</div>
            </div>
            <div style="text-align:center;margin-top:20px;">
              <canvas id="qrcanvas"></canvas>
              <p style="font-size:10px;color:#555;margin-top:3px;">QR Code for Invoice</p>
            </div>
            <img src="${settings.logoUrl}" alt="Company Logo" style="height:100px;">
          </div>

          <h2 style="text-align:center;background:#4caf50;color:#fff;padding:10px 0;margin-top:20px;">
            فاتورة شراء – Purchase Invoice
          </h2>

          <!-- بيانات الفاتورة -->
          <div style="display:flex;justify-content:space-between;margin-top:20px;font-size:15px;">
            <div>
              <div><strong>رقم المستند:</strong> ${orderData.documentNumber}</div>
              <div><strong>التاريخ:</strong> ${orderData.approvalDate}</div>
              <div><strong>السبب:</strong> ${orderData.reason}</div>
            </div>
            <div style="text-align:left;">
              <div><strong>الموقع:</strong> ${orderData.siteLocation}</div>
              <div><strong>بطلب من:</strong> ${orderData.requestBy}</div>
              <div><strong>المورد:</strong> ${orderData.SupplierNameOrder}</div>
            </div>
          </div>

          <!-- جدول المشتريات -->
          <table style="width:100%;border-collapse:collapse;margin-top:25px;font-size:14px;">
            <thead>
              <tr style="background:#eee;border-bottom:2px solid #000;">
                <th style="padding:6px;">م / No.</th>
                <th>البيان / Description</th>
                <th>الكمية / Qty</th>
                <th>السعر / Unit Price</th>
                <th>الإجمالي / Total</th>
                <th>ملاحظات / Notes</th>
              </tr>
            </thead>
            <tbody>
              ${orderData.orders.map((it, i) => `
                <tr style="border-bottom:1px solid #ccc;">
                  <td style="text-align:center;padding:5px;">${i + 1}</td>
                  <td style="text-align:center;padding:5px;">${it.itemName}</td>
                  <td style="text-align:center;padding:5px;">${it.quantity}</td>
                  <td style="text-align:center;padding:5px;">${it.unitPrice.toFixed(2)}</td>
                  <td style="text-align:center;padding:5px;">${it.totalPrice.toFixed(2)}</td>
                  <td style="text-align:center;padding:5px;">${it.notes || ''}</td>
                </tr>
              `).join('')}
              <tr style="background:#d0f0d0;font-weight:bold;">
                <td colspan="2" style="text-align:right;padding:8px;">الإجمالي:</td>
                <td style="text-align:center;padding:5px;">
                  ${orderData.orders.reduce((s, o) => s + o.quantity, 0).toFixed(2)}
                </td>
                <td style="text-align:center;padding:5px;">—</td>
                <td style="text-align:center;padding:5px;">
                  ${orderData.orders.reduce((s, o) => s + o.totalPrice, 0).toFixed(2)}
                </td>
                <td></td>
              </tr>
            </tbody>
          </table>

          <!-- التواقيع -->
          <div style="display:flex;justify-content:space-between;margin-top:50px;
                      border-top:1px solid #ccc;padding-top:30px;">
            <div style="width:30%;text-align:center;">
              <p>مدير الموقع</p>
              <div style="height:60px;border-bottom:1px solid #aaa;margin:10px auto;width:80%;"></div>
              <p style="font-size:12px;color:#555;">Site Manager Signature</p>
            </div>
            <div style="width:30%;text-align:center;">
              <p>مدير تقنية المعلومات</p>
              <div style="height:60px;border-bottom:1px solid #aaa;margin:10px auto;width:80%;"></div>
              <p style="font-size:12px;color:#555;">IT Manager Signature</p>
            </div>
            <div style="width:30%;text-align:center;">
              <p>المدير العام</p>
              <div style="height:60px;border-bottom:1px solid #aaa;margin:10px auto;width:80%;"></div>
              <p style="font-size:12px;color:#555;">General Manager Signature</p>
            </div>
          </div>
        </div>
      `;
        const w = window.open("", "_blank");
        w.document.write(template);
        w.document.close();

        w.onload = () => {
          QRCode.toCanvas(
            w.document.getElementById('qrcanvas'),
            JSON.stringify({
              doc: orderData.documentNumber,
              total: orderData.orders.reduce((s, o) => s + o.totalPrice, 0)
            }),
            { width: 100 }
          );
        };

      } catch (error) {
        console.error("❌ فشل في تحميل إعدادات الشركة:", error);
        alert("❌ حدث خطأ أثناء تحميل إعدادات الشركة للفاتورة");
      }
    };

    window.showInvoice2 = async function (orderData) {
      try {
        const settingsRef = ref(
          database,
          `companySettings/${orderData.company.code}`
        );
        const snapshot = await get(settingsRef);

        if (!snapshot.exists()) {
          alert("❌ إعدادات الشركة غير موجودة");
          return;
        }

        const settings = snapshot.val();

        const totalQty = orderData.items.reduce((s, o) => s + parseFloat(o.itemQuantity || 0), 0);
        const totalSum = orderData.items.reduce((s, o) => s + parseFloat(o.itemQuantity || 0) * parseFloat(o.unitPrice || 0), 0);

        const template = `
      <div id="invoiceBody" style="font-family: 'Arial', sans-serif; direction: rtl; padding:40px; background:#fff; border:1px solid #ccc; position:relative;">
        
        <!-- العلامة المائية -->
        <div style="position:absolute; top:45%; left:50%; transform:translate(-50%,-50%) rotate(-30deg); opacity:0.03; font-size:100px; font-weight:bold; color:#000;">
          ${settings.watermark || ''}
        </div>

        <!-- الرأس -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div style="text-align:left; line-height:1.6;">
            <div style="font-weight:bold; font-size:18px;">company: ${settings.name}</div>
            <div style="font-size:14px;">address: ${settings.address}</div>
            <div style="font-size:14px;">Phone: ${settings.phone}</div>
            <div style="font-size:14px;">Email: ${settings.email}</div>
          </div>
          <img src="${settings.logoUrl}" alt="Logo" style="height:100px;">
        </div>

        <!-- العنوان -->
        <h2 style="text-align:center; background:#4caf50; color:#fff; padding:12px 0;">
          فاتورة شراء – Purchase Invoice
        </h2>

        <!-- معلومات الفاتورة -->
        <div style="display:flex; justify-content:space-between; font-size:15px; margin-top:20px;">
          <div>
            <div><strong>رقم المستند:</strong> ${orderData.documentNumberOrder}</div>
            <div><strong>التاريخ:</strong> ${orderData.purchaseDate}</div>
            <div><strong>السبب:</strong> ${orderData.purchaseReason}</div>
          </div>
          <div style="text-align:left;">
            <div><strong>الموقع:</strong> ${orderData.locationPurchase}</div>
            <div><strong>بطلب من:</strong> ${orderData.purchaseRequester}</div>
            <div><strong>المورد:</strong> ${orderData.SupplierNameOrder2}</div>
          </div>
        </div>

        <!-- جدول العناصر -->
        <table style="width:100%; border-collapse:collapse; margin-top:25px; font-size:14px;">
          <thead>
            <tr style="background:#eee; border-bottom:2px solid #000;">
              <th>م</th>
              <th>البيان</th>
              <th>الكمية</th>
              <th>سعر الوحدة</th>
              <th>الإجمالي</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody>
            ${orderData.items.map((it, i) => `
              <tr style="border-bottom:1px solid #ccc;">
                <td style="text-align:center;">${i + 1}</td>
                <td style="text-align:center;">${it.itemName}</td>
                <td style="text-align:center;">${parseFloat(it.itemQuantity || 0).toFixed(2)}</td>
                <td style="text-align:center;">${parseFloat(it.unitPrice || 0).toFixed(2)}</td>
                <td style="text-align:center;">${(parseFloat(it.itemQuantity || 0) * parseFloat(it.unitPrice || 0)).toFixed(2)}</td>
                <td style="text-align:center;">${it.itemNotes || ''}</td>
              </tr>
            `).join('')}
            <tr style="background:#d0f0d0; font-weight:bold;">
              <td colspan="2" style="text-align:right;">الإجمالي:</td>
              <td style="text-align:center;">${totalQty.toFixed(2)}</td>
              <td></td>
              <td style="text-align:center;">${totalSum.toFixed(2)}</td>
              <td></td>
            </tr>
          </tbody>
        </table>

        <!-- التواقيع -->
        <div style="display:flex; justify-content:space-between; margin-top:50px; border-top:1px solid #ccc; padding-top:30px;">
          <div style="width:30%; text-align:center;">
            <p>مدير الموقع</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
          </div>
          <div style="width:30%; text-align:center;">
            <p>مدير تقنية المعلومات</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
          </div>
          <div style="width:30%; text-align:center;">
            <p>المدير العام</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
          </div>
        </div>
      </div>
    `;

        const w = window.open('', '_blank');
        w.document.write(template);
        w.document.close();

      } catch (error) {
        console.error('❌ خطأ أثناء طباعة الفاتورة:', error);
        alert('❌ فشل في تحميل بيانات الشركة.');
      }
    };

    ////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////// موفقه التسليم ////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////
    function loadCompaniesIntoSelectDeliver() {
      const companySelect = document.getElementById("CompanySelectDelivery");
      const purchaseCompanySelect = document.getElementById("CompanySelectDelivery2");
      const queryCompanySelect = document.getElementById("queryCompanySelectDelivery");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeDelivery");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (purchaseCompanySelect) purchaseCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
          if (purchaseCompanySelect) {
            const option3 = document.createElement("option");
            option3.value = company.code;
            option3.textContent = company.name;
            purchaseCompanySelect.appendChild(option3);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectDeliver);

    let addedItemsDelivery = [];
    window.savedelivery = async function () {
      const DeliverySave = localStorage.getItem('DeliverySave') === 'true';
      if (!DeliverySave) {
        alert("❌ ليس لديك صلاحية حفظ البيانات.");
        return;
      }

      const approvalDate = document.getElementById('approvalDateDelivery').value.trim();
      const location = document.getElementById('LocationDelivery').value.trim();
      const reason = document.getElementById('reasonDelivery').value.trim();
      const requester = document.getElementById('requestDelivery').value.trim();
      const companyCode = document.getElementById("CompanySelectDelivery").value;
      const companyName = document.getElementById("CompanySelectDelivery").selectedOptions[0]?.textContent || "";

      if (!approvalDate || !location || !reason || !requester) {
        alert("❌ يرجى تعبئة جميع الحقول.");
        return;
      }

      if (addedItemsDelivery.length === 0) {
        alert("❌ لا يمكن الحفظ بدون أصناف.");
        return;
      }

      try {
        const docCounterRef = ref(database, 'documentNumberDelivery');
        const snapshot = await get(docCounterRef);
        let documentNumberDelivery = 1;

        if (snapshot.exists()) {
          documentNumberDelivery = snapshot.val() + 1;
        }

        const deliveryData = {
          documentNumberDelivery,
          approvalDate,
          location,
          reason,
          requester,
          items: addedItemsDelivery,
          company: {
            code: companyCode,
            name: companyName
          }
        };

        const deliveryRef = ref(database, `deliveryRequests/${documentNumberDelivery}`);
        await set(deliveryRef, deliveryData);
        await set(docCounterRef, documentNumberDelivery);

        alert("✅ تم حفظ طلب التسليم بنجاح!");
        showDeliveryApproval(deliveryData);

        document.getElementById('approvalDateDelivery').value = '';
        document.getElementById('LocationDelivery').value = '';
        document.getElementById('reasonDelivery').value = '';
        document.getElementById('requestDelivery').value = '';
        document.getElementById('CompanySelectDelivery').value = '';

        addedItemsDelivery = [];
        updateItemsTableDelivery();
        clearDeliveryInputs();


      } catch (error) {
        console.error("❌ خطأ أثناء الحفظ:", error);
        alert("❌ حدث خطأ أثناء حفظ البيانات.");
      }
    };

    function clearDeliveryInputs() {
      document.getElementById('approvalDateDelivery').value = '';
      document.getElementById('LocationDelivery').value = '';
      document.getElementById('reasonDelivery').value = '';
      document.getElementById('requestDelivery').value = '';
      document.getElementById('ItemCodeDelivery').value = '';
      document.getElementById('ItemNameDelivery').value = '';
      document.getElementById('newQuantityDelivery').value = '';
      document.getElementById('newBeneficiary').value = '';
      document.getElementById('newNotesDelivery').value = '';
    }

    window.removeDeliveryItem = function (index) {
      addedItemsDelivery.splice(index, 1);
      updateItemsTableDelivery();
      clearDeliveryInputs();

    };

    function updateItemsTableDelivery() {
      const tbody = document.getElementById('deliveryItemsBody');
      tbody.innerHTML = '';

      if (addedItemsDelivery.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">لا توجد أصناف مضافة</td></tr>';
        return;
      }

      addedItemsDelivery.forEach((item, index) => {
        const row = `
            <tr>
                <td>${item.itemCode}</td>
                <td>${item.itemName}</td>
                <td>${item.quantity}</td>
                <td>${item.beneficiary}</td>
                <td>${item.notes || ''}</td>
                <td><button onclick="removeDeliveryItem(${index})">❌</button></td>
            </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    window.addRowDelivery = function () {
      const itemCode = document.getElementById('ItemCodeDelivery').value.trim();
      const itemName = document.getElementById('ItemNameDelivery').value.trim();
      const quantity = document.getElementById('newQuantityDelivery').value.trim();
      const beneficiary = document.getElementById('newBeneficiary').value.trim();
      const notes = document.getElementById('newNotesDelivery').value.trim();

      if (!itemCode || !itemName || !quantity || !beneficiary) {
        alert("يرجى إدخال جميع بيانات الصنف.");
        return;
      }

      if (isNaN(quantity) || parseFloat(quantity) <= 0) {
        alert("⚠️ يرجى إدخال كمية صحيحة.");
        return;
      }

      addedItemsDelivery.push({
        itemCode,
        itemName,
        quantity: parseFloat(quantity),
        beneficiary,
        notes
      });

      updateItemsTableDelivery();

      document.getElementById('ItemCodeDelivery').value = '';
      document.getElementById('ItemNameDelivery').value = '';
      document.getElementById('newQuantityDelivery').value = '';
      document.getElementById('newBeneficiary').value = '';
      document.getElementById('newNotesDelivery').value = '';
    };

    function loadItemsSuggestionsDelivery() {
      const itemsRef = ref(database, 'items');
      get(itemsRef).then(snapshot => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('itemSuggestionsDelivery');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(item => {
            const option = document.createElement("option");
            option.value = item.itemName;
            option.dataset.code = item.itemCode;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الأصناف:", err));
    }

    document.getElementById('ItemNameDelivery').addEventListener('input', function () {
      const selectedName = this.value;
      const options = document.querySelectorAll('#itemSuggestionsDelivery option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('ItemCodeDelivery').value = option.dataset.code;
        }
      });
    });

    window.fetchItemDetailsDelivery = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('ItemCodeDelivery').value.trim()
        : document.getElementById('ItemNameDelivery').value.trim();

      if (!searchValue) return;

      const itemsRef = ref(database, 'items');
      get(itemsRef).then(snapshot => {
        if (snapshot.exists()) {
          const itemsData = snapshot.val();
          let foundItem = null;
          let matchingItems = [];

          for (const key in itemsData) {
            const item = itemsData[key];

            if (type === 'code' && item.itemCode.toString() === searchValue) {
              foundItem = item;
              break;
            } else if (type === 'name' && item.itemName.toLowerCase().includes(searchValue.toLowerCase())) {
              matchingItems.push({ name: item.itemName, code: item.itemCode });
            }
          }

          if (type === 'code') {
            if (foundItem) {
              document.getElementById('ItemCodeDelivery').value = foundItem.itemCode;
              document.getElementById('ItemNameDelivery').value = foundItem.itemName;
            } else {
              alert("⚠️ الصنف غير موجود.");
            }
          } else if (type === 'name') {
            const dataList = document.getElementById('itemSuggestionsDelivery');
            dataList.innerHTML = "";
            matchingItems.forEach(item => {
              let option = document.createElement("option");
              option.value = item.name;
              option.dataset.code = item.code;
              dataList.appendChild(option);
            });
          }
        }
      }).catch(error => {
        console.error("❌ خطأ أثناء جلب بيانات الأصناف:", error);
      });
    };

    window.updateDelivery = async function () {
      const DeliveryEdit = localStorage.getItem('DeliveryEdit') === 'true';
      const dataId = document.getElementById("documentNumberDelivery").getAttribute("data-id");

      if (dataId && !DeliveryEdit) return alert("❌ ليس لديك صلاحية تعديل البيانات.");

      const documentNumber = document.getElementById('documentNumberDelivery').value.trim();
      const approvalDate = document.getElementById('approvalDateDelivery2').value.trim();
      const location = document.getElementById('LocationDelivery2').value.trim();
      const reason = document.getElementById('reasonDelivery2').value.trim();
      const requester = document.getElementById('requestDelivery2').value.trim();
      const companyCode = document.getElementById("CompanySelectDelivery2").value;
      const companyName = document.getElementById("CompanySelectDelivery2").selectedOptions[0]?.textContent || "";


      if (!documentNumber) {
        alert("❗يرجى إدخال رقم المستند.");
        return;
      }

      if (!approvalDate || !location || !reason || !requester) {
        alert("❗يرجى تعبئة جميع الحقول.");
        return;
      }

      if (addedItemsDelivery.length === 0) {
        alert("❗لا يمكن الحفظ بدون أصناف.");
        return;
      }

      try {
        const docRef = ref(database, `deliveryRequests/${documentNumber}`);
        const docSnap = await get(docRef);

        if (docSnap.exists()) {
          const existingData = docSnap.val();

          if (existingData.deleted === true) {
            alert("❌ لا يمكن تعديل هذا الطلب لأنه محذوف.");
            return;
          }

          if (existingData.migrated === true) {
            alert("❌ لا يمكن تعديل هذا الطلب لأنه مرحّل.");
            return;
          }
        }

        const documentData = {
          documentNumberDelivery: parseInt(documentNumber),
          approvalDate,
          location,
          reason,
          requester,
          items: addedItemsDelivery,
          deleted: false,
          migrated: false,
          company: {
            code: companyCode,
            name: companyName
          },
        };

        await set(docRef, documentData);

        alert("✅ تم تعديل طلب التسليم بنجاح!");
        showDeliveryApproval(documentData);

        addedItemsDelivery = [];
        updateItemsTableDelivery2();
        clearDeliveryFormFields();


      } catch (err) {
        console.error("❌ خطأ أثناء تعديل التسليم:", err);
        alert("⚠️ حدث خطأ أثناء تعديل التسليم.");
      }
    };

    function clearDeliveryFormFields() {
      document.getElementById('documentNumberDelivery').value = '';
      document.getElementById('approvalDateDelivery2').value = '';
      document.getElementById('LocationDelivery2').value = '';
      document.getElementById('reasonDelivery2').value = '';
      document.getElementById('requestDelivery2').value = '';

      const tableBody = document.getElementById("deliveryItemsTable");
      tableBody.innerHTML = '<tr><td colspan="6">لا توجد أصناف مضافة</td></tr>';
    }

    window.removeDeliveryItem2 = function (index) {
      addedItemsDelivery.splice(index, 1);
      updateItemsTableDelivery2();
    };

    window.postToDisbursement = async function () {
      const documentNumber = document.getElementById('documentNumberDelivery').value.trim();
      const approvalDate = document.getElementById('approvalDateDelivery2').value.trim();
      const location = document.getElementById('LocationDelivery2').value.trim();
      const reason = document.getElementById('reasonDelivery2').value.trim();
      const requester = document.getElementById('requestDelivery2').value.trim();
      const companyCode = document.getElementById("CompanySelectDelivery2").value;
      const companyName = document.getElementById("CompanySelectDelivery2").selectedOptions[0]?.textContent || "";

      if (!documentNumber || !approvalDate || !location || !reason || !requester) {
        alert("❗يرجى تعبئة جميع الحقول قبل الترحيل.");
        return;
      }

      if (addedItemsDelivery.length === 0) {
        alert("❗لا يمكن الترحيل بدون أصناف.");
        return;
      }

      try {
        const deliveryRef = ref(database, `deliveryRequests/${documentNumber}`);
        const deliverySnap = await get(deliveryRef);

        let existingDisbNum = null;

        if (deliverySnap.exists()) {
          const existingData = deliverySnap.val();

          if (existingData.deleted === true) {
            alert("❌ لا يمكن ترحيل هذا الطلب لأنه محذوف.");
            return;
          }

          if (existingData.migrated === true) {
            alert("❗تم ترحيل هذا الطلب مسبقًا ولا يمكن ترحيله مرة أخرى.");
            return;
          }

          if (existingData.disbursementDocNumber) {
            existingDisbNum = existingData.disbursementDocNumber;
          }
        }

        const disbCounterRef = ref(database, 'documentNumberDisbursement');
        const counterSnap = await get(disbCounterRef);
        const newDisbNumber = existingDisbNum || (counterSnap.exists() ? counterSnap.val() + 1 : 1);

        const additionsSnapshot = await get(ref(database, 'documentsAddition'));
        let lastPrices = {};
        let stock = {};

        if (additionsSnapshot.exists()) {
          additionsSnapshot.forEach(doc => {
            const docData = doc.val();
            if (docData.deleted) return;

            const docNumber = parseInt(docData.documentNumberAddition) || 0;
            const items = Array.isArray(docData.items) ? docData.items : Object.values(docData.items);

            for (let item of items) {
              const { itemCode, price = 0, quantity = 0 } = item;

              if (!lastPrices[itemCode] || docNumber > lastPrices[itemCode].docNumber) {
                lastPrices[itemCode] = { price: parseFloat(price), docNumber };
              }

              stock[itemCode] = (stock[itemCode] || 0) + parseFloat(quantity);
            }
          });
        }

        for (let item of addedItemsDelivery) {
          const code = item.itemCode;
          const requestedQty = parseFloat(item.quantity) || 0;
          const availableQty = stock[code] || 0;

          if (requestedQty > availableQty) {
            alert(`❌ الكمية المطلوبة للصنف ${item.itemName} (${code}) هي ${requestedQty}، بينما المتوفر ${availableQty}.`);
            return;
          }
        }

        const deliveryData = {
          documentNumberDelivery: documentNumber,
          approvalDate,
          location,
          reason,
          requester,
          items: addedItemsDelivery,
          disbursementDocNumber: newDisbNumber,
          migrated: true,
          deleted: false,
          company: { code: companyCode, name: companyName }
        };

        await set(deliveryRef, deliveryData);

        let totalSum = 0;
        const disbItems = addedItemsDelivery.map(item => {
          const price = lastPrices[item.itemCode]?.price || 0;
          const qty = parseFloat(item.quantity) || 0;
          const total = price * qty;
          totalSum += total;

          return {
            itemCode: item.itemCode,
            itemName: item.itemName,
            itemQuantity: qty,
            itemPrice: price,
            itemTotal: total
          };
        });

        const disbursementData = {
          documentNumberDisbursement: newDisbNumber,
          documentDateDisbursement: approvalDate,
          notesDisbursement: reason,
          locationDisbursement: location,
          items: disbItems,
          totalSum,
          company: { code: companyCode, name: companyName }
        };

        await set(ref(database, `documentsDisbursement/${newDisbNumber}`), disbursementData);
        await set(disbCounterRef, newDisbNumber);

        alert(`✅ تم ترحيل الطلب بنجاح! رقم إذن الصرف: ${newDisbNumber}`);

        document.getElementById('documentNumberDelivery').value = '';
        document.getElementById('approvalDateDelivery2').value = '';
        document.getElementById('LocationDelivery2').value = '';
        document.getElementById('reasonDelivery2').value = '';
        document.getElementById('requestDelivery2').value = '';
        addedItemsDelivery = [];
        updateItemsTableDelivery2();

      } catch (error) {
        console.error("❌ خطأ أثناء الترحيل:", error);
        alert("❌ حدث خطأ أثناء ترحيل الطلب.");
      }
    };

    function updateItemsTableDelivery2() {
      const tableBody = document.getElementById("deliveryItemsTable");
      tableBody.innerHTML = "";

      if (addedItemsDelivery.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6">لا توجد أصناف مضافة</td></tr>`;
        return;
      }

      addedItemsDelivery.forEach((item, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${item.itemCode}</td>
            <td>${item.itemName}</td>
            <td>${item.quantity}</td>
            <td>${item.beneficiary}</td>
            <td>${item.notes}</td>
            <td><button onclick="removeDeliveryItem2(${index})">❌ حذف</button></td>
        `;
        tableBody.appendChild(row);
      });
    }

    window.addItemToDelivery2 = function () {
      const itemCode = document.getElementById('itemCodeDelivery2').value.trim();
      const itemName = document.getElementById('itemNameDelivery2').value.trim();
      const quantity = document.getElementById('QuantityDelivery2').value.trim();
      const beneficiary = document.getElementById('beneficiary2').value.trim();
      const notes = document.getElementById('notesDelivery2').value.trim();
      if (!itemCode || !itemName || !quantity) {
        alert("❗يرجى تعبئة جميع الحقول الأساسية.");
        return;
      }

      if (isNaN(quantity) || parseFloat(quantity) <= 0) {
        alert("⚠️ يرجى إدخال كمية صحيحة.");
        return;
      }

      addedItemsDelivery.push({
        itemCode,
        itemName,
        quantity: parseFloat(quantity),
        beneficiary,
        notes
      });

      updateItemsTableDelivery2();

      document.getElementById('itemCodeDelivery2').value = '';
      document.getElementById('itemNameDelivery2').value = '';
      document.getElementById('QuantityDelivery2').value = '';
      document.getElementById('beneficiary2').value = '';
      document.getElementById('notesDelivery2').value = '';
    };

    window.fetchItemDetailsDelivery2 = function (type) {
      const searchValue = type === 'code'
        ? document.getElementById('itemCodeDelivery2').value.trim()
        : document.getElementById('itemNameDelivery2').value.trim();

      if (!searchValue) return;

      const itemsRef = ref(database, 'items');
      get(itemsRef).then(snapshot => {
        if (snapshot.exists()) {
          const itemsData = snapshot.val();
          let foundItem = null;
          let matches = [];

          for (const key in itemsData) {
            const item = itemsData[key];

            if (type === 'code' && item.itemCode.toString() === searchValue) {
              foundItem = item;
              break;
            }

            if (type === 'name') {
              if (item.itemName.toLowerCase() === searchValue.toLowerCase()) {
                foundItem = item;
                break;
              } else if (item.itemName.toLowerCase().includes(searchValue.toLowerCase())) {
                matches.push({ name: item.itemName, code: item.itemCode });
              }
            }
          }

          if (foundItem) {
            document.getElementById('itemCodeDelivery2').value = foundItem.itemCode;
            document.getElementById('itemNameDelivery2').value = foundItem.itemName;
          } else if (type === 'name') {
            let dataList = document.getElementById('itemSuggestionsDelivery2');
            dataList.innerHTML = '';
            matches.forEach(item => {
              let option = document.createElement('option');
              option.value = item.name;
              option.dataset.code = item.code;
              dataList.appendChild(option);
            });
          } else if (type === 'code') {
            alert("⚠️ لم يتم العثور على الصنف بالكود المدخل.");
          }
        }
      }).catch(error => {
        console.error("❌ خطأ بجلب بيانات الأصناف:", error);
      });
    };

    document.getElementById('itemNameDelivery2').addEventListener('input', function () {
      const selectedName = this.value;
      const options = document.querySelectorAll('#itemSuggestionsDelivery2 option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('itemCodeDelivery2').value = option.dataset.code;
        }
      });
    });

    function loadItemsSuggestionsDelivery2() {
      const itemsRef = ref(database, 'items');
      get(itemsRef).then(snapshot => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('itemSuggestionsDelivery2');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(item => {
            let option = document.createElement("option");
            option.value = item.itemName;
            option.dataset.code = item.itemCode;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الأصناف:", err));
    }

    window.onload = function () {
      loadItemsSuggestionsDelivery();
      loadItemsSuggestionsDelivery2();
    };

    window.searchDatadelivery = async function () {
      const DeliveryQuery = localStorage.getItem('DeliveryQuery') === 'true';
      const dataId = document.getElementById("queryDocNumDelivery").getAttribute("data-id");

      if (!dataId && !DeliveryQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }
      const queryDate = document.getElementById("queryDateDelivery")?.value.trim() || "";
      const queryDocNum = document.getElementById("queryDocNumDelivery")?.value.trim() || "";
      const queryLocation = document.getElementById("locationdelivery2")?.value.trim() || "";
      const generalSearch = document.getElementById("generalSearchDelivery")?.value.trim().toLowerCase() || "";
      const filterItemCode = document.getElementById("filterItemDelivery")?.value.trim() || "";
      const queryResultsDelivery = document.getElementById("queryResultsDelivery");
      const queryCompanyName = document.getElementById("queryCompanySelectDelivery")?.value.trim().toLowerCase() || "";

      queryResultsDelivery.innerHTML = "⌛ جاري البحث...";

      try {
        const snap = await get(ref(database, "deliveryRequests"));

        if (!snap.exists()) {
          queryResultsDelivery.innerHTML = "<tr><td colspan='9'>❌ لا توجد نتائج</td></tr>";
          return;
        }

        let allDeliveries = Object.entries(snap.val()).map(([key, val]) => ({
          id: key,
          ...val
        }));

        let filtered = allDeliveries.filter(delivery => {
          return (
            (queryDocNum === "" || (delivery.documentNumberDelivery && delivery.documentNumberDelivery.toString().includes(queryDocNum))) &&
            (queryDate === "" || (delivery.approvalDate && delivery.approvalDate === queryDate)) &&
            (queryLocation === "" || (delivery.location && delivery.location.includes(queryLocation))) &&
            (filterItemCode === "" || (delivery.items && delivery.items.some(item => item.itemCode && item.itemCode === filterItemCode))) &&
            (queryCompanyName === "" || (delivery.company && delivery.company.name && delivery.company.name.toLowerCase().includes(queryCompanyName)))
          );
        });

        if (generalSearch) {
          filtered = filtered.filter(delivery => {
            return Object.values(delivery).some(value =>
              String(value).toLowerCase().includes(generalSearch)
            );
          });
        }

        if (filtered.length === 0) {
          queryResultsDelivery.innerHTML = "<tr><td colspan='9'>❌ لا توجد نتائج مطابقة</td></tr>";
          return;
        }

        let rows = '';
        let totalItems = 0;

        filtered.forEach(delivery => {
          const items = delivery.items ? Object.values(delivery.items) : [];
          const isDeleted = !!delivery.deleted;
          const isDeletedStyle = isDeleted ? 'background-color: #f8d7da; color: #721c24;' : '';

          items.forEach(item => {
            if (!isDeleted) {
              totalItems += parseFloat(item.quantity || 0);
            }

            rows += `
                    <tr style="${isDeletedStyle}" ondblclick="showDeliveryInvoiceById('${delivery.id}')">
                        <td>${delivery.documentNumberDelivery || ''}</td>
                        <td>${delivery.company?.name || ''}</td>
                        <td>${delivery.approvalDate || ''}</td>
                        <td>${delivery.location || ''}</td>
                        <td>${delivery.requester || ''}</td>
                        <td>${item.itemName || ''} (${item.itemCode || ''})</td>
                        <td>${item.quantity || 0}</td>
                        <td>${item.beneficiary || ''}</td>
                        <td>${item.notes || ''}</td>
                    </tr>
                `;
          });
        });

        queryResultsDelivery.innerHTML = `
            <table border="1" style="width: 100%; border-collapse: collapse; text-align: center;">
                <thead style="background-color: #f2f2f2;">
                    <tr>
                        <th>رقم المستند</th>
                        <th>اسم الشركة</th>
                        <th>تاريخ الموافقة</th>
                        <th>المنطقة</th>
                        <th>مقدم الطلب</th>
                        <th>الصنف</th>
                        <th>الكمية</th>
                        <th>المستفيد</th>
                        <th>ملاحظات</th>
                    </tr>
                </thead>
                <tbody>
                    ${rows}
                </tbody>
                <tfoot>
                    <tr style="font-weight: bold; background-color: #dff0d8;">
                        <td colspan="5" style="text-align: right;">إجمالي الكمية:</td>
                        <td colspan="4">${totalItems}</td>
                    </tr>
                </tfoot>
            </table>
        `;

      } catch (err) {
        console.error("❌ خطأ أثناء البحث:", err);
        queryResultsDelivery.innerHTML = "<tr><td colspan='9'>⚠️ حدث خطأ أثناء تحميل البيانات</td></tr>";
      }
    };

    window.showDeliveryInvoiceById = async function (docId) {
      try {
        const snap = await get(ref(database, `deliveryRequests/${docId}`));
        if (!snap.exists()) {
          alert("⚠️ لم يتم العثور على هذا المستند.");
          return;
        }

        const data = snap.val();
        showDeliveryApproval(data);
      } catch (err) {
        console.error("❌ خطأ أثناء جلب بيانات المستند:", err);
        alert("❌ حدث خطأ أثناء تحميل الفاتورة.");
      }
    };

    async function loadItemsToSelectDelivery() {
      const itemsRef = ref(database, 'items');
      try {
        const snapshot = await get(itemsRef);
        const select = document.getElementById('filterItemDelivery');
        select.innerHTML = '<option value="">- اختر الصنف -</option>';

        if (snapshot.exists()) {
          const items = snapshot.val();

          Object.values(items).forEach(item => {
            const option = document.createElement('option');
            option.value = item.itemCode;
            option.textContent = `${item.itemName} - ${item.itemCode}`;
            select.appendChild(option);
          });
        } else {
          console.warn("⚠️ لا توجد أصناف في قاعدة البيانات.");
        }
      } catch (error) {
        console.error("❌ خطأ أثناء تحميل الأصناف:", error);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadItemsToSelectDelivery();
    });

    window.printTableDelivery = function () {
      const resultsContainer = document.getElementById("queryResultsDelivery");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة الأجهزة</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExceDlelivery = function () {
      const table = document.querySelector("#queryResultsDelivery table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "Delivery Data" });
      XLSX.writeFile(workbook, "Delivery_Data.xlsx");
    };

    window.showDeliveryApproval = async function (deliveryData) {
      try {
        const settingsRef = ref(
          database,
          `companySettings/${deliveryData.company.code}`
        );

        const snapshot = await get(settingsRef);

        if (!snapshot.exists()) {
          alert("❌ إعدادات الشركة غير موجودة");
          return;
        }

        const settings = snapshot.val();

        const totalQty = deliveryData.items.reduce((s, o) => s + o.quantity, 0);

        const template = `
      <div id="invoiceBody" style="font-family: 'Arial', sans-serif; direction: rtl; padding:40px; position: relative; background:#fff; border:1px solid #ccc;">
        
        <!-- العلامة المائية -->
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-50deg); opacity:0.05; font-size:100px; font-weight:bold; color:#000; white-space:nowrap;">
          ${settings.watermark || ''}
        </div>

        <!-- رأس الصفحة -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div style="text-align:left; line-height:1.6;">
            <div style="font-weight:bold; font-size:18px;">company: ${settings.name}</div>
            <div style="font-size:14px;">address: ${settings.address}</div>
            <div style="font-size:14px;">Phone: ${settings.phone}</div>
            <div style="font-size:14px;">Email: ${settings.email}</div>
          </div>
          <div style="text-align:center; margin-top:20px;">
              <canvas id="qrcanvas"></canvas>
              <p style="font-size:10px; color:#555; margin-top:3px;">QR Code for Delivery</p>
          </div>
          <img src="${settings.logoUrl}" alt="Company Logo" style="height:100px;">
        </div>

        <!-- عنوان الفاتورة -->
        <h2 style="text-align:center; background:#ffeb3b; color:#000; padding:10px 0; margin-top:20px;">
          فاتورة تسليم – Delivery Invoice
        </h2>

        <!-- بيانات عامة -->
        <div style="display:flex; justify-content:space-between; margin-top:20px; font-size:15px;">
          <div>
            <div><strong>رقم المستند:</strong> ${deliveryData.documentNumberDelivery}</div>
            <div><strong>التاريخ:</strong> ${deliveryData.approvalDate}</div>
            <div><strong>السبب:</strong> ${deliveryData.reason}</div>
          </div>
          <div style="text-align:left;">
            <div><strong>الموقع:</strong> ${deliveryData.location}</div>
            <div><strong>بطلب من:</strong> ${deliveryData.requester}</div>
          </div>
        </div>

        <!-- جدول الأصناف -->
        <table style="width:100%; border-collapse:collapse; margin-top:25px; font-size:14px;">
          <thead>
            <tr style="background:#eee; border-bottom:2px solid #000;">
              <th style="padding:6px;">م / No.</th>
              <th>كود الصنف / Item Code</th>
              <th>البيان / Description</th>
              <th>الكمية / Qty</th>
              <th>المستفيد / Beneficiary</th>
              <th>ملاحظات / Notes</th>
            </tr>
          </thead>
          <tbody>
            ${deliveryData.items.map((it, i) => `
              <tr style="border-bottom:1px solid #ccc;">
                <td style="text-align:center; padding:5px;">${i + 1}</td>
                <td style="text-align:center; padding:5px;">${it.itemCode}</td>
                <td style="text-align:center; padding:5px;">${it.itemName}</td>
                <td style="text-align:center; padding:5px;">${it.quantity}</td>
                <td style="text-align:center; padding:5px;">${it.beneficiary || ''}</td>
                <td style="text-align:center; padding:5px;">${it.notes || ''}</td>
              </tr>
            `).join('')}
            <tr style="background:#fff9c4; font-weight:bold;">
              <td colspan="3" style="text-align:right; padding:8px;">الإجمالي الكلي:</td>
              <td style="text-align:center; padding:5px;">${totalQty.toFixed(2)}</td>
              <td colspan="2"></td>
            </tr>
          </tbody>
        </table>

        <!-- التوقيعات -->
        <div style="display:flex; justify-content:space-between; margin-top:50px; border-top:1px solid #ccc; padding-top:30px;">
          <div style="width:30%; text-align:center;">
            <p>مدير الموقع</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
            <p style="font-size:12px; color:#555;">Site Manager Signature</p>
          </div>
          <div style="width:30%; text-align:center;">
            <p>مدير تقنية المعلومات</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
            <p style="font-size:12px; color:#555;">IT Manager Signature</p>
          </div>
          <div style="width:30%; text-align:center;">
            <p>المدير العام</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
            <p style="font-size:12px; color:#555;">General Manager Signature</p>
          </div>
        </div>
      </div>
    `;

        const w = window.open("", "_blank");
        w.document.write(template);
        w.document.close();

        w.onload = () => {
          QRCode.toCanvas(w.document.getElementById('qrcanvas'),
            JSON.stringify({
              doc: deliveryData.documentNumberDelivery,
              totalQty: totalQty
            }),
            { width: 100 }
          );
        };

      } catch (error) {
        console.error("❌ فشل تحميل إعدادات الشركة:", error);
        alert("❌ حدث خطأ أثناء تحميل إعدادات الشركة للفاتورة");
      }
    };

    ///////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////// اداره الهاتف //////////////////////////////////////
    ///////////////////////////////////////////////////////////////////////////////////////////
    let currentEditingDeviceTypePhone = null;
    window.addDeviceDataPhone = async function () {
      const newType = document.getElementById("deviceTypePhone").value.trim();
      const models = document.getElementById("deviceModelsPhone").value
        .split(',')
        .map(m => m.trim())
        .filter(Boolean);

      if (!newType || models.length === 0) {
        alert("❌ يرجى إدخال نوع الجهاز والموديلات.");
        return;
      }

      if (currentEditingDeviceTypePhone && newType !== currentEditingDeviceTypePhone) {
        await remove(ref(database, "Phone/" + currentEditingDeviceTypePhone));
      }

      await set(ref(database, "Phone/" + newType), {
        models: models
      });

      alert(currentEditingDeviceTypePhone ? "✅ تم حفظ بيانات الجهاز." : "✅ تم إضافة الجهاز بنجاح.");
      document.getElementById("deviceTypePhone").value = "";
      document.getElementById("deviceModelsPhone").value = "";
      document.getElementById("updateDeviceButton").textContent = "إضافة";
      document.getElementById("deleteDeviceButton").style.display = "none";
      currentEditingDeviceTypePhone = null;
      loadDeviceTablePhone();
      populateDeviceTypeOptionsPhone();
    };

    window.editDeviceType = function (type) {
      const modelsRef = ref(database, "Phone/" + type + "/models");

      get(modelsRef).then(snapshot => {
        const models = snapshot.val();

        if (Array.isArray(models)) {
          document.getElementById("deviceTypePhone").value = type;
          document.getElementById("deviceModelsPhone").value = models.join(', ');
          currentEditingDeviceTypePhone = type;
          document.getElementById("updateDeviceButton").textContent = "تحديث";
          document.getElementById("deleteDeviceButton").style.display = "inline-block";
        }
      });
    };

    function loadDeviceTablePhone() {
      const tableBody = document.querySelector("#deviceTablePhone tbody");
      const deviceRef = ref(database, "Phone");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        tableBody.innerHTML = "";

        for (const type in data) {
          const models = data[type].models;
          const row = document.createElement("tr");

          row.innerHTML = `
                <td>${type}</td>
                <td>${models.join(', ')}</td>
            `;

          row.addEventListener("click", () => {
            fetchDeviceDataPhone(type);
          });

          tableBody.appendChild(row);
        }
      });
    }

    function populateDeviceTypeOptionsPhone() {
      const deviceTypeSelect = document.getElementById("phoneType");
      const queryDeviceType = document.getElementById("searchphoneType");

      const deviceRef = ref(database, "Phone");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();

        const defaultOption = '<option value="">-- اختر نوع الجهاز --</option>';
        deviceTypeSelect.innerHTML = defaultOption;
        queryDeviceType.innerHTML = defaultOption;

        if (!data) return;

        Object.keys(data).forEach(type => {
          const option1 = document.createElement("option");
          option1.value = type;
          option1.textContent = type;

          const option2 = option1.cloneNode(true);

          deviceTypeSelect.appendChild(option1);
          queryDeviceType.appendChild(option2);
        });
      }, {
        onlyOnce: true
      });
    }

    document.getElementById("phoneType").addEventListener("change", (e) => {
      const selectedType = e.target.value;
      const modelSelect = document.getElementById("phoneModel");

      modelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

      if (selectedType) {
        const modelsRef = ref(database, "Phone/" + selectedType + "/models");
        onValue(modelsRef, (snapshot) => {
          const models = snapshot.val();
          if (Array.isArray(models)) {
            models.forEach(model => {
              const opt = document.createElement("option");
              opt.value = model;
              opt.textContent = model;
              modelSelect.appendChild(opt);
            });
          }
        });
      }
    });
    loadDeviceTablePhone();
    populateDeviceTypeOptionsPhone();

    function loadCompaniesIntoSelectPhone() {
      const companySelect = document.getElementById("companySelectPhone");
      const queryCompanySelect = document.getElementById("queryCompanySelectPhone");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodePhone");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectPhone);

    window.savePhone = async function () {
      const phoneSave = localStorage.getItem('phoneSave') === 'true';
      const phoneEdit = localStorage.getItem('phoneEdit') === 'true';
      const dataId = document.getElementById("documentNumberPhone").getAttribute("data-id");

      if (!dataId && !phoneSave) {
        alert("❌ ليس لديك صلاحية إضافة بيانات جديدة.");
        return;
      }
      if (dataId && !phoneEdit) {
        alert("❌ ليس لديك صلاحية تعديل البيانات.");
        return;
      }

      const employeeNamePhone = document.getElementById("employeeNamePhone").value.trim();
      const datePhone = document.getElementById("datePhone").value.trim();
      const locationPhone = document.getElementById("locationPhone").value.trim();
      const phoneType = document.getElementById("phoneType").value.trim();
      const phoneModel = document.getElementById("phoneModel").value.trim();
      const ram = document.getElementById("ram").value.trim();
      const storage = document.getElementById("storage").value.trim();
      const imeiNumber = document.getElementById("imeiNumber").value.trim();
      const simNumberPhoe = document.getElementById("simNumberPhone").value.trim();
      const phoneStatus = document.getElementById("phoneStatus").value.trim();
      const notesPhone = document.getElementById("notesPhone").value.trim();
      const companyCode = document.getElementById("selectedCompanyCodePhone").value;

      if (!employeeNamePhone || !datePhone || !locationPhone || !phoneType ||
        !phoneModel || !ram || !storage || !imeiNumber || !simNumberPhoe || !phoneStatus || !companyCode) {
        alert("❌ يرجى تعبئة جميع الحقول المطلوبة!");
        return;
      }

      if (imeiNumber.length !== 15 || isNaN(imeiNumber)) {
        alert("❌ رقم IMEI غير صحيح! يجب أن يكون 15 رقمًا.");
        return;
      }

      if (simNumberPhoe.length < 10 || simNumberPhoe.length > 20 || isNaN(simNumberPhoe)) {
        alert("❌ رقم SIM غير صحيح! يجب أن يكون بين 10 و 20 رقمًا.");
        return;
      }

      const documentField = document.getElementById("documentNumberPhone");
      const documentId = documentField.getAttribute("data-id");

      const phoneData = {
        employeeNamePhone,
        datePhone,
        locationPhone,
        phoneType,
        phoneModel,
        ram,
        storage,
        imeiNumber,
        simNumberPhoe,
        phoneStatus,
        notesPhone,
        companyCode
      };

      const phonesRef = ref(database, "phones");

      if (documentId) {
        const phoneRef = ref(database, `phones/${documentId}`);
        get(phoneRef).then(async (snapshot) => {
          if (snapshot.exists()) {
            const phoneDataBeforeUpdate = snapshot.val();
            if (phoneDataBeforeUpdate.documentNumberPhone !== documentField.value.trim()) {
              alert("❌ لا يمكن تعديل المستند لأن رقم المستند لا يتطابق مع البيانات الأصلية.");
              return;
            }
            if (phoneDataBeforeUpdate.deleted) {
              alert("❌ لا يمكن تعديل المستند لأنه محذوف!");
              return;
            }

            await update(phoneRef, phoneData);
            alert("✅ تم تعديل البيانات بنجاح!");

            const settingsRef = ref(database, "companySettings/" + companyCode);
            const settingsSnapshot = await get(settingsRef);
            if (!settingsSnapshot.exists()) {
              alert("❌ لم يتم العثور على إعدادات الشركة لهذا الكود!");
              return;
            }

            const settingsData = settingsSnapshot.val();
            showPhoneHandoverInvoice(phoneData, settingsData);
            clearFields();

          } else {
            alert("❌ المستند غير موجود!");
          }
        }).catch((error) => {
          alert("❌ حدث خطأ أثناء التحقق من المستند: " + error.message);
        });

      } else {
        get(phonesRef).then(async (snapshot) => {
          let usedNumbers = new Set();

          if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
              const docNum = parseInt(childSnapshot.val().documentNumberPhone);
              if (!isNaN(docNum)) {
                usedNumbers.add(docNum);
              }
            });
          }

          let manualDocNumber = documentField.value.trim();
          let finalDocumentNumber;

          if (manualDocNumber && !isNaN(manualDocNumber)) {
            const manualNum = parseInt(manualDocNumber);
            if (usedNumbers.has(manualNum)) {
              alert("❌ رقم المستند الذي أدخلته مستخدم بالفعل!");
              return;
            }
            finalDocumentNumber = manualNum;
          } else {
            let nextAvailable = 1;
            while (usedNumbers.has(nextAvailable)) {
              nextAvailable++;
            }
            finalDocumentNumber = nextAvailable;
          }

          phoneData.documentNumberPhone = finalDocumentNumber.toString();
          documentField.value = finalDocumentNumber;

          push(phonesRef, phoneData).then(async () => {
            alert(`✅ تم حفظ البيانات الجديدة بنجاح! رقم المستند: ${finalDocumentNumber}`);
            const settingsRef = ref(database, "companySettings/" + companyCode);
            const settingsSnapshot = await get(settingsRef);
            if (!settingsSnapshot.exists()) {
              alert("❌ لم يتم العثور على إعدادات الشركة لهذا الكود!");
              return;
            }
            const settingsData = settingsSnapshot.val();
            showPhoneHandoverInvoice(phoneData, settingsData);
            clearFields();
          }).catch((error) => {
            alert("❌ حدث خطأ أثناء الحفظ: " + error.message);
          });
        }).catch((error) => {
          alert("❌ حدث خطأ أثناء التحقق من البيانات: " + error.message);
        });
      }
    };

    function editPhone(documentId, phoneData) {
      document.getElementById("employeeNamePhone").value = phoneData.employeeNamePhone;
      document.getElementById("datePhone").value = phoneData.datePhone;
      document.getElementById("locationPhone").value = phoneData.locationPhone;
      document.getElementById("phoneType").value = phoneData.phoneType;
      document.getElementById("phoneModel").value = phoneData.phoneModel;
      document.getElementById("ram").value = phoneData.ram;
      document.getElementById("storage").value = phoneData.storage;
      document.getElementById("imeiNumber").value = phoneData.imeiNumber;
      document.getElementById("simNumberPhone").value = phoneData.simNumberPhoe;
      document.getElementById("phoneStatus").value = phoneData.phoneStatus;
      document.getElementById("notesPhone").value = phoneData.notesPhone;
      document.getElementById("documentNumberPhone").setAttribute("data-id", documentId);
    }

    function clearFields() {
      document.getElementById("employeeNamePhone").value = "";
      document.getElementById("datePhone").value = "";
      document.getElementById("locationPhone").value = "";
      document.getElementById("phoneType").value = "";
      document.getElementById("phoneModel").value = "";
      document.getElementById("ram").value = "";
      document.getElementById("storage").value = "";
      document.getElementById("imeiNumber").value = "";
      document.getElementById("simNumberPhone").value = "";
      document.getElementById("phoneStatus").value = "";
      document.getElementById("notesPhone").value = "";
      document.getElementById("documentNumberPhone").value = "";
      document.getElementById("companySelectPhone").value = "";
      document.getElementById("documentNumberPhone").removeAttribute("data-id");
    }

    window.searchPhone = function () {
      const phoneQuery = localStorage.getItem('phoneQuery1') === 'true';
      const dataId = document.getElementById("searchDocumentNumber").getAttribute("data-id");

      if (!dataId && !phoneQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }


      const searchDocumentNumber = document.getElementById("searchDocumentNumber").value.trim();
      const searchDatePhone = document.getElementById("searchDatePhone").value.trim();
      const searchPhoneStatus = document.getElementById("searchPhoneStatus").value.trim();
      const searchphoneType = document.getElementById("searchphoneType").value.trim();
      const searchLocationPhone = document.getElementById("searchLocationPhone").value.trim();
      const generalSearchPhone = document.getElementById("generalSearchPhone").value.trim().toLowerCase();
      const queryResultsPhone = document.getElementById("queryResultsPhone");
      const queryCompanySelectPhone = document.getElementById("queryCompanySelectPhone").value.trim();

      queryResultsPhone.innerHTML = "⏳ جاري البحث...";

      const companiesRef = ref(database, "companies");

      get(companiesRef).then((companySnapshot) => {
        const companyMap = {};

        if (companySnapshot.exists()) {
          companySnapshot.forEach((child) => {
            const company = child.val();
            companyMap[company.code] = company.name;
          });
        }

        const phonesRef = ref(database, "phones");

        get(phonesRef).then((snapshot) => {
          if (snapshot.exists()) {
            let table = document.createElement("table");
            table.border = "1";
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            table.style.textAlign = "center";

            let thead = document.createElement("thead");
            thead.innerHTML = `
                    <tr>
                       <th>الشركة</th>
                        <th>رقم المستند</th>
                        <th>التاريخ</th>
                        <th>الحالة</th>
                        <th>اسم الموظف</th>
                        <th>الموقع</th>
                        <th>نوع الهاتف</th>
                        <th>IMEI</th>
                        <th>الرام</th>
                        <th>التخزين</th>
                        <th>رقم الشريحة</th>
                        <th>ملاحظات</th>                  
                    </tr>
                `;
            table.appendChild(thead);

            let tbody = document.createElement("tbody");
            let dataFound = false;
            let phoneData = [];

            snapshot.forEach((childSnapshot) => {
              const data = childSnapshot.val();
              const id = childSnapshot.key;

              if ((searchDocumentNumber && data.documentNumberPhone !== searchDocumentNumber) ||
                (searchDatePhone && data.datePhone !== searchDatePhone) ||
                (searchLocationPhone && data.locationPhone !== searchLocationPhone) ||
                (queryCompanySelectPhone && data.companyCode !== queryCompanySelectPhone) ||
                (searchPhoneStatus && data.phoneStatus !== searchPhoneStatus) ||
                (searchphoneType && data.phoneType !== searchphoneType)) {
                return;
              }

              phoneData.push({ id, ...data });
              dataFound = true;
            });

            if (generalSearchPhone) {
              phoneData = phoneData.filter(item =>
                Object.values(item).some(value =>
                  String(value).toLowerCase().includes(generalSearchPhone)
                )
              );
            }

            phoneData.sort((a, b) =>
              parseInt(a.documentNumberPhone || 0) - parseInt(b.documentNumberPhone || 0)
            );

            phoneData.forEach((data) => {
              const allEmpty = Object.values(data).every(val => val === null || val === "" || val === undefined);
              if (allEmpty) return;

              const companyName = companyMap[data.companyCode] || data.companyCode || "غير معروف";

              let row = document.createElement("tr");
              row.id = "row-" + data.id;
              if (data.deleted) {
                row.style.backgroundColor = "#ffcccc";
              }

              row.innerHTML = `
                        <td>${companyName}</td>
                        <td>${data.documentNumberPhone || ""}</td>
                        <td>${data.datePhone || ""}</td>
                        <td>${data.phoneStatus || ""}</td>
                        <td>${data.employeeNamePhone || ""}</td>
                        <td>${data.locationPhone || ""}</td>
                        <td>${(data.phoneType || "") + " - " + (data.phoneModel || "")}</td>
                        <td>${data.imeiNumber || ""}</td>
                        <td>${data.ram || ""}</td>
                        <td>${data.storage || ""}</td>
                        <td>${data.simNumberPhoe || ""}</td>
                        <td>${data.notesPhone || ""}</td>
                    `;

              tbody.appendChild(row);
            });

            table.appendChild(tbody);

            if (dataFound && phoneData.length > 0) {
              queryResultsPhone.innerHTML = "";
              queryResultsPhone.appendChild(table);
            } else {
              queryResultsPhone.innerHTML = "❌ لم يتم العثور على نتائج تطابق الفلاتر.";
            }

          } else {
            queryResultsPhone.innerHTML = "❌ لا توجد بيانات مخزنة.";
          }
        }).catch((error) => {
          queryResultsPhone.innerHTML = "❌ خطأ أثناء جلب بيانات الهواتف: " + error.message;
        });

      }).catch((error) => {
        queryResultsPhone.innerHTML = "❌ خطأ أثناء جلب بيانات الشركات: " + error.message;
      });
    };

    window.printTablePhone = function () {
      const resultsContainer = document.getElementById("queryResultsPhone");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة بيانات الهواتف</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelPhone = function () {
      const table = document.querySelector("#queryResultsPhone table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "Phones" });
      XLSX.writeFile(workbook, "Phones_Data.xlsx");
    }

    window.showPhoneHandoverInvoice = function (data, settings) {
      try {
        const html = `
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="UTF-8">
      <title>نموذج استلام هاتف</title>
      <style>
        body { font-family: 'Arial', sans-serif; margin: 40px; direction: rtl; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header img { height: 80px; }
        .company-info { text-align: left; font-size: 14px; line-height: 1.6; }
        h1 { text-align: center; margin: 30px 0; color: #0d47a1; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background-color: #f2f2f2; }
        .acknowledgment { margin-top: 30px; font-size: 15px; line-height: 1.8; }
        .signatures { display: flex; justify-content: space-between; margin-top: 50px; }
        .signatures div { width: 30%; text-align: center; }
        .signatures .line { border-top: 1px solid #000; margin-top: 40px; }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="${settings.logoUrl || ''}" alt="شعار الشركة">
        <div class="company-info">
          <div style="font-weight:bold; font-size:18px;">${settings.name || ''}</div>
          <div style="font-size:14px;">العنوان: ${settings.address || ''}</div>
          <div style="font-size:14px;">الهاتف: ${settings.phone || ''}</div>
          <div style="font-size:14px;">الإيميل: ${settings.email || ''}</div>
        </div>
      </div>

      <!-- العلامة المائية -->
      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-50deg); opacity:0.05; font-size:100px; font-weight:bold; color:#000; white-space:nowrap;">
        ${settings.watermark || ''}
      </div>

      <h1>نموذج استلام هاتف موظف</h1>

      <table>
        <tr><th>اسم الموظف</th><th>الموقع</th><th>تاريخ الاستلام</th><th>نوع الهاتف</th><th>الموديل</th></tr>
        <tr>
          <td>${data.employeeNamePhone}</td>
          <td>${data.locationPhone}</td>
          <td>${data.datePhone}</td>
          <td>${data.phoneType}</td>
          <td>${data.phoneModel}</td>
        </tr>
      </table>

      <table>
        <tr><th>رقم IMEI</th><td>${data.imeiNumber}</td></tr>
        <tr><th>رقم الشريحة (SIM)</th><td>${data.simNumberPhoe}</td></tr>
        <tr><th>الرام</th><td>${data.ram}</td></tr>
        <tr><th>التخزين الداخلي</th><td>${data.storage}</td></tr>
      </table>

      <div class="acknowledgment">
        أقر أنا الموقع أدناه بأنني استلمت الهاتف والمعلومات الموضحة أعلاه كاملة وسليمة،
        وأتعهد بالمحافظة عليه واستخدامه للأغراض الوظيفية فقط، وفي حال فقدانه أو تلفه أتحمل كامل المسؤولية.
      </div>

      <div class="signatures">
        <div><p>توقيع الموظف</p><div class="line"></div></div>
        <div><p>توقيع مسؤول العهدة</p><div class="line"></div></div>
        <div><p>توقيع الإدارة</p><div class="line"></div></div>
      </div>
    </body>
    </html>
    `;

        const printWin = window.open("", "_blank");
        printWin.document.write(html);
        printWin.document.close();
        printWin.focus();
      } catch (error) {
        alert("❌ خطأ أثناء عرض الفاتورة: " + error.message);
        console.error(error);
      }
    };

    ///////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////////////// اداره الخطوط ///////////////////////////////////////
    ///////////////////////////////////////////////////////////////////////////////////////////
    let currentEditingDeviceTypeLine = null;
    window.addCompanyPlans = async function () {
      const newType = document.getElementById("companyInput").value.trim();
      const models = document.getElementById("plansInput").value
        .split(',')
        .map(m => m.trim())
        .filter(Boolean);

      if (!newType || models.length === 0) {
        alert("❌ يرجى إدخال نوع الجهاز والموديلات.");
        return;
      }

      if (currentEditingDeviceTypeLine && newType !== currentEditingDeviceTypeLine) {
        await remove(ref(database, "Line/" + currentEditingDeviceTypeLine));
      }

      await set(ref(database, "Line/" + newType), {
        models: models
      });

      alert(currentEditingDeviceTypeLine ? "✅ تم حفظ بيانات الجهاز." : "✅ تم إضافة الجهاز بنجاح.");
      document.getElementById("companyInput").value = "";
      document.getElementById("plansInput").value = "";
      document.getElementById("updateDeviceButton").textContent = "إضافة";
      document.getElementById("deleteDeviceButton").style.display = "none";
      currentEditingDeviceTypeLine = null;
      loadDeviceTableLine();
      populateDeviceTypeOptionsLine();
    };

    window.editDeviceType = function (type) {
      const modelsRef = ref(database, "Line/" + type + "/models");

      get(modelsRef).then(snapshot => {
        const models = snapshot.val();

        if (Array.isArray(models)) {
          document.getElementById("companyInput").value = type;
          document.getElementById("plansInput").value = models.join(', ');
          currentEditingDeviceTypeLine = type;
          document.getElementById("updateDeviceButton").textContent = "تحديث";
          document.getElementById("deleteDeviceButton").style.display = "inline-block";
        }
      });
    };

    function loadDeviceTableLine() {
      const tableBody = document.querySelector("#companyTable tbody");
      const deviceRef = ref(database, "Line");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        tableBody.innerHTML = "";

        for (const type in data) {
          const models = data[type].models;
          const row = document.createElement("tr");

          row.innerHTML = `
                <td>${type}</td>
                <td>${models.join(', ')}</td>
            `;

          row.addEventListener("click", () => {
            fetchDeviceDataLine(type);
          });

          tableBody.appendChild(row);
        }
      });
    }

    function populateDeviceTypeOptionsLine() {
      const deviceTypeSelect = document.getElementById("companyLine");
      const queryDeviceType = document.getElementById("companySearchLine");

      const deviceRef = ref(database, "Line");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();

        const defaultOption = '<option value="">-- اختر نوع الجهاز --</option>';
        deviceTypeSelect.innerHTML = defaultOption;
        queryDeviceType.innerHTML = defaultOption;

        if (!data) return;

        Object.keys(data).forEach(type => {
          const option1 = document.createElement("option");
          option1.value = type;
          option1.textContent = type;

          const option2 = option1.cloneNode(true);

          deviceTypeSelect.appendChild(option1);
          queryDeviceType.appendChild(option2);
        });
      }, {
        onlyOnce: true
      });
    }

    document.getElementById("companyLine").addEventListener("change", (e) => {
      const selectedType = e.target.value;
      const modelSelect = document.getElementById("plansLine");

      modelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

      if (selectedType) {
        const modelsRef = ref(database, "Line/" + selectedType + "/models");
        onValue(modelsRef, (snapshot) => {
          const models = snapshot.val();
          if (Array.isArray(models)) {
            models.forEach(model => {
              const opt = document.createElement("option");
              opt.value = model;
              opt.textContent = model;
              modelSelect.appendChild(opt);
            });
          }
        });
      }
    });
    loadDeviceTableLine();
    populateDeviceTypeOptionsLine();

    function loadCompaniesIntoSelectLine() {
      const companySelect = document.getElementById("companySelectLine");
      const queryCompanySelect = document.getElementById("queryCompanySelectLine");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeLine");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }

    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectLine);

    window.saveLine = function () {
      const LineSave = localStorage.getItem('LineSave') === 'true';
      const LineEdit = localStorage.getItem('LineEdit') === 'true';
      const dataId = document.getElementById("documentNumberLine").getAttribute("data-id");

      if (!dataId && !LineSave) {
        alert("❌ ليس لديك صلاحية إضافة بيانات جديدة.");
        return;
      }
      if (dataId && !LineEdit) {
        alert("❌ ليس لديك صلاحية تعديل البيانات.");
        return;
      }
      const documentNumberInput = document.getElementById("documentNumberLine");
      const employeeName = document.getElementById("employeeNameLine").value.trim();
      const phoneNumber = document.getElementById("phoneNumberLine").value.trim();
      const date = document.getElementById("dateLine").value;
      const location = document.getElementById("locationLine").value.trim();
      const company = document.getElementById("companyLine").value;
      const plans = document.getElementById("plansLine").value;
      const packageType = document.getElementById("packageTypeLine").value;
      const packageSize = document.getElementById("packageSize").value;
      const simNumber = document.getElementById("simNumberLine").value.trim();
      const startDate = document.getElementById("startDateLine").value;
      const packageDuration = document.getElementById("packageDuration").value;
      const endDate = document.getElementById("endDate").value;
      const notes = document.getElementById("notesLine").value.trim();

      const selectedCompanyCode = document.getElementById("selectedCompanyCodeLine").value;
      const selectedCompanyName = document.getElementById("companySelectLine").options[
        document.getElementById("companySelectLine").selectedIndex
      ]?.text || "";

      let errors = [];

      if (!employeeName || !phoneNumber || !date || !location || !company || !packageType || !packageSize || !simNumber || !startDate || !packageDuration || !selectedCompanyCode) {
        errors.push("❌ يرجى ملء جميع الحقول المطلوبة.");
      }

      if (!/^\d{11}$/.test(phoneNumber)) {
        errors.push(" رقم الهاتف يجب أن يحتوي على 11 رقمًا.");
      }

      const companyPrefixes = {
        "فودافون": "010",
        "أورنج": "012",
        "اتصالات": "011",
        "WE": "015"
      };

      if (company in companyPrefixes) {
        const expectedPrefix = companyPrefixes[company];
        if (!phoneNumber.startsWith(expectedPrefix)) {
          errors.push(`📱 رقم الهاتف لشركة ${company} يجب أن يبدأ بـ ${expectedPrefix}.`);
        }
      }

      if (!/^\d{19,20}$/.test(simNumber)) {
        errors.push(" رقم الـ SIM يجب أن يكون 19 أو 20 رقمًا.");
      }

      if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
        errors.push(" تاريخ الانتهاء يجب أن يكون بعد تاريخ البدء.");
      }

      if (errors.length > 0) {
        alert(errors.join("\n"));
        return;
      }

      if (dataId) {
        const lineRef = ref(database, "lines/" + dataId);
        get(lineRef).then((snapshot) => {
          if (snapshot.exists()) {
            const lineData = snapshot.val();
            if (lineData.deleted) {
              alert(" هذا الخط محذوف ولا يمكن تعديله!");
              return;
            }

            const updatedData = {
              documentNumberLine: documentNumberInput.value,
              employeeName,
              phoneNumber,
              date,
              location,
              company,
              plans,
              packageType,
              packageSize,
              simNumber,
              startDate,
              packageDuration,
              endDate,
              notes,
              selectedCompanyCode,
              selectedCompanyName,
              timestamp: Date.now()
            };

            console.log(" تعديل السجل برقم المستند:", documentNumberInput.value);
            update(lineRef, updatedData)
              .then(() => {
                alert(" تم تحديث البيانات بنجاح!");
                showLineHandoverInvoice(updatedData); // ✅ بعد التحديث نعرض الفاتورة
                resetForm();
              })
              .catch((error) => {
                alert("❌ خطأ أثناء التحديث: " + error.message);
              });
          } else {
            alert("❌ السجل غير موجود!");
          }
        }).catch((error) => {
          alert("❌ حدث خطأ أثناء جلب البيانات: " + error.message);
        });

      } else {
        const linesRef = ref(database, "lines");

        get(linesRef).then((snapshot) => {
          let newDocumentNumber = 1;

          if (snapshot.exists()) {
            let maxNumber = 0;
            snapshot.forEach((childSnapshot) => {
              const line = childSnapshot.val();
              if (line.documentNumberLine) {
                const docNumber = parseInt(line.documentNumberLine, 10);
                if (!isNaN(docNumber) && docNumber > maxNumber) {
                  maxNumber = docNumber;
                }
              }
            });

            newDocumentNumber = maxNumber + 1;
          }

          documentNumberInput.value = newDocumentNumber;
          const newData = {
            documentNumberLine: newDocumentNumber,
            employeeName,
            phoneNumber,
            date,
            location,
            company,
            plans,
            packageType,
            packageSize,
            simNumber,
            startDate,
            packageDuration,
            endDate,
            notes,
            selectedCompanyCode,
            selectedCompanyName,
            timestamp: Date.now(),
            deleted: false
          };

          console.log("📥 إضافة سجل جديد برقم المستند:", newDocumentNumber);
          push(linesRef, newData)
            .then(() => {
              alert(` تم حفظ البيانات الجديدة بنجاح! رقم المستند: ${newDocumentNumber}`);
              showLineHandoverInvoice(newData);
              resetForm();
            })
            .catch((error) => {
              alert("❌ خطأ أثناء الحفظ: " + error.message);
            });

        }).catch((error) => {
          alert("❌ حدث خطأ أثناء جلب الرقم الترتيبي: " + error.message);
        });
      }
    };

    function resetForm() {
      document.getElementById("companySelectLine").value = "";
      document.getElementById("documentNumberLine").value = "";
      document.getElementById("employeeNameLine").value = "";
      document.getElementById("phoneNumberLine").value = "";
      document.getElementById("dateLine").value = "";
      document.getElementById("locationLine").value = "";
      document.getElementById("companyLine").value = "";
      document.getElementById("plansLine").value = "";
      document.getElementById("packageTypeLine").value = "";
      document.getElementById("packageSize").value = "";
      document.getElementById("simNumberLine").value = "";
      document.getElementById("startDateLine").value = "";
      document.getElementById("packageDuration").value = "";
      document.getElementById("endDate").value = "";
      document.getElementById("notesLine").value = "";
      document.getElementById("documentNumberLine").removeAttribute("data-id");
    }

    window.searchLine = function () {
      const LineQuery = localStorage.getItem('LineQuery1') === 'true';
      const dataId = document.getElementById("documentNumberSearchLine").getAttribute("data-id");

      if (!dataId && !LineQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }
      const searchDocumentNumber = document.getElementById("documentNumberSearchLine").value.trim().toLowerCase();
      const searchDate = document.getElementById("searchDateLine").value.trim().toLowerCase();
      const searchLocation = document.getElementById("locationLineSearch").value.trim().toLowerCase();
      const searchCompany = document.getElementById("companySearchLine").value.trim().toLowerCase();
      const generalSearchLine = document.getElementById("generalSearchLine").value.trim().toLowerCase();
      const queryResultsLine = document.getElementById("queryResultsLine");
      const selectedCompanyCodeLine = document.getElementById("selectedCompanyCodeLine").value.trim().toLowerCase();

      queryResultsLine.innerHTML = "⏳ جاري البحث...";

      let linesRef = ref(database, "lines");

      get(linesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();

          let filteredData = Object.keys(data).map(key => ({
            id: key,
            ...data[key]
          })).filter(item =>
            (searchDocumentNumber === "" || String(item.documentNumberLine || "").toLowerCase().includes(searchDocumentNumber)) &&
            (searchDate === "" || String(item.date || "").toLowerCase().includes(searchDate)) &&
            (searchLocation === "" || String(item.location || "").toLowerCase().includes(searchLocation)) &&
            (selectedCompanyCodeLine === "" || String(item.selectedCompanyName || "").toLowerCase().includes(selectedCompanyCodeLine)) &&
            (searchCompany === "" || String(item.company || "").toLowerCase().includes(searchCompany))
          );

          if (generalSearchLine !== "") {
            filteredData = filteredData.filter(item =>
              Object.values(item).some(value =>
                String(value).toLowerCase().includes(generalSearchLine)
              )
            );
          }

          if (filteredData.length === 0) {
            queryResultsLine.innerHTML = "❌ لم يتم العثور على نتائج تطابق الفلاتر.";
            return;
          }

          let table = document.createElement("table");
          table.style.width = "100%";
          table.style.borderCollapse = "collapse";
          table.style.textAlign = "center";

          let thead = document.createElement("thead");
          let headerRow = "<tr>";
          selectedLineColumns.forEach(col => {
            headerRow += `<th>${allLineColumns[col] || col}</th>`;
          });
          headerRow += "</tr>";
          thead.innerHTML = headerRow;
          thead.style.position = "sticky";
          thead.style.top = "0";
          thead.style.backgroundColor = "#fff";
          table.appendChild(thead);

          let tbody = document.createElement("tbody");

          filteredData.forEach(item => {
            let row = document.createElement("tr");

            if (item.deleted) {
              row.style.backgroundColor = "#ffe6e6";
            }

            let rowHtml = "";
            selectedLineColumns.forEach(col => {
              rowHtml += `<td>${item[col] || "null"}</td>`;
            });

            row.innerHTML = rowHtml;
            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          queryResultsLine.innerHTML = "";
          queryResultsLine.appendChild(table);

        } else {
          queryResultsLine.innerHTML = "❌ لا توجد بيانات في قاعدة البيانات.";
        }
      }).catch((err) => {
        queryResultsLine.innerHTML = "❌ حدث خطأ أثناء البحث: " + err.message;
      });
    };

    const allLineColumns = {
      documentNumberLine: "رقم المستند",
      selectedCompanyName: " اسم الشركه ",
      date: "التاريخ",
      company: "شركة الاتصالات",
      location: "المنطقة",
      employeeName: "اسم الموظف",
      phoneNumber: "رقم الهاتف",
      plans: "الباقات",
      packageType: "نوع الباقة",
      packageSize: "حجم الباقة",
      simNumber: "رقم الـ SIM",
      startDate: "تاريخ البدء",
      packageDuration: "مدة الباقة",
      endDate: "تاريخ الانتهاء",
      notes: "ملاحظات"
    };
    let selectedLineColumns = Object.keys(allLineColumns);

    window.applyColumnFilterLine = function () {
      selectedLineColumns = Array.from(document.querySelectorAll('.lineColumnCheckbox:checked')).map(cb => cb.value);
      document.getElementById("columnFilterBoxLine").style.display = "none";
      searchLine();
    };

    window.toggleColumnFilterLine = function () {
      const box = document.getElementById("columnFilterBoxLine");
      const container = document.getElementById("columnCheckboxesLine");
      box.style.display = box.style.display === "none" ? "block" : "none";

      if (container.innerHTML === "") {
        Object.keys(allLineColumns).forEach(key => {
          container.innerHTML += `
                <label style="display:block;"><input type="checkbox" class="lineColumnCheckbox" value="${key}" checked> ${allLineColumns[key]}</label>
            `;
        });
      }
    };

    window.printTableLine = function () {
      const resultsContainer = document.getElementById("queryResultsLine");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة الأجهزة</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelLine = function () {
      const table = document.querySelector("#queryResultsLine table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "Line" });
      XLSX.writeFile(workbook, "Line_Data.xlsx");
    }

    window.showLineHandoverInvoice = async function (data) {
      try {
        const settingsRef = ref(database, 'companySettings/' + data.selectedCompanyCode);
        const settingsSnapshot = await get(settingsRef);

        if (!settingsSnapshot.exists()) {
          alert("❌ لم يتم العثور على إعدادات الشركة.");
          return;
        }

        const settings = settingsSnapshot.val();

        const html = `
      <html dir="rtl" lang="ar">
      <head>
        <meta charset="UTF-8">
        <title>نموذج استلام عهدة خط هاتف</title>
        <style>
          body { font-family: 'Arial', sans-serif; margin: 40px; direction: rtl; color: #333; }
          .header { display: flex; justify-content: space-between; align-items: center; }
          .header img { height: 80px; }
          .company-info { text-align: left; font-size: 14px; line-height: 1.6; }
          h1 { text-align: center; margin: 30px 0; color: #0d47a1; }
          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
          th { background-color: #f2f2f2; }
          .acknowledgment { margin-top: 30px; font-size: 15px; line-height: 1.8; }
          .signatures { display: flex; justify-content: space-between; margin-top: 50px; }
          .signatures div { width: 30%; text-align: center; }
          .signatures .line { border-top: 1px solid #000; margin-top: 40px; }
        </style>
      </head>
      <body>
        <div class="header">
          <img src="${settings.logoUrl}" alt="شعار الشركة">
          <div class="company-info">
            <div style="font-weight:bold; font-size:18px;">${settings.name}</div>
            <div style="font-size:14px;">${settings.address}</div>
            <div style="font-size:14px;">الهاتف: ${settings.phone}</div>
            <div style="font-size:14px;">البريد الإلكتروني: ${settings.email}</div>
          </div>
        </div>

        <h1>نموذج استلام عهدة خط هاتف</h1>

        <table>
          <tr><th>اسم الموظف</th><th>الموقع</th><th>رقم الهاتف</th><th>شركة الاتصال</th><th>تاريخ التفعيل</th></tr>
          <tr>
            <td>${data.employeeName}</td>
            <td>${data.location}</td>
            <td>${data.phoneNumber}</td>
            <td>${data.company}</td>
            <td>${data.date}</td>
          </tr>
        </table>

        <table>
          <thead>
            <tr><th>م</th><th>الوصف</th><th>القيمة</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>رقم الشريحة (SIM)</td>
              <td>${data.simNumber}</td>
            </tr>
          </tbody>
        </table>

        <div class="acknowledgment">
          أقر أنا الموقع أدناه بأنني استلمت خط الهاتف الموضح أعلاه كاملًا وسليمًا، وأتعهد باستخدامه للأغراض الوظيفية فقط، 
          وفي حال فقدانه أو إساءة استخدامه أتحمل كامل المسؤولية.
        </div>

        <div class="signatures">
          <div><p>توقيع الموظف</p><div class="line"></div></div>
          <div><p>توقيع مسؤول العهدة</p><div class="line"></div></div>
          <div><p>توقيع الإدارة</p><div class="line"></div></div>
        </div>
      </body>
      </html>
    `;

        const printWin = window.open("", "_blank");
        printWin.document.write(html);
        printWin.document.close();
        printWin.focus();
      } catch (error) {
        alert("❌ خطأ أثناء جلب إعدادات الشركة: " + error.message);
        console.error(error);
      }
    };

    /////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////// طلب صيانة IT /////////////////////////////////////////////
    document.getElementById("device").addEventListener("change", function () {
      const value = this.value;
      document.getElementById("RouterDetails").style.display = value === "Router" ? "block" : "none";
    });

    document.getElementById("routerType").addEventListener("change", function () {
      const type = this.value;
      const commonFields = document.getElementById("routerCommonFields");
      const mobileFields = document.getElementById("routerMobileFields");

      if (type === "fixed") {
        commonFields.style.display = "block";
        mobileFields.style.display = "none";
      } else if (type === "mobile") {
        commonFields.style.display = "block";
        mobileFields.style.display = "block";
      } else {
        commonFields.style.display = "none";
        mobileFields.style.display = "none";
      }
    });

    document.getElementById("screenMaintenanc").addEventListener("change", function () {
      const type = this.value;
      const commonFields = document.getElementById("CommonFields");
      const mobileFields = document.getElementById("MobileFields");

      if (type === "عادية") {
        commonFields.style.display = "block";
        mobileFields.style.display = "none";
      } else if (type === "كمبيوتر") {
        commonFields.style.display = "block";
        mobileFields.style.display = "block";
      } else {
        commonFields.style.display = "none";
        mobileFields.style.display = "none";
      }
    });



    const deviceConfig = {
      computer: {
        sectionId: 'computerDetails',
        fieldsToClear: ['pcNumMaintenanc', 'pcUserMaintenanc', 'pcLocationMaintenanc', 'deviceModelMaintenanc']
      },
      laptop: {
        sectionId: 'laptopDetails',
        fieldsToClear: ['pcNumMaintenanc2', 'pcUserMaintenanc2', 'pcLocationMaintenanc2', 'deviceModelMaintenanc2']
      },
      phone: {
        sectionId: 'phoneDetails',
        fieldsToClear: ['docNumberPhoneMaintenanc', 'employeNamePhoneMaintenanc', 'locationPhoneMaintenanc', 'phoneTypeMaintenanc']
      },
      printer: {
        sectionId: 'printerDetails',
        fieldsToClear: ['printerNumMaintenanc', 'printerLocationMaintenanc', 'printerdeviceModelMaintenanc', 'printerModelDetails', 'previousCounter', 'currentCounter', 'totalCounter']
      },
      camera: {
        sectionId: 'cameraDetails',
        fieldsToClear: [
          'cameraNumMaintenanc',
          'cameraLocationMaintenanc',
          'cameradeviceModelMaintenanc',
          'cameraModelDetails',
        ]
      },
      screen: {
        sectionId: 'screenDetails',
        fieldsToClear: [
          'screenMaintenancDoc',
          'screenMaintenanc',
          'screenLocationMaintenanc',
          'deviceModelMaintenancScreen',
          'linkedEmployeeNameMaintenanc'
        ]
      },
      Router: {
        sectionId: 'RouterDetails',
        fieldsToClear: [
          'RouterNumMaintenanc',
          'routerType',
          'RouterCompanyMaintenanc',
          'RouterLocationMaintenanc',
          'RouterdeviceModelMaintenanc',
          'RouterUserNameMaintenanc'
        ]
      }

    };

    document.getElementById('device').addEventListener('change', function () {
      const selected = this.value;
      for (let key in deviceConfig) {
        const cfg = deviceConfig[key];
        const sec = document.getElementById(cfg.sectionId);
        if (selected === key) {
          sec.style.display = 'block';
        } else {
          sec.style.display = 'none';
          cfg.fieldsToClear.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
          });
        }
      }
    });
    function attachBlurListener(inputId, dbPath, matchField, targetMap) {
      const inputEl = document.getElementById(inputId);
      inputEl.addEventListener('blur', function () {
        const val = this.value.trim();

        if (!val) {
          Object.values(targetMap).forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
          });
          inputEl.removeAttribute('data-id');
          return;
        }

        get(ref(database, dbPath))
          .then(snap => {
            if (!snap.exists()) throw new Error("لا توجد بيانات في المسار " + dbPath);
            const data = snap.val();
            let recKey = null, rec = null;

            for (let k in data) {
              if (data[k][matchField] == val) {
                recKey = k;
                rec = data[k];
                break;
              }
            }
            if (!rec) throw new Error("الرقم غير موجود");

            console.log("Found record:", recKey, rec);
            console.log("linkedPC.employee:", rec.linkedPC?.employee);

            inputEl.setAttribute('data-id', recKey);

            for (let field in targetMap) {
              let v;
              if (field.includes('.')) {
                v = field.split('.').reduce((o, p) => o?.[p], rec) || '';
              } else {
                v = rec[field] || '';
              }
              const el = document.getElementById(targetMap[field]);
              if (el) el.value = v;
            }

            document.getElementById("CommonFields").style.display = "block";
            if (rec.linkedPC) {
              document.getElementById("MobileFields").style.display = "block";
            }
          })
          .catch(err => {
            console.warn(err);
            Object.values(targetMap).forEach(id => {
              const el = document.getElementById(id);
              if (el) el.value = '';
            });
            inputEl.removeAttribute('data-id');
            document.getElementById("CommonFields").style.display = "none";
            document.getElementById("MobileFields").style.display = "none";
            alert("⚠️ " + err.message);
          });
      });
    }
    attachBlurListener(
      'screenMaintenancDoc',
      'screens',
      'documentNumberScreen',
      {
        screenLocation: 'screenLocationMaintenanc',
        screenModel: 'deviceModelMaintenancScreen',
        'linkedPC.employee': 'linkedEmployeeNameMaintenanc',
      }
    );

    attachBlurListener('pcNumMaintenanc', 'computers', 'pcNum', {
      pcUser: 'pcUserMaintenanc',
      pcLocation: 'pcLocationMaintenanc',
      deviceModel: 'deviceModelMaintenanc'
    });

    attachBlurListener('pcNumMaintenanc2', 'computers', 'pcNum', {
      pcUser: 'pcUserMaintenanc2',
      pcLocation: 'pcLocationMaintenanc2',
      deviceModel: 'deviceModelMaintenanc2'
    });

    attachBlurListener('printerNumMaintenanc', 'printers', 'doc_number', {
      location: 'printerLocationMaintenanc',
      printer_name: 'printerdeviceModelMaintenanc',
      printer_model: 'printerModelDetails'
    });

    attachBlurListener('cameraNumMaintenanc', 'cameras', 'documentNumberCamera', {
      cameraLocation: 'cameraLocationMaintenanc',
      cameraType: 'cameradeviceModelMaintenanc',
      cameraModel: 'cameraModelDetails'
    });

    attachBlurListener('docNumberPhoneMaintenanc', 'phones', 'documentNumberPhone', {
      employeeNamePhone: 'employeNamePhoneMaintenanc',
      locationPhone: 'locationPhoneMaintenanc',
      phoneType: 'phoneTypeMaintenanc'
    });

    attachBlurListener('RouterNumMaintenanc', 'routers', 'docNumber', {
      providerCompany: 'RouterCompanyMaintenanc',
      location: 'RouterLocationMaintenanc',
      routerModel: 'RouterdeviceModelMaintenanc',
      userNameRouter: 'RouterUserNameMaintenanc'
    });

    function loadCompaniesIntoSelectMaintenance() {
      const companySelect = document.getElementById("CompanySelectMaintenance");
      const queryCompanySelect = document.getElementById("searchCompanySelectMaintenance");
      const CompanySelect = document.getElementById("CompanySelectMaintenance2");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeMaintenance");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (CompanySelect) CompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
          if (CompanySelect) {
            const option3 = document.createElement("option");
            option3.value = company.code;
            option3.textContent = company.name;
            CompanySelect.appendChild(option3);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectMaintenance);

    window.SaveTheMaintenanceRequest = function () {
      const maintenanceDate = document.getElementById('maintenanceDate').value.trim();
      const device = document.getElementById('device').value.trim();
      const name = document.getElementById('name').value.trim();
      const description = document.getElementById('description').value.trim();
      const companyCode = document.getElementById("CompanySelectMaintenance").value;
      const companyName = document.getElementById("CompanySelectMaintenance").selectedOptions[0]?.textContent || "";

      if (!companyCode || !maintenanceDate || !device || !name || !description) {
        alert("برجاء ملء جميع الحقول قبل الحفظ.");
        return;
      }

      if (device === 'computer') {
        const pcStatusEl = document.getElementById('pcStatus');
        if (pcStatusEl) pcStatusEl.value = 'Maintenance';

        const noteEl = document.getElementById('note');
        if (noteEl) noteEl.value = `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`;
      }

      if (device === 'laptop') {
        const pcStatusEl2 = document.getElementById('pcStatus');
        if (pcStatusEl2) pcStatusEl2.value = 'Maintenance';

        const noteEl2 = document.getElementById('note');
        if (noteEl2) noteEl2.value = `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`;
      }

      if (device === 'phone') {
        const phoneStatus = document.getElementById('phoneStatus');
        if (phoneStatus) phoneStatus.value = 'Maintenance';

        const notesPhone = document.getElementById('notesPhone');
        if (notesPhone) notesPhone.value = `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`;
      }
      if (device === 'printer') {
        const printerStatus = document.getElementById('statusPrint');
        if (printerStatus) printerStatus.value = 'Maintenance';

        const notesPrint = document.getElementById('notesPrint');
        if (notesPrint) notesPrint.value = `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`;
      }

      if (device === 'Router') {
        const deviceStatusRouter = document.getElementById('deviceStatusRouter');
        if (deviceStatusRouter) deviceStatusRouter.value = 'Maintenance';

        const notesPouter = document.getElementById('notes');
        if (notesPouter) notesPouter.value = `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`;
      }
      if (device === 'screen') {
        const condition = document.getElementById('condition');
        if (condition) condition.value = 'Maintenance';

        const notesScreen = document.getElementById('notesScreen');
        if (notesScreen) notesScreen.value = `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`;
      }
      if (device === 'camera') {
        const cameraCondition = document.getElementById('cameraCondition');
        if (cameraCondition) condition.value = 'Maintenance';

        const notesCamera = document.getElementById('notesCamera');
        if (notesCamera) notesCamera.value = `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`;
      }
      let extraData = {};

      switch (device) {
        case 'computer':
          extraData = {
            pcNum: document.getElementById('pcNumMaintenanc').value.trim(),
            pcUser: document.getElementById('pcUserMaintenanc').value.trim(),
            location: document.getElementById('pcLocationMaintenanc').value.trim(),
            deviceModel: document.getElementById('deviceModelMaintenanc').value.trim(),
            pcStatus: "Maintenance",
            note: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
          };
          break;
        case 'laptop':
          extraData = {
            pcNum2: document.getElementById('pcNumMaintenanc2').value.trim(),
            pcUser2: document.getElementById('pcUserMaintenanc2').value.trim(),
            location2: document.getElementById('pcLocationMaintenanc2').value.trim(),
            deviceModel2: document.getElementById('deviceModelMaintenanc2').value.trim(),
            pcStatus2: "Maintenance",
            note2: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
          };
          break;
        case 'phone':
          extraData = {
            documentNumberPhone: document.getElementById('docNumberPhoneMaintenanc').value.trim(),
            employeeNamePhone: document.getElementById('employeNamePhoneMaintenanc').value.trim(),
            location: document.getElementById('locationPhoneMaintenanc').value.trim(),
            phoneType: document.getElementById('phoneTypeMaintenanc').value.trim(),
            phoneStatus: "Maintenance",
            notesPhone: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
          };
          break;
        case 'printer':
          extraData = {
            doc_number: document.getElementById('printerNumMaintenanc').value.trim(),
            location: document.getElementById('printerLocationMaintenanc').value.trim(),
            printer_name: document.getElementById('printerdeviceModelMaintenanc').value.trim(),
            printer_model: document.getElementById('printerModelDetails').value.trim(),
            previousCounter: document.getElementById('previousCounter').value.trim(),
            currentCounter: document.getElementById('currentCounter').value.trim(),
            totalCounter: document.getElementById('totalCounter').value.trim(),
            printerStatus: "Maintenance",
            notes: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
          };
          break;
        case 'camera':
          extraData = {
            documentNumberCamera: document.getElementById('cameraNumMaintenanc').value.trim(),
            cameraLocation: document.getElementById('cameraLocationMaintenanc').value.trim(),
            cameraType: document.getElementById('cameradeviceModelMaintenanc').value.trim(),
            cameraModel: document.getElementById('cameraModelDetails').value.trim(),
            cameraCondition: "Maintenance",
            notesCamera: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
          };
          break;
        case 'screen':
          const screenTypeValue = document.getElementById('screenMaintenanc').value;
          if (!screenTypeValue) {
            alert("⚠️ الرجاء اختيار نوع الشاشة (عادية أو كمبيوتر).");
            return;
          }

          extraData = {
            documentNumberScreen: document.getElementById('screenMaintenancDoc').value.trim(),
            screenLocation: document.getElementById('screenLocationMaintenanc').value.trim(),
            screenModel: document.getElementById('deviceModelMaintenancScreen').value.trim(),
            screenType: screenTypeValue,
            condition: "Maintenance",
            notesScreen: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
          };

          if (screenTypeValue === "كمبيوتر") {
            extraData.linkedEmployeeName = document.getElementById('linkedEmployeeNameMaintenanc').value.trim();
          }
          break;

        case 'Router':
          const routerType = document.getElementById('routerType').value;
          if (!routerType) {
            alert("⚠️ الرجاء اختيار نوع الراوتر (ثابت أو متنقل)");
            return;
          }

          extraData = {
            routerType,
            docNumber: document.getElementById('RouterNumMaintenanc').value.trim(),
            providerCompany: document.getElementById('RouterCompanyMaintenanc').value.trim(),
            location: document.getElementById('RouterLocationMaintenanc').value.trim(),
            routerModel: document.getElementById('RouterdeviceModelMaintenanc').value.trim(),
            deviceStatusRouter: "Maintenance",
            notes: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
          };

          if (routerType === 'mobile') {
            extraData.userNameRouter = document.getElementById('RouterUserNameMaintenanc').value.trim();
          }
          break;
      }

      console.log("extraData values before validation:", extraData);

      for (let key in extraData) {
        if (
          (!extraData[key] || extraData[key].trim() === '') &&
          !(key === 'userNameRouter' && extraData.routerType === 'fixed')
        ) {
          alert("⚠️ تأكد من إدخال جميع بيانات الجهاز قبل الحفظ.");
          return;
        }
      }


      const counterRef = ref(database, 'maintenanceCounter');

      get(counterRef).then((snapshot) => {
        let maintenanceId = 1;
        if (snapshot.exists()) {
          maintenanceId = snapshot.val() + 1;
        }

        const requestRef = ref(database, `maintenance/${maintenanceId}`);

        const requestData = {
          maintenanceId,
          maintenanceDate,
          device,
          name,
          description,
          status: "قيد الانتظار",
          createdAt: new Date().toISOString(),
          price: "",
          fixDetails: "",
          repairDate: "",
          isDeleted: false,
          company: {
            code: companyCode,
            name: companyName
          },
          ...extraData
        };

        console.log(" requestData = ", requestData);

        set(requestRef, requestData)
          .then(() => {
            set(counterRef, maintenanceId);
            alert("✅ تم حفظ الطلب بنجاح!");
            if (device === 'computer') {
              const pcNum = extraData.pcNum;
              if (pcNum) {
                get(ref(database, "computers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.pcNum == pcNum && !data.deleted) {
                      const updateRef = ref(database, "computers/" + childSnapshot.key);
                      update(updateRef, {
                        pcStatus: "Maintenance",
                        note: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث سجل الكمبيوتر:", error);
                });
              }
            }

            if (device === 'Router') {
              const docNumber = extraData.docNumber

              if (docNumber) {
                get(ref(database, "routers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.docNumber == docNumber && !data.deleted) {
                      const updateRef = ref(database, "routers/" + childSnapshot.key);
                      update(updateRef, {
                        deviceStatus: "Maintenance",
                        notes: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث سجل الكمبيوتر:", error);
                });
              }
            }

            if (device === 'printer') {
              const docNumber = extraData.docNumber;
              if (docNumber) {
                get(ref(database, "printers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.docNumber == docNumber && !data.deleted) {
                      const updateRef = ref(database, "printers/" + childSnapshot.key);
                      update(updateRef, {
                        deviceStatus: "Maintenance",
                        notes: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث سجل الرواتر:", error);
                });
              }
            }
            if (device === 'camera') {
              const documentNumberCamera = extraData.documentNumberCamera;
              if (documentNumberCamera) {
                get(ref(database, "cameras")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.documentNumberCamera == documentNumberCamera && !data.deleted) {
                      const updateRef = ref(database, "cameras/" + childSnapshot.key);
                      update(updateRef, {
                        cameraCondition: "Maintenance",
                        notesCamera: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث سجل الرواتر:", error);
                });
              }
            }
            if (device === 'laptop') {
              const pcNum = extraData.pcNum;
              if (pcNum) {
                get(ref(database, "computers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.pcNum == pcNum && !data.deleted) {
                      const updateRef = ref(database, "computers/" + childSnapshot.key);
                      update(updateRef, {
                        pcStatus: "Maintenance",
                        note: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث سجل الكمبيوتر:", error);
                });
              }
            }

            if (device === 'phone') {
              const documentNumberPhone = extraData.documentNumberPhone;
              if (documentNumberPhone) {
                get(ref(database, "phones")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.documentNumberPhone == documentNumberPhone && !data.deleted) {
                      const updateRef = ref(database, "phones/" + childSnapshot.key);
                      update(updateRef, {
                        phoneStatus: "Maintenance",
                        notesPhone: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث سجل الكمبيوتر:", error);
                });
              }
            }
            if (device === 'screen') {
              const screenDoc = extraData.documentNumberScreen;
              if (screenDoc) {
                get(ref(database, "screens")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.documentNumberScreen == screenDoc && !data.deleted) {
                      const updateRef = ref(database, "screens/" + childSnapshot.key);
                      update(updateRef, {
                        condition: "Maintenance",
                        notesScreen: `تم إدخال الجهاز في الصيانة يوم ${maintenanceDate}`
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث سجل الشاشات:", error);
                });
              }
            }

            document.getElementById('maintenanceDate').value = '';
            document.getElementById('device').value = '';
            document.getElementById('name').value = '';
            document.getElementById('description').value = '';

            const config = deviceConfig[device];
            if (config && config.fieldsToClear) {
              config.fieldsToClear.forEach(id => document.getElementById(id).value = '');
            }

            loadMaintenanceRequests();
          })
          .catch((error) => {
            console.error("❌ خطأ في حفظ البيانات:", error);
            alert("حدث خطأ أثناء حفظ البيانات.");
          });
      }).catch((error) => {
        console.error("❌ خطأ في قراءة العداد:", error);
        alert("حدث خطأ أثناء قراءة العداد.");
      });
    };

    function loadMaintenanceRequests() {
      const tbody = document.querySelector('#maintenanceTable tbody');
      tbody.innerHTML = '';

      const requestsRef = ref(database, 'maintenance');

      get(requestsRef).then((snapshot) => {
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const request = childSnapshot.val();
            if (request.status === 'تم الإصلاح') return;

            let name = '';
            let docNumber = '';
            let location = '';
            let deviceModel = '';
            let companyName = request.company?.name || '';
            const device = request.device;

            switch (request.device) {
              case 'computer':
                docNumber = request.pcNum || '';
                name = request.pcUser || '';
                location = request.location || '';
                deviceModel = request.deviceModel || '';
                break;
              case 'laptop':
                docNumber = request.pcNum2 || '';
                name = request.pcUser2 || '';
                location = request.location2 || '';
                deviceModel = request.deviceModel2 || '';
                break;
              case 'phone':
                docNumber = request.documentNumberPhone || '';
                name = request.employeeNamePhone || '';
                location = request.location || '';
                deviceModel = request.phoneType || '';
                break;
              case 'printer':
                docNumber = request.doc_number || '';
                location = request.location || '';
                deviceModel = request.printer_model || '';
                break;
              case 'Router':
                docNumber = request.docNumber || '';
                name = request.userNameRouter || '';
                location = request.location || '';
                deviceModel = request.routerModel || '';
                break;
              case 'camera':
                docNumber = request.documentNumberCamera || '';
                location = request.cameraLocation || '';
                deviceModel = request.cameraModel || '';
                break;
              case 'screen':
                docNumber = request.documentNumberScreen || '';
                name = request.linkedEmployeeName || '';
                location = request.screenLocation || '';
                deviceModel = request.screenModel || '';
                break;

            }

            const row = tbody.insertRow();
            row.setAttribute('data-id', request.maintenanceId);
            row.innerHTML = `
          <td>${request.maintenanceId}</td>
          <td>${companyName}</td>
          <td>${name}</td>
          <td>${docNumber}</td>
          <td>${location}</td>
          <td>${deviceModel}</td>
          <td>${request.device}</td>
          <td>${request.maintenanceDate}</td>
          <td>${request.status}</td>
          <td>${request.repairDate || 'لم يتم الإصلاح بعد'}</td>
          <td><button type="button" onclick="window.saveMaintenance('${request.maintenanceId}', this.parentElement.parentElement)">تعديل</button></td>
        `;
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="10">لا توجد طلبات صيانة مسجلة</td></tr>';
        }
      }).catch(error => {
        console.error("❌ فشل في تحميل طلبات الصيانة:", error);
      });
    }

    window.saveMaintenance = function (maintenanceId, row) {
      const maintenanceRef = ref(database, 'maintenance/' + maintenanceId);

      get(maintenanceRef).then((snapshot) => {
        if (snapshot.exists()) {
          const maintenance = snapshot.val();
          const editFormHtml = `
                <tr id="editFormRow_${maintenanceId}">
                    <td colspan="20">
                        <h3>تعديل طلب الصيانة</h3>
                        <form id="maintenanceEditForm">
                            <label for="editPrice">سعر الصيانة:</label>
                            <input type="number" id="editPrice" value="${maintenance.price || ''}" required>
                            <label for="editFixDetails">ما تم إصلاحه:</label>
                            <textarea id="editFixDetails" rows="4" required>${maintenance.fixDetails || ''}</textarea>
                        </form>
                        <button type="button" onclick="saveMaintenanceDetails('${maintenanceId}', this)">حفظ التعديلات</button>

                        <button type="button" onclick="cancelEdit('${maintenanceId}')">❌ إلغاء</button>

                    </td>
                </tr>
            `;

          row.insertAdjacentHTML('afterend', editFormHtml);
        } else {
          alert("الطلب غير موجود.");
        }
      }).catch((error) => {
        console.error("Error fetching maintenance details: ", error);
      });
    }

    window.saveMaintenanceDetails = function (maintenanceId) {
      const price = document.getElementById('editPrice').value.trim();
      const fixDetails = document.getElementById('editFixDetails').value.trim();
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      const companyCode = document.getElementById("CompanySelectMaintenance").value;
      const companyName = document.getElementById("CompanySelectMaintenance").selectedOptions[0]?.textContent || "";

      if (!price || !fixDetails) {
        alert("برجاء إدخال بيانات الإصلاح.");
        return;
      }

      const maintenanceRef = ref(database, `maintenance/${maintenanceId}`);

      get(maintenanceRef).then((snapshot) => {
        const oldData = snapshot.val();

        const updatedData = {
          ...oldData,
          price: price,
          fixDetails: fixDetails,
          repairDate: formattedDate,
          company: {
            code: companyCode,
            name: companyName
          },
          status: "تم الإصلاح"
        };

        set(maintenanceRef, updatedData)
          .then(() => {
            alert("✅ تم حفظ التعديلات بنجاح!");

            if (oldData.device === 'laptop') {
              const pcNum = oldData.pcNum;
              if (pcNum) {
                get(ref(database, "computers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.pcNum == pcNum && !data.deleted) {
                      const updateRef = ref(database, "computers/" + childSnapshot.key);

                      const originalNote = data.note || "";
                      const newNote = originalNote + `\nتم إصلاح الجهاز بتاريخ ${formattedDate}`;

                      update(updateRef, {
                        pcStatus: "working",
                        note: newNote
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث حالة الجهاز:", error);
                });
              }
            }

            if (oldData.device === 'printer') {
              const docNumber = oldData.docNumber;
              if (docNumber) {
                get(ref(database, "printers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.docNumber == docNumber && !data.deleted) {
                      const updateRef = ref(database, "printers/" + childSnapshot.key);

                      const originalNote = data.notes || "";
                      const newNote = originalNote + `\nتم إصلاح الجهاز بتاريخ ${formattedDate}`;

                      update(updateRef, {
                        deviceStatus: "working",
                        notes: newNote
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث حالة الجهاز:", error);
                });
              }
            }

            if (oldData.device === 'camera') {
              const documentNumberCamera = oldData.documentNumberCamera;
              if (documentNumberCamera) {
                get(ref(database, "cameras")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.documentNumberCamera == documentNumberCamera && !data.deleted) {
                      const updateRef = ref(database, "printers/" + childSnapshot.key);

                      const originalNote = data.notesCamera || "";
                      const newNote = originalNote + `\nتم إصلاح الجهاز بتاريخ ${formattedDate}`;

                      update(updateRef, {
                        cameraCondition: "working",
                        notesCamera: newNote
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث حالة الجهاز:", error);
                });
              }
            }

            if (oldData.device === 'computer') {
              const pcNum = oldData.pcNum;
              if (pcNum) {
                get(ref(database, "computers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.pcNum == pcNum && !data.deleted) {
                      const updateRef = ref(database, "computers/" + childSnapshot.key);

                      const originalNote = data.note || "";
                      const newNote = originalNote + `\nتم إصلاح الجهاز بتاريخ ${formattedDate}`;

                      update(updateRef, {
                        pcStatus: "working",
                        note: newNote
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث حالة الجهاز:", error);
                });
              }
            }

            if (oldData.device === 'phone') {
              const documentNumberPhone = oldData.documentNumberPhone;
              if (documentNumberPhone) {
                get(ref(database, "phones")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.documentNumberPhone == documentNumberPhone && !data.deleted) {
                      const updateRef = ref(database, "phones/" + childSnapshot.key);

                      const originalNote = data.notesPhone || "";
                      const newNote = originalNote + `\nتم إصلاح الجهاز بتاريخ ${formattedDate}`;

                      update(updateRef, {
                        phoneStatus: "working",
                        notesPhone: newNote
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث حالة الجهاز:", error);
                });
              }
            }

            if (oldData.device === 'Router') {
              const docNumber = oldData.docNumber;
              if (docNumber) {
                get(ref(database, "routers")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.docNumber == docNumber && !data.deleted) {
                      const updateRef = ref(database, "routers/" + childSnapshot.key);

                      const originalNote = data.notes || "";
                      const newNote = originalNote + `\nتم إصلاح الجهاز بتاريخ ${formattedDate}`;

                      update(updateRef, {
                        deviceStatus: "working",
                        notes: newNote
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث حالة الجهاز:", error);
                });
              }
            }
            if (oldData.device === 'screen') {
              const docNumber = oldData.documentNumberScreen;
              if (docNumber) {
                get(ref(database, "screens")).then(snapshot => {
                  snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    if (data.documentNumberScreen == docNumber && !data.deleted) {
                      const updateRef = ref(database, "screens/" + childSnapshot.key);

                      const originalNote = data.notesScreen || "";
                      const newNote = originalNote + `\nتم إصلاح الجهاز بتاريخ ${formattedDate}`;

                      update(updateRef, {
                        condition: "working",
                        notesScreen: newNote
                      });
                    }
                  });
                }).catch(error => {
                  console.error("❌ خطأ في تحديث حالة الجهاز:", error);
                });
              }
            }

            document.getElementById('editPrice').value = '';
            document.getElementById('editFixDetails').value = '';
            document.querySelector(`#maintenanceTable tr[data-id='${maintenanceId}']`)?.remove();

            showMaintenanceInvoice(updatedData);
            loadMaintenanceRequests();

          })
          .catch((error) => {
            console.error("❌ خطأ في حفظ بيانات الإصلاح:", error);
            alert("حدث خطأ أثناء حفظ بيانات الإصلاح.");
          });
      }).catch((error) => {
        console.error("❌ خطأ في جلب بيانات الصيانة:", error);
      });
    };
    let dataFetched = false;
    window.SaveTheMaintenanceRequestModification = function () {
      if (!dataFetched) {
        alert("❌ يجب جلب البيانات قبل الحفظ!");
        return;
      }

      const maintenanceId = document.getElementById('editDocumentNumber').value.trim();

      if (!maintenanceId) {
        alert("❌ خطأ: لم يتم تحديد الطلب المراد تعديله.");
        return;
      }

      const requestRef = ref(database, `maintenance/${maintenanceId}`);

      get(requestRef).then((snapshot) => {
        if (!snapshot.exists()) {
          alert("❌ الطلب غير موجود.");
          return;
        }

        const data = snapshot.val();

        if (data.isDeleted) {
          alert("❌ لا يمكن تعديل البيانات، هذا الطلب محذوف.");
          return;
        }

        if (data.status !== "تم الإصلاح") {
          alert("❌ لا يمكن تعديل الطلب قبل إتمام عملية الإصلاح وحفظ تفاصيله.");
          return;
        }

        const updatedData = {
          device: document.getElementById('editDevice').value.trim(),
          maintenanceDate: document.getElementById('editMaintenanceDate').value.trim(),
          name: document.getElementById('editName').value.trim(),
          description: document.getElementById('editDescription').value.trim(),
          price: document.getElementById('editPrice2').value.trim(),
          fixDetails: document.getElementById('editFixDetails2').value.trim(),
          repairDate: document.getElementById('editFixDate2').value.trim(),
          status: document.getElementById('status2').value.trim(),
          companyName: document.getElementById('CompanySelectMaintenance2').value.trim(),
        };

        update(requestRef, updatedData)
          .then(() => {
            console.log("✅ تم تحديث بيانات الصيانة بنجاح!");
            alert("✅ تم حفظ التعديلات بنجاح!");

            showMaintenanceInvoice(updatedData);
            loadMaintenanceRequests();

            dataFetched = false;
            clearMaintenanceForm();
          })
          .catch((error) => {
            console.error("❌ خطأ في تحديث البيانات:", error);
            alert("❌ حدث خطأ أثناء حفظ التعديلات.");
          });

      }).catch((error) => {
        console.error("❌ خطأ في جلب الطلب:", error.message);
        alert("❌ حدث خطأ أثناء التحقق من الطلب:\n" + error.message);
      });
    };

    function clearMaintenanceForm() {
      document.getElementById('editDocumentNumber').value = "";
      document.getElementById('editDevice').value = "";
      document.getElementById('editMaintenanceDate').value = "";
      document.getElementById('editLocation').value = "";
      document.getElementById('editName').value = "";
      document.getElementById('editDescription').value = "";
      document.getElementById('editPrice2').value = "";
      document.getElementById('editFixDetails2').value = "";
      document.getElementById('editFixDate2').value = "";
      document.getElementById('status2').value = "";
    }

    window.searchMaintenance = function () {
      const maintenanceId = document.getElementById('maintenanceId').value.trim();
      const maintenanceDate = document.getElementById('searchDateMaintenance').value;
      const location = document.getElementById('locationMaintenanceSearch').value;
      const device = document.getElementById('companySearchMaintenance').value;

      const queryRef = ref(database, 'maintenance/');
      let queryStr = '';

      if (maintenanceId) queryStr += `maintenanceId=${maintenanceId}&`;
      if (maintenanceDate) queryStr += `maintenanceDate=${maintenanceDate}&`;
      if (location) queryStr += `location=${location}&`;
      if (device) queryStr += `device=${device}&`;

      queryStr = queryStr.slice(0, -1);

      get(queryRef).then((snapshot) => {
        const results = [];
        if (snapshot.exists()) {
          const requests = snapshot.val();
          for (let id in requests) {
            const request = requests[id];

            const matches =
              (!maintenanceId || request.maintenanceId.toString().includes(maintenanceId)) &&
              (!maintenanceDate || request.maintenanceDate === maintenanceDate) &&
              (!location || deviceLocation.toLowerCase() === location.toLowerCase()) &&
              (!device || request.device === device);

            if (matches) {
              results.push(request);
            }
          }

          displaySearchResults(results);
        } else {
          alert("لا توجد بيانات لطلبات الصيانة.");
        }
      }).catch((error) => {
        console.error("Error reading data: ", error);
      });
    };

    function displaySearchResults(results) {
      const queryResultsDiv = document.getElementById('queryResultsMaintenance');
      queryResultsDiv.innerHTML = '';

      if (results.length === 0) {
        queryResultsDiv.innerHTML = '<p>لا توجد نتائج للبحث.</p>';
        return;
      }

      const table = document.createElement('table');
      const headerRow = document.createElement('tr');

      headerRow.innerHTML = `
        <th>رقم الطلب</th>
        <th>تاريخ العطل</th>
        <th>الجهاز</th>
        <th>رقم الجهاز</th>
        <th>المستخدم</th>
        <th>الموقع</th>
        <th>موديل / نوع الجهاز</th>
        <th>عداد سابق</th>
        <th>عداد حالي</th>
        <th>الإجمالي</th>
        <th> الشركه  / نوع الراوتر</th>
        <th> الحاله</th>
        <th>وصف العطل</th>
        <th>تاريخ الإصلاح</th>
        <th>سعر الصيانة</th>
        <th>تفاصيل الإصلاح</th>
        <th>ملاحظات</th>
    `;
      table.appendChild(headerRow);

      results.forEach((request) => {
        const row = document.createElement('tr');

        row.style.cursor = 'pointer';
        row.ondblclick = () => showMaintenanceInvoice(request);

        if (request.deleted === true) {
          row.style.backgroundColor = '#ffcccc';
          row.style.opacity = '0.6';
          row.style.textDecoration = 'line-through';
        }

        const device = request.device;

        let deviceNum = '';
        let user = '';
        let location = '';
        let model = '';
        let notes = '';
        let routerType = '';
        let providerCompany = '';
        let previousCounter = '';
        let currentCounter = '';
        let totalCounter = '';


        switch (device) {
          case 'computer':
            deviceNum = request.pcNum || '';
            user = request.pcUser || '';
            location = request.location || '';
            model = request.deviceModel || '';
            notes = request.note || '';
            break;
          case 'laptop':
            deviceNum = request.pcNum2 || '';
            user = request.pcUser2 || '';
            location = request.location2 || '';
            model = request.deviceModel2 || '';
            notes = request.note2 || '';
            break;
          case 'phone':
            deviceNum = request.documentNumberPhone || '';
            user = request.employeeNamePhone || '';
            location = request.location || '';
            model = request.phoneType || '';
            notes = request.notesPhone || '';
            break;
          case 'printer':
            deviceNum = request.doc_number || '';
            location = request.location || '';
            model = request.printer_model || '';
            previousCounter = request.previousCounter || '';
            currentCounter = request.currentCounter || '';
            totalCounter = request.totalCounter || '';
            notes = request.notes || '';
            break;
          case 'Router':
            deviceNum = request.docNumber || '';
            user = request.userNameRouter || '';
            location = request.location || '';
            model = request.routerModel || '';
            notes = request.notes || '';
            routerType = request.routerType || '';
            providerCompany = request.providerCompany || '';
            break;
          case 'camera':
            deviceNum = request.documentNumberCamera || '';
            location = request.cameraLocation || '';
            model = request.cameraModel || '';
            notes = request.notesCamera || '';
            break;
          case 'screen':
            deviceNum = request.documentNumberScreen || '';
            user = request.linkedEmployeeName || '';
            location = request.screenLocation || '';
            model = request.screenModel || '';
            notes = request.notesScreen || '';
            break;
        }

        row.innerHTML = `
            <td>${request.maintenanceId || ''}</td>
            <td>${request.maintenanceDate || ''}</td>
            <td>${device || ''}</td>
            <td>${deviceNum}</td>
            <td>${user}</td>
            <td>${location}</td>
            <td>${model}</td>
            <td>${previousCounter}</td>
            <td>${currentCounter}</td>
            <td>${totalCounter}</td>
            <td>${providerCompany}</td>
            <td>${request.status || ''}</td>
            <td>${request.description || ''}</td>
            <td>${request.repairDate || 'لم يتم الإصلاح بعد'}</td>
            <td>${request.price || ''}</td>
            <td>${request.fixDetails || ''}</td>
            <td>${notes}</td>
        `;

        table.appendChild(row);
      });

      queryResultsDiv.appendChild(table);
    }

    window.onload = loadMaintenanceRequests;

    window.cancelEdit = function (maintenanceId) {
      const editFormRow = document.getElementById(`editFormRow_${maintenanceId}`);
      if (editFormRow) {
        editFormRow.remove();
      } else {
        console.error("لم يتم العثور على نموذج التعديل.");
      }
    };

    window.showMaintenanceInvoice = async function (maintenanceData) {
      try {
        const settingsRef = ref(database, `companySettings/${maintenanceData.company.code}`);
        const snapshot = await get(settingsRef);

        if (!snapshot.exists()) {
          alert("❌ لم يتم العثور على إعدادات الشركة.");
          return;
        }
        const settings = snapshot.val();

        let employeeName = '';
        let locationName = '';
        switch (maintenanceData.device) {
          case 'computer':
            employeeName = maintenanceData.pcUser || '';
            locationName = maintenanceData.location || '';
            break;
          case 'laptop':
            employeeName = maintenanceData.pcUser2 || '';
            locationName = maintenanceData.location2 || '';
            break;
          case 'phone':
            employeeName = maintenanceData.employeeNamePhone || '';
            locationName = maintenanceData.location || '';
            break;
          case 'printer':
            locationName = maintenanceData.location || '';
            break;
          case 'Router':
            employeeName = maintenanceData.userNameRouter || '';
            locationName = maintenanceData.location || '';
            break;
          case 'screen':
            employeeName = maintenanceData.linkedEmployeeName || '';
            locationName = maintenanceData.screenLocation || '';
            break;
          case 'camera':
            locationName = maintenanceData.cameraLocation || '';
            break;
          default:
            employeeName = maintenanceData.name || '';
            locationName = maintenanceData.location || '';
        }

        const template = `
      <div id="invoiceBody"
           style="font-family: 'Arial', sans-serif; direction: rtl; padding:40px; position: relative; background:#fff; border:1px solid #ccc;">

        <!-- Watermark -->
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-50deg);
                    opacity:0.05; font-size:100px; font-weight:bold; color:#000; white-space:nowrap;">
          ${settings.watermark || ''}
        </div>

        <!-- Header -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div style="text-align:left; line-height:1.6;">
            <div style="font-weight:bold; font-size:18px;">${settings.name}</div>
            <div style="font-size:14px;">${settings.address}</div>
            <div style="font-size:14px;">${settings.phone}</div>
            <div style="font-size:14px;">${settings.email}</div>
          </div>
          <div style="text-align:center; margin-top:20px;">
            <canvas id="qrcanvas"></canvas>
            <p style="font-size:10px; color:#555; margin-top:3px;">QR Code for Maintenance</p>
          </div>
          <img src="${settings.logoUrl}" alt="Company Logo" style="height:100px;">
        </div>

        <!-- Title -->
        <h2 style="text-align:center; background:#673AB7; color:#fff; padding:10px 0; margin-top:20px;">
          فاتورة صيانة – Maintenance Invoice
        </h2>

        <!-- Meta info -->
        <div style="display:flex; justify-content:space-between; margin-top:20px; font-size:15px;">
          <div>
            <div><strong>رقم الطلب:</strong> ${maintenanceData.maintenanceId}</div>
            <div><strong>تاريخ الطلب:</strong> ${maintenanceData.maintenanceDate}</div>
            <div><strong>تاريخ الإصلاح:</strong> ${maintenanceData.repairDate || 'لم يتم الإصلاح بعد'}</div>
          </div>
          <div style="text-align:left;">
            <div><strong>اسم الموظف:</strong> ${employeeName}</div>
            <div><strong>نوع الجهاز:</strong> ${maintenanceData.device}</div>
            <div><strong>الموقع:</strong> ${locationName}</div>
          </div>
        </div>

        <!-- Maintenance Table -->
        <table style="width:100%; border-collapse:collapse; margin-top:25px; font-size:14px;">
          <thead>
            <tr style="background:#eee; border-bottom:2px solid #000;">
              <th>الوصف</th>
              <th>التفاصيل</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid #ccc;">
              <td style="text-align:center;">سبب الصيانة</td>
              <td style="text-align:center;">${maintenanceData.description || ''}</td>
            </tr>
            <tr style="border-bottom:1px solid #ccc;">
              <td style="text-align:center;">تفاصيل الإصلاح</td>
              <td style="text-align:center;">${maintenanceData.fixDetails || ''}</td>
            </tr>
            <tr style="background:#E1BEE7; font-weight:bold;">
              <td>سعر الصيانة</td>
              <td>${maintenanceData.price ? parseFloat(maintenanceData.price).toFixed(2) + ' ج.م' : '0.00 ج.م'}</td>
            </tr>
          </tbody>
        </table>

        <!-- Signatures -->
        <div style="display:flex; justify-content:space-between; margin-top:50px; border-top:1px solid #ccc; padding-top:30px;">
          <div style="width:30%; text-align:center;">
            <p>مدير الموقع</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
            <p style="font-size:12px; color:#555;">Site Manager Signature</p>
          </div>
          <div style="width:30%; text-align:center;">
            <p>مدير تقنية المعلومات</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
            <p style="font-size:12px; color:#555;">IT Manager Signature</p>
          </div>
          <div style="width:30%; text-align:center;">
            <p>المدير العام</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
            <p style="font-size:12px; color:#555;">General Manager Signature</p>
          </div>
        </div>
      </div>
    `;
        const w = window.open("", "_blank");
        w.document.write(template);
        w.document.close();
        w.onload = () => {
          QRCode.toCanvas(
            w.document.getElementById('qrcanvas'),
            JSON.stringify({
              requestId: maintenanceData.maintenanceId,
              price: maintenanceData.price || 0
            }),
            { width: 100 }
          );
        };

      } catch (error) {
        console.error("❌ حدث خطأ أثناء تحميل إعدادات الشركة:", error);
        alert("❌ تعذر تحميل إعدادات الشركة");
      }
    };

    /////////////////////////////////////////////////////////////////////////////////
    //////////////////////////// إدارة الأصناف /////////////////////////////////////
    window.saveAddItems = async function () {
      const itemNameInput = document.getElementById('itemName');
      const itemCodeInput = document.getElementById('itemCode');

      const itemName = itemNameInput.value.trim();
      let itemCode = parseInt(itemCodeInput.value.trim());

      if (!itemName) {
        return alert("يرجى إدخال اسم الصنف قبل الحفظ.");
      }

      const counterRef = ref(database, 'itemCounter');

      try {
        if (!itemCode) {
          const snapshot = await get(counterRef);
          itemCode = snapshot.exists() ? snapshot.val() + 1 : 1;
          itemCodeInput.value = itemCode;
        }

        const itemRef = ref(database, `items/${itemCode}`);
        const itemData = {
          itemCode,
          itemName,
          updatedAt: new Date().toISOString()
        };

        await set(itemRef, itemData);

        const counterSnap = await get(counterRef);
        const currentCounter = counterSnap.exists() ? counterSnap.val() : 0;
        if (itemCode > currentCounter) {
          await set(counterRef, itemCode);
        }

        alert("✅ تم حفظ الصنف بنجاح!");
        itemNameInput.value = '';
        itemCodeInput.value = '';
        if (typeof loadItems === 'function') loadItems();

      } catch (error) {
        console.error("❌ خطأ أثناء حفظ الصنف:", error);
        alert("حدث خطأ أثناء حفظ البيانات. حاول مجددًا.");
      }
    };

    window.fetchItemByCode = async function () {
      const code = document.getElementById("itemCode").value.trim();
      const nameInput = document.getElementById("itemName");

      if (!code) {
        nameInput.value = "";
        return;
      }

      const itemRef = ref(database, `items/${code}`);

      try {
        const snapshot = await get(itemRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          nameInput.value = data.itemName || "";
        } else {
          nameInput.value = "";
        }
      } catch (error) {
        console.error("❌ خطأ أثناء جلب بيانات الصنف:", error);
        alert("حدث خطأ أثناء جلب بيانات الصنف.");
      }
    };

    window.loadItems = async function () {
      const itemsTableBody = document.querySelector("#querySection tbody");
      itemsTableBody.innerHTML = "";

      const itemsRef = ref(database, 'items');

      try {
        const snapshot = await get(itemsRef);

        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();
            const row = document.createElement("tr");

            row.innerHTML = `
                    <td>${item.itemCode}</td>
                    <td>${item.itemName}</td>
                    <td>
                        <button onclick="deleteItem(${item.itemCode})" class="btn btn-danger btn-sm">🗑 حذف</button>
                    </td>
                `;

            itemsTableBody.appendChild(row);
          });
        } else {
          itemsTableBody.innerHTML = `<tr><td colspan="3" class="text-center">لا توجد أصناف مسجلة</td></tr>`;
        }
      } catch (error) {
        console.error("❌ خطأ في تحميل البيانات:", error);
        alert("حدث خطأ أثناء تحميل الأصناف.");
      }
    };

    window.deleteItem = function (itemCode) {
      const itemRef = ref(database, `items/${itemCode}`);

      if (confirm("هل أنت متأكد من حذف هذا الصنف؟")) {
        set(itemRef, null)
          .then(() => {
            console.log("✅ تم حذف الصنف بنجاح!");
            alert("تم حذف الصنف بنجاح!");
            searchItems();
          })
          .catch((error) => {
            console.error("❌ خطأ في حذف الصنف:", error);
            alert("حدث خطأ أثناء حذف الصنف.");
          });
      }
    };

    window.searchItems = async function () {
      const searchValue = document.getElementById('searchInput').value.trim().toLowerCase();
      const itemsTableBody = document.querySelector("#querySection tbody");
      itemsTableBody.innerHTML = "";

      const itemsRef = ref(database, 'items');

      try {
        const snapshot = await get(itemsRef);

        if (snapshot.exists()) {
          let found = false;
          snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();

            if (item.itemName.toLowerCase().includes(searchValue)) {
              const row = document.createElement("tr");

              row.innerHTML = `
                        <td>${item.itemCode}</td>
                        <td>${item.itemName}</td>
                        <td>
                            <button onclick="deleteItem(${item.itemCode})" class="btn btn-danger btn-sm">🗑 حذف</button>
                        </td>
                    `;

              itemsTableBody.appendChild(row);
              found = true;
            }
          });

          if (!found) {
            itemsTableBody.innerHTML = `<tr><td colspan="3" class="text-center">🔍 لا توجد نتائج مطابقة</td></tr>`;
          }
        } else {
          itemsTableBody.innerHTML = `<tr><td colspan="3" class="text-center">لا توجد أصناف مسجلة</td></tr>`;
        }
      } catch (error) {
        console.error("❌ خطأ في البحث:", error);
        alert("حدث خطأ أثناء البحث.");
      }
    };

    ///////////////////////////////////////////////////////////////////////
    ////////////////////////// إدارة المناطق ////////////////////////////
/* ===================== خريطة وواجهة عامة ===================== */
var map = L.map('map').setView([0, 0], 2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

var marker = L.marker([0, 0], { draggable: true }).addTo(map);
var circle = null;

function updateInputs(lat, lng) {
  document.getElementById("lat").value = (lat === null || lat === undefined) ? '' : lat.toFixed(6);
  document.getElementById("lng").value = (lng === null || lng === undefined) ? '' : lng.toFixed(6);
  updateCircle();
}

marker.on('dragend', function () {
  var pos = marker.getLatLng();
  updateInputs(pos.lat, pos.lng);
});

map.on('click', function (e) {
  marker.setLatLng(e.latlng);
  updateInputs(e.latlng.lat, e.latlng.lng);
});

document.getElementById("lat").addEventListener("change", moveMapToInputs);
document.getElementById("lng").addEventListener("change", moveMapToInputs);
document.getElementById("radius").addEventListener("change", updateCircle);

function moveMapToInputs() {
  let lat = parseFloat(document.getElementById("lat").value);
  let lng = parseFloat(document.getElementById("lng").value);
  if (!isNaN(lat) && !isNaN(lng)) {
    marker.setLatLng([lat, lng]);
    map.setView([lat, lng], 12);
    updateCircle();
  }
}

function updateCircle() {
  let lat = parseFloat(document.getElementById("lat").value);
  let lng = parseFloat(document.getElementById("lng").value);
  let radius = parseInt(document.getElementById("radius").value);

  if (!isNaN(lat) && !isNaN(lng) && !isNaN(radius) && radius > 0) {
    if (circle) map.removeLayer(circle);
    circle = L.circle([lat, lng], { radius: radius, color: "blue", fillOpacity: 0.2 }).addTo(map);
  } else {
    if (circle) { map.removeLayer(circle); circle = null; }
  }
}

map.locate({ setView: true, maxZoom: 12 });

map.on('locationfound', function (e) {
  marker.setLatLng(e.latlng);
  updateInputs(e.latlng.lat, e.latlng.lng);
});

    window.saveAddRegion = async function () {
      const code = document.getElementById("RegionCode").value.trim();
      const name = document.getElementById("RegionName").value.trim();
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const radius = parseInt(document.getElementById("radius").value);

      if (!code || !name) {
        alert("يرجى إدخال رقم واسم المنطقة.");
        return;
      }

      const regionRef = ref(database, `Region/${code}`);

      try {
        const snapshot = await get(regionRef);
        const regionData = {
          RegionCode: parseInt(code),
          RegionName: name,
          Lat: lat,
          Lng: lng,
          Radius: radius
        };

        await set(regionRef, regionData);

        const counterRef = ref(database, 'RegionCounter');
        const currentCounterSnap = await get(counterRef);
        const currentMax = currentCounterSnap.exists() ? currentCounterSnap.val() : 0;

        if (parseInt(code) > currentMax) {
          await set(counterRef, parseInt(code));
        }

        alert(snapshot.exists() ? "✅ تم تحديث اسم المنطقة." : "✅ تم حفظ المنطقة الجديدة.");
        if (typeof loadRegion === 'function') loadRegion();

        document.getElementById("RegionCode").value = "";
        document.getElementById("RegionName").value = "";
        document.getElementById("lat").value = "";
        document.getElementById("lng").value = "";
        document.getElementById("radius").value = "";
      } catch (error) {
        console.error("❌ خطأ أثناء الحفظ أو التحديث:", error);
        alert("حدث خطأ أثناء العملية.");
      }
    };

    window.fetchRegionByCode = async function () {
      const code = document.getElementById("RegionCode").value.trim();

      const nameInput = document.getElementById("RegionName");
      const latInput = document.getElementById("lat");
      const lngInput = document.getElementById("lng");
      const radiusInput = document.getElementById("radius");

      if (!code) {
        nameInput.value = "";
        latInput.value = "";
        lngInput.value = "";
        radiusInput.value = "";
        return;
      }

      const regionRef = ref(database, `Region/${code}`);

      try {
        const snapshot = await get(regionRef);
        if (snapshot.exists()) {
          const data = snapshot.val();

          nameInput.value = data.RegionName || "";
          latInput.value = data.Lat || "";
          lngInput.value = data.Lng || "";
          radiusInput.value = data.Radius || "";

          if (data.Lat && data.Lng) {
            marker.setLatLng([parseFloat(data.Lat), parseFloat(data.Lng)]);
            map.setView([parseFloat(data.Lat), parseFloat(data.Lng)], 12);
            updateCircle();
          }

        } else {
          nameInput.value = "";
          latInput.value = "";
          lngInput.value = "";
          radiusInput.value = "";
        }
      } catch (error) {
        console.error("❌ خطأ أثناء جلب بيانات المنطقة:", error);
        alert("حدث خطأ أثناء جلب بيانات المنطقة.");
      }
    };

    window.loadRegion = function () {
      const regionDropdownIds = [
        'editLocation', 'maintenanceLocation', 'locationMaintenanceSearch', 'locationAddition',
        'filterRegion', 'locationDisbursement', 'pcLocation', 'queryPcLocation',
        'locationLine', 'locationPrint', 'locationRouter', 'siteLocation',
        'locationPhone', 'purchaseLocation', 'purchaseLocationOrder', 'queryLocation',
        'LocationDelivery', 'LocationDelivery2', 'screenLocation', 'queryScreenLocation',
        'filter_Location_camera', 'cameraLocation', 'locationGPS', 'queryLocationGPS'
      ];

      const regionRef = ref(database, 'Region');

      get(regionRef)
        .then(snapshot => {
          if (!snapshot.exists()) {
            console.warn("🚫 لا توجد بيانات في مسار Region");
            return;
          }
          const regions = [];
          snapshot.forEach(child => {
            const data = child.val();
            if (data && data.RegionName) {
              regions.push(data.RegionName);
            }
          });

          if (regions.length === 0) {
            console.warn("🚫 لا توجد أسماء مناطق صالحة");
            return;
          }

          regionDropdownIds.forEach(id => {
            const select = document.getElementById(id);
            if (select) {
              select.innerHTML = '<option value="">- اختر المنطقة -</option>';
              regions.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
              });
            }
          });
        })
        .catch(error => {
          console.error("❌ خطأ أثناء تحميل المناطق:", error.message);
        });
    };
    window.onload = function () {
      loadRegion();
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadRegion();
    })

    window.deleteRegion = function (RegionCode) {
      if (confirm("هل أنت متأكد من حذف هذه المنطقة؟")) {
        const regionRef = ref(database, `Region/${RegionCode}`);
        set(regionRef, null)
          .then(() => {
            alert("✅ تم حذف المورد بنجاح");
            searchRegion();
          })
          .catch((error) => {
            alert("❌ فشل الحذف");
            console.error(error);
          });
      }
    };

    window.searchRegion = function () {
      const searchValue = document.getElementById('searchRegion').value.trim().toLowerCase();
      const itemsTableBody = document.querySelector("#queryRegion tbody");
      itemsTableBody.innerHTML = "";

      const itemsRef = ref(database, 'Region');

      get(itemsRef).then(snapshot => {
        if (snapshot.exists()) {
          let found = false;
          snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();

            if (item.RegionName.toLowerCase().includes(searchValue)) {
              const row = document.createElement("tr");
              row.innerHTML = `
                        <td>${item.RegionCode}</td>
                        <td>${item.RegionName}</td>
                        <td>${item.Lat}</td>
                        <td>${item.Lng}</td>
                        <td>${item.Radius}</td>
                        <td>
                            <button onclick="deleteRegion(${item.RegionCode})" class="btn btn-danger btn-sm">🗑 حذف</button>
                        </td>
                    `;
              itemsTableBody.appendChild(row);
              found = true;
            }
          });

          if (!found) {
            itemsTableBody.innerHTML = `<tr><td colspan="3" class="text-center">🔍 لا توجد نتائج مطابقة</td></tr>`;
          }
        } else {
          itemsTableBody.innerHTML = `<tr><td colspan="3" class="text-center">لا توجد مناطق مسجلة</td></tr>`;
        }
      }).catch(error => {
        console.error("❌ خطأ في البحث:", error);
        alert("حدث خطأ أثناء البحث.");
      });
    };

    ///////////////////////////////////////////////////////////////
    ///////////////////////// إدارة الموردين ////////////////////
    window.fetchResourceByCode = async function () {
      const code = document.getElementById("ResourceCode").value.trim();
      if (!code) return;

      const resourcesRef = ref(database, "resources");

      try {
        const snapshot = await get(resourcesRef);
        if (!snapshot.exists()) return;

        let found = false;
        snapshot.forEach(child => {
          const data = child.val();
          if (data.code === code) {
            found = true;

            document.getElementById("ResourceName").value = data.name || "";
            document.getElementById("ResourcePhone").value = data.phone || "";
            document.getElementById("ResourceCountries").value = data.address?.country || "";
            document.getElementById("ResourceGovernorate").value = data.address?.governorate || "";
            document.getElementById("ResourceCity").value = data.address?.city || "";
            document.getElementById("ResourceAddress").value = data.address?.fullAddress || "";
            document.getElementById("ResourceDestination").value = data.taxInfo?.destination || "";
            document.getElementById("ResourceCard").value = data.taxInfo?.taxId || "";
            document.getElementById("ResourceCommercial").value = data.taxInfo?.commercialRecord || "";

            document.getElementById("ResourceCode").setAttribute("data-id", data.id);
          }
        });

        if (!found) {
          clearResourceFieldsExceptCode();
          document.getElementById("ResourceCode").removeAttribute("data-id");
        }

      } catch (error) {
        console.error("❌ خطأ أثناء البحث:", error);
        alert("حدث خطأ أثناء البحث عن المورد.");
      }
    };

    function clearResourceFieldsExceptCode() {
      const ids = [
        "ResourceName", "ResourcePhone", "ResourceCountries", "ResourceGovernorate",
        "ResourceCity", "ResourceAddress", "ResourceDestination", "ResourceCard", "ResourceCommercial"
      ];
      ids.forEach(id => document.getElementById(id).value = "");
    }

    window.saveAddResource = async function () {
      const resourceCodeInput = document.getElementById("ResourceCode");
      let code = resourceCodeInput.value.trim();
      let newId = parseInt(resourceCodeInput.getAttribute("data-id")) || null;

      const name = document.getElementById('ResourceName').value.trim();
      const phone = document.getElementById('ResourcePhone').value.trim();
      const country = document.getElementById('ResourceCountries').value.trim();
      const governorate = document.getElementById('ResourceGovernorate').value.trim();
      const city = document.getElementById('ResourceCity').value.trim();
      const address = document.getElementById('ResourceAddress').value.trim();
      const destination = document.getElementById('ResourceDestination').value.trim();
      const card = document.getElementById('ResourceCard').value.trim();
      const commercial = document.getElementById('ResourceCommercial').value.trim();

      if (!name || !phone || !country || !governorate || !city || !address || !destination || !card || !commercial) {
        alert("❌ من فضلك أدخل جميع الحقول.");
        return;
      }

      const phoneRegex = /^\d{11}$/;
      if (!phoneRegex.test(phone)) {
        alert("❌ رقم الهاتف يجب أن يكون 11 رقمًا.");
        return;
      }

      const counterRef = ref(database, "resources_counter");

      if (!newId) {
        const snapshot = await get(counterRef);
        newId = snapshot.exists() ? snapshot.val() + 1 : 1;
        code = String(newId);
        resourceCodeInput.value = code;
      }

      const newResource = {
        id: newId,
        code,
        name,
        phone,
        address: {
          country,
          governorate,
          city,
          fullAddress: address
        },
        taxInfo: {
          destination,
          taxId: card,
          commercialRecord: commercial
        }
      };

      const resourceRef = ref(database, `resources/${newId}`);

      try {
        await set(resourceRef, newResource);

        const currentCounterSnap = await get(counterRef);
        const currentCounter = currentCounterSnap.exists() ? currentCounterSnap.val() : 0;
        if (newId > currentCounter) {
          await set(counterRef, newId);
        }

        alert("✅ تم حفظ المورد بنجاح.");
        clearResourceFields();
      } catch (error) {
        console.error("❌ خطأ أثناء الحفظ:", error);
        alert("حدث خطأ أثناء الحفظ.");
      }
    };

    function clearResourceFields() {
      document.getElementById("ResourceCode").value = "";
      document.getElementById("ResourceName").value = "";
      document.getElementById("ResourcePhone").value = "";
      document.getElementById("ResourceCountries").value = "";
      document.getElementById("ResourceGovernorate").value = "";
      document.getElementById("ResourceCity").value = "";
      document.getElementById("ResourceAddress").value = "";
      document.getElementById("ResourceDestination").value = "";
      document.getElementById("ResourceCard").value = "";
      document.getElementById("ResourceCommercial").value = "";
      document.getElementById("ResourceCode").removeAttribute("data-id");
    }

    window.deleteResource = function (resourceId) {
      if (confirm("هل أنت متأكد من حذف هذا المورد؟")) {
        const resourceRef = ref(database, `resources/${resourceId}`);
        set(resourceRef, null)
          .then(() => {
            alert("✅ تم حذف المورد بنجاح");
            searchResource();
          })
          .catch((error) => {
            alert("❌ فشل الحذف");
            console.error(error);
          });
      }
    };

    window.searchResource = async function () {
      const searchValue = document.getElementById("searchResource").value.trim().toLowerCase();
      const tableBody = document.querySelector("#queryResource table tbody");
      tableBody.innerHTML = "";

      try {
        const snapshot = await get(ref(database, 'resources'));

        if (!snapshot.exists()) {
          tableBody.innerHTML = `<tr><td colspan="10">لا توجد بيانات.</td></tr>`;
          return;
        }

        const data = snapshot.val();
        let found = false;

        Object.values(data).forEach(resource => {
          if (resource.name.toLowerCase().includes(searchValue)) {
            const row = document.createElement("tr");
            row.innerHTML = `
                    <td>${resource.code || ''}</td>
                    <td>${resource.name || ''}</td>
                    <td>${resource.phone || ''}</td>
                    <td>${resource.address?.governorate || ''}</td>
                    <td>${resource.address?.city || ''}</td>
                    <td>${resource.address?.fullAddress || ''}</td>
                    <td>${resource.taxInfo?.destination || ''}</td>
                    <td>${resource.taxInfo?.taxId || ''}</td>
                    <td>${resource.taxInfo?.commercialRecord || ''}</td>
                    <td><button onclick="deleteResource(${resource.id})">🗑️ حذف</button></td>
                `;
            tableBody.appendChild(row);
            found = true;
          }
        });

        if (!found) {
          tableBody.innerHTML = `<tr><td colspan="10">🔍 لا توجد نتائج مطابقة</td></tr>`;
        }

      } catch (error) {
        console.error("❌ فشل في البحث:", error);
        alert("حدث خطأ أثناء البحث.");
      }
    };

    ////////////////////////////////////////////////////////////////
    ////////////////////////// اذن اضافه //////////////////////////
    function loadCompaniesIntoSelectAddition() {
      const companySelect = document.getElementById("CompanySelectAddition");
      const queryCompanySelect = document.getElementById("filterCompanySelectAddition");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeAddition");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectAddition);

    let addedItems = [];
    window.saveAddItemsAll = async function () {
      const documentDateAddition = document.getElementById('documentDateAddition').value.trim();
      const notesAddition = document.getElementById('notesAddition').value.trim();
      const locationAddition = document.getElementById('locationAddition').value;
      const supplierCode = document.getElementById('supplierCode').value.trim();
      const supplierName = document.getElementById('SupplierName').value.trim();
      const companyCode = document.getElementById("CompanySelectAddition").value;
      const companyName = document.getElementById("CompanySelectAddition").selectedOptions[0]?.textContent || "";

      let documentNumberAddition = document.getElementById('documentNumberAddition').value.trim();

      if (!documentDateAddition) {
        alert("يرجى إدخال التاريخ قبل الحفظ.");
        return;
      }

      if (!supplierCode || !supplierName) {
        alert("يرجى إدخال بيانات المورد قبل الحفظ.");
        return;
      }

      if (addedItems.length === 0) {
        alert("لا يمكن الحفظ بدون أصناف. يرجى إضافة صنف واحد على الأقل.");
        return;
      }

      try {
        const totalSum = addedItems.reduce((sum, item) => sum + item.itemTotal, 0);
        const docCounterRef = ref(database, 'documentNumberAddition');
        const isEditing = documentNumberAddition ? true : false;

        if (isEditing) {
          const purchaseOrdersRef = ref(database, "purchaseOrders");
          const purchaseSnap = await get(purchaseOrdersRef);

          if (purchaseSnap.exists()) {
            const allOrders = purchaseSnap.val();
            const linkedToPurchase = Object.values(allOrders).some(order =>
              order.disbursementDocNumber?.toString() === documentNumberAddition
            );

            if (linkedToPurchase) {
              alert("❌ لا يمكن تعديل إذن الإضافة لأنه مرتبط بطلب شراء مرحل.");
              return;
            }
          }

          const existingRef = ref(database, `documentsAddition/${documentNumberAddition}`);
          const existingSnap = await get(existingRef);
          if (existingSnap.exists()) {
            const existingData = existingSnap.val();
            if (existingData.deleted === true) {
              alert("❌ لا يمكن تعديل إذن الإضافة لأنه تم حذفه.");
              return;
            }
          }
        } else {
          const snapshot = await get(docCounterRef);
          documentNumberAddition = 1;
          if (snapshot.exists()) {
            documentNumberAddition = snapshot.val() + 1;
          }
        }

        const documentData = {
          documentNumberAddition,
          documentDateAddition,
          notesAddition,
          supplierCode,
          supplierName,
          locationAddition,
          items: addedItems,
          totalSum,
          deleted: false,
          company: {
            code: companyCode,
            name: companyName
          },
        };

        const documentRef = ref(database, `documentsAddition/${documentNumberAddition}`);
        await set(documentRef, documentData);

        if (!isEditing) {
          await set(docCounterRef, documentNumberAddition);
        }

        alert(isEditing ? "✅ تم تحديث إذن الإضافة بنجاح!" : "✅ تم حفظ إذن الإضافة بنجاح!");
        showAdditionInvoice(documentData);

        document.getElementById('documentDateAddition').value = '';
        document.getElementById('notesAddition').value = '';
        document.getElementById('supplierCode').value = '';
        document.getElementById('SupplierName').value = '';
        document.getElementById('locationAddition').value = '';
        document.getElementById('documentNumberAddition').value = '';

        if (isEditing) {
          document.getElementById('documentNumberAddition').removeAttribute("readonly");
        }

        addedItems = [];
        updateItemsTable();

      } catch (error) {
        console.error("❌ خطأ أثناء الحفظ:", error);
        alert("❌ حدث خطأ أثناء حفظ البيانات.");
      }
    };

    window.addItems = function () {
      const itemCode = document.getElementById('itemCode2').value.trim();
      const itemName = document.getElementById('itemName2').value.trim();
      const quantity = parseFloat(document.getElementById('itemQuantity').value);
      const price = parseFloat(document.getElementById('itemPrice').value.trim());
      const total = parseFloat(document.getElementById('itemTotalPrice').value.trim());

      if (!itemCode || !itemName || isNaN(quantity) || quantity <= 0 || isNaN(price) || isNaN(total)) {
        alert("يرجى إدخال بيانات الصنف كاملة.");
        return;
      }

      addedItems.push({ itemCode, itemName, quantity, price, itemTotal: total });

      updateItemsTable();

      document.getElementById('itemCode2').value = '';
      document.getElementById('itemName2').value = '';
      document.getElementById('itemQuantity').value = '';
      document.getElementById('itemPrice').value = '';
      document.getElementById('itemTotalPrice').value = '';
    };

    window.fetchItemDetails = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('itemCode2').value.trim()
        : document.getElementById('itemName2').value.trim();

      if (!searchValue) {
        return;
      }

      const itemsRef = ref(database, 'items');

      get(itemsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const itemsData = snapshot.val();
          let foundItem = null;
          let matchingItems = [];

          for (const key in itemsData) {
            if (itemsData.hasOwnProperty(key)) {
              const item = itemsData[key];

              if (type === 'code' && item.itemCode.toString() === searchValue) {
                foundItem = item;
                break;
              } else if (type === 'name' && item.itemName.toLowerCase().includes(searchValue.toLowerCase())) {
                matchingItems.push({ name: item.itemName, code: item.itemCode });
              }
            }
          }

          if (type === 'code') {
            if (foundItem) {
              document.getElementById('itemCode2').value = foundItem.itemCode;
              document.getElementById('itemName2').value = foundItem.itemName;
            } else {
              alert("⚠️ الصنف غير موجود.");
            }
          } else if (type === 'name') {
            let dataList = document.getElementById('itemSuggestions');
            dataList.innerHTML = "";

            if (matchingItems.length > 0) {
              matchingItems.forEach(item => {
                let option = document.createElement("option");
                option.value = item.name;
                option.dataset.code = item.code;
                dataList.appendChild(option);
              });
            }
          }
        }
      }).catch((error) => {
        console.error("❌ خطأ أثناء جلب بيانات الأصناف:", error);
      });
    };

    window.calculateTotalPrice = function () {
      const quantityStr = document.getElementById('itemQuantity').value;
      const priceStr = document.getElementById('itemPrice').value;

      const quantity = parseFloat(quantityStr);
      const price = parseFloat(priceStr);

      if (!isNaN(quantity) && !isNaN(price)) {
        document.getElementById('itemTotalPrice').value = (quantity * price).toFixed(2);
      } else {
        document.getElementById('itemTotalPrice').value = '';
      }
    };

    document.getElementById('itemName2').addEventListener('input', function () {
      let selectedName = this.value;
      let options = document.querySelectorAll('#itemSuggestions option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('itemCode2').value = option.dataset.code; // تعبئة كود الصنف تلقائيًا
        }
      });
    });

    function loadSuppliersSuggestions() {
      const resourcesRef = ref(database, 'resources');
      get(resourcesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('resourceSuggestions');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(resource => {
            let option = document.createElement("option");
            option.value = resource.name;
            option.dataset.code = resource.code;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الموردين:", err));
    }

    function loadItemsSuggestions() {
      const itemsRef = ref(database, 'items');
      get(itemsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('itemSuggestions');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(item => {
            let option = document.createElement("option");
            option.value = item.itemName;
            option.dataset.code = item.itemCode;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الأصناف:", err));
    }

    window.onload = function () {
      loadSuppliersSuggestions();
      loadItemsSuggestions();
    };

    function updateItemsTable() {
      const tbody = document.getElementById('itemsTableBody');
      tbody.innerHTML = '';

      const existingFooter = document.getElementById('totalAmountRowAddition');
      if (existingFooter) {
        existingFooter.remove();
      }

      if (addedItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">لا توجد أصناف مضافة</td></tr>';
        return;
      }

      let totalSum = 0;

      addedItems.forEach((item, index) => {
        const total = item.total || (item.price * item.quantity);
        totalSum += total;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.itemCode}</td>
            <td>${item.itemName}</td>
            <td>${item.quantity}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${total.toFixed(2)}</td>
            <td><button class="btn btn-danger btn-sm" onclick="removeItem(${index})">🗑️ حذف</button></td>
        `;
        tbody.appendChild(row);
      });

      const table = tbody.closest('table');
      const tfoot = document.createElement('tfoot');
      tfoot.id = 'totalAmountRowAddition';
      tfoot.innerHTML = `<tr>
        <td colspan="4" style="text-align: right; font-weight: bold;">الإجمالي الكلي:</td>
        <td colspan="2" style="font-weight: bold;">${totalSum.toFixed(2)}</td>
    </tr>`;
      table.appendChild(tfoot);
    }


    window.removeItem = function (index) {
      addedItems.splice(index, 1);
      updateItemsTable();
    };

    window.fetchResourceDetails = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('supplierCode').value.trim()
        : document.getElementById('SupplierName').value.trim();

      if (!searchValue) {
        return;
      }

      const resourcesRef = ref(database, 'resources');

      get(resourcesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const resourcesData = snapshot.val();
          let foundResource = null;
          let matchingResources = [];

          for (const key in resourcesData) {
            if (resourcesData.hasOwnProperty(key)) {
              const resource = resourcesData[key];

              if (type === 'code' && resource.code.toString() === searchValue) {
                foundResource = resource;
                break;
              }
              else if (type === 'name') {
                if (resource.name.toLowerCase() === searchValue.toLowerCase()) {
                  foundResource = resource;
                  break;
                } else if (resource.name.toLowerCase().includes(searchValue.toLowerCase())) {
                  matchingResources.push({ name: resource.name, code: resource.code });
                }
              }
            }
          }

          if (foundResource) {
            document.getElementById('supplierCode').value = foundResource.code;
            document.getElementById('SupplierName').value = foundResource.name;
          } else if (type === 'code') {
            alert("⚠️ المورد غير موجود.");
          } else if (type === 'name') {
            let dataList = document.getElementById('resourceSuggestions');
            dataList.innerHTML = "";

            matchingResources.forEach(resource => {
              let option = document.createElement("option");
              option.value = resource.name;
              option.dataset.code = resource.code;
              dataList.appendChild(option);
            });
          }
        }
      }).catch((error) => {
        console.error("❌ خطأ أثناء جلب بيانات المورد:", error);
      });
    };

    document.getElementById('SupplierName').addEventListener('input', function () {
      let selectedName = this.value;
      let options = document.querySelectorAll('#resourceSuggestions option');

      options.forEach(option => {
        if (option.value === selectedName) {
          document.getElementById('supplierCode').value = option.dataset.code;
        }
      });
    });

    function loadSuppliersSuggestionsOrder() {
      const resourcesRef = ref(database, 'resources');
      get(resourcesRef).then((snapshot) => {
        if (snapshot.exists()) {
          const dataList = document.getElementById('resourceSuggestions');
          dataList.innerHTML = '';
          Object.values(snapshot.val()).forEach(resource => {
            let option = document.createElement("option");
            option.value = resource.name;
            option.dataset.code = resource.code;
            dataList.appendChild(option);
          });
        }
      }).catch(err => console.error("❌ خطأ تحميل الموردين:", err));
    }

    window.loadRegionsIntoSelect = function () {
      const locationSelect = document.getElementById('locationAddition');
      locationSelect.innerHTML = '<option value="">- Location -</option>';

      const regionsRef = ref(database, 'Region');
      get(regionsRef).then(snapshot => {
        if (snapshot.exists()) {
          const regionsData = snapshot.val();
          for (const key in regionsData) {
            if (regionsData.hasOwnProperty(key)) {
              const region = regionsData[key];
              const option = document.createElement('option');
              option.value = region.RegionCode;
              option.textContent = region.RegionName;
              locationSelect.appendChild(option);
            }
          }
        }
      }).catch(error => {
        console.error("❌ خطأ في تحميل المناطق:", error);
      });
    };

    async function loadSuppliers() {
      const snap = await get(ref(database, 'resources'));
      if (!snap.exists()) return;

      const dl = document.getElementById('suppliers');
      snap.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.val().name;
        dl.appendChild(opt);
      });
    }

    async function loadItems() {
      const snap = await get(ref(database, 'items'));
      if (!snap.exists()) return;

      const dl = document.getElementById('items');
      snap.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.val().itemName;
        dl.appendChild(opt);
      });
    }

    window.generateAdditionReport = async function () {
      const dateFrom = document.getElementById('filterDateFrom').value.trim();
      const dateTo = document.getElementById('filterDateTo').value.trim();
      const docIdFrom = document.getElementById('filterDocIdFrom').value.trim();
      const docIdTo = document.getElementById('filterDocIdTo').value.trim();
      const supplierFilter = document.getElementById('filterSupplier').value.trim().toLowerCase();
      const regionFilter = document.getElementById('filterRegion').value;
      const itemFilter = document.getElementById('filterItem').value.trim().toLowerCase();
      const queryCompanyName = document.getElementById("filterCompanySelectAddition").value.trim().toLowerCase();

      const thead = document.querySelector('#additionTable thead');
      const tbody = document.getElementById('additionBody');
      tbody.innerHTML = '';
      thead.innerHTML = '';
      document.getElementById('additionTotalFooter')?.remove();

      const snap = await get(ref(database, 'documentsAddition'));
      if (!snap.exists()) {
        tbody.innerHTML = '<tr><td colspan="9">❌ لا توجد نتائج</td></tr>';
        return;
      }

      const allDocs = Object.values(snap.val());
      let hasResults = false;
      let rowsHtml = '';
      let totalGlobalQty = 0;
      let totalGlobalSum = 0;

      thead.innerHTML = `
    <tr style="background-color:#f2f2f2;">
      <th>رقم الإذن</th>
      <th>اسم الشركة</th>
      <th>التاريخ</th>
      <th>الموقع</th>
      <th>المورد (الكود)</th>
      <th>العنصر (الكود)</th>
      <th>الكمية</th>
      <th>السعر</th>
      <th>الإجمالي</th>
    </tr>
  `;

      const filteredDocs = allDocs.filter(doc => {
        const date = doc.documentDateAddition || '';
        const num = (doc.documentNumberAddition || '').toString();
        const region = doc.locationAddition || '';
        const supplier = (doc.supplierName || '').toLowerCase();
        const companyCode = (doc.company?.code || '').toLowerCase();

        return (
          (!dateFrom || new Date(date) >= new Date(dateFrom)) &&
          (!dateTo || new Date(date) <= new Date(dateTo)) &&
          (!docIdFrom || parseInt(num) >= parseInt(docIdFrom)) &&
          (!docIdTo || parseInt(num) <= parseInt(docIdTo)) &&
          (!regionFilter || regionFilter === "الكل" || region === regionFilter) &&
          (!supplierFilter || supplier.includes(supplierFilter)) &&
          (!queryCompanyName || companyCode === queryCompanyName)
        );
      });

      filteredDocs.forEach(doc => {
        const isDeleted = !!doc.deleted;
        const items = doc.items || [];
        const filteredItems = items.filter(item => {
          const name = (item.itemName || '').toLowerCase();
          const code = (item.itemCode || '').toLowerCase();
          return !itemFilter || name.includes(itemFilter) || code === itemFilter;
        });

        if (filteredItems.length === 0) return;

        let docQty = 0;
        let docSum = 0;

        filteredItems.forEach(item => {
          const qty = parseFloat(item.quantity) || 0;
          const price = parseFloat(item.price) || 0;
          const total = qty * price;

          if (!isDeleted) {
            docQty += qty;
            docSum += total;
            totalGlobalQty += qty;
            totalGlobalSum += total;
          }

          rowsHtml += `
        <tr style="${isDeleted ? 'background:#f8d7da;color:#721c24;' : ''}" data-doc='${JSON.stringify(doc).replace(/'/g, '&apos;')}'>
          <td ondblclick="showAdditionInvoice(this)" data-doc='${JSON.stringify(doc).replace(/'/g, '&apos;')}'>
            ${doc.documentNumberAddition}
          </td>
          <td>${doc.company?.name || ''}</td>
          <td>${doc.documentDateAddition || ''}</td>
          <td>${doc.locationAddition || ''}</td>
          <td>${doc.supplierName || ''} (${doc.supplierCode || ''})</td>
          <td>${item.itemName || ''} (${item.itemCode || ''})</td>
          <td>${qty}</td>
          <td>${price.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
        </tr>`;
        });

        rowsHtml += `
      <tr style="font-weight:bold;background:${isDeleted ? '#f8d7da' : '#f1f1f1'};color:${isDeleted ? '#721c24' : 'black'};">
        <td colspan="6" style="text-align:right;">إجمالي المستند رقم ${doc.documentNumberAddition}${isDeleted ? ' (محذوف)' : ''}:</td>
        <td>${isDeleted ? '-' : docQty}</td>
        <td></td>
        <td>${isDeleted ? '-' : docSum.toFixed(2)}</td>
      </tr>`;
        hasResults = true;
      });

      tbody.innerHTML = hasResults ? rowsHtml : '<tr><td colspan="9">❌ لا توجد نتائج</td></tr>';

      if (hasResults) {
        const tfoot = document.createElement('tfoot');
        tfoot.id = 'additionTotalFooter';
        tfoot.innerHTML = `
      <tr style="font-weight:bold;background:#dff0d8;">
        <td colspan="6" style="text-align:right;">الإجمالي الكلي لجميع المستندات:</td>
        <td>${totalGlobalQty}</td>
        <td></td>
        <td>${totalGlobalSum.toFixed(2)}</td>
      </tr>`;
        document.getElementById('additionTable').appendChild(tfoot);
      }

      document.querySelectorAll('tr[data-doc]').forEach(row => {
        row.addEventListener('dblclick', () => {
          const doc = JSON.parse(row.dataset.doc.replace(/&apos;/g, `'`));
          showAdditionInvoice(doc);
        });
      });
    };


    window.showAdditionInvoice = function (doc) {
      try {
        showAdditionInvoice(doc);
      } catch (err) {
        console.error("❌ خطأ أثناء عرض فاتورة إذن الإضافة:", err);
        alert("⚠️ لا يمكن عرض الفاتورة.");
      }
    };


    window.showAdditionInvoice = async function (documentData) {
      try {
        if (!documentData.company || !documentData.company.code) {
          alert("❌ بيانات الشركة غير موجودة في هذا الإذن.");
          return;
        }

        const settingsRef = ref(database, `companySettings/${documentData.company.code}`);

        const snapshot = await get(settingsRef);

        if (!snapshot.exists()) {
          alert("❌ إعدادات الشركة غير موجودة");
          return;
        }

        const settings = snapshot.val();

        const template = `
      <div id="invoiceBody"
           style="font-family:'Arial',sans-serif;direction:rtl;padding:40px;position:relative;background:#fff;border:1px solid #ccc;">

        <!-- العلامة المائية -->
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-50deg);
                    opacity:0.05;font-size:100px;font-weight:bold;color:#000;white-space:nowrap;">
          ${settings.watermark}
        </div>

        <!-- رأس الفاتورة -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div style="text-align:left;line-height:1.6;">
            <div style="font-weight:bold;font-size:18px;">${settings.name}</div>
            <div style="font-size:14px;">${settings.address}</div>
            <div style="font-size:14px;">${settings.phone}</div>
            <div style="font-size:14px;">${settings.email}</div>
          </div>
          <div style="text-align:center;margin-top:20px;">
            <canvas id="qrcanvas"></canvas>
            <p style="font-size:10px;color:#555;margin-top:3px;">QR Code for Addition</p>
          </div>
          <img src="${settings.logoUrl}" alt="Company Logo" style="height:100px;">
        </div>

        <h2 style="text-align:center;background:#2196f3;color:#fff;padding:10px 0;margin-top:20px;">
          إذن إضافة – Addition Permit
        </h2>

        <!-- بيانات الإذن -->
        <div style="display:flex;justify-content:space-between;margin-top:20px;font-size:15px;">
          <div>
            <div><strong>رقم الإذن:</strong> ${documentData.documentNumberAddition}</div>
            <div><strong>التاريخ:</strong> ${documentData.documentDateAddition}</div>
            <div><strong>الموقع:</strong> ${documentData.locationAddition}</div>
          </div>
          <div style="text-align:left;">
            <div><strong>المورد:</strong> ${documentData.supplierName}</div>
            <div><strong>الرمز:</strong> ${documentData.supplierCode}</div>
            <div><strong>ملاحظات:</strong> ${documentData.notesAddition || ''}</div>
          </div>
        </div>

        <!-- جدول الأصناف -->
        <table style="width:100%;border-collapse:collapse;margin-top:25px;font-size:14px;">
          <thead>
            <tr style="background:#eee;border-bottom:2px solid #000;">
              <th style="padding:6px;">م / No.</th>
              <th>الرمز / Code</th>
              <th>البيان / Description</th>
              <th>الكمية / Qty</th>
              <th>السعر / Unit Price</th>
              <th>الإجمالي / Total</th>
            </tr>
          </thead>
          <tbody>
            ${documentData.items.map((it, i) => `
              <tr style="border-bottom:1px solid #ccc;">
                <td style="text-align:center;padding:5px;">${i + 1}</td>
                <td style="text-align:center;padding:5px;">${it.itemCode}</td>
                <td style="text-align:center;padding:5px;">${it.itemName}</td>
                <td style="text-align:center;padding:5px;">${it.quantity}</td>
                <td style="text-align:center;padding:5px;">${it.price.toFixed(2)}</td>
                <td style="text-align:center;padding:5px;">${it.itemTotal.toFixed(2)}</td>
              </tr>
            `).join('')}
            <tr style="background:#d0eaff;font-weight:bold;">
              <td colspan="3" style="text-align:right;padding:8px;">الإجمالي:</td>
              <td style="text-align:center;padding:5px;">
                ${documentData.items.reduce((s, o) => s + o.quantity, 0).toFixed(2)}
              </td>
              <td style="text-align:center;">—</td>
              <td style="text-align:center;padding:5px;">
                ${documentData.totalSum.toFixed(2)}
              </td>
            </tr>
          </tbody>
        </table>

        <!-- التواقيع -->
        <div style="display:flex;justify-content:space-between;margin-top:50px;
                    border-top:1px solid #ccc;padding-top:30px;">
          <div style="width:30%;text-align:center;">
            <p>مستلم المواد</p>
            <div style="height:60px;border-bottom:1px solid #aaa;margin:10px auto;width:80%;"></div>
            <p style="font-size:12px;color:#555;">Receiver Signature</p>
          </div>
          <div style="width:30%;text-align:center;">
            <p>أمين المخزن</p>
            <div style="height:60px;border-bottom:1px solid #aaa;margin:10px auto;width:80%;"></div>
            <p style="font-size:12px;color:#555;">Storekeeper Signature</p>
          </div>
          <div style="width:30%;text-align:center;">
            <p>مدير المخزون</p>
            <div style="height:60px;border-bottom:1px solid #aaa;margin:10px auto;width:80%;"></div>
            <p style="font-size:12px;color:#555;">Inventory Manager Signature</p>
          </div>
        </div>
      </div>
    `;

        const w = window.open("", "_blank");
        w.document.write(template);
        w.document.close();

        w.onload = () => {
          QRCode.toCanvas(
            w.document.getElementById('qrcanvas'),
            JSON.stringify({
              doc: documentData.documentNumberAddition,
              total: documentData.totalSum
            }),
            { width: 100 }
          );
        };
      } catch (error) {
        console.error("❌ فشل في عرض إذن الإضافة:", error);
        alert("❌ حدث خطأ أثناء عرض إذن الإضافة.");
      }
    };

    window.addEventListener('load', () => {
      loadSuppliers();
      loadItems();
    });

    window.downloadReportAsExcel = function () {
      const table = document.getElementById('additionTable');
      const wb = XLSX.utils.table_to_book(table, { sheet: "تقرير الإضافة" });
      XLSX.writeFile(wb, 'تقرير_اذون_الاضافة.xlsx');
    };
    /////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////// اذن صرف ///////////////////////////////////////////////
    function loadCompaniesIntoSelectDisbursement() {
      const companySelect = document.getElementById("CompanySelectDisbursement");
      const queryCompanySelect = document.getElementById("filterCompanySelectDisbursement");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeDisbursement");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectDisbursement);

    let addedItemsDisbursement = [];
    window.saveAddItemsAllDisbursement = async function () {
      const documentDateDisbursement = document.getElementById('documentDateDisbursement').value.trim();
      const notesDisbursement = document.getElementById('notesDisbursement').value.trim();
      const locationDisbursement = document.getElementById('locationDisbursement').value.trim();
      const companyCode = document.getElementById("CompanySelectDisbursement").value;
      const companyName = document.getElementById("CompanySelectDisbursement").selectedOptions[0]?.textContent || "";
      let documentNumberDisbursement = document.getElementById('documentNumberDisbursement').value.trim();

      if (!documentDateDisbursement) {
        alert("يرجى إدخال التاريخ قبل الحفظ.");
        return;
      }

      if (addedItemsDisbursement.length === 0) {
        alert("لا يمكن الحفظ بدون أصناف. يرجى إضافة صنف واحد على الأقل.");
        return;
      }

      try {
        const itemsSnapshot = await get(ref(database, 'documentsAddition'));
        let stockMap = {};

        if (itemsSnapshot.exists()) {
          itemsSnapshot.forEach(doc => {
            const docData = doc.val();
            if (docData.deleted === true) return;

            const items = docData.items || [];
            items.forEach(item => {
              const code = item.itemCode;
              const qty = parseFloat(item.quantity) || 0;
              stockMap[code] = (stockMap[code] || 0) + qty;
            });
          });
        }

        const disbSnapshot = await get(ref(database, 'documentsDisbursement'));
        if (disbSnapshot.exists()) {
          disbSnapshot.forEach(doc => {
            const docData = doc.val();
            if (docData.deleted === true) return;

            const items = docData.items || [];
            items.forEach(item => {
              const code = item.itemCode;
              const qty = parseFloat(item.itemQuantity) || 0;
              stockMap[code] = (stockMap[code] || 0) - qty;
            });
          });
        }

        let insufficientItems = [];
        addedItemsDisbursement.forEach(item => {
          const code = item.itemCode;
          const name = item.itemName;
          const qty = parseFloat(item.itemQuantity) || 0;
          const availableQty = stockMap[code] || 0;

          if (qty > availableQty) {
            insufficientItems.push(`${name} (المتاح: ${availableQty}, المطلوب: ${qty})`);
          }
        });

        if (insufficientItems.length > 0) {
          alert("❌ لا يمكن الحفظ. الكمية المطلوبة أكبر من الكمية المتاحة لبعض الأصناف:\n\n" + insufficientItems.join("\n"));
          return;
        }

        const totalSum = addedItemsDisbursement.reduce((sum, item) => sum + item.itemTotal, 0);
        const docCounterRef = ref(database, 'documentNumberDisbursement');
        const isEditing = documentNumberDisbursement ? true : false;

        if (isEditing) {
          const existingRef = ref(database, `documentsDisbursement/${documentNumberDisbursement}`);
          const existingSnap = await get(existingRef);
          if (existingSnap.exists()) {
            const existingData = existingSnap.val();
            if (existingData.deleted === true) {
              alert("❌ لا يمكن تعديل إذن الصرف لأنه تم حذفه.");
              return;
            }
          }
        } else {
          const snapshot = await get(docCounterRef);
          documentNumberDisbursement = 1;
          if (snapshot.exists()) {
            documentNumberDisbursement = snapshot.val() + 1;
          }
        }

        const documentData = {
          documentNumberDisbursement,
          documentDateDisbursement,
          notesDisbursement,
          locationDisbursement,
          items: addedItemsDisbursement,
          totalSum,
          deleted: false,
          company: {
            code: companyCode,
            name: companyName
          },
        };

        const documentRef = ref(database, `documentsDisbursement/${documentNumberDisbursement}`);
        await set(documentRef, documentData);

        if (!isEditing) {
          await set(docCounterRef, documentNumberDisbursement);
        }

        alert(isEditing ? "✅ تم تحديث إذن الصرف بنجاح!" : "✅ تم حفظ إذن الصرف بنجاح!");

        showDisbursementInvoice(documentData);

        document.getElementById('documentDateDisbursement').value = '';
        document.getElementById('notesDisbursement').value = '';
        document.getElementById('locationDisbursement').value = '';
        document.getElementById('documentNumberDisbursement').value = '';

        if (isEditing) {
          document.getElementById('documentNumberDisbursement').removeAttribute("readonly");
        }

        addedItemsDisbursement = [];
        updateItemsTableDisbursement();

      } catch (error) {
        console.error("❌ خطأ أثناء الحفظ:", error);
        alert("❌ حدث خطأ أثناء حفظ البيانات.");
      }
    };

    window.addItemsDisbursement = function () {
      const itemCode = document.getElementById('itemCode3').value.trim();
      const itemName = document.getElementById('itemName3').value.trim();
      const itemQuantity = document.getElementById('itemQuantityDisbursement').value.trim();
      const itemPrice = parseFloat(document.getElementById('itemPriceDisbursement').value) || 0;

      if (!itemCode || !itemName || !itemQuantity) {
        alert("يرجى إدخال جميع بيانات الصنف.");
        return;
      }

      if (isNaN(itemQuantity) || parseInt(itemQuantity) <= 0) {
        alert("⚠️ يرجى إدخال كمية صحيحة.");
        return;
      }

      if (itemPrice <= 0) {
        alert("⚠️ السعر غير صالح.");
        return;
      }

      const qty = parseInt(itemQuantity);
      const itemTotal = itemPrice * qty;

      const existingItem = addedItemsDisbursement.find(item => item.itemCode === itemCode);
      if (existingItem) {
        existingItem.itemQuantity += qty;
        existingItem.itemTotal = existingItem.itemPrice * existingItem.itemQuantity;  // تحديث المجموع
      } else {
        addedItemsDisbursement.push({
          itemCode,
          itemName,
          itemQuantity: qty,
          itemPrice,
          itemTotal
        });
      }

      updateItemsTableDisbursement();

      document.getElementById('itemCode3').value = '';
      document.getElementById('itemName3').value = '';
      document.getElementById('itemQuantityDisbursement').value = '';
      document.getElementById('itemPriceDisbursement').value = '';
    };

    window.fetchLastItemPrice = async function (itemCode) {
      console.log('fetchLastItemPrice called with:', itemCode);
      if (!itemCode) {
        document.getElementById("itemPriceDisbursement").value = '';
        return;
      }

      document.getElementById("itemPriceDisbursement").value = '';

      try {
        const snapshot = await get(ref(database, 'documentsAddition'));
        let latestPrice = null;
        let latestDocNumber = 0;

        if (snapshot.exists()) {
          snapshot.forEach(doc => {
            const docData = doc.val();
            const docNumber = parseInt(docData.documentNumberAddition) || 0;
            const items = docData.items || {};
            const itemsArray = Array.isArray(items) ? items : Object.values(items);

            itemsArray.forEach(item => {
              if (item.itemCode.toString().trim() === itemCode.toString().trim() && item.price != null && !isNaN(Number(item.price))) {
                if (docNumber > latestDocNumber) {
                  latestDocNumber = docNumber;
                  latestPrice = item.price;
                }
              }
            });
          });
        }

        document.getElementById("itemPriceDisbursement").value = latestPrice !== null ? latestPrice : '';
        console.log('Price set to:', latestPrice);
      } catch (error) {
        document.getElementById("itemPriceDisbursement").value = '';
        console.error('خطأ في جلب السعر:', error);
      }
    };

    window.handleItemNameInput = function () {
      const input = document.getElementById('itemName3');
      const val = input.value.trim();
      const opts = document.getElementById('itemSuggestions').options;
      let matchedCode = null;

      for (let i = 0; i < opts.length; i++) {
        if (opts[i].value === val) {
          matchedCode = opts[i].dataset.code;
          break;
        }
      }

      if (matchedCode) {
        document.getElementById('itemCode3').value = matchedCode;
        window.fetchLastItemPrice(matchedCode);
      } else if (val === '') {
        document.getElementById('itemCode3').value = '';
        document.getElementById("itemPriceDisbursement").value = '';
      }
    };

    window.fetchItemDetailsDisbursement = function (type) {
      let searchValue = type === 'code'
        ? document.getElementById('itemCode3').value.trim()
        : document.getElementById('itemName3').value.trim();

      if (!searchValue) {
        return;
      }

      const itemsRef = ref(database, 'items');

      get(itemsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const itemsData = snapshot.val();
          let foundItem = null;
          let matchingItems = [];

          for (const key in itemsData) {
            if (itemsData.hasOwnProperty(key)) {
              const item = itemsData[key];

              if (type === 'code' && item.itemCode.toString() === searchValue) {
                foundItem = item;
                break;
              } else if (type === 'name' && item.itemName.toLowerCase().includes(searchValue.toLowerCase())) {
                matchingItems.push({ name: item.itemName, code: item.itemCode });
              }
            }
          }

          if (type === 'code') {
            if (foundItem) {
              document.getElementById('itemCode3').value = foundItem.itemCode;
              document.getElementById('itemName3').value = foundItem.itemName;

              fetchLastItemPrice(foundItem.itemCode);
            } else {
              alert("⚠️ الصنف غير موجود.");
              document.getElementById("itemPriceDisbursement").value = '';
            }
          } else if (type === 'name') {
            let dataList = document.getElementById('itemSuggestions');
            dataList.innerHTML = "";

            if (matchingItems.length > 0) {
              matchingItems.forEach(item => {
                let option = document.createElement("option");
                option.value = item.name;
                option.dataset.code = item.code;
                dataList.appendChild(option);
              });

              if (matchingItems.length === 1 && matchingItems[0].name.toLowerCase() === searchValue.toLowerCase()) {
                document.getElementById('itemCode3').value = matchingItems[0].code;

                fetchLastItemPrice(matchingItems[0].code);
              } else {
                document.getElementById("itemPriceDisbursement").value = '';
              }
            } else {
              document.getElementById("itemPriceDisbursement").value = '';
            }
          }
        }
      }).catch((error) => {
        console.error("❌ خطأ أثناء جلب بيانات الأصناف:", error);
      });
    };

    document.getElementById('itemName3').addEventListener('input', function () {
      let selectedName = this.value;
      let options = document.querySelectorAll('#itemSuggestions option');

      options.forEach(option => {
        if (option.value === selectedName) {
          const code = option.dataset.code;
          document.getElementById('itemCode3').value = code;
          fetchLastItemPrice(code);
        }
      });
    });

    window.onload = function () {
      const itemsRef = ref(database, 'items');

      get(itemsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const itemsData = snapshot.val();
          let dataList = document.getElementById('itemSuggestions');

          for (const key in itemsData) {
            if (itemsData.hasOwnProperty(key)) {
              let option = document.createElement("option");
              option.value = itemsData[key].itemName;
              option.dataset.code = itemsData[key].itemCode;
              dataList.appendChild(option);
            }
          }
        }
      }).catch((error) => {
        console.error("❌ خطأ أثناء تحميل الأصناف:", error);
      });
    };

    function updateItemsTableDisbursement() {
      const tableBody = document.getElementById('itemsTableBodyDisbursement');
      tableBody.innerHTML = "";

      if (addedItemsDisbursement.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6">لا توجد أصناف مضافة</td></tr>';
        if (document.getElementById('totalAmountRow')) {
          document.getElementById('totalAmountRow').remove();
        }
        return;
      }

      let totalSum = 0;

      addedItemsDisbursement.forEach((item, index) => {
        const price = item.itemPrice || 0;
        const itemTotal = price * item.itemQuantity;
        totalSum += itemTotal;

        const row = `<tr>
            <td>${item.itemCode}</td>
            <td>${item.itemName}</td>
            <td>${item.itemQuantity}</td>
            <td>${price.toFixed(2)}</td>
            <td>${itemTotal.toFixed(2)}</td>
            <td><button onclick="removeItem2(${index})">❌ حذف</button></td>
        </tr>`;
        tableBody.innerHTML += row;
      });

      if (!document.getElementById('totalAmountRow')) {
        const table = tableBody.closest('table');
        const tfoot = document.createElement('tfoot');
        tfoot.id = 'totalAmountRow';
        tfoot.innerHTML = `<tr>
            <td colspan="4" style="text-align: right; font-weight: bold;">الإجمالي الكلي:</td>
            <td colspan="2" style="font-weight: bold;">${totalSum.toFixed(2)}</td>
        </tr>`;
        table.appendChild(tfoot);
      } else {
        const tfoot = document.getElementById('totalAmountRow');
        tfoot.innerHTML = `<tr>
            <td colspan="4" style="text-align: right; font-weight: bold;">الإجمالي الكلي:</td>
            <td colspan="2" style="font-weight: bold;">${totalSum.toFixed(2)}</td>
        </tr>`;
      }
    }

    window.removeItem2 = function (index) {
      addedItemsDisbursement.splice(index, 1);
      updateItemsTableDisbursement();
    };

    window.generateAdditionReportDisbursement = async function () {
      const dateFrom = document.getElementById('filterDateFromDisbursement').value.trim();
      const dateTo = document.getElementById('filterDateToDisbursement').value.trim();
      const docIdFrom = document.getElementById('filterDocIdFromDisbursement').value.trim();
      const docIdTo = document.getElementById('filterDocIdToDisbursement').value.trim();
      const regionFilter = document.getElementById('filterRegionDisbursement').value;
      const itemFilter = document.getElementById('filterItemDisbursement').value.trim().toLowerCase();
      const queryCompanyName = document.getElementById("filterCompanySelectDisbursement").value.trim().toLowerCase();

      const thead = document.querySelector('#additionTableDisbursement thead');
      const tbody = document.getElementById('additionBodyDisbursement');
      tbody.innerHTML = '';
      thead.innerHTML = '';
      document.getElementById('disbursementTotalFooter')?.remove();

      const [snapDisb, snapAdd] = await Promise.all([
        get(ref(database, 'documentsDisbursement')),
        get(ref(database, 'documentsAddition'))
      ]);

      const allAdd = snapAdd.exists() ? snapAdd.val() : {};
      const allDisb = snapDisb.exists() ? snapDisb.val() : {};

      if (!snapDisb.exists()) {
        tbody.innerHTML = '<tr><td colspan="8">❌ لا توجد نتائج</td></tr>';
        return;
      }

      thead.innerHTML = `
    <tr style="background-color:#f2f2f2;">
      <th>رقم الإذن</th>
      <th>اسم الشركة</th>
      <th>التاريخ</th>
      <th>الموقع</th>
      <th>العنصر (الكود)</th>
      <th>الكمية</th>
      <th>السعر</th>
      <th>الإجمالي</th>
    </tr>
  `;

      let hasResults = false, rowsHtml = '';
      let totalGlobalQty = 0, totalGlobalSum = 0;
      const processed = new Set();

      const shouldInclude = doc => {
        const date = (doc.documentDateDisbursement || '').trim();
        const num = (doc.documentNumberDisbursement || '').toString().trim();
        const region = doc.locationDisbursement || '';
        const companyCode = (doc.company?.code || '').toLowerCase();

        return (
          (!dateFrom || new Date(date) >= new Date(dateFrom)) &&
          (!dateTo || new Date(date) <= new Date(dateTo)) &&
          (!docIdFrom || parseInt(num) >= parseInt(docIdFrom)) &&
          (!docIdTo || parseInt(num) <= parseInt(docIdTo)) &&
          (!regionFilter || regionFilter === 'الكل' || region === regionFilter) &&
          (!queryCompanyName || companyCode === queryCompanyName)
        );
      };

      Object.values(allDisb).forEach(doc => {
        const num = (doc.documentNumberDisbursement || '').toString();
        if (processed.has(num) || !shouldInclude(doc)) return;

        const isDeletedSelf = doc.deleted === true;
        const isLinkedDeleted = doc.additionDocNumber
          ? (allAdd[doc.additionDocNumber]?.deleted === true)
          : false;

        const isDeleted = isDeletedSelf || isLinkedDeleted;
        const style = isDeleted ? 'background-color: #f8d7da; color: #721c24;' : '';
        const items = doc.items || [];

        const filteredItems = items.filter(item => {
          const name = (item.itemName || '').toLowerCase();
          const code = (item.itemCode || '').toLowerCase();
          return !itemFilter || name.includes(itemFilter) || code === itemFilter;
        });

        if (filteredItems.length === 0) return;

        processed.add(num);
        let docQty = 0, docSum = 0;

        filteredItems.forEach(item => {
          const qty = parseFloat(item.itemQuantity) || 0;
          const price = parseFloat(item.itemPrice) || 0;
          const total = qty * price;
          docQty += qty;
          docSum += total;
          totalGlobalQty += qty;
          totalGlobalSum += total;

          const docJson = JSON.stringify(doc).replace(/'/g, '&apos;');

          rowsHtml += `
        <tr style="${style}" data-doc='${docJson}'>
          <td ondblclick="showDisbursementInvoice(this)" data-doc='${docJson}'>${num}${isDeletedSelf ? ' (محذوف)' : ''}</td>
          <td>${doc.company?.name || ''}</td>
          <td>${doc.documentDateDisbursement}</td>
          <td>${doc.locationDisbursement}</td>
          <td>${item.itemName} (${item.itemCode})</td>
          <td>${qty}</td>
          <td>${price.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
        </tr>`;
        });

        rowsHtml += `
      <tr style="font-weight:bold;${style}">
        <td colspan="5" style="text-align:right;">إجمالي المستند رقم ${num}${isDeletedSelf ? ' (محذوف)' : ''}:</td>
        <td>${docQty}</td>
        <td></td>
        <td>${docSum.toFixed(2)}</td>
      </tr>`;

        hasResults = true;
      });

      tbody.innerHTML = hasResults ? rowsHtml : '<tr><td colspan="8">❌ لا توجد نتائج</td></tr>';

      if (hasResults) {
        const tfoot = document.createElement('tfoot');
        tfoot.id = 'disbursementTotalFooter';
        tfoot.innerHTML = `
      <tr style="font-weight:bold;background:#dff0d8;">
        <td colspan="5" style="text-align:right;">الإجمالي الكلي:</td>
        <td>${totalGlobalQty}</td>
        <td></td>
        <td>${totalGlobalSum.toFixed(2)}</td>
      </tr>`;
        document.getElementById('additionTableDisbursement').appendChild(tfoot);
      }

      document.querySelectorAll('#additionBodyDisbursement tr[data-doc]').forEach(row => {
        row.addEventListener('dblclick', () => {
          const doc = JSON.parse(row.dataset.doc.replace(/&apos;/g, `'`));
          showDisbursementInvoice(doc);
        });
      });
    };

    window.showDisbursementInvoice = function (doc) {
      try {
        showDisbursementInvoice(doc);
      } catch (err) {
        console.error("❌ خطأ أثناء عرض فاتورة إذن الإضافة:", err);
        alert("⚠️ لا يمكن عرض الفاتورة.");
      }
    }

    window.addEventListener('load', () => {
      loadItems();
    });
    window.downloadReportAsExcelDisbursement = function () {
      const table = document.getElementById('additionTableDisbursement');
      const wb = XLSX.utils.table_to_book(table, { sheet: "تقرير الإضافة" });
      XLSX.writeFile(wb, 'تقرير_اذون_الاضافة.xlsx');
    };

    window.showDisbursementInvoice = async function (documentData) {
      try {
        if (!documentData.company || !documentData.company.code) {
          alert("❌ بيانات الشركة غير موجودة في هذا الإذن.");
          return;
        }

        const settingsRef = ref(database, `companySettings/${documentData.company.code}`);

        const snapshot = await get(settingsRef);

        if (!snapshot.exists()) {
          alert("❌ إعدادات الشركة غير موجودة");
          return;
        }

        const settings = snapshot.val();

        let totalQty = 0;
        const itemsRows = documentData.items.map((item, i) => {
          const qty = parseFloat(item.itemQuantity) || 0;
          const price = parseFloat(item.itemPrice) || 0;
          const total = qty * price;
          totalQty += qty;

          return `
        <tr style="border-bottom:1px solid #ccc;">
          <td style="text-align:center;">${i + 1}</td>
          <td style="text-align:center;">${item.itemName || ''}</td>
          <td style="text-align:center;">${item.itemCode || ''}</td>
          <td style="text-align:center;">${qty}</td>
          <td style="text-align:center;">${price.toFixed(2)}</td>
          <td style="text-align:center;">${total.toFixed(2)}</td>
          <td style="text-align:center;">${item.itemNotes || ''}</td>
        </tr>`;
        }).join('');

        const template = `
      <div id="disbursementInvoiceBody" style="font-family:'Arial'; direction: rtl; padding: 40px; background: #fff; border: 1px solid #ccc; position: relative;">
      
        <div style="position:absolute; top:45%; left:50%; transform:translate(-50%,-50%) rotate(-30deg); opacity:0.03; font-size:100px; font-weight:bold; color:#000; white-space:nowrap;">
          ${settings.watermark || ''}
        </div>

        <!-- Header -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <img src="${settings.logoUrl}" alt="Logo" style="height:100px;">
          <div style="text-align:left; line-height:1.6;">
            <div style="font-weight:bold; font-size:18px;">company: ${settings.name}</div>
            <div style="font-size:14px;">address: ${settings.address}</div>
            <div style="font-size:14px;">Phone: ${settings.phone}</div>
            <div style="font-size:14px;">Email: ${settings.email}</div>
          </div>
        </div>

        <!-- Title -->
        <h2 style="text-align:center; background:#f44336; color:#fff; padding:12px 0; margin-top:30px;">
          إذن صرف – Store Disbursement Note
        </h2>

        <!-- Info -->
        <div style="display:flex; justify-content:space-between; font-size:15px; margin-top:20px;">
          <div>
            <div><strong>رقم الإذن:</strong> ${documentData.documentNumberDisbursement}</div>
            <div><strong>التاريخ:</strong> ${documentData.documentDateDisbursement}</div>
          </div>
          <div style="text-align:left;">
            <div><strong>الموقع:</strong> ${documentData.locationDisbursement}</div>
            <div><strong>ملاحظات:</strong> ${documentData.notesDisbursement || '-'}</div>
          </div>
        </div>

        <!-- Items Table -->
        <table style="width:100%; border-collapse:collapse; margin-top:25px; font-size:14px;">
          <thead>
            <tr style="background:#eee; border-bottom:2px solid #000;">
              <th style="padding:6px;">م / No.</th>
              <th>اسم الصنف</th>
              <th>الكود</th>
              <th>الكمية</th>
              <th>سعر الوحدة</th>
              <th>الإجمالي</th>
              <th>ملاحظات</th>
            </tr>
          </thead>
          <tbody>
            ${itemsRows}
            <tr style="font-weight:bold; background:#f1f1f1;">
              <td colspan="3" style="text-align:right;">إجمالي الكمية:</td>
              <td style="text-align:center;">${totalQty}</td>
              <td colspan="3"></td>
            </tr>
          </tbody>
        </table>

        <!-- Total -->
        <div style="margin-top:30px; text-align:right; font-size:16px; font-weight:bold;">
          الإجمالي: ${documentData.totalSum?.toFixed(2) || '0.00'} جنيه
        </div>

        <!-- Signatures -->
        <div style="display:flex; justify-content:space-between; margin-top:50px; border-top:1px solid #ccc; padding-top:30px;">
          <div style="width:30%; text-align:center;">
            <p>مستلم الأصناف</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
          </div>
          <div style="width:30%; text-align:center;">
            <p>أمين المخزن</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
          </div>
          <div style="width:30%; text-align:center;">
            <p>مدير عام</p>
            <div style="height:60px; border-bottom:1px solid #aaa; margin:10px auto; width:80%;"></div>
          </div>
        </div>
      </div>
    `;

        const win = window.open("", "_blank");
        win.document.write(template);
        win.document.close();

      } catch (error) {
        console.error("❌ خطأ أثناء تحميل إعدادات الشركة:", error);
        alert("⚠️ تعذر تحميل إعدادات الشركة. تأكد من وجود البيانات في Firebase.");
      }
    };


    /////////////////////////////////////////////////////////////////////////
    //////////////////////// رصيد الأصناف في المخزون ///////////////////////
    window.generateStockReport = function () {
      const filterCode = document.getElementById('filterCode').value.trim().toLowerCase();
      const filterItemName = document.getElementById('filterItemName').value.trim().toLowerCase();

      const additionsRef = ref(database, 'documentsAddition');
      const disbursementsRef = ref(database, 'documentsDisbursement');

      Promise.all([get(additionsRef), get(disbursementsRef)]).then(([addSnapshot, disSnapshot]) => {
        const stockMap = {};

        if (addSnapshot.exists()) {
          Object.values(addSnapshot.val()).forEach(doc => {
            if (doc.deleted) return;

            if (doc.items) {
              Object.values(doc.items).filter(Boolean).forEach(item => {
                const code = (item.itemCode || '').toLowerCase();
                const name = (item.itemName || '').toLowerCase();

                if ((filterCode && !code.includes(filterCode)) || (filterItemName && !name.includes(filterItemName))) return;

                const qty = parseFloat(item.quantity) || 0;
                const price = parseFloat(item.price) || 0;
                const value = qty * price;

                if (!stockMap[code]) {
                  stockMap[code] = {
                    itemCode: item.itemCode,
                    itemName: item.itemName,
                    totalAddQty: 0,
                    totalAddVal: 0,
                    totalDisQty: 0,
                    totalDisVal: 0,
                    lastPrice: 0
                  };
                }

                stockMap[code].totalAddQty += qty;
                stockMap[code].totalAddVal += value;
                stockMap[code].lastPrice = price;
              });
            }
          });
        }

        if (disSnapshot.exists()) {
          Object.values(disSnapshot.val()).forEach(doc => {
            if (doc.deleted) return;

            if (doc.items) {
              Object.values(doc.items).filter(Boolean).forEach(item => {
                const code = (item.itemCode || '').toLowerCase();
                const name = (item.itemName || '').toLowerCase();

                if ((filterCode && !code.includes(filterCode)) || (filterItemName && !name.includes(filterItemName))) return;

                const qty = parseFloat(item.itemQuantity) || 0;
                const price = parseFloat(item.itemPrice) || 0;
                const value = qty * price;

                if (!stockMap[code]) {
                  stockMap[code] = {
                    itemCode: item.itemCode,
                    itemName: item.itemName,
                    totalAddQty: 0,
                    totalAddVal: 0,
                    totalDisQty: 0,
                    totalDisVal: 0,
                    lastPrice: 0
                  };
                }

                stockMap[code].totalDisQty += qty;
                stockMap[code].totalDisVal += value;
              });
            }
          });
        }

        const tableBody = document.getElementById('tableBody');
        if (!tableBody) {
          console.error("❌ لم يتم العثور على عنصر الجدول tableBody");
          return;
        }

        tableBody.innerHTML = '';

        const rows = Object.values(stockMap).map(item => {
          const remainingQty = item.totalAddQty - item.totalDisQty;
          const remainingVal = remainingQty * item.lastPrice;

          return `
                <tr>
                    <td>${item.itemCode}</td>
                    <td>${item.itemName}</td>
                    <td>${item.totalAddQty}</td>
                    <td>${item.totalAddVal.toFixed(2)}</td>
                    <td>${item.totalDisQty}</td>
                    <td>${item.totalDisVal.toFixed(2)}</td>
                    <td>${remainingQty}</td>
                    <td>${remainingVal.toFixed(2)}</td>
                </tr>
            `;
        });

        tableBody.innerHTML = rows.length
          ? rows.join('')
          : '<tr><td colspan="8">لا توجد بيانات مطابقة للفلاتر</td></tr>';
      }).catch(error => {
        console.error("❌ خطأ في تحميل البيانات:", error);
        alert("❌ حدث خطأ أثناء تحميل بيانات التقرير.");
      });
    };

    window.exportToExcelStore = function () {
      const table = document.getElementById("stockTable");
      if (!table) {
        alert("❌ لم يتم العثور على الجدول.");
        return;
      }

      const wb = XLSX.utils.table_to_book(table, { sheet: "رصيد المخزون" });
      XLSX.writeFile(wb, "تقرير_رصيد_المخزون.xlsx");
    }

    ////////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////////////// رواتر //////////////////////////////////////////////////
    let isEditingRouter = false;
    let editingRouterId = null;
    function loadCompaniesIntoSelectRouter() {
      const companySelect = document.getElementById("CompanySelectRouter");
      const queryCompanySelect = document.getElementById("queryCompanySelectRouter");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeRouter");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }
    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectRouter);

    document.addEventListener("DOMContentLoaded", function () {
      const phoneInput = document.getElementById("phoneNumberRouter");

      if (!phoneInput) {
        console.error("❌ عنصر phoneNumber غير موجود في الصفحة!");
        return;
      }

      phoneInput.addEventListener("input", async function () {
        const phone = this.value.trim();
        const deviceType = document.getElementById("deviceTypeRouter").value;

        if (deviceType !== "متنقل" || phone.length !== 11) return;

        try {
          const linesRef = ref(database, "lines");
          const snapshot = await get(linesRef);

          if (snapshot.exists()) {
            let found = false;

            snapshot.forEach(child => {
              const line = child.val();
              const linePhone = (line.phoneNumber || "").trim();

              if (!line.deleted && linePhone === phone) {
                document.getElementById("userNameRouter").value = line.employeeName || '';
                document.getElementById("simNumberRouter").value = line.simNumber || '';
                found = true;
                console.log("✅ تم العثور على الخط:", line);
                return true;
              }
            });

            if (!found) {
              document.getElementById("userNameRouter").value = '';
              document.getElementById("simNumberRouter").value = '';
              console.warn("⚠️ لم يتم العثور على خط بهذا الرقم.");
            }
          }
        } catch (error) {
          console.error("❌ خطأ أثناء جلب بيانات الخط:", error);
        }
      });
    });

    window.saveDataRouter = async function () {
      const routerSave = localStorage.getItem('routerSave') === 'true';
      const routerEdit = localStorage.getItem('routerEdit') === 'true';
      const dataId = document.getElementById("docNumberRouter").getAttribute("data-id");

      const companySelect = document.getElementById("CompanySelectRouter");
      const selectedCompanyName = companySelect.options[companySelect.selectedIndex]?.textContent?.trim() || "";
      const companyCode = document.getElementById("selectedCompanyCodeRouter").value;

      if (!dataId && !routerSave) {
        alert("❌ ليس لديك صلاحية إضافة بيانات جديدة.");
        return;
      }
      if (dataId && !routerEdit) {
        alert("❌ ليس لديك صلاحية تعديل البيانات.");
        return;
      }

      const saveBtn = document.querySelector("button[onclick='saveDataRouter()']");
      const form = document.getElementById("routerForm");
      const formData = new FormData(form);
      const data = {};

      data.companyCode = companyCode;
      data.companyName = selectedCompanyName;

      for (let [k, v] of formData.entries()) {
        data[k] = v.trim();
      }

      const deviceType = document.getElementById("deviceTypeRouter").value;
      const routerModel = document.getElementById("routerModel").value;

      if (deviceType === "متنقل") {
        if (!data.userNameRouter || !data.phoneNumberRouter || !data.simNumberRouter) {
          alert("يرجى إدخال اسم المستخدم، رقم الهاتف، ورقم الشريحة (SIM)");
          return;
        }
      }

      if (deviceType === "ثابت" && (!data.macAddress || !data.landlineNumber)) {
        alert("يرجى إدخال عنوان MAC ورقم الهاتف الأرضي");
        return;
      }

      if (deviceType === "آخر" && !data.deviceDescription) {
        alert("يرجى إدخال وصف الجهاز");
        return;
      }

      if (routerModel === "آخر" && !data.otherRouterModel) {
        alert("يرجى إدخال اسم الموديل في حال اختيار 'آخر'");
        return;
      }

      const required = ['date', 'location', 'deviceStatus', 'deviceTypeRouter', 'routerModel', 'serialNumber', 'providerCompany'];
      for (let f of required) {
        if (!data[f]) {
          alert("يرجى تعبئة كافة الحقول الإلزامية");
          return;
        }
      }

      try {
        saveBtn.disabled = true;
        const routersRef = ref(database, "routers");

        if (dataId) {
          const thisRef = ref(database, `routers/${dataId}`);
          const snap = await get(thisRef);
          if (!snap.exists()) {
            alert("❌ المستند غير موجود!");
            saveBtn.disabled = false;
            return;
          }
          const before = snap.val();
          if (before.deleted) {
            alert("❌ لا يمكن تعديل مستند محذوف!");
            saveBtn.disabled = false;
            return;
          }
          await update(thisRef, data);
          alert("✅ تم تعديل البيانات بنجاح!");
        } else {
          const snapshot = await get(routersRef);
          const used = new Set();

          if (snapshot.exists()) {
            snapshot.forEach(ch => {
              const num = Number(ch.val().docNumber);
              if (!isNaN(num)) used.add(num);
            });
          }

          let docNum = parseInt(data.docNumber, 10);
          if (!docNum || isNaN(docNum)) {
            let n = 1;
            while (used.has(n)) n++;
            docNum = n;
          } else if (used.has(docNum)) {
            alert("⚠️ رقم المستند مستخدم بالفعل. يرجى اختيار رقم آخر.");
            saveBtn.disabled = false;
            return;
          }

          data.docNumber = docNum;
          document.getElementById("docNumberRouter").value = docNum;

          await push(routersRef, data);
          alert(`✅ تم حفظ البيانات الجديدة بنجاح! رقم المستند: ${docNum}`);
        }

        form.reset();
        ['mobileFieldsRouter', 'fixedFieldsRouter', 'otherFieldsRouter', 'customRouterModelRouter']
          .forEach(id => document.getElementById(id).style.display = 'none');

        if (deviceType === "متنقل") {
          const settingsSnap = await get(ref(database, `companySettings/${companyCode}`));
          if (!settingsSnap.exists()) {
            alert("❌ لم يتم العثور على إعدادات الشركة لهذا الكود!");
          } else {
            const settingsData = settingsSnap.val();
            window.showRouterHandoverInvoice(data, settingsData);
          }
        }

      } catch (err) {
        console.error("❌ خطأ في حفظ البيانات:", err);
        alert("❌ حدث خطأ أثناء الحفظ: " + err.message);
      } finally {
        saveBtn.disabled = false;
      }
    };

    window.searchRouter = async function (showAll = false) {
      const RouterQuery = localStorage.getItem('RouterQuery1') === 'true';
      const dataId = document.getElementById("searchDocNumRouter").getAttribute("data-id");

      if (!dataId && !RouterQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }
      const docNum = document.getElementById("searchDocNumRouter").value.trim();
      const date = document.getElementById("searchDateRouter").value;
      const status = document.getElementById("searchRouterStatus").value;
      const provider = document.getElementById("searchProviderCompany").value;
      const location = document.getElementById("searchLocationRouter").value;
      const type = document.getElementById("searchRouterType").value;
      const generalSearch = document.getElementById("generalSearchRouter").value.trim().toLowerCase();
      const companyFilter = document.getElementById("selectedCompanyCodeRouter").value;

      const container = document.getElementById("queryResultsRouter");
      container.innerHTML = "⏳ جاري تحميل البيانات...";

      try {
        const compSnap = await get(ref(database, "companies"));
        const companyMap = {};
        if (compSnap.exists()) {
          compSnap.forEach(c => {
            const comp = c.val();
            companyMap[comp.code] = comp.name;
          });
        }

        const snap = await get(ref(database, "routers"));
        if (!snap.exists()) {
          container.innerHTML = "❌ لا توجد بيانات.";
          return;
        }

        let results = [];
        snap.forEach(c => {
          const r = { id: c.key, ...c.val() };
          if (!showAll) {
            if (docNum && String(r.docNumber) !== docNum) return;
            if (date && String(r.date) !== date) return;
            if (provider && String(r.providerCompany) !== provider) return;
            if (location && String(r.location) !== location) return;
            if (type && String(r.deviceTypeRouter) !== type) return;
            if (status && String(r.deviceStatus) !== status) return;
            if (companyFilter && String(r.companyCode) !== companyFilter) return;

            if (generalSearch) {
              const matched = Object.values(r).some(v =>
                String(v).toLowerCase().includes(generalSearch)
              );
              if (!matched) return;
            }
          }
          results.push(r);
        });

        if (results.length === 0) {
          container.innerHTML = "⚠️ لم يتم العثور على نتائج.";
          return;
        }

        results.forEach(r => {
          if (r.companyCode && companyMap[r.companyCode]) {
            r.companyCode = companyMap[r.companyCode];
          }
        });

        results.sort((a, b) => (parseInt(a.docNumber) || 0) - (parseInt(b.docNumber) || 0));

        const table = document.createElement("table");
        table.style.cssText = "width:100%;border-collapse:collapse;text-align:center";

        const thead = document.createElement("thead");
        thead.style.background = "#f0f0f0";
        const headRow = document.createElement("tr");
        selectedColumnsRouter.forEach(col => {
          const th = document.createElement("th");
          th.textContent = allColumnsRouter[col] || col;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        results.forEach(r => {
          const allEmpty = selectedColumnsRouter.every(col => {
            const v = r[col];
            return v === null || v === undefined || String(v).trim() === "";
          });
          if (allEmpty) return;

          const tr = document.createElement("tr");
          if (r.deleted) tr.style.cssText = "color:red;background:#ffe6e6";

          selectedColumnsRouter.forEach(col => {
            const td = document.createElement("td");
            if (col === "routerModel") {
              td.innerHTML = r.routerModel === "آخر"
                ? (r.otherRouterModel || "-")
                : (r.routerModel || "-");
            } else if (col === "googleMapsLink") {
              td.innerHTML = r.googleMapsLink
                ? `<a href="${r.googleMapsLink}" target="_blank">فتح الخريطة</a>`
                : "-";
            } else if (col === "extraDetails") {
              if (r.deviceTypeRouter === "متنقل") {
                td.innerHTML = `هاتف: ${r.phoneNumberRouter || "-"}<br>SIM: ${r.simNumberRouter || "-"}<br>الاسم: ${r.userNameRouter || "-"}`;
              } else if (r.deviceTypeRouter === "ثابت") {
                td.innerHTML = `أرضي: ${r.landlineNumber || "-"}<br>MAC: ${r.macAddress || "-"}`;
              } else if (r.deviceTypeRouter === "آخر") {
                td.innerHTML = `وصف: ${r.deviceDescription || "-"}`;
              } else {
                td.innerHTML = "-";
              }
            } else {
              td.textContent = r[col] || "-";
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        container.innerHTML = "";
        container.appendChild(table);
        window.lastRouterResults = results;

      } catch (e) {
        console.error("❌ خطأ أثناء الاستعلام:", e);
        container.innerHTML = "❌ حدث خطأ أثناء تحميل البيانات.";
      }
    };

    const allColumnsRouter = {
      companyCode: " اسم الشركه ",
      docNumber: "رقم المستند",
      date: "التاريخ",
      location: "الموقع",
      deviceStatus: "الحالة",
      deviceTypeRouter: "نوع الراوتر",
      providerCompany: "الشركة التابع لها الراوتر",
      routerModel: "موديل الراوتر",
      serialNumber: "الرقم التسلسلي",
      ssid: "SSID",
      wifiPassword: "كلمة المرور",
      ipAddress: "IP",
      googleMapsLink: "رابط Google Maps",
      notes: "ملاحظات",
      extraDetails: "تفاصيل إضافية"
    };

    let selectedColumnsRouter = Object.keys(allColumnsRouter);

    window.toggleColumnFilterRouter = function () {
      const box = document.getElementById("columnFilterBoxRouter");
      const container = document.getElementById("columnCheckboxesRouter");
      box.style.display = box.style.display === "none" ? "block" : "none";

      if (container.innerHTML === "") {
        Object.keys(allColumnsRouter).forEach(key => {
          container.innerHTML += `
                <label><input type="checkbox" class="columnCheckboxRouter" value="${key}" checked> ${allColumnsRouter[key]}</label>
            `;
        });
      }
    }
    window.applyColumnFilterRouter = function () {
      selectedColumnsRouter = Array.from(document.querySelectorAll('.columnCheckboxRouter:checked')).map(cb => cb.value);
      document.getElementById("columnFilterBoxRouter").style.display = "none";
      searchRouter();
    };

    window.printTableRouter = function () {
      const resultsContainer = document.getElementById("queryResultsRouter");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة بيانات الهواتف</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelRouter = function () {
      const data = window.lastRouterResults;
      if (!data || data.length === 0) {
        alert("⚠️ لا توجد بيانات لتصديرها.");
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "RouterData");
      XLSX.writeFile(workbook, "router_data.xlsx");
    };

    window.showRouterHandoverInvoice = function (data, settings) {
      try {
        const html = `
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="UTF-8">
      <title>نموذج استلام راوتر</title>
      <style>
        body { font-family: 'Arial', sans-serif; margin: 40px; direction: rtl; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header img { height: 80px; }
        .company-info { text-align: left; font-size: 14px; line-height: 1.6; }
        h1 { text-align: center; margin: 30px 0; color: #0d47a1; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background-color: #f2f2f2; }
        .acknowledgment { margin-top: 30px; font-size: 15px; line-height: 1.8; }
        .signatures { display: flex; justify-content: space-between; margin-top: 50px; }
        .signatures div { width: 30%; text-align: center; }
        .signatures .line { border-top: 1px solid #000; margin-top: 40px; }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="${settings.logoUrl || ''}" alt="شعار الشركة">
        <div class="company-info">
          <div style="font-weight:bold; font-size:18px;">${settings.name || ''}</div>
          <div style="font-size:14px;">العنوان: ${settings.address || ''}</div>
          <div style="font-size:14px;">الهاتف: ${settings.phone || ''}</div>
          <div style="font-size:14px;">الإيميل: ${settings.email || ''}</div>
        </div>
      </div>

      <h1>نموذج استلام جهاز راوتر موظف</h1>

      <table>
        <tr>
          <th>اسم الموظف</th>
          <th>الموقع</th>
          <th>تاريخ الاستلام</th>
          <th>موديل الراوتر</th>
          <th>رقم السيريال</th>
        </tr>
        <tr>
          <td>${data.userNameRouter}</td>
          <td>${data.location}</td>
          <td>${data.date}</td>
          <td>${data.routerModel}</td>
          <td>${data.serialNumber}</td>
        </tr>
      </table>

      <table>
        <tr><th>اسم المستخدم (User Name)</th><td>${data.userNameRouter}</td></tr>
        <tr><th>رقم الهاتف</th><td>${data.phoneNumberRouter}</td></tr>
        <tr><th>رقم الشريحة (SIM)</th><td>${data.simNumberRouter}</td></tr>
        <tr><th>شركة المزود</th><td>${data.providerCompany}</td></tr>
      </table>

      <div class="acknowledgment">
        أقر أنا الموقع أدناه بأنني استلمت جهاز الراوتر والمعلومات الموضحة أعلاه كاملة وسليمة،
        وأتعهد بالمحافظة عليه واستخدامه للأغراض الوظيفية فقط، وفي حال فقدانه أو تلفه أتحمل كامل المسؤولية.
      </div>

      <div class="signatures">
        <div>
          <p>توقيع الموظف</p>
          <div class="line"></div>
        </div>
        <div>
          <p>توقيع مسؤول العهدة</p>
          <div class="line"></div>
        </div>
        <div>
          <p>توقيع الإدارة</p>
          <div class="line"></div>
        </div>
      </div>
    </body>
    </html>
    `;

        const printWin = window.open("", "_blank");
        printWin.document.write(html);
        printWin.document.close();
        printWin.focus();
      } catch (error) {
        alert("❌ خطأ أثناء عرض نموذج العهدة: " + error.message);
        console.error(error);
      }
    };

    ////////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////طباعات //////////////////////////////////////////////////////////////////
    let currentEditingPrinterType = null;
    window.addPrinterData = async function () {
      const newType = document.getElementById("deviceTypeInputPrint").value.trim();
      const models = document.getElementById("deviceModelsInputPrinter").value
        .split(',')
        .map(m => m.trim())
        .filter(Boolean);

      if (!newType || models.length === 0) {
        alert("❌ يرجى إدخال نوع الجهاز والموديلات.");
        return;
      }

      if (currentEditingPrinterType && newType !== currentEditingPrinterType) {
        await remove(ref(database, "Printer/" + currentEditingPrinterType));
      }

      await set(ref(database, "Printer/" + newType), {
        models: models
      });

      alert(currentEditingPrinterType ? "✅ تم حفظ بيانات الجهاز." : "✅ تم إضافة الجهاز بنجاح.");
      document.getElementById("deviceTypeInputPrint").value = "";
      document.getElementById("deviceModelsInputPrinter").value = "";
      document.getElementById("updateDeviceButton").textContent = "إضافة";
      document.getElementById("deleteDeviceButton").style.display = "none";
      currentEditingPrinterType = null;
      loadDeviceTablePrinter();
      populateDeviceTypeOptionsPrinter();
    };

    window.editDeviceType = function (type) {
      const modelsRef = ref(database, "Printer/" + type + "/models");

      get(modelsRef).then(snapshot => {
        const models = snapshot.val();

        if (Array.isArray(models)) {
          document.getElementById("deviceTypeInputPrint").value = type;
          document.getElementById("deviceModelsInputPrinter").value = models.join(', ');
          currentEditingPrinterType = type;
          document.getElementById("updateDeviceButton").textContent = "تحديث";
          document.getElementById("deleteDeviceButton").style.display = "inline-block";
        }
      });
    };

    function loadDeviceTablePrinter() {
      const tableBody = document.querySelector("#PrinterTable tbody");
      const deviceRef = ref(database, "Printer");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        tableBody.innerHTML = "";

        for (const type in data) {
          const models = data[type].models;
          const row = document.createElement("tr");

          row.innerHTML = `
                <td>${type}</td>
                <td>${models.join(', ')}</td>
            `;

          row.addEventListener("click", () => {
            fetchDeviceDataPrinter(type);
          });

          tableBody.appendChild(row);
        }
      });
    }

    function populateDeviceTypeOptionsPrinter() {
      const deviceTypeSelect = document.getElementById("printer_name");
      const queryDeviceType = document.getElementById("filter_printer_type");

      const deviceRef = ref(database, "Printer");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();

        const defaultOption = '<option value="">-- اختر نوع الجهاز --</option>';
        deviceTypeSelect.innerHTML = defaultOption;
        queryDeviceType.innerHTML = defaultOption;

        if (!data) return;

        Object.keys(data).forEach(type => {
          const option1 = document.createElement("option");
          option1.value = type;
          option1.textContent = type;

          const option2 = option1.cloneNode(true);

          deviceTypeSelect.appendChild(option1);
          queryDeviceType.appendChild(option2);
        });
      }, {
        onlyOnce: true
      });
    }

    document.getElementById("printer_name").addEventListener("change", (e) => {
      const selectedType = e.target.value;
      const modelSelect = document.getElementById("printer_model");

      modelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

      if (selectedType) {
        const modelsRef = ref(database, "Printer/" + selectedType + "/models");
        onValue(modelsRef, (snapshot) => {
          const models = snapshot.val();
          if (Array.isArray(models)) {
            models.forEach(model => {
              const opt = document.createElement("option");
              opt.value = model;
              opt.textContent = model;
              modelSelect.appendChild(opt);
            });
          }
        });
      }
    });
    loadDeviceTablePrinter();
    populateDeviceTypeOptionsPrinter();

    function loadCompaniesIntoSelectPrinter() {
      const companySelect = document.getElementById("printerCompanySelect");
      const queryCompanySelect = document.getElementById("queryCompanySelectPrinter");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodePrinter");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }

    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectPrinter);

    window.saveDataPrint = async function () {

      const PrintSave = localStorage.getItem('PrintSave') === 'true';
      const PrintEdit = localStorage.getItem('PrintEdit') === 'true';
      const dataId = document.getElementById("doc_number").getAttribute("data-id");

      if (!dataId && !PrintSave) {
        alert("❌ ليس لديك صلاحية إضافة بيانات جديدة.");
        return;
      }
      if (dataId && !PrintEdit) {
        alert("❌ ليس لديك صلاحية تعديل البيانات.");
        return;
      }
      const docNumberInput = document.getElementById("doc_number");
      const doc_number_input = docNumberInput.value.trim();
      const existingId = docNumberInput.getAttribute("data-id");
      const doc_date = document.getElementById("doc_date").value;
      const location = document.getElementById("locationPrint").value;
      const printer_name = document.getElementById("printer_name").value;
      const printer_type = document.getElementById("printer_type").value;
      const serial_number = document.getElementById("serial_number").value;
      const ip_address = document.getElementById("ip_address").value;
      const status = document.getElementById("statusPrint").value;
      const notes = document.getElementById("notesPrint").value;
      const printer_model = document.getElementById("printer_model").value;
      const companyCode = document.getElementById("printerCompanySelect").value;
      const companyName = document.getElementById("printerCompanySelect").selectedOptions[0]?.textContent || "";

      if (!doc_date || !location || !printer_name || !printer_type || !serial_number || !printer_model || !companyCode) {
        alert("يرجى تعبئة جميع الحقول الإلزامية.");
        return;
      }

      const printersRef = ref(database, 'printers');

      if (existingId) {
        const editRef = ref(database, `printers/${existingId}`);
        update(editRef, {
          doc_number: parseInt(doc_number_input),
          doc_date,
          location,
          printer_name,
          printer_type,
          serial_number,
          ip_address,
          status,
          printer_model,
          notes,
          company: {
            code: companyCode,
            name: companyName
          }
        }).then(() => {
          alert("✅ تم تعديل البيانات بنجاح!");
          document.getElementById("printerForm").reset();
          docNumberInput.removeAttribute("data-id");
          docNumberInput.removeAttribute("readonly");
        }).catch((error) => {
          alert("❌ حدث خطأ أثناء التعديل: " + error.message);
        });

      } else {
        const snapshot = await get(printersRef);
        const usedNumbers = [];

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const n = parseInt(child.val().doc_number);
            if (!isNaN(n)) usedNumbers.push(n);
          });
        }

        let doc_number;
        if (doc_number_input) {
          doc_number = parseInt(doc_number_input);
          if (usedNumbers.includes(doc_number)) {
            alert("رقم المستند موجود بالفعل! يرجى اختيار رقم آخر.");
            return;
          }
        } else {
          let next = 1;
          while (usedNumbers.includes(next)) {
            next++;
          }
          doc_number = next;
        }

        const newPrinterRef = push(printersRef);
        set(newPrinterRef, {
          doc_number,
          doc_date,
          location,
          printer_name,
          printer_type,
          serial_number,
          ip_address,
          status,
          printer_model,
          notes,
          company: {
            code: companyCode,
            name: companyName
          }

        }).then(() => {
          alert("✅ تم حفظ البيانات بنجاح برقم المستند: " + doc_number);
          document.getElementById("printerForm").reset();
        }).catch((error) => {
          alert("❌ حدث خطأ أثناء الحفظ: " + error.message);
        });
      }
    };

    window.searchPrinters = async function () {
      const PrintQuery = localStorage.getItem('PrintQuery1') === 'true';
      const dataId = document.getElementById("filter_doc_number").getAttribute("data-id");

      if (!dataId && !PrintQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }

      const doc_number = document.getElementById("filter_doc_number").value.trim();
      const doc_date = document.getElementById("filter_doc_date").value;
      const printer_name = document.getElementById("filter_printer_type").value.trim().toLowerCase();
      const status = document.getElementById("filter_status").value.trim().toLowerCase();
      const generalSearchPrint = document.getElementById("generalSearchPrint").value.trim().toLowerCase();
      const LocationPrinter = document.getElementById("filter_LocationPrinter").value.trim().toLowerCase();
      const queryCompanyName = document.getElementById("queryCompanySelectPrinter").value.trim().toLowerCase();

      const resultsTable = document.getElementById("resultsTable");
      resultsTable.innerHTML = "<p>جاري التحميل...</p>";

      try {
        const printersRef = ref(database, 'printers');
        const snapshot = await get(printersRef);

        if (!snapshot.exists()) {
          resultsTable.innerHTML = "<p>لا توجد بيانات</p>";
          return;
        }

        let rows = "";
        let matchingResults = [];

        snapshot.forEach(child => {
          const data = child.val();

          const matchesDocNumber = !doc_number || data.doc_number?.toString() === doc_number;
          const matchesDate = !doc_date || data.doc_date === doc_date;
          const matchesType = !printer_name || (data.printer_name || '').toLowerCase().includes(printer_name);
          const matchesStatus = !status || (data.status || '').toLowerCase().includes(status);
          const matchesLocation = !LocationPrinter || (data.location || '').toLowerCase().includes(LocationPrinter);
          const matchesCompanyName = !queryCompanyName || (data.company?.code || '').toLowerCase() === queryCompanyName;

          let matchesGeneral = true;
          if (generalSearchPrint) {
            const values = Object.values(data).map(v => String(v).toLowerCase());
            matchesGeneral = values.some(val => val.includes(generalSearchPrint));
          }

          if (matchesDocNumber && matchesDate && matchesType && matchesStatus && matchesLocation && matchesCompanyName && matchesGeneral) {
            matchingResults.push(data);

            const isDeleted = data.deleted === true;
            const rowStyle = isDeleted ? 'style="background-color: #ffdddd;"' : "";

            rows += `
                    <tr ${rowStyle}>
                        <td>${data.doc_number || ""}</td>
                        <td>${data.company?.name || ""}</td>
                        <td>${data.doc_date || ""}</td>
                        <td>${data.location || ""}</td>
                        <td>${data.printer_name || ""}</td>
                        <td>${data.printer_type || ""}</td>
                        <td>${data.printer_model || ""}</td>
                        <td>${data.serial_number || ""}</td>
                        <td>${data.ip_address || ""}</td>
                        <td>${data.status || ""}</td>
                        <td>${data.notes || ""}</td>
                    </tr>
                `;
          }
        });

        window.lastRouterResults = matchingResults;

        if (rows === "") {
          resultsTable.innerHTML = "<p>لا توجد نتائج مطابقة</p>";
        } else {
          resultsTable.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;" border="1">
                    <thead style="background-color: #f0f0f0;">
                        <tr>
                            <th>رقم المستند</th>
                            <th> اسم الشركه</th>
                            <th>تاريخ المستند</th>
                            <th>الموقع</th>
                            <th>اسم الطابعة</th>
                            <th>نوع الطابعة</th>
                            <th>موديل الطابعة</th>
                            <th>الرقم التسلسلي</th>
                            <th>IP</th>
                            <th>الحالة</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }
      } catch (error) {
        console.error("خطأ في تحميل البيانات:", error);
        resultsTable.innerHTML = `<p>حدث خطأ: ${error.message}</p>`;
      }
    };

    window.printTablePrint = function () {
      const resultsContainer = document.getElementById("resultsTable");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة بيانات الهواتف</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelPrint = function () {
      const data = window.lastRouterResults;
      if (!data || data.length === 0) {
        alert("⚠️ لا توجد بيانات لتصديرها.");
        return;
      }
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "PrintData");
      XLSX.writeFile(workbook, "Print_data.xlsx");
    };

    //////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////// عهده مؤقتة ////////////////////////////////////////
    let temporaryAssetsList = [];
    async function loadEquipmentTypes() {
      const equipmentTypeSelect = document.getElementById('equipmentType');
      const filterEquipmentType = document.getElementById('filter_equipment_type');
      const editEquipmentType = document.getElementById('editEquipmentType');

      const selects = [equipmentTypeSelect, filterEquipmentType, editEquipmentType];

      const itemsRef = ref(database, 'items');

      try {
        const snapshot = await get(itemsRef);
        if (snapshot.exists()) {
          const items = snapshot.val();

          selects.forEach(select => {
            if (select) {
              select.innerHTML = '<option value="">-- اختر نوع العهدة --</option>';
            }
          });

          Object.values(items).forEach(item => {
            selects.forEach(select => {
              if (select) {
                const option = document.createElement('option');
                option.value = item.itemName;
                option.textContent = item.itemName;
                select.appendChild(option);
              }
            });
          });
        } else {
          console.warn("⚠️ لا توجد عناصر مسجلة في قاعدة البيانات.");
        }
      } catch (error) {
        console.error("❌ خطأ أثناء تحميل الأصناف:", error);
        alert("حدث خطأ أثناء تحميل أنواع العهدة.");
      }
    }

    async function loadTemporaryAssets() {
      const tempAssetsRef = ref(database, 'temporaryAssets');
      try {
        const snapshot = await get(tempAssetsRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          temporaryAssetsList = Object.values(data);
          renderTemporaryTable();
        }
      } catch (error) {
        console.error("❌ خطأ أثناء تحميل العهد:", error);
        alert("حدث خطأ أثناء تحميل العهد المسجلة.");
      }
    }

    function renderTemporaryTable() {
      const container = document.getElementById("temporaryTableContainer");

      const filteredList = temporaryAssetsList.filter(item => item.status !== "تم الإرجاع");

      if (filteredList.length === 0) {
        container.innerHTML = "<p>لا توجد عهد مسجلة حالياً (كل العهد تم إرجاعها).</p>";
        return;
      }

      let rows = filteredList.map(item => `
        <tr>
            <td>${item.documentNumber}</td>
            <td>${item.employeeName}</td>
            <td>${item.equipmentType}</td>
            <td>${item.handoverDate}</td>
            <td>
                <select onchange="updateStatus(${item.documentNumber}, this.value)">
                    <option value="">-- اختر الحالة --</option>
                    <option value="حدث كسر" ${item.whatHappened === "حدث كسر" ? "selected" : ""}>حدث كسر</option>
                    <option value="سرق" ${item.whatHappened === "سرق" ? "selected" : ""}>سرق</option>
                    <option value="مفقودة" ${item.whatHappened === "مفقودة" ? "selected" : ""}>مفقودة</option>
                    <option value="تم بيعه" ${item.whatHappened === "تم بيعه" ? "selected" : ""}>تم بيعه</option>
                </select>
                <br/>
                <button data-doc="${item.documentNumber}" onclick="markAsReturnedToday(${item.documentNumber})">
                    📦 تم التسليم اليوم
                </button>
            </td>
            <td>${item.notes || ""}</td>
        </tr>
    `).join("");

      container.innerHTML = `
        <table border="1" style="width:100%; text-align:center; border-collapse: collapse;">
            <thead style="background-color: #f0f0f0;">
                <tr>
                    <th>رقم المستند</th>
                    <th>الموظف</th>
                    <th>نوع العهدة</th>
                    <th>تاريخ التسليم</th>
                    <th>ماذا حدث للعهدة؟</th>
                    <th>ملاحظات</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    }

    window.markAsReturnedToday = async function (documentNumber) {
      const docId = Number(documentNumber);
      const assetIndex = temporaryAssetsList.findIndex(item => item.documentNumber === docId);

      if (assetIndex === -1) {
        alert("❗ لا يمكن العثور على العهدة.");
        return;
      }

      const asset = temporaryAssetsList[assetIndex];
      const button = document.querySelector(`button[data-doc='${docId}']`);

      if (button) {
        button.disabled = true;
        button.textContent = "⏳ جاري التحديث...";
      }

      try {
        asset.status = "تم الإرجاع";
        asset.expectedReturn = new Date().toISOString().split('T')[0];
        const baseNote = (asset.notes || "").split('|')[0].trim();

        asset.notes = baseNote + (asset.whatHappened ? ` | ما حدث: ${asset.whatHappened}` : " | تم الاسترجاع");

        const tempRef = ref(database, `temporaryAssets/${docId}`);
        await set(tempRef, asset);

        temporaryAssetsList.splice(assetIndex, 1);
        showTemporaryReturnInvoice(asset);
        renderTemporaryTable();

        alert(`✅ تم تحديث العهدة رقم ${docId} كمُسترجعة.`);
      } catch (error) {
        console.error("❌ خطأ أثناء التحديث:", error);
        alert("❌ حدث خطأ أثناء تحديث العهدة.");
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = "📦 تم التسليم اليوم";
        }
      }
    };

    window.saveTemporaryForm = async function () {
      const employeeName = document.getElementById("employeeName").value.trim();
      const handoverDate = document.getElementById("handoverDate").value;
      const equipmentType = document.getElementById("equipmentType").value;
      const notes = document.getElementById("notesTemporary").value.trim();

      if (!employeeName) return alert("❗ يرجى إدخال اسم الموظف.");
      if (!equipmentType) return alert("❗ يرجى اختيار نوع العهدة.");
      if (!handoverDate) return alert("❗ يرجى إدخال تاريخ التسليم.");

      try {
        const counterRef = ref(database, 'temporaryAssetsCounter');
        const newDocNumber = await runTransaction(counterRef, (currentValue) => (currentValue || 0) + 1);

        const documentNumber = newDocNumber.snapshot.val();

        const tempFormData = {
          documentNumber,
          employeeName,
          equipmentType,
          handoverDate,
          status: "قيد الاستخدام",
          notes: notes ? `${notes} | قيد الاسترجاع` : "قيد الاسترجاع",
          whatHappened: ""
        };

        const tempRef = ref(database, `temporaryAssets/${documentNumber}`);
        await set(tempRef, tempFormData);

        temporaryAssetsList.push(tempFormData);
        renderTemporaryTable();
        showTemporaryHandoverInvoice(tempFormData);

        alert(`✅ تم استلام العهدة بنجاح. رقم المستند: ${documentNumber}`);
        document.getElementById("temporaryForm").reset();
      } catch (error) {
        console.error("❌ خطأ أثناء الحفظ:", error);
        alert("حدث خطأ أثناء حفظ البيانات.");
      }
    };

    window.updateTemporaryForm = async function () {
      const docNumber = document.getElementById("editDocumentNumberTemporary").value;
      const employeeName = document.getElementById("editEmployeeName").value.trim();
      const equipmentType = document.getElementById("editEquipmentType").value;
      const expectedReturn = document.getElementById("editReturnDate").value;
      const handoverDate = document.getElementById("editHandoverDate").value;
      const notes = document.getElementById("editNotesTemporary").value.trim();

      if (!docNumber || !employeeName || !equipmentType) {
        alert("يرجى تعبئة جميع الحقول المطلوبة.");
        return;
      }

      const tempRef = ref(database, `temporaryAssets/${docNumber}`);

      try {
        const snapshot = await get(tempRef);
        if (!snapshot.exists()) {
          alert("❌ لا يمكن تعديل السجل لأنه غير موجود.");
          return;
        }

        const currentData = snapshot.val();

        if (currentData.status !== "تم الإرجاع") {
          alert("⚠️ لا يمكن تعديل هذه العهدة لأنها لم تُسلم بعد.");
          return;
        }

        if (currentData.deleted === true) {
          alert("⚠️ لا يمكن تعديل هذه العهدة لأنها محذوفة.");
          return;
        }

        const updatedData = {
          ...currentData,
          documentNumber: parseInt(docNumber),
          employeeName,
          equipmentType,
          expectedReturn,
          handoverDate,
          notes
        };

        await set(tempRef, updatedData);

        const index = temporaryAssetsList.findIndex(item => item.documentNumber == docNumber);
        if (index !== -1) {
          temporaryAssetsList[index] = updatedData;
        }

        renderTemporaryTable();
        showTemporaryReturnInvoice(updatedData);
        alert("✅ تم تحديث بيانات العهدة المؤقتة بنجاح.");

        document.getElementById("editDocumentNumberTemporary").value = "";
        document.getElementById("editEmployeeName").value = "";
        document.getElementById("editEquipmentType").value = "";
        document.getElementById("editReturnDate").value = "";
        document.getElementById("editHandoverDate").value = "";
        document.getElementById("editNotesTemporary").value = "";

      } catch (error) {
        console.error("❌ خطأ أثناء التحديث:", error);
        alert("حدث خطأ أثناء تحديث البيانات.");
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      await loadEquipmentTypes();
      await loadTemporaryAssets();
    });

    window.searchTemporaryForms = async function () {
      const docNumber = document.getElementById("filter_temp_doc_number").value.trim();
      const employeeName = document.getElementById("filter_employee_name").value.trim().toLowerCase();
      const equipmentType = document.getElementById("filter_equipment_type").value.trim().toLowerCase();
      const handoverDate = document.getElementById("filter_handover_date").value;
      const generalSearch = document.getElementById("generalSearchTemporary").value.trim().toLowerCase();
      const resultsTable = document.getElementById("resultsTableTemporary");

      resultsTable.innerHTML = "<p>جاري البحث...</p>";

      try {
        const tempRef = ref(database, 'temporaryAssets');
        const snapshot = await get(tempRef);

        if (!snapshot.exists()) {
          resultsTable.innerHTML = "<p>❗ لا توجد بيانات متاحة</p>";
          return;
        }

        let rows = "";
        const matchingResults = [];

        snapshot.forEach(child => {
          const data = child.val();

          const matchDoc = !docNumber || data.documentNumber?.toString() === docNumber;
          const matchEmployee = !employeeName || (data.employeeName || "").toLowerCase().includes(employeeName);
          const matchType = !equipmentType || (data.equipmentType || "").toLowerCase().includes(equipmentType);
          const matchDate = !handoverDate || data.handoverDate === handoverDate;

          let matchGeneral = true;
          if (generalSearch) {
            const combinedValues = Object.values(data).join(" ").toLowerCase();
            matchGeneral = combinedValues.includes(generalSearch);
          }

          if (matchDoc && matchEmployee && matchType && matchDate && matchGeneral) {
            matchingResults.push(data);

            const isDeleted = data.deleted === true;
            const rowStyle = isDeleted ? 'style="background-color: #ffe6e6;"' : "";

            rows += `
                    <tr ${rowStyle}>
                        <td>${data.documentNumber || ""}</td>
                        <td>${data.employeeName || ""}</td>
                        <td>${data.equipmentType || ""}</td>
                        <td>${data.handoverDate || ""}</td>
                        <td>${data.expectedReturn || ""}</td>
                        <td>
                            ${data.notes || ""}
                            ${data.whatHappened ? `<br/><strong>ما حدث:</strong> ${data.whatHappened}` : ""}
                            ${isDeleted ? `<div style="color:red;"><strong>❌ محذوف</strong></div>` : ""}
                        </td>
                    </tr>
                `;
          }
        });

        window.lastTemporaryResults = matchingResults;

        if (matchingResults.length === 0) {
          resultsTable.innerHTML = "<p>🔍 لا توجد نتائج مطابقة.</p>";
        } else {
          resultsTable.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;" border="1">
                    <thead style="background-color: #f0f0f0;">
                        <tr>
                            <th>رقم المستند</th>
                            <th>اسم الموظف</th>
                            <th>نوع العهدة</th>
                            <th>تاريخ التسليم</th>
                            <th>تاريخ الاسترجاع</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

      } catch (error) {
        console.error("❌ خطأ أثناء البحث:", error);
        resultsTable.innerHTML = `<p>❌ حدث خطأ: ${error.message}</p>`;
      }
    };


    window.updateStatus = async function (index, newStatus) {
      const asset = temporaryAssetsList[index];
      if (!asset || !asset.documentNumber) {
        alert("تعذر العثور على العهدة.");
        return;
      }
      asset.whatHappened = newStatus;
      try {
        const tempRef = ref(database, `temporaryAssets/${asset.documentNumber}`);
        await set(tempRef, asset);
        alert("✅ تم تحديث ما حدث للعهدة.");
      } catch (error) {
        console.error("❌ خطأ أثناء تحديث الحالة:", error);
        alert("حدث خطأ أثناء تحديث الحالة.");
      }
    };

    window.exportToExcelTemporary = function () {
      const data = window.lastTemporaryResults;
      if (!data || data.length === 0) {
        alert("⚠️ لا توجد بيانات لتصديرها.");
        return;
      }
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "TemporaryAssets");
      XLSX.writeFile(workbook, "TemporaryAssets.xlsx");
    };

    function normalizeName(name) {
      return name.trim().replace(/\s+/g, ' ').toLowerCase();
    }

    window.searchAllAssets = function () {
      const employeeName = document.getElementById("employeeNameSearch").value.trim();
      if (!employeeName) {
        alert("⚠️ الرجاء إدخال اسم الموظف.");
        return;
      }

      document.getElementById("computersResult").innerHTML = "⏳ جاري البحث عن الأجهزة...";
      document.getElementById("phonesResult").innerHTML = "⏳ جاري البحث عن الهواتف...";
      document.getElementById("linesResult").innerHTML = "⏳ جاري البحث عن الخطوط...";
      document.getElementById("routersResult").innerHTML = "⏳ جاري البحث عن الراوترات...";
      document.getElementById("screensResult").innerHTML = "⏳ جاري البحث عن الشاشات...";

      searchComputers(employeeName);
      searchPhones(employeeName);
      searchLines(employeeName);
      searchRouters(employeeName);
      searchScreensByEmployee(employeeName);
    };

    function searchScreensByEmployee(name) {
      const refScreens = ref(database, "screens");
      const normalizedInput = normalizeName(name);

      document.getElementById("screensResult").innerHTML = "⏳ جاري البحث عن الشاشات...";

      get(refScreens).then(snapshot => {
        let html = `
            <div class="card">
                <div class="card-header text-center">الشاشات</div>
                <div class="card-body">
                    <div class="table-responsive">
        `;

        let found = false;
        let table = `
            <table class="table table-bordered table-hover text-center m-0">
                <thead class="thead-dark">
                    <tr>
                        <th>رقم المستند</th>
                        <th>الموظف</th>
                        <th>الموقع</th>
                        <th>نوع الشاشة</th>
                        <th>موديل</th>
                        <th>الرقم التسلسلي</th>
                        <th>الحجم</th>
                        <th>الدقة</th>
                        <th>عدد المنافذ</th>
                        <th>الحالة</th>
                        <th>التاريخ</th>
                        <th>ملاحظات</th>
                        <th>اسم الشركة</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody>`;

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const d = child.val();
            const employeeName = d.screenEmployeeName ? normalizeName(d.screenEmployeeName) : "";

            if (!d.deleted && employeeName.includes(normalizedInput)) {
              found = true;

              table += `
                        <tr>
                            <td>${d.documentNumberScreen || ""}</td>
                            <td>${d.screenEmployeeName || ""}</td>
                            <td>${d.screenLocation || ""}</td>
                            <td>${d.screenType || ""}</td>
                            <td>${d.screenModel || ""}</td>
                            <td>${d.serial || ""}</td>
                            <td>${d.size || ""}</td>
                            <td>${d.resolution || ""}</td>
                            <td>${d.ports || ""}</td>
                            <td>${d.condition || ""}</td>
                            <td>${d.dateScreen || ""}</td>
                            <td>${d.notesScreen || ""}</td>
                            <td>${(d.company && d.company.name) || ""}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="returnScreen('${child.key}', '${d.screenEmployeeName}')">
                                    استرجاع
                                </button>
                            </td>
                        </tr>`;
            }
          });

          table += "</tbody></table>";

          html += found
            ? table
            : "<div class='p-3 text-danger'>❌ لا توجد شاشات لهذا الموظف.</div>";
        } else {
          html += "<div class='p-3 text-danger'>❌ لا توجد بيانات.</div>";
        }

        html += "</div></div></div>";
        document.getElementById("screensResult").innerHTML = html;
      }).catch(error => {
        console.error("❌ خطأ في تحميل بيانات الشاشات:", error);
        document.getElementById("screensResult").innerHTML = `<div class="p-3 text-danger">❌ حدث خطأ أثناء البحث.</div>`;
      });
    }
    window.returnScreen = function (screenKey, employeeName) {
      const screenRef = ref(database, `screens/${screenKey}`);
      const today = new Date().toISOString().split('T')[0];

      update(screenRef, {
        screenEmployeeName: "قسم IT",
        notesScreen: `تم استرجاع العهدة بتاريخ ${today} بواسطة قسم IT`
      }).then(() => {
        alert("✅ تم استرجاع الشاشة بنجاح.");
        searchScreensByEmployee(employeeName);
      }).catch(error => {
        console.error("❌ خطأ في استرجاع الشاشة:", error);
        alert("❌ حدث خطأ أثناء الاسترجاع.");
      });
    };

    function searchRouters(name) {
      const refRouters = ref(database, "routers");
      get(refRouters).then(snapshot => {
        let html = `
            <div class="card">
                <div class="card-header text-center">
                    الراوترات
                </div>
                <div class="card-body">
                    <div class="table-responsive">
        `;

        let found = false;
        let count = 0;

        let table = `
            <table class="table table-bordered table-hover text-center m-0">
                <thead class="thead-dark">
                    <tr>
                        <th>رقم المستند</th>
                        <th>الاسم</th>
                        <th>الموقع</th>
                        <th>نوع الراوتر</th>
                        <th>موديل</th>
                        <th>التاريخ</th>
                        <th>IP</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody>`;

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const d = child.val();

            const userName = d.deviceTypeRouter === "متنقل" ? (d.userNameRouter || "") : (d.employeeName || "");
            const normalizedUserName = normalizeName(userName);
            const normalizedInput = normalizeName(name);

            if (!d.deleted && normalizedUserName.includes(normalizedInput)) {
              found = true;
              count++;

              table += `
                        <tr>
                            <td>${d.docNumber || "—"}</td>
                            <td>${userName || "—"}</td>
                            <td>${d.location || "—"}</td>
                            <td>${d.deviceTypeRouter || "—"}</td>
                            <td>${d.routerModel === "آخر" ? (d.otherRouterModel || "—") : (d.routerModel || "—")}</td>
                            <td>${d.date || "—"}</td>
                            <td>${d.ipAddress || "—"}</td>
                            <td>
                               <button class="btn btn-sm btn-warning" onclick="returnRouter('${child.key}')">
                                  استرجاع
                               </button>
                            </td>
                        </tr>`;
            }
          });

          table += "</tbody></table>";

          html += found
            ? table
            : "<div class='p-3 text-danger'>❌ لا توجد راوترات تطابق الاسم.</div>";
        } else {
          html += "<div class='p-3 text-danger'>❌ لا توجد بيانات.</div>";
        }

        html += `</div></div></div>`;
        document.getElementById("routersResult").innerHTML = html;
      }).catch(error => {
        console.error("❌ خطأ في تحميل بيانات الراوترات:", error);
        document.getElementById("routersResult").innerHTML = `<div class="p-3 text-danger">❌ حدث خطأ أثناء البحث.</div>`;
      });
    }
    window.returnRouter = function (routerKey) {
      const routerRef = ref(database, `routers/${routerKey}`);
      const today = new Date().toISOString().split('T')[0];
      update(routerRef, {
        userNameRouter: "قسم IT",
        notes: `تم استرجاع العهدة بتاريخ ${today} بواسطة قسم IT`
      }).then(() => {
        alert("✅ تم استرجاع الراوتر بنجاح.");
        const name = document.getElementById("userNameRouter").value;
        searchRouters(name);
      }).catch(error => {
        console.error("❌ خطأ في استرجاع الراوتر:", error);
        alert("❌ حدث خطأ.");
      });
    };

    function searchComputers(name) {
      const refComp = ref(database, "computers");
      get(refComp).then(snapshot => {
        let html = `
            <div class="card">
                <div class="card-header text-center">
                     الأجهزة
                </div>
                <div class="card-header text-center">
                    <div class="table-responsive">
        `;
        let found = false;
        let table = `
            <table class="table table-bordered table-hover text-center m-0">
                <thead class="thead-dark">
                    <tr>
                        <th>رقم العهدة</th>
                        <th>اسم الموظف</th>
                        <th>الموقع</th>
                        <th>نوع الجهاز</th>
                        <th>موديل</th>
                        <th>تاريخ الإضافة</th>
                        <th>إجراء</th>
                    </tr>
                </thead><tbody>`;

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const d = child.val();
            if (d.pcUser && d.pcUser.trim() === name) {
              found = true;
              table += `
                        <tr class="${d.deleted ? 'table-danger' : ''}">
                            <td>${d.pcNum}</td>
                            <td>${d.pcUser}</td>
                            <td>${d.pcLocation}</td>
                            <td>${d.deviceType}</td>
                            <td>${d.deviceModel}</td>
                            <td>${d.dateAdded}</td>
                            <td>
                               <button class="btn btn-sm btn-warning" onclick="returnComputers('${child.key}')">
                                  استرجاع
                                </button>
                            </td>
                        </tr>`;
            }
          });

          table += "</tbody></table>";
          html += found ? table : "<div class='p-3 text-danger'>❌ لا توجد أجهزة.</div>";
        } else {
          html += "<div class='p-3 text-danger'>❌ لا توجد بيانات.</div>";
        }

        html += `</div></div></div>`;
        document.getElementById("computersResult").innerHTML = html;
      });
    }
    window.returnComputers = function (ComputersKey) {
      const routerRef = ref(database, `computers/${ComputersKey}`);
      const today = new Date().toISOString().split('T')[0];
      update(routerRef, {
        pcUser: "قسم IT",
        note: `تم استرجاع العهدة بتاريخ ${today} بواسطة قسم IT`
      }).then(() => {
        alert("✅ تم استرجاع Pc , Laptop بنجاح.");
        const name = document.getElementById("pcUser").value;
        searchComputers(name);
      }).catch(error => {
        console.error("❌ خطأ في استرجاع Pc , Laptop:", error);
        alert("❌ حدث خطأ.");
      });
    };

    function searchPhones(name) {
      const refPhones = ref(database, "phones");

      document.getElementById("phonesResult").innerHTML = "⏳ جاري البحث عن الهواتف...";

      get(refPhones).then(snapshot => {
        let html = `
            <div class="card">
                <div class="card-header text-center">
                     الهواتف
                </div>
                <div class="card-body">
                    <div class="table-responsive">
        `;

        let found = false;
        let table = `
            <table class="table table-bordered table-hover text-center m-0">
                <thead class="thead-dark">
                    <tr>
                        <th>رقم المستند</th>
                        <th>الاسم</th>
                        <th>الحالة</th>
                        <th>الموقع</th>
                        <th>النوع</th>
                        <th>IMEI</th>
                        <th>الرام</th>
                        <th>التخزين</th>
                        <th>تاريخ</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody>`;

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const d = child.val();

            const employeeNameFromDB = d.employeeNamePhone ? normalizeName(d.employeeNamePhone) : "";
            const searchInput = normalizeName(name);

            if (
              !d.deleted && // استبعاد المحذوفين
              employeeNameFromDB.includes(searchInput) // البحث الجزئي بالاسم
            ) {
              found = true;
              table += `
                        <tr>
                            <td>${d.documentNumberPhone || ""}</td>
                            <td>${d.employeeNamePhone || ""}</td>
                            <td>${d.phoneStatus || ""}</td>
                            <td>${d.locationPhone || ""}</td>
                            <td>${(d.phoneType || "") + " - " + (d.phoneModel || "")}</td>
                            <td>${d.imeiNumber || ""}</td>
                            <td>${d.ram || ""}</td>
                            <td>${d.storage || ""}</td>
                            <td>${d.datePhone || ""}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="returnPhones('${child.key}')">
                                    استرجاع
                                </button>
                            </td>
                        </tr>`;
            }
          });

          table += "</tbody></table>";
          html += found ? table : "<div class='p-3 text-danger'>❌ لا توجد هواتف بهذا الاسم.</div>";
        } else {
          html += "<div class='p-3 text-danger'>❌ لا توجد بيانات مخزنة.</div>";
        }

        html += `</div></div></div>`;
        document.getElementById("phonesResult").innerHTML = html;
      }).catch(error => {
        console.error("❌ خطأ أثناء البحث عن الهواتف:", error);
        document.getElementById("phonesResult").innerHTML = "❌ حدث خطأ أثناء جلب البيانات.";
      });
    }
    window.returnPhones = function (PhonesKey) {
      const routerRef = ref(database, `phones/${PhonesKey}`);
      const today = new Date().toISOString().split('T')[0];
      update(routerRef, {
        employeeNamePhone: "قسم IT",
        notesPhone: `تم استرجاع العهدة بتاريخ ${today} بواسطة قسم IT`
      }).then(() => {
        alert("✅ تم استرجاع الهاتف  بنجاح.");
        const name = document.getElementById("employeeNamePhone").value;
        searchPhones(name);
      }).catch(error => {
        console.error("❌ خطأ في استرجاع الهاتف :", error);
        alert("❌ حدث خطأ.");
      });
    };

    function searchLines(name) {
      const refLines = ref(database, "lines");

      document.getElementById("linesResult").innerHTML = "⏳ جاري البحث عن الخطوط...";

      get(refLines).then(snapshot => {
        let html = `
            <div class="card">
                <div class="card-header text-center">
                     الخطوط
                </div>
                <div class="card-body">
                    <div class="table-responsive">
        `;

        let found = false;
        let table = `
            <table class="table table-bordered table-hover text-center m-0">
                <thead class="thead-dark">
                    <tr>
                        <th>رقم المستند</th>
                        <th>الاسم</th>
                        <th>رقم الهاتف</th>
                        <th>الشركة</th>
                        <th>المنطقة</th>
                        <th>SIM</th>
                        <th>الباقة</th>
                        <th>تاريخ البدء</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody>`;

        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const d = child.val();

            const storedName = d.employeeName ? normalizeName(d.employeeName) : "";
            const searchInput = normalizeName(name);

            if (!d.deleted && storedName.includes(searchInput)) {
              found = true;
              table += `
                        <tr>
                            <td>${d.documentNumberLine || ""}</td>
                            <td>${d.employeeName || ""}</td>
                            <td>${d.phoneNumber || ""}</td>
                            <td>${d.company || ""}</td>
                            <td>${d.location || ""}</td>
                            <td>${d.simNumber || ""}</td>
                            <td>${(d.packageType || "") + " - " + (d.packageSize || "")}</td>
                            <td>${d.notes || ""}</td>
                            <td>
                               <button class="btn btn-sm btn-warning" onclick="returnLines('${child.key}')">
                                  استرجاع
                               </button>
                            </td>
                        </tr>`;
            }
          });

          table += "</tbody></table>";
          html += found ? table : "<div class='p-3 text-danger'>❌ لا توجد خطوط تطابق الاسم.</div>";
        } else {
          html += "<div class='p-3 text-danger'>❌ لا توجد بيانات.</div>";
        }

        html += `</div></div></div>`;
        document.getElementById("linesResult").innerHTML = html;
      }).catch(error => {
        console.error("❌ خطأ في تحميل بيانات الخطوط:", error);
        document.getElementById("linesResult").innerHTML = `<div class="p-3 text-danger">❌ حدث خطأ أثناء البحث.</div>`;
      });
    }
    window.returnLines = function (LinesKey, employeeName) {
      const routerRef = ref(database, `lines/${LinesKey}`);
      const today = new Date().toISOString().split('T')[0];
      update(routerRef, {
        employeeName: "قسم IT",
        notes: `تم استرجاع العهدة بتاريخ ${today} بواسطة قسم IT`
      }).then(() => {
        alert("✅ تم استرجاع الخط  بنجاح.");
        searchLines(employeeName);
      }).catch(error => {
        console.error("❌ خطأ في استرجاع الخط :", error);
        alert("❌ حدث خطأ.");
      });
    };

    window.showTemporaryHandoverInvoice = async function (data) {
      try {
        const settingsSnapshot = await get(ref(database, 'companySettings'));
        if (!settingsSnapshot.exists()) {
          alert("❌ لم يتم العثور على إعدادات الشركة.");
          return;
        }

        const settings = settingsSnapshot.val();

        const html = `
    <html dir="rtl" lang="ar">
    <head>
      <meta charset="UTF-8">
      <title>نموذج استلام عهدة مؤقتة</title>
      <style>
        body { font-family: 'Arial', sans-serif; margin: 40px; direction: rtl; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header img { height: 80px; }
        .company-info { text-align: left; font-size: 14px; line-height: 1.6; }
        h1 { text-align: center; margin: 30px 0; color: #0d47a1; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background-color: #f2f2f2; }
        .acknowledgment { margin-top: 30px; font-size: 15px; line-height: 1.8; }
        .signatures { display: flex; justify-content: space-between; margin-top: 50px; }
        .signatures div { width: 30%; text-align: center; }
        .signatures .line { border-top: 1px solid #000; margin-top: 40px; }
      </style>
    </head>
    <body>
      <div class="header">
        <img src="${settings.logoUrl}" alt="شعار الشركة">
        <div class="company-info">
          <div style="font-weight:bold; font-size:18px;">company: ${settings.name}</div>
          <div style="font-size:14px;">address: ${settings.address}</div>
          <div style="font-size:14px;">Phone: ${settings.phone}</div>
          <div style="font-size:14px;">Email: ${settings.email}</div>
        </div>
      </div>

      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-50deg); opacity:0.05; font-size:100px; font-weight:bold; color:#000; white-space:nowrap;">
        ${settings.watermark || ''}
      </div>

      <h1>نموذج استلام عهدة مؤقتة</h1>

      <table>
        <tr><th>اسم الموظف</th><td>${data.employeeName}</td></tr>
        <tr><th>نوع العهدة</th><td>${data.equipmentType}</td></tr>
        <tr><th>تاريخ الاستلام</th><td>${data.handoverDate}</td></tr>
        <tr><th>ملاحظات</th><td>${data.notes || "-"}</td></tr>
      </table>

      <div class="acknowledgment">
        أقر أنا الموقع أدناه بأنني استلمت العهدة الموضحة أعلاه مؤقتًا، وأتعهد بالمحافظة عليها 
        واستخدامها للأغراض الوظيفية فقط، وأتحمل المسؤولية الكاملة في حال تلفها أو فقدانها.
      </div>

      <div class="signatures">
        <div><p>توقيع الموظف</p><div class="line"></div></div>
        <div><p>توقيع مسؤول العهدة</p><div class="line"></div></div>
        <div><p>توقيع الإدارة</p><div class="line"></div></div>
      </div>
    </body>
    </html>
    `;

        const printWin = window.open("", "_blank");
        printWin.document.write(html);
        printWin.document.close();
        printWin.focus();

      } catch (error) {
        alert("❌ خطأ أثناء جلب إعدادات الشركة: " + error.message);
        console.error(error);
      }
    };

    window.showTemporaryReturnInvoice = async function (data) {
      try {
        const settingsSnapshot = await get(ref(database, 'companySettings'));
        if (!settingsSnapshot.exists()) {
          alert("❌ لم يتم العثور على إعدادات الشركة.");
          return;
        }

        const settings = settingsSnapshot.val();

        // تنسيق التاريخ العربي
        function formatArabicDate(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          return date.toLocaleDateString('ar-EG', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        }

        const html = `
        <html dir="rtl" lang="ar">
        <head>
          <meta charset="UTF-8">
          <title>إيصال تسليم عهدة مؤقتة</title>
          <style>
            body { font-family: 'Arial', sans-serif; margin: 40px; direction: rtl; color: #333; }
            .header { display: flex; justify-content: space-between; align-items: center; }
            .header img { height: 80px; }
            .company-info { text-align: left; font-size: 14px; line-height: 1.6; }
            h1 { text-align: center; margin: 30px 0; color: #0d47a1; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
            th { background-color: #f2f2f2; }
            .acknowledgment { margin-top: 30px; font-size: 15px; line-height: 1.8; }
            .signatures { display: flex; justify-content: space-between; margin-top: 50px; }
            .signatures div { width: 30%; text-align: center; }
            .signatures .line { border-top: 1px solid #000; margin-top: 40px; }
            .watermark {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-45deg);
                opacity: 0.05;
                font-size: 100px;
                font-weight: bold;
                color: #000;
                white-space: nowrap;
                z-index: 0;
            }
          </style>
        </head>
        <body>
          <div class="header">
        <img src="${settings.logoUrl}" alt="شعار الشركة">
        <div class="company-info">
          <div style="font-weight:bold; font-size:18px;">company: ${settings.name}</div>
          <div style="font-size:14px;">address: ${settings.address}</div>
          <div style="font-size:14px;">Phone: ${settings.phone}</div>
          <div style="font-size:14px;">Email: ${settings.email}</div>
        </div>
      </div>

          <div class="watermark">${settings.watermark || ''}</div>

          <h1>إيصال تسليم عهدة مؤقتة</h1>

          <table>
            <tr><th>رقم المستند</th><td>${data.documentNumber}</td></tr>
            <tr><th>اسم الموظف</th><td>${data.employeeName}</td></tr>
            <tr><th>نوع العهدة</th><td>${data.equipmentType}</td></tr>
            <tr><th>تاريخ التسليم</th><td>${formatArabicDate(data.handoverDate)}</td></tr>
            <tr><th>تاريخ الاسترجاع</th><td>${formatArabicDate(data.expectedReturn)}</td></tr>
            <tr><th>ماذا حدث للعهدة؟</th><td>${data.whatHappened || 'لم يُذكر'}</td></tr>
            <tr><th>ملاحظات</th><td>${data.notes || '-'}</td></tr>
          </table>

          <div class="acknowledgment">
            أقر أنا الموقع أدناه بأنني سلمت العهدة الموضحة أعلاه في التاريخ المحدد، 
            وأتحمل المسؤولية الكاملة عن أي تلف أو فقدان خلال فترة الاستخدام.
          </div>

          <div class="signatures">
            <div>
              <p>توقيع الموظف</p>
              <div class="line"></div>
            </div>
            <div>
              <p>توقيع مسؤول العهدة</p>
              <div class="line"></div>
            </div>
            <div>
              <p>توقيع الإدارة</p>
              <div class="line"></div>
            </div>
          </div>
        </body>
        </html>
        `;

        const printWindow = window.open("", "_blank");
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();

      } catch (error) {
        alert("❌ خطأ أثناء إنشاء الفاتورة: " + error.message);
        console.error(error);
      }
    };

    /////////////////////////////////////////////////////////////
    ////////////////////////// المستخدم ///////////////////////
    window.createUser = async function (event) {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const role = document.getElementById('role').value;

      if (!username || !password || !role) {
        alert("❌ يرجى ملء جميع الحقول.");
        return;
      }

      const usersRef = ref(database, 'users');
      const newUserRef = push(usersRef);
      await set(newUserRef, { username, password, role, active: true });  // اضفت active: true

      alert(`✅ تم إنشاء المستخدم: ${username}`);
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('role').value = 'user';

      loadUsersTable();
    };

    window.login = async function (event) {
      event.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const snapshot = await get(ref(database, 'users'));

      if (snapshot.exists()) {
        const users = snapshot.val();
        let found = false;

        for (const key in users) {
          const user = users[key];
          if (user.username === username && user.password === password) {
            if (user.active === false) {
              alert("❌ هذا المستخدم معطل ولا يمكنه تسجيل الدخول.");
              return;
            }
            found = true;

            localStorage.setItem('loggedIn', 'true');
            localStorage.setItem('userRole', user.role || 'user');
            localStorage.setItem('username', user.username);

            await loadUserPermissionsOnLogin(username);

            document.querySelectorAll('.admin-only').forEach(el => {
              if (user.role === 'admin') {
                el.classList.remove('d-none');
              } else {
                el.classList.add('d-none');
              }
            });

            break;
          }
        }

        if (found) {
          document.getElementById('loginScreen').style.display = 'none';
          showUserInfo();
          window.onload();
        } else {
          alert("❌ اسم المستخدم أو كلمة المرور غير صحيحة.");
        }
      }
    };

    window.logout = function () {
      localStorage.removeItem('loggedIn');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');

      document.getElementById('loginScreen').style.display = 'flex';
    };

    function showUserInfo() {
      const displayName = localStorage.getItem('username') || 'مستخدم';

      const nameElement = document.getElementById('userDisplayName');
      if (nameElement) {
        nameElement.textContent = displayName;
      }

      const avatarImg = document.getElementById('userAvatar');
      if (avatarImg) {
        const encodedName = encodeURIComponent(displayName);
        avatarImg.src = `https://ui-avatars.com/api/?name=${encodedName}&background=random&rounded=true&size=64`;
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      const isLoggedIn = localStorage.getItem('loggedIn') === 'true';
      const isAdmin = localStorage.getItem('userRole') === 'admin';

      const loginScreen = document.getElementById('loginScreen');
      const mainContent = document.getElementById('mainContent');

      if (loginScreen) loginScreen.style.display = isLoggedIn ? 'none' : 'flex';
      if (mainContent) mainContent.style.display = isLoggedIn ? 'block' : 'none';

      if (isLoggedIn) {
        showUserInfo();
      }

      document.body.style.visibility = 'visible';

      document.querySelectorAll('.admin-only').forEach(el => {
        if (isAdmin) {
          el.classList.remove('d-none');
        } else {
          el.classList.add('d-none');
        }
      });

      if (isLoggedIn && isAdmin) {
        loadUsersTable();
      }
    });

    window.loadUsersTable = async function () {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '';
      const snapshot = await get(ref(database, 'users'));

      if (snapshot.exists()) {
        const users = snapshot.val();
        for (const key in users) {
          const user = users[key];
          const isActive = user.active === false ? 'false' : 'true';
          tbody.innerHTML += `
        <tr>
          <td><a href="#" onclick="fillEditForm('${key}', '${user.username}', '${user.password}', '${user.role}', '${isActive}')">${user.username}</a></td>
          <td><i>••••</i></td>
          <td>${user.role}</td>
          <td>${user.active === false ? 'معطل' : 'مفعل'}</td>
        </tr>`;
        }
      }
    };

    window.fillEditForm = function (id, username, password, role, active) {
      document.getElementById('editUserId').value = id;
      document.getElementById('editUsername').value = username;
      document.getElementById('editPassword').value = password;
      document.getElementById('editRole').value = role;

      const isActive = (active === true || active === 'true');
      document.getElementById('editActive').value = isActive ? 'true' : 'false';

      document.getElementById('editUserSection').style.display = 'block';
    };

    window.updateUser = async function (event) {
      event.preventDefault();


      const isAdmin = localStorage.getItem('userRole') === 'admin';
      if (!isAdmin) {
        alert("❌ ليس لديك صلاحية لتعديل المستخدمين.");
        return;
      }

      const id = document.getElementById('editUserId').value;
      const username = document.getElementById('editUsername').value.trim();
      const password = document.getElementById('editPassword').value.trim();
      const role = document.getElementById('editRole').value;
      const active = document.getElementById('editActive').value === 'true';

      await update(ref(database, `users/${id}`), { username, password, role, active });

      alert("✅ تم تحديث المستخدم.");
      loadUsersTable();
      document.getElementById('editUserSection').style.display = 'none';
      return false;

    };
    ///////////////////////////////////////////////////////////////////
    /////////////////////////الشاشات /////////////////////////////////
    let currentEditingScreenType = null;
    window.addScreenData = async function () {
      const newType = document.getElementById("screenTypeInput").value.trim();
      const models = document.getElementById("screenModelsInput").value
        .split(',')
        .map(m => m.trim())
        .filter(Boolean);

      if (!newType || models.length === 0) {
        alert("❌ يرجى إدخال نوع الجهاز والموديلات.");
        return;
      }

      if (currentEditingScreenType && newType !== currentEditingScreenType) {
        await remove(ref(database, "Screen/" + currentEditingScreenType));
      }

      await set(ref(database, "Screen/" + newType), {
        models: models
      });

      alert(currentEditingScreenType ? "✅ تم حفظ بيانات الجهاز." : "✅ تم إضافة الجهاز بنجاح.");
      document.getElementById("screenTypeInput").value = "";
      document.getElementById("screenModelsInput").value = "";
      document.getElementById("updateDeviceButton").textContent = "إضافة";
      document.getElementById("deleteDeviceButton").style.display = "none";
      currentEditingScreenType = null;
      loadDeviceTableScreen();
      populateDeviceTypeOptionsScreen();
    };

    window.editDeviceType = function (type) {
      const modelsRef = ref(database, "Screen/" + type + "/models");

      get(modelsRef).then(snapshot => {
        const models = snapshot.val();

        if (Array.isArray(models)) {
          document.getElementById("screenModelsInput").value = type;
          document.getElementById("screenModelsInput").value = models.join(', ');
          currentEditingScreenType = type;
          document.getElementById("updateDeviceButton").textContent = "تحديث";
          document.getElementById("deleteDeviceButton").style.display = "inline-block";
        }
      });
    };

    function loadDeviceTableScreen() {
      const tableBody = document.querySelector("#screenTable tbody");
      const deviceRef = ref(database, "Screen");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        tableBody.innerHTML = "";

        for (const type in data) {
          const models = data[type].models;
          const row = document.createElement("tr");

          row.innerHTML = `
                <td>${type}</td>
                <td>${models.join(', ')}</td>
            `;

          row.addEventListener("click", () => {
            fetchDeviceData(type);
          });

          tableBody.appendChild(row);
        }
      });
    }

    function populateDeviceTypeOptionsScreen() {
      const deviceTypeSelect = document.getElementById("screenType");
      const queryDeviceType = document.getElementById("queryscreenType");

      const deviceRef = ref(database, "Screen");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();

        const defaultOption = '<option value="">-- اختر نوع الجهاز --</option>';
        deviceTypeSelect.innerHTML = defaultOption;
        queryDeviceType.innerHTML = defaultOption;

        if (!data) return;

        Object.keys(data).forEach(type => {
          const option1 = document.createElement("option");
          option1.value = type;
          option1.textContent = type;

          const option2 = option1.cloneNode(true);

          deviceTypeSelect.appendChild(option1);
          queryDeviceType.appendChild(option2);
        });
      }, {
        onlyOnce: true
      });
    }

    document.getElementById("screenType").addEventListener("change", (e) => {
      const selectedType = e.target.value;
      const modelSelect = document.getElementById("screenModel");

      modelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

      if (selectedType) {
        const modelsRef = ref(database, "Screen/" + selectedType + "/models");
        onValue(modelsRef, (snapshot) => {
          const models = snapshot.val();
          if (Array.isArray(models)) {
            models.forEach(model => {
              const opt = document.createElement("option");
              opt.value = model;
              opt.textContent = model;
              modelSelect.appendChild(opt);
            });
          }
        });
      }
    });
    loadDeviceTableScreen();
    populateDeviceTypeOptionsScreen();

    function loadCompaniesIntoSelectScreen() {
      const companySelect = document.getElementById("screenCompanySelect");
      const queryCompanySelect = document.getElementById("queryCompanySelectScreen");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeScreen");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }

    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectScreen);

    document.getElementById("screen").addEventListener("change", function () {
      const selected = this.value;
      const pcFields = document.getElementById("pcFields");

      if (selected === "كمبيوتر") {
        pcFields.style.display = "block";
      } else {
        pcFields.style.display = "none";
        document.getElementById("linkedEmployeeName").value = "";
        document.getElementById("linkedDeviceType").value = "";
        document.getElementById("linkedDeviceModel").value = "";
      }
    });

    document.getElementById("screenPCName").addEventListener("blur", function () {
      const pcNum = this.value.trim();
      if (!pcNum) return;

      const pcRef = ref(database, "computers");
      get(pcRef).then(snapshot => {
        let found = false;
        snapshot.forEach(child => {
          const data = child.val();
          if (data.pcNum == pcNum) {
            document.getElementById("linkedEmployeeName").value = data.pcUser || "";
            document.getElementById("linkedDeviceType").value = data.deviceType || "";
            document.getElementById("linkedDeviceModel").value = data.deviceModel || "";
            found = true;
          }
        });

        if (!found) {
          alert("⚠️ لم يتم العثور على الجهاز بهذا الرقم.");
          document.getElementById("linkedEmployeeName").value = "";
          document.getElementById("linkedDeviceType").value = "";
          document.getElementById("linkedDeviceModel").value = "";
        }
      }).catch(error => {
        alert("❌ خطأ أثناء البحث عن الجهاز: " + error.message);
      });
    });

    window.SaveScreen = function () {
      const canSave = localStorage.getItem('ScreenSave') === 'true';
      const canEdit = localStorage.getItem('ScreenEdit') === 'true';
      const dataId = document.getElementById("documentNumberScreen").getAttribute("data-id");

      if (!dataId && !canSave) return alert("❌ ليس لديك صلاحية إضافة بيانات جديدة.");
      if (dataId && !canEdit) return alert("❌ ليس لديك صلاحية تعديل البيانات.");


      const documentNumberScreen = document.getElementById("documentNumberScreen").value.trim();
      const screenPCName = document.getElementById("screenPCName").value.trim();
      const linkedEmployeeName = document.getElementById("linkedEmployeeName").value.trim();
      const linkedDeviceType = document.getElementById("linkedDeviceType").value.trim();
      const linkedDeviceModel = document.getElementById("linkedDeviceModel").value.trim();
      const screenLocation = document.getElementById("screenLocation").value.trim();
      const dateScreen = document.getElementById("dateScreen").value.trim();
      const screen = document.getElementById("screen").value.trim();
      const screenType = document.getElementById("screenType").value;
      const screenModel = document.getElementById("screenModel").value.trim();
      const serial = document.getElementById("serial").value.trim();
      const size = document.getElementById("size").value.trim();
      const resolution = document.getElementById("resolution").value.trim();
      const ports = document.getElementById("ports").value.trim();
      const condition = document.getElementById("condition").value.trim();
      const notesScreen = document.getElementById("notesScreen").value.trim();
      const companyCode = document.getElementById("screenCompanySelect").value;
      const companyName = document.getElementById("screenCompanySelect").selectedOptions[0]?.textContent || "";

      if (!screenLocation || !dateScreen || !screen || !screenType || !screenModel) {
        alert("❌ يرجى ملء جميع الحقول الأساسية!");
        return;
      }

      const generatePcNum = (manualNum = null) => {
        return new Promise((resolve, reject) => {
          get(ref(database, "screens"))
            .then(snapshot => {
              let existingNums = new Set();

              snapshot.forEach(childSnapshot => {
                const documentNumberScreen = parseInt(childSnapshot.val().documentNumberScreen);
                if (!isNaN(documentNumberScreen)) {
                  existingNums.add(documentNumberScreen);
                }
              });

              if (manualNum !== null && manualNum !== "") {
                const parsedManual = parseInt(manualNum);
                if (isNaN(parsedManual)) {
                  reject(new Error("⚠️ الرقم المدخل غير صالح."));
                } else if (existingNums.has(parsedManual) && !dataId) {
                  reject(new Error("⚠️ الرقم موجود مسبقًا."));
                } else {
                  resolve(parsedManual);
                }
              } else {
                let nextNum = 1;
                while (existingNums.has(nextNum)) {
                  nextNum++;
                }
                resolve(nextNum);
              }
            })
            .catch(error => reject(error));
        });
      };
      const saveOrUpdate = (documentNumberScreen) => {
        const data = {
          documentNumberScreen, screenLocation,
          dateScreen, screen, dateAdded, screenType, screenModel,
          serial, size, resolution, ports, condition, notesScreen,
          company: {
            code: companyCode,
            name: companyName
          }
        };
        if (screen === "كمبيوتر") {
          data.linkedPC = {
            pcNumber: screenPCName,
            employee: linkedEmployeeName,
            deviceType: linkedDeviceType,
            deviceModel: linkedDeviceModel
          };
        } else {
          data.linkedPC = null;
        }

        document.getElementById("documentNumberScreen").setAttribute("readonly", true);

        if (dataId) {
          const pcRef = ref(database, "screens/" + dataId);
          get(pcRef).then(snapshot => {
            if (snapshot.exists()) {
              if (snapshot.val().deleted) {
                alert("⚠️ الجهاز محذوف ولا يمكن تعديله!");
                return;
              } else {
                update(pcRef, data)
                  .then(() => {
                    alert("✅ تم تحديث البيانات بنجاح!");
                    clearFormScreens();
                  })
                  .catch(error => {
                    alert("❌ خطأ أثناء التحديث: " + error.message);
                  });
              }
            } else {
              alert("❌ الجهاز غير موجود في قاعدة البيانات!");
            }
          }).catch(error => {
            alert("❌ خطأ أثناء التحقق من حالة الجهاز: " + error.message);
          });
        } else {
          push(ref(database, "screens"), data)
            .then(() => {
              alert("✅ تم إضافة الجهاز بنجاح!");
              clearFormScreens();
            })
            .catch(error => {
              alert("❌ خطأ أثناء الحفظ: " + error.message);
            });
        }
      };
      generatePcNum(documentNumberScreen)
        .then(documentNumberScreen => saveOrUpdate(documentNumberScreen))
        .catch(error => {
          alert(error.message);
        });
    };

    function clearFormScreens() {
      const fields = [
        "documentNumberScreen", "screenLocation", "companyCode",
        "dateScreen", "screen", "screenPCName", "linkedEmployeeName", "linkedDeviceType", "linkedDeviceModel",
        "screenType", "screenModel", "serial",
        "size", "resolution", "ports", "condition", "notesScreen"
      ];
      fields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.value = "";
        }
      });
      const documentNumberScreen = document.getElementById("documentNumberScreen");
      if (documentNumberScreen) {
        documentNumberScreen.removeAttribute("readonly");
        documentNumberScreen.removeAttribute("data-id");
      }
    }

    window.searchDataScreen = function () {
      const ScreenQuery = localStorage.getItem('ScreenQuery1') === 'true';
      const dataId = document.getElementById("queryScreenNum").getAttribute("data-id");

      if (!dataId && !ScreenQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }

      const queryScreenNum = document.getElementById("queryScreenNum").value.trim().toLowerCase();
      const queryScreenLocation = document.getElementById("queryScreenLocation").value.trim().toLowerCase();
      const querydateAddedScreen = document.getElementById("querydateAddedScreen").value.trim().toLowerCase();
      const queryscreenType = document.getElementById("queryscreenType").value.trim().toLowerCase();
      const generalSearchScreen = document.getElementById("generalSearchScreen").value.trim().toLowerCase();
      const queryScreen = document.getElementById("queryScreen").value.trim().toLowerCase();
      const queryCompanyName = document.getElementById("queryCompanySelectScreen").value.trim().toLowerCase();

      const resultsContainer = document.getElementById("queryResultsScreen");
      resultsContainer.innerHTML = "⏳ جاري البحث...";

      const dbRef = ref(database, "screens");

      get(dbRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();

          let filteredData = Object.keys(data).map(key => {
            const item = data[key];
            const linkedPC = item.linkedPC || {};
            return {
              id: key,
              ...item,
              companyName: item.company?.name || "",
              "linkedPC.pcNumber": linkedPC.pcNumber || "",
              "linkedPC.employee": linkedPC.employee || "",
              "linkedPC.deviceType": linkedPC.deviceType || "",
              "linkedPC.deviceModel": linkedPC.deviceModel || ""
            };
          }).filter(item =>
            (queryScreenNum === "" || String(item.documentNumberScreen || "").toLowerCase().includes(queryScreenNum)) &&
            (queryScreenLocation === "" || String(item.screenLocation || "").toLowerCase().includes(queryScreenLocation)) &&
            (querydateAddedScreen === "" || String(item.dateAdded || "").toLowerCase().includes(querydateAddedScreen)) &&
            (queryscreenType === "" || String(item.screenType || "").toLowerCase().includes(queryscreenType)) &&
            (queryScreen === "" || String(item.screen || "").toLowerCase().includes(queryScreen)) &&
            (queryCompanyName === "" || String(item.companyName || "").toLowerCase().includes(queryCompanyName))
          );

          if (generalSearchScreen !== "") {
            filteredData = filteredData.filter(item =>
              Object.values(item).some(value =>
                String(value).toLowerCase().includes(generalSearchScreen)
              )
            );
          }

          filteredData.sort((a, b) => (parseInt(a.documentNumberScreen) || 0) - (parseInt(b.documentNumberScreen) || 0));

          if (filteredData.length === 0) {
            resultsContainer.innerHTML = "❌ لم يتم العثور على بيانات";
            return;
          }

          const table = document.createElement("table");
          table.style.width = "100%";
          table.style.borderCollapse = "collapse";
          table.style.textAlign = "center";

          const thead = document.createElement("thead");
          let headerRow = "<tr>";
          selectedColumns1.forEach(col => {
            headerRow += `<th>${allColumnsscreen[col] || col}</th>`;
          });
          headerRow += "</tr>";
          thead.innerHTML = headerRow;
          thead.style.position = "sticky";
          thead.style.top = "0";
          thead.style.backgroundColor = "#fff";
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          filteredData.forEach(item => {
            const allNull = selectedColumns1.every(col => {
              const value = item[col];
              return value === null || value === undefined || String(value).trim() === "";
            });

            if (allNull) return;

            const row = document.createElement("tr");
            if (item.deleted) {
              row.style.color = "red";
              row.style.backgroundColor = "#ffe6e6";
            }

            let rowHtml = "";
            selectedColumns1.forEach(col => {
              const value = item[col];
              rowHtml += `<td>${value !== undefined && value !== null && value !== "" ? value : "null"}</td>`;
            });

            row.innerHTML = rowHtml;
            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          resultsContainer.innerHTML = "";
          resultsContainer.appendChild(table);

        } else {
          resultsContainer.innerHTML = "❌ لا توجد بيانات مطابقة!";
        }
      }).catch(err => {
        resultsContainer.innerHTML = "❌ حدث خطأ أثناء البحث: " + err.message;
      });
    };

    const allColumnsscreen = {
      documentNumberScreen: "رقم المستند",
      companyName: "اسم الشركة",
      screenLocation: "الموقع",
      dateScreen: "تاريخ الشاشة",
      screen: "نوع الشاشة",
      screenType: "نوع الشاشة",
      screenModel: "موديل الشاشة",
      serial: "الرقم التسلسلي",
      size: "الحجم (بوصة)",
      resolution: "الدقة",
      ports: "عدد المنافذ",
      condition: "الحالة",
      notesScreen: "ملاحظات",
      "linkedPC.pcNumber": "رقم الجهاز المرتبط",
      "linkedPC.employee": "اسم الموظف المرتبط",
      "linkedPC.deviceType": "نوع الجهاز المرتبط",
      "linkedPC.deviceModel": "موديل الجهاز المرتبط"
    };

    let selectedColumns1 = Object.keys(allColumnsscreen);

    window.printTableScreen = function () {
      const resultsContainer = document.getElementById("queryResultsScreen");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة الأجهزة</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelScreen = function () {
      const table = document.querySelector("#queryResultsScreen table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "Screen Data" });
      XLSX.writeFile(workbook, "Screen_Data.xlsx");
    };
    //////////////////////////////////////////////////////////////////////////
    ///////////////////////// اعدادات افاتوره///////////////////////////////
    window.fetchCompanyByCode = async function () {
      const codeInput = document.getElementById('invoiceCompanyCode').value.trim();
      const nameField = document.getElementById('invoiceCompanyName');

      if (!codeInput) {
        nameField.value = '';
        return;
      }

      const companiesRef = ref(database, 'companies');
      const q = query(companiesRef, orderByChild('code'), equalTo(codeInput));

      try {
        const snapshot = await get(q);
        if (snapshot.exists()) {
          const data = Object.values(snapshot.val())[0];
          nameField.value = data.name || '❓ غير معروف';
        } else {
          nameField.value = '❌ لم يتم العثور على الشركة';
        }
      } catch (error) {
        console.error("❌ خطأ أثناء جلب الشركة:", error);
        nameField.value = '⚠️ خطأ في الاتصال';
      }
    };

    window.previewLogo = function (event) {
      const reader = new FileReader();
      reader.onload = function () {
        document.getElementById('logoPreview').src = reader.result;
      };
      reader.readAsDataURL(event.target.files[0]);
    };

    window.updateCompanySettings = async function () {
      try {
        const code = document.getElementById('invoiceCompanyCode').value.trim();
        const name = document.getElementById('invoiceCompanyName').value;
        const address = document.getElementById('inputCompanyAddress').value;
        const phone = document.getElementById('inputCompanyPhone').value;
        const email = document.getElementById('inputCompanyEmail').value;
        const watermark = document.getElementById('inputCompanyWatermark').value;
        const logoUrl = document.getElementById('logoPreview').src;

        if (!code || !name) {
          alert("❗ يجب إدخال كود الشركة واسمها أولاً");
          return;
        }

        const settings = { code, name, address, phone, email, watermark, logoUrl };

        const settingsRef = ref(database, 'companySettings/' + code);
        await set(settingsRef, settings);

        alert('✅ تم حفظ إعدادات الشركة بنجاح');

        document.getElementById('inputCompanyAddress').value = '';
        document.getElementById('inputCompanyPhone').value = '';
        document.getElementById('inputCompanyEmail').value = '';
        document.getElementById('inputCompanyWatermark').value = '';
        document.getElementById('inputCompanyLogoFile').value = '';
        document.getElementById('logoPreview').removeAttribute('src');
        loadCompanySettings();
      } catch (error) {
        console.error('❌ خطأ أثناء الحفظ:', error);
        alert('❌ حدث خطأ أثناء حفظ إعدادات الشركة');
      }
    };

    window.loadCompanySettings = async function () {
      try {
        const settingsRef = ref(database, 'companySettings');
        const snapshot = await get(settingsRef);

        const tableBody = document.getElementById('companySettingsTableBody');
        tableBody.innerHTML = '';

        if (snapshot.exists()) {
          const companies = snapshot.val();
          Object.keys(companies).forEach((code) => {
            const data = companies[code];
            const row = `
          <tr>
            <td>${data.name || ''}</td>
            <td>${data.address || ''}</td>
            <td>${data.phone || ''}</td>
            <td>${data.email || ''}</td>
            <td>${data.watermark || ''}</td>
            <td><img src="${data.logoUrl || ''}" style="height:60px;"></td>
          </tr>
        `;
            tableBody.innerHTML += row;
          });
        } else {
          tableBody.innerHTML = `<tr><td colspan="6">لا توجد بيانات شركات محفوظة</td></tr>`;
        }
      } catch (error) {
        console.error('❌ خطأ أثناء تحميل إعدادات الشركات:', error);
      }
    };

    window.onload = function () {
      loadCompanySettings();
    };
    //////////////////////////////////////////////////////////////////////////
    //////////////////////////// الصلاحيات ///////////////////////////////////
    window.loadUserPermissions = async function () {
      const username = document.getElementById('powerManagementUser').value.trim();
      if (!username) {
        alert("❌ يرجى إدخال اسم المستخدم.");
        return;
      }

      const snapshot = await get(ref(database, 'users'));
      if (!snapshot.exists()) {
        alert("❌ لا يوجد مستخدمين.");
        return;
      }

      const users = snapshot.val();
      let userData = null;

      for (const key in users) {
        if (users[key].username === username) {
          userData = { ...users[key], key };
          break;
        }
      }

      if (!userData) {
        alert("❌ المستخدم غير موجود.");
        return;
      }

      const defaultPerms = {
        canDelete: false,
        canSave: false,
        canEdit: false,
        canQuery: false,
        phoneSave: false,
        phoneEdit: false,
        phoneQuery: false,
        routerSave: false,
        routerEdit: false,
        RouterQuery: false,
        ScreenSave: false,
        ScreenEdit: false,
        ScreenQuery: false,
        CameraSave: false,
        CameraEdit: false,
        CameraQuery: false,
        PrintSave: false,
        PrintEdit: false,
        PrintQuery: false,
        LineSave: false,
        LineEdit: false,
        LineQuery: false,
        AssetEdit: false,
        AssetSave: false,
        gpsSave: false,
        gpsEdit: false,
        GpsQuery: false,
        OrderSave: false,
        OrderEdit: false,
        OrderQuery: false,
        DeliverySave: false,
        DeliveryEdit: false,
        DeliveryQuery: false,
      };

      const permissions = { ...defaultPerms, ...userData.permissions };

      const html = `
    <table class="table table-bordered">
      <thead>
        <tr><th>الصلاحية</th><th>السماح</th></tr>
      </thead>
      <tbody>
        <tr><td>صلاحيه الحذف</td>
            <td><input type="checkbox" id="permDelete"  ${permissions.canDelete ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الحفظ بيانات الكمبيوتر</td>
            <td><input type="checkbox" id="permSave"    ${permissions.canSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل بيانات الكمبيوتر</td>
            <td><input type="checkbox" id="permEdit"    ${permissions.canEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن الكمبيوتر</td>
            <td><input type="checkbox" id="permQuery"   ${permissions.canQuery ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الحفظ بيانات الهاتف</td>
            <td><input type="checkbox" id="phoneSave"   ${permissions.phoneSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل بيانات الهاتف</td>
            <td><input type="checkbox" id="phoneEdit"   ${permissions.phoneEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن الهواتف</td>
            <td><input type="checkbox" id="phoneQuery1"  ${permissions.phoneQuery ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الحفظ بيانات الرواتر</td>
            <td><input type="checkbox" id="routerSave"  ${permissions.routerSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل بيانات الرواتر</td>
            <td><input type="checkbox" id="routerEdit"  ${permissions.routerEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن الرواتر</td>
            <td><input type="checkbox" id="RouterQuery1"  ${permissions.RouterQuery ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الحفظ بيانات الشاشات</td>
            <td><input type="checkbox" id="ScreenSave"  ${permissions.ScreenSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل بيانات الشاشات</td>
            <td><input type="checkbox" id="ScreenEdit"  ${permissions.ScreenEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن الشاشات</td>
            <td><input type="checkbox" id="ScreenQuery1"  ${permissions.ScreenQuery ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الحفظ بيانات الكاميرات</td>
            <td><input type="checkbox" id="CameraSave"   ${permissions.CameraSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل بيانات الكاميرات</td>
            <td><input type="checkbox" id="CameraEdit"   ${permissions.CameraEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن الكاميرات</td>
            <td><input type="checkbox" id="CameraQuery1"  ${permissions.CameraQuery ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الحفظ بيانات الطابعات</td>
            <td><input type="checkbox" id="PrintSave"   ${permissions.PrintSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل بيانات الطابعات</td>
            <td><input type="checkbox" id="PrintEdit"   ${permissions.PrintEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن الطابعات</td>
            <td><input type="checkbox" id="PrintQuery1"  ${permissions.PrintQuery ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الحفظ بيانات الخطوط</td>
            <td><input type="checkbox" id="LineSave"   ${permissions.LineSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل بيانات الخطوط</td>
            <td><input type="checkbox" id="LineEdit"   ${permissions.LineEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن الخطوط</td>
            <td><input type="checkbox" id="LineQuery1"  ${permissions.LineQuery ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه حفظ الاصول </td>
            <td><input type="checkbox" id="AssetSave"   ${permissions.AssetSave ? 'checked' : ''}></td></tr>
        <tr><td> صلاحيه تعديل الاصول </td>
            <td><input type="checkbox" id="AssetEdit"  ${permissions.AssetEdit ? 'checked' : ''}></td></tr>
        <tr><td> صلاحيه حفظ مستند GPS</td>
            <td><input type="checkbox" id="gpsSave"  ${permissions.gpsSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه تعديل  GPS </td>
            <td><input type="checkbox" id="gpsEdit"   ${permissions.gpsEdit ? 'checked' : ''}></td></tr>
        <tr><td> صلاحيه استعلام بيانات GPS </td>
            <td><input type="checkbox" id="GpsQuery"  ${permissions.GpsQuery ? 'checked' : ''}></td></tr>
        <tr><td> صلاحيه حفظ مستند طلب الشراء </td>
          <td><input type="checkbox" id="OrderSave"  ${permissions.OrderSave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل مستند طلب الشراء</td>
            <td><input type="checkbox" id="OrderEdit"    ${permissions.OrderEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن مستند طلب الشراء</td>
            <td><input type="checkbox" id="OrderQuery"   ${permissions.OrderQuery ? 'checked' : ''}></td></tr>
        <tr><td> صلاحيه حفظ مستند موافقة تسليم </td>
          <td><input type="checkbox" id="DeliverySave"  ${permissions.DeliverySave ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه التعديل مستند موافقة تسليم</td>
            <td><input type="checkbox" id="DeliveryEdit"    ${permissions.DeliveryEdit ? 'checked' : ''}></td></tr>
        <tr><td>صلاحيه الاستعلام عن مستند موافقة تسليم </td>
            <td><input type="checkbox" id="DeliveryQuery"   ${permissions.DeliveryQuery ? 'checked' : ''}></td></tr>

      </tbody>
    </table>
  `;

      document.getElementById('powerManagementResults').innerHTML = html;
      document.getElementById('powerManagementUser').dataset.userKey = userData.key;
    };

    window.updatePowerManagemen = async function () {
      const userKey = document.getElementById('powerManagementUser').dataset.userKey;
      if (!userKey) {
        alert("❌ يرجى تحميل بيانات المستخدم أولاً.");
        return;
      }

      function isChecked(id) {
        const el = document.getElementById(id);
        return el ? !!el.checked : false;
      }

      const permissions = {
        canDelete: isChecked('permDelete'),
        canSave: isChecked('permSave'),
        canEdit: isChecked('permEdit'),
        canQuery: isChecked('permQuery'),
        phoneSave: isChecked('phoneSave'),
        phoneEdit: isChecked('phoneEdit'),
        phoneQuery: isChecked('phoneQuery1') || false,
        routerSave: isChecked('routerSave'),
        routerEdit: isChecked('routerEdit'),
        RouterQuery: isChecked('RouterQuery1') || false,
        ScreenSave: isChecked('ScreenSave'),
        ScreenEdit: isChecked('ScreenEdit'),
        ScreenQuery: isChecked('ScreenQuery1'),
        CameraSave: isChecked('CameraSave'),
        CameraEdit: isChecked('CameraEdit'),
        CameraQuery: isChecked('CameraQuery1') || false,
        PrintSave: isChecked('PrintSave'),
        PrintEdit: isChecked('PrintEdit'),
        PrintQuery: isChecked('PrintQuery1') || false,
        LineSave: isChecked('LineSave'),
        LineEdit: isChecked('LineEdit'),
        LineQuery: isChecked('LineQuery1') || false,
        AssetSave: isChecked('AssetSave'),
        AssetEdit: isChecked('AssetEdit') || false,
        gpsSave: isChecked('gpsSave'),
        gpsEdit: isChecked('gpsEdit'),
        GpsQuery: isChecked('GpsQuery') || false,
        OrderSave: isChecked('OrderSave') || false,
        OrderEdit: isChecked('OrderEdit') || false,
        OrderQuery: isChecked('OrderQuery') || false,
        DeliverySave: isChecked('DeliverySave') || false,
        DeliveryEdit: isChecked('DeliveryEdit') || false,
        DeliveryQuery: isChecked('DeliveryQuery') || false,
      };

      try {
        await set(ref(database, 'users/' + userKey + '/permissions'), permissions);
        alert("✅ تم تحديث الصلاحيات بنجاح!");
      } catch (err) {
        console.error(err);
        alert("❌ حدث خطأ أثناء التحديث: " + err.message);
      }
    };

    window.loadUserPermissionsOnLogin = async function (username) {
      const snapshot = await get(ref(database, 'users'));
      if (!snapshot.exists()) return;

      const users = snapshot.val();
      for (const key in users) {
        if (users[key].username === username) {
          const permissions = users[key].permissions || {};

          localStorage.setItem('canDelete', permissions.canDelete ? 'true' : 'false');
          localStorage.setItem('canSave', permissions.canSave ? 'true' : 'false');
          localStorage.setItem('canEdit', permissions.canEdit ? 'true' : 'false');
          localStorage.setItem('canQuery', permissions.canQuery ? 'true' : 'false');
          localStorage.setItem('phoneSave', permissions.phoneSave ? 'true' : 'false');
          localStorage.setItem('phoneEdit', permissions.phoneEdit ? 'true' : 'false');
          localStorage.setItem('phoneQuery1', permissions.phoneQuery ? 'true' : 'false');
          localStorage.setItem('routerSave', permissions.routerSave ? 'true' : 'false');
          localStorage.setItem('routerEdit', permissions.routerEdit ? 'true' : 'false');
          localStorage.setItem('RouterQuery1', permissions.RouterQuery ? 'true' : 'false');
          localStorage.setItem('ScreenSave', permissions.ScreenSave ? 'true' : 'false');
          localStorage.setItem('ScreenEdit', permissions.ScreenEdit ? 'true' : 'false');
          localStorage.setItem('ScreenQuery1', permissions.ScreenQuery ? 'true' : 'false');
          localStorage.setItem('CameraSave', permissions.CameraSave ? 'true' : 'false');
          localStorage.setItem('CameraEdit', permissions.CameraEdit ? 'true' : 'false');
          localStorage.setItem('CameraQuery1', permissions.CameraQuery ? 'true' : 'false');
          localStorage.setItem('PrintSave', permissions.PrintSave ? 'true' : 'false');
          localStorage.setItem('PrintEdit', permissions.PrintEdit ? 'true' : 'false');
          localStorage.setItem('PrintQuery1', permissions.PrintQuery ? 'true' : 'false');
          localStorage.setItem('LineSave', permissions.LineSave ? 'true' : 'false');
          localStorage.setItem('LineEdit', permissions.LineEdit ? 'true' : 'false');
          localStorage.setItem('LineQuery1', permissions.LineQuery ? 'true' : 'false');
          localStorage.setItem('AssetSave', permissions.AssetSave ? 'true' : 'false');
          localStorage.setItem('AssetEdit', permissions.AssetEdit ? 'true' : 'false');
          localStorage.setItem('gpsSave', permissions.gpsSave ? 'true' : 'false');
          localStorage.setItem('gpsEdit', permissions.gpsEdit ? 'true' : 'false');
          localStorage.setItem('GpsQuery', permissions.GpsQuery ? 'true' : 'false');
          localStorage.setItem('OrderSave', permissions.OrderSave ? 'true' : 'false');
          localStorage.setItem('OrderEdit', permissions.OrderEdit ? 'true' : 'false');
          localStorage.setItem('OrderQuery', permissions.OrderQuery ? 'true' : 'false');
          localStorage.setItem('DeliverySave', permissions.DeliverySave ? 'true' : 'false');
          localStorage.setItem('DeliveryEdit', permissions.DeliveryEdit ? 'true' : 'false');
          localStorage.setItem('DeliveryQuery', permissions.DeliveryQuery ? 'true' : 'false');
          break;

        }
      }
    };

    window.grantAllPermissions = function () {
      const checkboxes = document.querySelectorAll("#powerManagementResults input[type='checkbox']");
      checkboxes.forEach(cb => cb.checked = true);
      alert("✅ تم تفعيل جميع الصلاحيات بنجاح!");
    };

    /////////////////////////////////////////////////////////////////////////
    ///////////////////////////// تعريف الشركات ///////////////////////////
    const companiesRef = ref(database, 'companies');

    function clearCompanyForm() {
      document.getElementById('companyCode1').value = '';
      document.getElementById('name1').value = '';
      document.getElementById('field1').value = '';
      document.getElementById('description1').value = '';
      document.getElementById('website1').value = '';
    }

    window.addSaveCompanies = function () {
      const companyCode = document.getElementById('companyCode1').value.trim();
      const name = document.getElementById('name1').value.trim();
      const field = document.getElementById('field1').value.trim();
      const description = document.getElementById('description1').value.trim();
      const website = document.getElementById('website1').value.trim();

      if (!companyCode || !name || !field || !description) {
        alert("⚠️ يرجى تعبئة جميع الحقول المطلوبة.");
        return;
      }

      const codeQuery = query(companiesRef, orderByChild('code'), equalTo(companyCode));

      get(codeQuery).then((snapshot) => {
        if (snapshot.exists()) {
          alert("❌ هذا الكود مستخدم بالفعل. الرجاء اختيار كود مختلف.");
          return;
        }

        const companyData = { code: companyCode, name, field, description, website };

        push(companiesRef, companyData).then(() => {
          const companySettingsRef = ref(database, 'companySettings/' + companyCode);
          const defaultSettings = {
            code: companyCode,
            name,
            address: '',
            phone: '',
            email: '',
            watermark: '',
            logoUrl: ''
          };
          set(companySettingsRef, defaultSettings);

          alert("✅ تم حفظ الشركة بنجاح");
          clearCompanyForm();
        }).catch((error) => {
          alert("❌ حدث خطأ أثناء الحفظ: " + error);
        });
      }).catch((error) => {
        alert("❌ فشل التحقق من الكود: " + error);
      });
    };

    const companiesTable = document.getElementById("companiesBody");

    onValue(companiesRef, (snapshot) => {
      companiesTable.innerHTML = "";
      snapshot.forEach((childSnapshot) => {
        const data = childSnapshot.val();
        const row = document.createElement("tr");
        row.innerHTML = `
      <td>${data.code}</td>
      <td>${data.name}</td>
      <td>${data.field}</td>
      <td>${data.description}</td>
      <td>${data.website ? `<a href="${data.website}" target="_blank">${data.website}</a>` : 'غير متوفر'}</td>
    `;
        companiesTable.appendChild(row);
      });
    });

    ///////////////////////////////////////////////////////////////////////////
    ////////////////////////// الكاميرات /////////////////////////////////////
    let currentEditingCameraType = null;
    window.addCameraData = async function () {
      const newType = document.getElementById("cameraTypeInput").value.trim();
      const models = document.getElementById("cameraModelsInput").value
        .split(',')
        .map(m => m.trim())
        .filter(Boolean);

      if (!newType || models.length === 0) {
        alert("❌ يرجى إدخال نوع الجهاز والموديلات.");
        return;
      }

      if (currentEditingCameraType && newType !== currentEditingCameraType) {
        await remove(ref(database, "Camera/" + currentEditingCameraType));
      }

      await set(ref(database, "Camera/" + newType), {
        models: models
      });

      alert(currentEditingCameraType ? "✅ تم حفظ بيانات الجهاز." : "✅ تم إضافة الجهاز بنجاح.");
      document.getElementById("cameraTypeInput").value = "";
      document.getElementById("cameraModelsInput").value = "";
      document.getElementById("updateDeviceButton").textContent = "إضافة";
      document.getElementById("deleteDeviceButton").style.display = "none";
      currentEditingCameraType = null;
      loadDeviceTableCamera();
      populateDeviceTypeOptionsCamera();
    };

    window.editDeviceType = function (type) {
      const modelsRef = ref(database, "Camera/" + type + "/models");

      get(modelsRef).then(snapshot => {
        const models = snapshot.val();

        if (Array.isArray(models)) {
          document.getElementById("cameraTypeInput").value = type;
          document.getElementById("cameraModelsInput").value = models.join(', ');
          currentEditingCameraType = type;
          document.getElementById("updateDeviceButton").textContent = "تحديث";
          document.getElementById("deleteDeviceButton").style.display = "inline-block";
        }
      });
    };

    function loadDeviceTableCamera() {
      const tableBody = document.querySelector("#cameraTable tbody");
      const deviceRef = ref(database, "Camera");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        tableBody.innerHTML = "";

        for (const type in data) {
          const models = data[type].models;
          const row = document.createElement("tr");

          row.innerHTML = `
                <td>${type}</td>
                <td>${models.join(', ')}</td>
            `;

          row.addEventListener("click", () => {
            fetchDeviceDataCamera(type);
          });

          tableBody.appendChild(row);
        }
      });
    }

    function populateDeviceTypeOptionsCamera() {
      const deviceTypeSelect = document.getElementById("cameraType");
      const queryDeviceType = document.getElementById("filter_camera_type");

      const deviceRef = ref(database, "Camera");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();

        const defaultOption = '<option value="">-- اختر نوع الجهاز --</option>';
        deviceTypeSelect.innerHTML = defaultOption;
        queryDeviceType.innerHTML = defaultOption;

        if (!data) return;

        Object.keys(data).forEach(type => {
          const option1 = document.createElement("option");
          option1.value = type;
          option1.textContent = type;

          const option2 = option1.cloneNode(true);

          deviceTypeSelect.appendChild(option1);
          queryDeviceType.appendChild(option2);
        });
      }, {
        onlyOnce: true
      });
    }

    document.getElementById("cameraType").addEventListener("change", (e) => {
      const selectedType = e.target.value;
      const modelSelect = document.getElementById("cameraModel");

      modelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

      if (selectedType) {
        const modelsRef = ref(database, "Camera/" + selectedType + "/models");
        onValue(modelsRef, (snapshot) => {
          const models = snapshot.val();
          if (Array.isArray(models)) {
            models.forEach(model => {
              const opt = document.createElement("option");
              opt.value = model;
              opt.textContent = model;
              modelSelect.appendChild(opt);
            });
          }
        });
      }
    });
    loadDeviceTableCamera();
    populateDeviceTypeOptionsCamera();

    function loadCompaniesIntoSelectCamera() {
      const companySelect = document.getElementById("cameraCompanySelect");
      const queryCompanySelect = document.getElementById("queryCompanySelectCamera");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeCamera");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }

    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelectCamera);

    window.SaveCamera = function () {
      const CameraSave = localStorage.getItem('CameraSave') === 'true';
      const CameraEdit = localStorage.getItem('CameraEdit') === 'true';
      const dataId = document.getElementById("documentNumberCamera").getAttribute("data-id");

      if (!dataId && !CameraSave) {
        alert("❌ ليس لديك صلاحية إضافة بيانات جديدة.");
        return;
      }
      if (dataId && !CameraEdit) {
        alert("❌ ليس لديك صلاحية تعديل البيانات.");
        return;
      }
      const documentNumberCamera = document.getElementById("documentNumberCamera").value.trim();
      const dateCamera = document.getElementById("dateCamera").value.trim();
      const cameraLocation = document.getElementById("cameraLocation").value.trim();
      const cameraType = document.getElementById("cameraType").value.trim();
      const cameraModel = document.getElementById("cameraModel").value.trim();
      const cameraCondition = document.getElementById("cameraCondition").value.trim();
      const cameraLens = document.getElementById("cameraLens").value;
      const cameraResolution = document.getElementById("cameraResolution").value;
      const serialCamera = document.getElementById("serialCamera").value.trim();
      const infrared = document.getElementById("infrared").value.trim();
      const connectionType = document.getElementById("connectionType").value.trim();
      const notesCamera = document.getElementById("notesCamera").value.trim();
      const companyCode = document.getElementById("cameraCompanySelect").value;
      const companyName = document.getElementById("cameraCompanySelect").selectedOptions[0]?.textContent || "";

      if (!companyCode || !dateCamera || !connectionType || !cameraLocation || !cameraType || !cameraModel || !cameraCondition || !cameraLens || !infrared) {
        alert("❌ يرجى ملء جميع الحقول الأساسية!");
        return;
      }

      const generatePcNum = (manualNum = null) => {
        return new Promise((resolve, reject) => {
          get(ref(database, "cameras"))
            .then(snapshot => {
              let existingNums = new Set();

              snapshot.forEach(childSnapshot => {
                const documentNumberCamera = parseInt(childSnapshot.val().documentNumberCamera);
                if (!isNaN(documentNumberCamera)) {
                  existingNums.add(documentNumberCamera);
                }
              });

              if (manualNum !== null && manualNum !== "") {
                const parsedManual = parseInt(manualNum);
                if (isNaN(parsedManual)) {
                  reject(new Error("⚠️ الرقم المدخل غير صالح."));
                } else if (existingNums.has(parsedManual) && !dataId) {
                  reject(new Error("⚠️ الرقم موجود مسبقًا."));
                } else {
                  resolve(parsedManual);
                }
              } else {
                let nextNum = 1;
                while (existingNums.has(nextNum)) {
                  nextNum++;
                }
                resolve(nextNum);
              }
            })
            .catch(error => reject(error));
        });
      };
      const saveOrUpdate = (documentNumberCamera) => {
        const data = {
          documentNumberCamera, dateCamera, cameraLocation, cameraType,
          cameraModel, cameraCondition, serialCamera, infrared,
          connectionType, notesCamera, cameraResolution, cameraLens,
          company: {
            code: companyCode,
            name: companyName
          }
        };

        document.getElementById("documentNumberCamera").setAttribute("readonly", true);

        if (dataId) {
          const pcRef = ref(database, "cameras/" + dataId);
          get(pcRef).then(snapshot => {
            if (snapshot.exists()) {
              if (snapshot.val().deleted) {
                alert("⚠️ الجهاز محذوف ولا يمكن تعديله!");
                return;
              } else {
                update(pcRef, data)
                  .then(() => {
                    alert("✅ تم تحديث البيانات بنجاح!");
                    clearFormCamera();
                  })
                  .catch(error => {
                    alert("❌ خطأ أثناء التحديث: " + error.message);
                  });
              }
            } else {
              alert("❌ الجهاز غير موجود في قاعدة البيانات!");
            }
          }).catch(error => {
            alert("❌ خطأ أثناء التحقق من حالة الجهاز: " + error.message);
          });
        } else {
          push(ref(database, "cameras"), data)
            .then(() => {
              alert("✅ تم إضافة الجهاز بنجاح!");
              clearFormCamera();
            })
            .catch(error => {
              alert("❌ خطأ أثناء الحفظ: " + error.message);
            });
        }
      };
      generatePcNum(documentNumberCamera)
        .then(documentNumberCamera => saveOrUpdate(documentNumberCamera))
        .catch(error => {
          alert(error.message);
        });
    };

    function clearFormCamera() {
      const fields = [
        "documentNumberCamera", "dateCamera", "cameraLocation",
        "cameraType", "cameraModel", 'cameraLens',
        "cameraCondition", "serialCamera", "infrared",
        "connectionType", "notesCamera", "cameraResolution"
      ];
      fields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.value = "";
        }
      });
      const documentNumberCamera = document.getElementById("documentNumberCamera");
      if (documentNumberCamera) {
        documentNumberCamera.removeAttribute("readonly");
        documentNumberCamera.removeAttribute("data-id");
      }
    }

    window.searchCamera = function () {
      const CameraQuery = localStorage.getItem('CameraQuery1') === 'true';
      const dataId = document.getElementById("filter_doc_number_camera").getAttribute("data-id");

      if (!dataId && !CameraQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }

      const queryCameraNum = document.getElementById("filter_doc_number_camera").value.trim().toLowerCase();
      const queryCameraLocation = document.getElementById("filter_Location_camera").value.trim().toLowerCase();
      const querydateAddedCamera = document.getElementById("filter_doc_date_camera").value.trim().toLowerCase();
      const queryCameraType = document.getElementById("filter_camera_type").value.trim().toLowerCase();
      const querystatusCamera = document.getElementById("filter_status_camera").value.trim().toLowerCase();
      const generalSearchCamera = document.getElementById("generalSearchCamera").value.trim().toLowerCase();
      const queryCompanyName = document.getElementById("queryCompanySelectCamera").value.trim().toLowerCase();

      const resultsContainer = document.getElementById("resultsTableCamera");
      resultsContainer.innerHTML = "⏳ جاري البحث...";

      const dbRef = ref(database, "cameras");

      const includesIgnoreCase = (source, query) => {
        return (source || "").toString().toLowerCase().includes(query);
      };

      get(dbRef).then((snapshot) => {
        if (!snapshot.exists()) {
          resultsContainer.innerHTML = "❌ لا توجد بيانات مطابقة!";
          return;
        }

        const data = snapshot.val();

        let filteredData = Object.keys(data).map(key => {
          const item = data[key];
          return {
            id: key,
            ...item,
            companyName: item.company?.name || ""
          };
        }).filter(item =>
          (queryCameraNum === "" || includesIgnoreCase(item.documentNumberCamera, queryCameraNum)) &&
          (queryCameraLocation === "" || includesIgnoreCase(item.cameraLocation, queryCameraLocation)) &&
          (querystatusCamera === "" || includesIgnoreCase(item.cameraCondition, querystatusCamera)) &&
          (querydateAddedCamera === "" || includesIgnoreCase(item.dateCamera, querydateAddedCamera)) &&
          (queryCameraType === "" || includesIgnoreCase(item.cameraType, queryCameraType)) &&
          (queryCompanyName === "" || includesIgnoreCase(item.companyName, queryCompanyName))
        );

        if (generalSearchCamera !== "") {
          filteredData = filteredData.filter(item =>
            Object.values(item).some(value =>
              includesIgnoreCase(value, generalSearchCamera)
            )
          );
        }

        filteredData.sort((a, b) => (parseInt(a.documentNumberCamera) || 0) - (parseInt(b.documentNumberCamera) || 0));

        if (filteredData.length === 0) {
          resultsContainer.innerHTML = "❌ لم يتم العثور على بيانات";
          return;
        }

        let table = document.createElement("table");
        table.style.width = "100%";
        table.style.borderCollapse = "collapse";
        table.style.textAlign = "center";

        let thead = document.createElement("thead");
        let headerRow = "<tr>";

        selectedColumnsCamera.forEach(col => {
          headerRow += `<th>${allColumnsCamera[col] || col}</th>`;
        });

        headerRow += "</tr>";
        thead.innerHTML = headerRow;
        thead.style.position = "sticky";
        thead.style.top = "0";
        thead.style.backgroundColor = "#fff";
        table.appendChild(thead);

        let tbody = document.createElement("tbody");

        filteredData.forEach(item => {
          const allNull = selectedColumnsCamera.every(col => {
            const value = item[col];
            return value === null || value === undefined || String(value).trim() === "";
          });

          if (allNull) return;

          let row = document.createElement("tr");

          if (item.deleted) {
            row.style.color = "red";
            row.style.backgroundColor = "#ffe6e6";
          }

          let rowHtml = "";
          selectedColumnsCamera.forEach(col => {
            rowHtml += `<td>${item[col] || "null"}</td>`;
          });

          row.innerHTML = rowHtml;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        resultsContainer.innerHTML = "";
        resultsContainer.appendChild(table);

      }).catch(err => {
        resultsContainer.innerHTML = "❌ حدث خطأ أثناء البحث: " + err.message;
      });
    };


    const allColumnsCamera = {
      documentNumberCamera: "رقم المستند",
      companyName: "اسم الشركة",
      dateCamera: "التاريخ",
      cameraLocation: "الموقع",
      cameraType: "نوع الكاميرا",
      cameraModel: "موديل كاميرا",
      cameraCondition: "حالة الكاميرا: ",
      cameraLens: "نوع العدسة",
      serialCamera: "الرقم التسلسلي:",
      infrared: "رؤية ليلية (IR) ",
      cameraResolution: "الدقة (ميغابيكسل)",
      connectionType: "نوع الاتصال:",
      notesCamera: "ملاحظات"

    };

    let selectedColumnsCamera = Object.keys(allColumnsCamera);

    window.printTableCamera = function () {
      const resultsContainer = document.getElementById("resultsTableCamera");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة الأجهزة</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelCamera = function () {
      const table = document.querySelector("#resultsTableCamera table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "Camera Data" });
      XLSX.writeFile(workbook, "Camera_Data.xlsx");
    };

    ///////////////////////////////////////////////////////////////////
    /////////////////////////// اعدادات الصفحه///////////////////////
    window.addEventListener('DOMContentLoaded', () => {

      loadPageSettingsFromLocal();

      loadPageSettings();

      document.getElementById('logoFile').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            const logo = event.target.result;
            const preview = document.getElementById('logoPreview');
            preview.src = logo;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('saveButton').addEventListener('click', savePageSettings);

      async function savePageSettings() {
        const pageName = document.getElementById('pageName').value.trim();
        const logoUrl = document.getElementById('logoPreview').src;

        if (!pageName || !logoUrl || logoUrl === window.location.href) {
          alert("❗ من فضلك أدخل اسم الصفحة وارفع شعار");
          return;
        }

        const settings = { pageName, logoUrl };

        try {
          await set(ref(database, 'pageSettings'), settings);
          localStorage.setItem('pageSettings', JSON.stringify(settings));
          alert("✅ تم حفظ الإعدادات بنجاح");
          applyPageSettings(settings);
        } catch (error) {
          console.error("❌ فشل الحفظ:", error);
        }
      }

      async function loadPageSettings() {
        try {
          const snapshot = await get(ref(database, 'pageSettings'));
          if (snapshot.exists()) {
            const settings = snapshot.val();
            document.getElementById('pageName').value = settings.pageName;
            document.getElementById('logoPreview').src = settings.logoUrl;
            document.getElementById('logoPreview').style.display = 'block';
            applyPageSettings(settings);
            localStorage.setItem('pageSettings', JSON.stringify(settings));
          }
        } catch (error) {
          console.error("❌ فشل تحميل الإعدادات:", error);
        }
      }

      function loadPageSettingsFromLocal() {
        const data = localStorage.getItem('pageSettings');
        if (data) {
          const settings = JSON.parse(data);
          document.getElementById('pageName').value = settings.pageName;
          document.getElementById('logoPreview').src = settings.logoUrl;
          document.getElementById('logoPreview').style.display = 'block';
          applyPageSettings(settings);
        }
      }

      function applyPageSettings(settings) {
        document.title = settings.pageName;
        document.getElementById('pageTitle').textContent = settings.pageName;

        let favicon = document.getElementById('dynamicFavicon');
        if (!favicon) {
          favicon = document.createElement('link');
          favicon.rel = 'icon';
          favicon.id = 'dynamicFavicon';
          document.head.appendChild(favicon);
        }
        favicon.href = settings.logoUrl;
      }
    });
    /////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////// Dashboard /////////////////////////////////////////////////////
    const ctx = document.getElementById("combinedChart").getContext("2d");
    const combinedChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            label: 'عدد الخطوط',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.7)' // أزرق واضح
          },
          {
            label: 'عدد الهواتف',
            data: [],
            backgroundColor: 'rgba(255, 99, 132, 0.7)' // أحمر وردي
          },
          {
            label: 'عدد الشاشات',
            data: [],
            backgroundColor: 'rgba(255, 206, 86, 0.7)' // أصفر ذهبي
          },
          {
            label: 'عدد الكمبيوتر',
            data: [],
            backgroundColor: 'rgba(75, 192, 192, 0.7)' // فيروزي
          },
          {
            label: 'عددالكاميرات',
            data: [],
            backgroundColor: 'rgba(153, 102, 255, 0.7)'
          },
          {
            label: 'عدد الرواتر',
            data: [],
            backgroundColor: 'rgba(255, 159, 64, 0.7)'
          },
          {
            label: 'عدد طبعات',
            data: [],
            backgroundColor: 'rgba(0, 204, 102, 0.7)'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    let linesCount = {};
    let phonesCount = {};
    let screensCount = {};
    let computersCount = {};
    let camerasCount = {};
    let routersCount = {};
    let printersCount = {};
    function updateChart() {
      let allEmployees = new Set([
        ...Object.keys(linesCount),
        ...Object.keys(phonesCount),
        ...Object.keys(screensCount),
        ...Object.keys(computersCount),
        ...Object.keys(camerasCount),
        ...Object.keys(routersCount),
        ...Object.keys(printersCount)
      ]);

      combinedChart.data.labels = Array.from(allEmployees);
      combinedChart.data.datasets[0].data = combinedChart.data.labels.map(name => linesCount[name] || 0);
      combinedChart.data.datasets[1].data = combinedChart.data.labels.map(name => phonesCount[name] || 0);
      combinedChart.data.datasets[2].data = combinedChart.data.labels.map(name => screensCount[name] || 0);
      combinedChart.data.datasets[3].data = combinedChart.data.labels.map(name => computersCount[name] || 0);
      combinedChart.data.datasets[4].data = combinedChart.data.labels.map(name => camerasCount[name] || 0);
      combinedChart.data.datasets[5].data = combinedChart.data.labels.map(name => routersCount[name] || 0);
      combinedChart.data.datasets[6].data = combinedChart.data.labels.map(name => printersCount[name] || 0);
      combinedChart.update();
    }


    onValue(ref(database, "lines"), (snapshot) => {
      linesCount = {};
      snapshot.forEach((child) => {
        const emp = child.val().location || "غير محدد";
        linesCount[emp] = (linesCount[emp] || 0) + 1;
      });
      updateChart();
    });

    onValue(ref(database, "phones"), (snapshot) => {
      phonesCount = {};
      snapshot.forEach((child) => {
        const emp = child.val().locationPhone || "غير محدد";
        phonesCount[emp] = (phonesCount[emp] || 0) + 1;
      });
      updateChart();
    });

    onValue(ref(database, "screens"), (snapshot) => {
      screensCount = {};
      snapshot.forEach((child) => {
        const emp = child.val().screenLocation || "غير محدد";
        screensCount[emp] = (screensCount[emp] || 0) + 1;
      });
      updateChart();
    });
    onValue(ref(database, "computers"), (snapshot) => {
      computersCount = {};
      snapshot.forEach((child) => {
        const emp = child.val().pcLocation || "غير محدد";
        computersCount[emp] = (computersCount[emp] || 0) + 1;
      });
      updateChart();
    });
    onValue(ref(database, "cameras"), (snapshot) => {
      camerasCount = {};
      snapshot.forEach((child) => {
        const emp = child.val().cameraLocation || "غير محدد";
        camerasCount[emp] = (camerasCount[emp] || 0) + 1;
      });
      updateChart();
    });
    onValue(ref(database, "routers"), (snapshot) => {
      routersCount = {};
      snapshot.forEach((child) => {
        const emp = child.val().location || "غير محدد";
        routersCount[emp] = (routersCount[emp] || 0) + 1;
      });
      updateChart();
    });
    onValue(ref(database, "printers"), (snapshot) => {
      printersCount = {};
      snapshot.forEach((child) => {
        const emp = child.val().location || "غير محدد";
        printersCount[emp] = (printersCount[emp] || 0) + 1;
      });
      updateChart();
    });
    /////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////// dashbord /////////////////////////////////

    async function loadDashboardData() {
      let locationPurchase = {};
      let locationDelivery = {};
      let itemsPurchase = {};
      let itemsDelivery = {};

      try {
        const purchaseSnap = await get(ref(database, 'purchaseOrders'));
        if (purchaseSnap.exists()) {
          Object.values(purchaseSnap.val()).forEach(order => {
            const loc = order.locationPurchase || "غير محدد";
            locationPurchase[loc] = (locationPurchase[loc] || 0) + order.items.length;
            order.items.forEach(item => {
              const name = item.itemName || "غير محدد";
              itemsPurchase[name] = (itemsPurchase[name] || 0) + Number(item.itemQuantity || 0);
            });
          });
        }

        const deliverySnap = await get(ref(database, 'deliveryRequests'));
        if (deliverySnap.exists()) {
          Object.values(deliverySnap.val()).forEach(order => {
            const loc = order.location || "غير محدد";
            locationDelivery[loc] = (locationDelivery[loc] || 0) + order.items.length;
            order.items.forEach(item => {
              const name = item.itemName || "غير محدد";
              itemsDelivery[name] = (itemsDelivery[name] || 0) + Number(item.quantity || 0);
            });
          });
        }

        renderCharts(locationPurchase, locationDelivery, itemsPurchase, itemsDelivery);

      } catch (err) {
        console.error("❌ خطأ في تحميل البيانات:", err);
      }
    }

    function renderCharts(locPurchase, locDelivery, itemsPurchase, itemsDelivery) {
      const allLocations = [...new Set([...Object.keys(locPurchase), ...Object.keys(locDelivery)])];
      const allItems = [...new Set([...Object.keys(itemsPurchase), ...Object.keys(itemsDelivery)])];

      new Chart(document.getElementById("locationChart"), {
        type: 'bar',
        data: {
          labels: allLocations,
          datasets: [
            {
              label: 'مشتريات',
              data: allLocations.map(l => locPurchase[l] || 0),
              backgroundColor: 'rgba(54, 162, 235, 0.7)'
            },
            {
              label: 'تسليم',
              data: allLocations.map(l => locDelivery[l] || 0),
              backgroundColor: 'rgba(255, 99, 132, 0.7)'
            }
          ]
        },
        options: { responsive: true }
      });

      new Chart(document.getElementById("itemChart"), {
        type: 'pie',
        data: {
          labels: allItems,
          datasets: [{
            label: 'إجمالي الكميات',
            data: allItems.map(i => (itemsPurchase[i] || 0) + (itemsDelivery[i] || 0)),
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)',
              'rgba(0, 204, 102, 0.7)'
            ]
          }]
        },
        options: { responsive: true }
      });
    }

    document.addEventListener("DOMContentLoaded", loadDashboardData);

    /////////////////////////////////////////////////////////////////////////////
    ///////////////////////// تغير كلمه المرور ////////////////////////////////
    window.changePassword = async function () {
      const username = localStorage.getItem('username');
      if (!username) {
        alert("❌ لم يتم العثور على مستخدم مسجل دخول.");
        return;
      }

      const newPassword = prompt(" أدخل كلمة المرور الجديدة:");
      if (!newPassword || newPassword.trim() === "") {
        alert("❌ كلمة المرور لا يمكن أن تكون فارغة.");
        return;
      }

      const snapshot = await get(ref(database, 'users'));
      if (snapshot.exists()) {
        const users = snapshot.val();
        let userId = null;

        for (const key in users) {
          if (users[key].username === username) {
            userId = key;
            break;
          }
        }

        if (!userId) {
          alert("❌ حدث خطأ: لم يتم العثور على المستخدم.");
          return;
        }

        await update(ref(database, `users/${userId}`), { password: newPassword });

        alert("✅ تم تغيير كلمة المرور بنجاح.");
      } else {
        alert("❌ لا يوجد مستخدمين في قاعدة البيانات.");
      }
    };

    ///////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////// مراكز التكلفه ////////////////////////////////////////
    window.saveCostCenter = function () {
      const codeInput = document.getElementById("costCenterCode").value.trim();
      const name = document.getElementById("costCenterName").value.trim();
      const desc = document.getElementById("costCenterDesc").value.trim();
      const parent = document.getElementById("parentCostCenter").value;
      const level = parent ? parseInt(document.getElementById("costCenterLevel").value) + 1 : 1;

      if (!name) return alert("⚠️ يجب إدخال اسم المركز");

      if (level > 1 && !parent) {
        return alert("⚠️ لا يمكن إنشاء فرع بدون اختيار مركز رئيسي");
      }

      if (!codeInput) {
        get(ref(database, "costCenters")).then(snapshot => {
          let max = 99;
          snapshot.forEach(child => {
            const c = parseInt(child.key);
            if (!isNaN(c) && c > max) max = c;
          });

          const newCode = (max + 1).toString();
          const data = { code: newCode, name, desc, parent, level };

          set(ref(database, "costCenters/" + newCode), data)
            .then(() => {
              alert("✅ تم الحفظ (الكود: " + newCode + ")");
              clearCostCenterForm();
              loadCostCenters();
            })
            .catch(e => alert("❌ خطأ: " + e.message));
        });
      } else {
        const data = { code: codeInput, name, desc, parent, level };
        set(ref(database, "costCenters/" + codeInput), data)
          .then(() => {
            alert("✅ تم التحديث");
            clearCostCenterForm();
            loadCostCenters();
          })
          .catch(e => alert("❌ خطأ: " + e.message));
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      loadCostCenters();
    });

    window.loadCostCenters = async function () {
      const tree = document.getElementById("costCenterTree");               // عنصر الشجرة (اختياري لكن مرغوب)
      const parentSelect = document.getElementById("parentCostCenter");    // select للأب
      const empSelect = document.getElementById("employeeCostCenter");     // select للموظف

      if (!parentSelect || !empSelect) {
        console.error("Missing HTML elements: parentCostCenter or employeeCostCenter");
        return;
      }

      parentSelect.innerHTML = "<option value=''>-- رئيسي --</option>";
      empSelect.innerHTML = "<option value=''>-- اختر مركز تكلفة --</option>";
      if (tree) tree.innerHTML = "";

      if (typeof get !== 'function' || typeof ref !== 'function' || typeof database === 'undefined') {
        console.error("Firebase not initialized or 'get/ref/database' not available.");
        if (tree) tree.innerHTML = "<p style='color:orange'>Firebase غير مهيأ.</p>";
        return;
      }

      try {
        const snapshot = await get(ref(database, "costCenters"));
        if (!snapshot.exists()) {
          if (tree) tree.innerHTML = "<p>لا توجد مراكز تكلفة.</p>";
          return;
        }

        const all = [];
        snapshot.forEach(child => {
          all.push(child.val());
        });

        const parentFrag = document.createDocumentFragment();
        const empFrag = document.createDocumentFragment();

        function buildTree(parent = "") {
          const ul = document.createElement("ul");

          all
            .filter(c => (c.parent || "") === (parent || ""))
            .sort((a, b) => String(a.code).localeCompare(String(b.code)))
            .forEach(c => {
              const li = document.createElement("li");

              const span = document.createElement("span");
              span.textContent = `${c.code} - ${c.name}`;
              span.style.cursor = "pointer";
              span.addEventListener('click', (e) => {
                e.stopPropagation();
                editCostCenter(c);
              });

              const editBtn = document.createElement("button");
              editBtn.type = "button";
              editBtn.textContent = "✏️";
              editBtn.style.marginInlineStart = "10px";
              editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                editCostCenter(c);
              });

              li.appendChild(span);
              li.appendChild(editBtn);

              const childrenUl = buildTree(c.code);
              if (childrenUl.childElementCount) li.appendChild(childrenUl);

              ul.appendChild(li);

              parentFrag.appendChild(new Option(`${c.code} - ${c.name}`, c.code));
              empFrag.appendChild(new Option(`${c.code} - ${c.name}`, c.code));
            });

          return ul;
        }

        const treeRoot = buildTree("");
        if (tree) {
          tree.innerHTML = "";
          tree.appendChild(treeRoot);
        }

        parentSelect.appendChild(parentFrag);
        empSelect.appendChild(empFrag);

      } catch (err) {
        console.error("Error loading cost centers:", err);
        if (tree) tree.innerHTML = "<p style='color:red'>حدث خطأ أثناء تحميل مراكز التكلفة.</p>";
      }
    };


    window.editCostCenter = function (c) {
      const setIf = (id, val) => { const el = document.getElementById(id); if (el) el.value = val ?? ""; };
      setIf("costCenterCode", c.code);
      setIf("costCenterName", c.name);
      setIf("costCenterDesc", c.desc || "");
      setIf("parentCostCenter", c.parent || "");
      setIf("costCenterLevel", c.level || "");
    };

    window.clearCostCenterForm = function () {
      ["costCenterCode", "costCenterName", "costCenterDesc", "costCenterLevel"].forEach(id => {
        const el = document.getElementById(id); if (el) el.value = "";
      });
      const p = document.getElementById("parentCostCenter"); if (p) p.value = "";
    };

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////// Gps ///////////////////////////////////////////////////////////////////////
    let currentEditingGpsType = null;
    window.addGPSData = async function () {
      const newType = document.getElementById("GPSTypeInput").value.trim();
      const models = document.getElementById("GPSModelsInput").value
        .split(',')
        .map(m => m.trim())
        .filter(Boolean);

      if (!newType || models.length === 0) {
        alert("❌ يرجى إدخال نوع الجهاز والموديلات.");
        return;
      }

      if (currentEditingGpsType && newType !== currentEditingGpsType) {
        await remove(ref(database, "GPS/" + currentEditingGpsType));
      }

      await set(ref(database, "GPS/" + newType), {
        models: models
      });

      alert(currentEditingGpsType ? "✅ تم حفظ بيانات الجهاز." : "✅ تم إضافة الجهاز بنجاح.");
      document.getElementById("GPSTypeInput").value = "";
      document.getElementById("GPSModelsInput").value = "";
      document.getElementById("updateDeviceButton").textContent = "إضافة";
      document.getElementById("deleteDeviceButton").style.display = "none";
      currentEditingGpsType = null;
      loadGpsTable();
      populateGpsTypeOptions();
    };

    window.editGpsType = function (type) {
      const modelsRef = ref(database, "GPS/" + type + "/models");

      get(modelsRef).then(snapshot => {
        const models = snapshot.val();

        if (Array.isArray(models)) {
          document.getElementById("GPSTypeInput").value = type;
          document.getElementById("GPSModelsInput").value = models.join(', ');
          currentEditingGpsType = type;
          document.getElementById("updateDeviceButton").textContent = "تحديث";
          document.getElementById("deleteDeviceButton").style.display = "inline-block";
        }
      });
    };

    function loadGpsTable() {
      const tableBody = document.querySelector("#GPSTable tbody");
      const deviceRef = ref(database, "GPS");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        tableBody.innerHTML = "";

        for (const type in data) {
          const models = data[type].models;
          const row = document.createElement("tr");

          row.innerHTML = `
                <td>${type}</td>
                <td>${models.join(', ')}</td>
            `;

          row.addEventListener("click", () => {
            fetchGpsSettingsData(type);
          });

          tableBody.appendChild(row);
        }
      });
    }

    function populateGpsTypeOptions() {
      const deviceTypeSelect = document.getElementById("GPSType");
      const queryDeviceType = document.getElementById("queryGpsType");

      const deviceRef = ref(database, "GPS");

      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();

        const defaultOption = '<option value="">-- اختر نوع الجهاز --</option>';
        deviceTypeSelect.innerHTML = defaultOption;
        queryDeviceType.innerHTML = defaultOption;

        if (!data) return;

        Object.keys(data).forEach(type => {
          const option1 = document.createElement("option");
          option1.value = type;
          option1.textContent = type;

          const option2 = option1.cloneNode(true);

          deviceTypeSelect.appendChild(option1);
          queryDeviceType.appendChild(option2);
        });
      }, {
        onlyOnce: true
      });
    }

    document.getElementById("GPSType").addEventListener("change", (e) => {
      const selectedType = e.target.value;
      const modelSelect = document.getElementById("GPSModel");

      modelSelect.innerHTML = '<option value="">-- اختر الموديل --</option>';

      if (selectedType) {
        const modelsRef = ref(database, "GPS/" + selectedType + "/models");
        onValue(modelsRef, (snapshot) => {
          const models = snapshot.val();
          if (Array.isArray(models)) {
            models.forEach(model => {
              const opt = document.createElement("option");
              opt.value = model;
              opt.textContent = model;
              modelSelect.appendChild(opt);
            });
          }
        });
      }
    });
    loadGpsTable();
    populateGpsTypeOptions();

    function loadCompaniesIntoSelect2() {
      const companySelect = document.getElementById("companySelect2");
      const queryCompanySelect = document.getElementById("queryCompanySelectGps");
      const selectedCompanyCode = document.getElementById("selectedCompanyCodeGps");

      if (companySelect) companySelect.innerHTML = '<option value="">-- اختر شركة --</option>';
      if (queryCompanySelect) queryCompanySelect.innerHTML = '<option value="">-- اختر شركة --</option>';

      const companiesRef = ref(database, "companies");

      onValue(companiesRef, (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const company = childSnapshot.val();

          const option = document.createElement("option");
          option.value = company.code;
          option.textContent = company.name;
          if (companySelect) companySelect.appendChild(option);

          if (queryCompanySelect) {
            const option2 = document.createElement("option");
            option2.value = company.code;
            option2.textContent = company.name;
            queryCompanySelect.appendChild(option2);
          }
        });
      });
      if (companySelect && selectedCompanyCode) {
        companySelect.addEventListener("change", () => {
          selectedCompanyCode.value = companySelect.value;
        });
      }
    }

    document.addEventListener("DOMContentLoaded", loadCompaniesIntoSelect2);


    document.addEventListener("DOMContentLoaded", function () {
      const phoneInput = document.getElementById("lineNumberGPS");
      if (!phoneInput) {
        console.error("❌ عنصر lineNumberGPS غير موجود!");
        return;
      }

      phoneInput.addEventListener("input", async function () {
        const phone = this.value.trim();
        const phoneRegex = /^01[0-9]{9}$/; // مثال: أرقام مصر

        if (!phoneRegex.test(phone)) return;

        try {
          const linesRef = ref(database, "lines");
          const snapshot = await get(linesRef);

          if (snapshot.exists()) {
            let found = false;
            snapshot.forEach(child => {
              const line = child.val();
              const linePhone = (line.phoneNumber || "").trim();
              if (!line.deleted && linePhone === phone) {
                document.getElementById("employeeNameGPS").value = line.employeeName || '';
                document.getElementById("simNumberGPS").value = line.simNumber || '';
                found = true;
                console.log("✅ تم العثور على الخط:", line);
              }
            });

            if (!found) {
              document.getElementById("employeeNameGPS").value = '';
              document.getElementById("simNumberGPS").value = '';
              console.warn("⚠️ لم يتم العثور على خط بهذا الرقم.");
            }
          }
        } catch (error) {
          console.error("❌ خطأ أثناء جلب بيانات الخط:", error);
        }
      });
    });

    window.saveDataGPS = function () {
      const gpsSave = localStorage.getItem('gpsSave') === 'true';
      const gpsEdit = localStorage.getItem('gpsEdit') === 'true';
      const dataId = document.getElementById("docNumberGPS").getAttribute("data-id");

      if (!dataId && !gpsSave) return Swal.fire("❌ خطأ", "ليس لديك صلاحية إضافة بيانات جديدة.", "error");
      if (dataId && !gpsEdit) return Swal.fire("❌ خطأ", "ليس لديك صلاحية تعديل البيانات.", "error");

      const docNumberGPS = document.getElementById("docNumberGPS").value.trim();
      const locationGPS = document.getElementById("locationGPS").value.trim();
      const installDateGPS = document.getElementById("installDateGPS").value.trim();
      const carLicenseGPS = document.getElementById("carLicenseGPS").value.trim();
      const carTypeGPS = document.getElementById("carTypeGPS").value.trim();
      const imeiGPS = document.getElementById("imeiGPS").value.trim();
      const GPSType = document.getElementById("GPSType").value.trim();
      const GPSModel = document.getElementById("GPSModel").value.trim();
      const employeeNameGPS = document.getElementById("employeeNameGPS").value.trim();
      const lineNumberGPS = document.getElementById("lineNumberGPS").value.trim();
      const simNumberGPS = document.getElementById("simNumberGPS").value.trim();
      const statusGPS = document.getElementById("statusGPS").value.trim();
      const notesGPS = document.getElementById("notesGPS").value.trim();
      const companyCode = document.getElementById("companySelect2").value.trim();

      if (!installDateGPS || !carLicenseGPS || !carTypeGPS || !companyCode) {
        return Swal.fire("⚠️ تنبيه", "يرجى ملء جميع الحقول الأساسية!", "warning");
      }

      const generateDocNumber = (manualNum = null) => {
        return new Promise((resolve, reject) => {
          get(ref(database, "GPSS")).then(snapshot => {
            const existingNums = new Set();
            snapshot.forEach(child => {
              const num = parseInt(child.val().docNumberGPS);
              if (!isNaN(num)) existingNums.add(num);
            });

            if (manualNum) {
              const parsed = parseInt(manualNum);
              if (isNaN(parsed)) return reject(new Error("⚠️ الرقم المدخل غير صالح."));
              if (existingNums.has(parsed) && !dataId) return reject(new Error("⚠️ الرقم موجود مسبقًا."));
              resolve(parsed);
            } else {
              let next = 1;
              while (existingNums.has(next)) next++;
              resolve(next);
            }
          }).catch(reject);
        });
      };

      const saveOrUpdate = (docNumberGPS, companyData = {}) => {
        const data = {
          docNumberGPS,
          locationGPS, installDateGPS,
          carLicenseGPS, carTypeGPS,
          GPSType, GPSModel, imeiGPS,
          employeeNameGPS, lineNumberGPS, simNumberGPS,
          statusGPS, notesGPS, companyCode,
          company: companyData,
          updatedAt: new Date().toISOString()
        };

        document.getElementById("docNumberGPS").setAttribute("readonly", true);

        Swal.fire({
          title: '⏳ جاري الحفظ',
          text: 'يرجى الانتظار...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        if (dataId) {
          const gpsRef = ref(database, "GPSS/" + dataId);
          get(gpsRef).then(snapshot => {
            if (snapshot.exists() && snapshot.val().deleted) {
              Swal.fire("⚠️ تنبيه", "الجهاز محذوف ولا يمكن تعديله!", "warning");
            } else {
              update(gpsRef, data)
                .then(() => {
                  Swal.fire("✅ نجاح", "تم تحديث البيانات بنجاح", "success");
                  clearFormGPS();
                })
                .catch(e => Swal.fire("❌ خطأ", "فشل في التحديث: " + e.message, "error"));
            }
          });
        } else {
          push(ref(database, "GPSS"), data)
            .then(() => {
              Swal.fire("✅ نجاح", "تم حفظ البيانات بنجاح!", "success");
              clearFormGPS();
            })
            .catch(e => Swal.fire("❌ خطأ", "فشل في الحفظ: " + e.message, "error"));
        }
      };

      generateDocNumber(docNumberGPS)
        .then(async finalDocNum => {
          let companyData = {};
          try {
            const companyRef = ref(database, "companySettings/" + companyCode);
            const snapshot = await get(companyRef);

            if (snapshot.exists()) {
              companyData = snapshot.val();
              console.log("✅ تم جلب بيانات الشركة:", companyData);
            } else {
              console.warn("⚠️ لم يتم العثور على بيانات الشركة:", companyCode);
            }
          } catch (error) {
            console.error("❌ خطأ أثناء تحميل بيانات الشركة:", error);
            Swal.fire("❌ خطأ", "حدث خطأ أثناء تحميل بيانات الشركة: " + error.message, "error");
          }

          saveOrUpdate(finalDocNum, companyData);
        })
        .catch(err => Swal.fire("⚠️ تنبيه", err.message, "warning"));
    };

    function clearFormGPS() {
      const fields = [
        "docNumberGPS", "locationGPS", "installDateGPS",
        "carLicenseGPS", "carTypeGPS", "imeiGPS",
        "GPSType", "GPSModel", "employeeNameGPS",
        "lineNumberGPS", "simNumberGPS", "statusGPS",
        "notesGPS", "companySelect2"
      ];

      fields.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = "";
      });

      const docNumberGPS = document.getElementById("docNumberGPS");
      if (docNumberGPS) {
        docNumberGPS.removeAttribute("readonly");
        docNumberGPS.removeAttribute("data-id");
      }
    }

    window.searchDataGPS = async function () {
      const resultsContainer = document.getElementById("queryResultsGps");
      const GpsQuery = localStorage.getItem('GpsQuery') === 'true';
      const dataId = document.getElementById("queryGPS").getAttribute("data-id");

      if (!dataId && !GpsQuery) {
        alert("❌ ليس لديك صلاحية الاستعلام.");
        return;
      }

      const inputs = {
        queryGPS: document.getElementById("queryGPS").value.trim().toLowerCase(),
        queryGPSUser: document.getElementById("queryGPSUser").value.trim().toLowerCase(),
        queryLocationGPS: document.getElementById("queryLocationGPS").value.trim().toLowerCase(),
        querydateAddedGPS: document.getElementById("querydateAddedGPS").value.trim().toLowerCase(),
        queryGpsType: document.getElementById("queryGpsType").value.trim().toLowerCase(),
        generalSearchGPS: document.getElementById("generalSearchGPS").value.trim().toLowerCase(),
        queryCompanySelectGps: document.getElementById("queryCompanySelectGps").value.trim().toLowerCase()
      };

      resultsContainer.innerHTML = "⏳ جاري البحث...";

      try {
        const snapshot = await get(ref(database, "GPSS"));
        if (!snapshot.exists()) {
          resultsContainer.innerHTML = "❌ لا توجد بيانات مطابقة!";
          return;
        }

        let gpsData = snapshot.val();

        let filteredData = Object.keys(gpsData).map(key => ({
          id: key, ...gpsData[key]
        })).filter(item =>
          (!inputs.queryGPS || String(item.docNumberGPS || "").toLowerCase().includes(inputs.queryGPS)) &&
          (!inputs.queryGPSUser || String(item.employeeNameGPS || "").toLowerCase().includes(inputs.queryGPSUser)) &&
          (!inputs.queryLocationGPS || String(item.locationGPS || "").toLowerCase().includes(inputs.queryLocationGPS)) &&
          (!inputs.querydateAddedGPS || String(item.installDateGPS || "").toLowerCase().includes(inputs.querydateAddedGPS)) &&
          (!inputs.queryCompanySelectGps || String(item.companyCode || "").toLowerCase().includes(inputs.queryCompanySelectGps)) &&
          (!inputs.queryGpsType || String(item.GPSType || "").toLowerCase().includes(inputs.queryGpsType))
        );

        if (inputs.generalSearchGPS) {
          filteredData = filteredData.filter(item =>
            Object.values(item).some(value =>
              String(value).toLowerCase().includes(inputs.generalSearchGPS)
            )
          );
        }

        filteredData.sort((a, b) => (parseInt(a.docNumberGPS) || 0) - (parseInt(b.docNumberGPS) || 0));

        renderResultsGPS(filteredData, resultsContainer);

      } catch (err) {
        resultsContainer.innerHTML = `❌ حدث خطأ أثناء البحث:<br> ${err.message}`;
      }
    };

    function renderResultsGPS(data, resultsContainer) {
      if (data.length === 0) {
        resultsContainer.innerHTML = "❌ لم يتم العثور على بيانات";
        return;
      }

      let table = document.createElement("table");

      let thead = document.createElement("thead");
      let headerRow = "<tr>";
      selectedColumnsGps.forEach(col => headerRow += `<th>${allColumnsGps[col] || col}</th>`);
      headerRow += "</tr>";
      thead.innerHTML = headerRow;
      table.appendChild(thead);

      let tbody = document.createElement("tbody");
      data.forEach(item => {
        let row = document.createElement("tr");
        if (item.deleted) row.style.backgroundColor = "#ffe6e6";
        let rowHtml = "";
        selectedColumnsGps.forEach(col => {
          const val = item[col] ? item[col] : "—";
          rowHtml += `<td>${val}</td>`;
        });
        row.innerHTML = rowHtml;
        tbody.appendChild(row);
      });
      table.appendChild(tbody);

      resultsContainer.innerHTML = ``;
      resultsContainer.appendChild(table);
    }

    const allColumnsGps = {
      docNumberGPS: "رقم المستند",
      locationGPS: "الموقع",
      installDateGPS: "تاريخ التركيب",
      carLicenseGPS: "رقم السيارة",
      carTypeGPS: "نوع السيارة",
      GPSType: "نوع الجهاز",
      GPSModel: "موديل الجهاز",
      imeiGPS: "IMEI",
      employeeNameGPS: "اسم الموظف",
      lineNumberGPS: "رقم الخط",
      simNumberGPS: "رقم الشريحة",
      statusGPS: "الحالة",
      notesGPS: "ملاحظات",
      companyCode: "كود الشركة"
    };

    let selectedColumnsGps = Object.keys(allColumnsGps);

    window.applyColumnFilter = function () {
      selectedColumnsGps = Array.from(document.querySelectorAll('.columnCheckbox:checked')).map(cb => cb.value);
      document.getElementById("columnFilterBoxGps").style.display = "none";
      searchDataGPS();
    }

    window.toggleColumnFilter = function () {
      const box = document.getElementById("columnFilterBoxGps");
      const container = document.getElementById("columnCheckboxesGps");
      box.style.display = box.style.display === "none" ? "block" : "none";

      if (container.innerHTML === "") {
        Object.keys(allColumnsGps).forEach(key => {
          container.innerHTML += `
        <label style="display:block;margin:3px 0;">
          <input type="checkbox" class="columnCheckbox" value="${key}" checked> ${allColumnsGps[key]}
        </label>
      `;
        });
      }
    }

    window.printTableGPS = function () {
      const resultsContainer = document.getElementById("queryResultsGps");
      const tableHTML = resultsContainer.innerHTML;

      if (!tableHTML.trim()) {
        alert("❌ لا يوجد جدول لطباعته.");
        return;
      }

      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write(`
        <html>
            <head>
                <title>طباعة الأجهزة</title>
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; text-align: center; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 6px; font-size: 12px; }
                    th { background-color: #f0f0f0; }
                </style>
            </head>
            <body>
                <img src="LOGO_URL_HERE" alt="الشعار" style="height: 100px; margin-bottom: 10px;">
                ${tableHTML}
            </body>
        </html>
    `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    };

    window.exportToExcelGPS = function () {
      const table = document.querySelector("#queryResultsGps table");
      if (!table) {
        alert("❌ لا يوجد جدول لتصديره!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(table, { sheet: "PC Data" });
      XLSX.writeFile(workbook, "PC_Data.xlsx");
    };


    //////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////  HR - Employees  /////////////////////////////////////////
    async function loadRegionsForEmployee() {
      const snapshot = await get(ref(database, "Region"));
      const select = document.getElementById("employeeRegion");

      select.innerHTML = '<option value="">-- اختر المنطقة --</option>';

      if (snapshot.exists()) {
        const regions = snapshot.val();
        Object.keys(regions).forEach(code => {
          const region = regions[code];
          const opt = document.createElement("option");
          opt.value = code;
          opt.textContent = region.RegionName + " (كود: " + code + ")";
          select.appendChild(opt);
        });
      }
    }
    loadRegionsForEmployee();

    window.checkAttendance = async function (employeeCode, lat, lng) {
      try {
        const empSnap = await get(ref(database, "hrEmployees/" + employeeCode));
        if (!empSnap.exists()) {
          alert("❌ الموظف غير موجود");
          return;
        }

        const emp = empSnap.val();
        if (!emp.regionCode) {
          alert("❌ الموظف لم يتم ربطه بأي منطقة");
          return;
        }

        const regSnap = await get(ref(database, "Region/" + emp.regionCode));
        if (!regSnap.exists()) {
          alert("❌ المنطقة المرتبطة بالموظف غير موجودة");
          return;
        }

        const region = regSnap.val();
        const dist = getDistance(
          parseFloat(lat),
          parseFloat(lng),
          parseFloat(region.Lat),
          parseFloat(region.Lng)
        );

        if (dist <= region.Radius) {
          alert("✅ الموظف داخل المنطقة، تم تسجيل الحضور");
          await set(ref(database, `Attendance/${employeeCode}/${Date.now()}`), {
            status: "Present",
            date: new Date().toISOString(),
            lat,
            lng,
            region: emp.regionCode
          });
        } else {
          alert("❌ الموظف خارج نطاق المنطقة (المسافة: " + dist.toFixed(2) + " متر)");
        }
      } catch (error) {
        console.error(error);
        alert("❌ خطأ أثناء تسجيل الحضور");
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      let isEditMode = false;

      async function generateEmployeeCode() {
        const snapshot = await get(ref(database, "hrEmployees"));
        if (snapshot.exists()) {
          const employees = Object.keys(snapshot.val());
          const numbers = employees.map(code => parseInt(code)).filter(n => !isNaN(n));
          const nextNum = numbers.length ? Math.max(...numbers) + 1 : 1;
          return nextNum.toString();
        } else {
          return "1";
        }
      }

      function checkRequired(id, message) {
        const el = document.getElementById(id);
        if (!el) {
          console.warn(`⚠️ العنصر #${id} غير موجود في الصفحة`);
          return "";
        }
        const value = el.value.trim();
        if (!value) {
          alert("❌ " + message);
          throw new Error(message);
        }
        return value;
      }

      window.saveAll = async function () {
        let employeeCode = document.getElementById("employeeCode").value.trim();
        let phone = String(document.getElementById("numberEmployess").value).trim();
        let nid = document.getElementById("nid").value.trim();

        if (!/^\d{11}$/.test(phone)) {
          alert("❌ رقم الهاتف يجب أن يكون 11 رقم");
          return;
        }

        if (!/^\d{14}$/.test(nid)) {
          alert("❌ الرقم القومي يجب أن يكون 14 رقم");
          return;
        }

        try {
          const fullName = checkRequired("fullName", "الاسم بالكامل مطلوب");
          const governorate = checkRequired("governorate", "المحافظة مطلوبة");
          const city = checkRequired("city", "المدينة مطلوبة");
          const dob = checkRequired("dob", "تاريخ الميلاد مطلوب");
          const qualification = checkRequired("qualification", "المؤهل الدراسي مطلوب");
          const jobTitle = checkRequired("jobTitle", "المسمى الوظيفي مطلوب");
          const dept = checkRequired("jobDept", "القسم التابع له مطلوب");

          if (!isEditMode && !employeeCode) {
            employeeCode = await generateEmployeeCode();
            document.getElementById("employeeCode").value = employeeCode;
          }

          const employeeData = {
            code: employeeCode,
            fullName: document.getElementById("fullName")?.value || "",
            governorate: document.getElementById("governorate")?.value || "",
            city: document.getElementById("city")?.value || "",
            street: document.getElementById("street")?.value || "",
            dob: document.getElementById("dob")?.value || "",
            birthPlace: document.getElementById("birthPlace")?.value || "",
            nid: document.getElementById("nid")?.value || "",
            religion: document.getElementById("religion")?.value || "",
            maritalStatus: document.getElementById("maritalStatus")?.value || "",
            gender: document.getElementById("gender")?.value || "",
            numberEmployess: phone,
            regionCode: document.getElementById("employeeRegion")?.value || ""
          };

          const educationData = {
            qualification: document.getElementById("qualification")?.value || "",
            specialization: document.getElementById("specialization")?.value || "",
            university: document.getElementById("university")?.value || "",
            graduationYear: document.getElementById("graduationYear")?.value || "",
            grade: document.getElementById("grade")?.value || "",
            courses: document.getElementById("courses")?.value || ""
          };

          const skillsData = {
            skillName: document.getElementById("skillName")?.value || "",
            skillLevel: document.getElementById("skillLevel")?.value || ""
          };

          const financeData = {
            employeeCostCenter: document.getElementById("employeeCostCenter")?.value || "",
            allowances: document.getElementById("allowances")?.value || "",
            salary: document.getElementById("salary")?.value || "",
            incentives: document.getElementById("salary2")?.value || ""
          };

          const socialData = {
            insuranceNumber: document.getElementById("insuranceNumber")?.value || "",
            basicInsuranceStatus: document.getElementById("basicInsuranceStatus")?.value || "",
            insuranceStart: document.getElementById("insuranceStart")?.value || "",
            insuranceSalary: document.getElementById("insuranceSalary")?.value || "",
            employeeShare: document.getElementById("employeeShare")?.value || "",
            companyShare: document.getElementById("companyShare")?.value || "",
            employeeDeduction: document.getElementById("employeeDeduction")?.value || "",
            totalContribution: document.getElementById("totalContribution")?.value || "",
            linkedInsuranceOffice: document.getElementById("linkedInsuranceOffice")?.value || "",
            linkedInsuranceOfficeNumber: document.getElementById("linkedInsuranceOfficeNumber")?.value || ""
          };

          const jobData = {
            dept: document.getElementById("jobDept")?.value || "",
            jobTitle: document.getElementById("jobTitle")?.value || "",
            status: document.getElementById("jobStatus")?.value || "",
            employmentType: document.getElementById("employmentType")?.value || "",
            jobGrade: document.getElementById("jobGrade")?.value || "",
            hireDate: document.getElementById("hireDate")?.value || "",
            contractStart: document.getElementById("contractStart")?.value || "",
            contractEnd: document.getElementById("contractEnd")?.value || "",
            previousJob: document.getElementById("previousJob")?.value || "",
            currentJob: document.getElementById("currentJob")?.value || "",
            lastPromotionDate: document.getElementById("lastPromotionDate")?.value || "",
            workHours: document.getElementById("workHours")?.value || "",
            shiftType: document.getElementById("shiftType")?.value || "",
            workLocation: document.getElementById("workLocation")?.value || ""
          };

          const reportsData = { notes: "لا يوجد تقارير حالياً" };

          await set(ref(database, "hrEmployees/" + employeeCode), {
            ...employeeData,
            education: educationData,
            skills: skillsData,
            finance: financeData,
            social: socialData,
            job: jobData,
            reports: reportsData
          });

          alert("✅ تم حفظ جميع بيانات الموظف (الكود: " + employeeCode + ")");

          document.getElementById("employeeForm").reset();
          document.getElementById("educationForm").reset();
          document.getElementById("skillsForm").reset();
          document.getElementById("financeForm").reset();
          document.getElementById("insuranceForm").reset();
          document.getElementById("jobForm").reset();

          document.getElementById("employeeCode").value = "";
          isEditMode = false;

        } catch (error) {
          console.warn("⚠️ خطأ:", error.message);
        }
      };
    });

    ////////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////////////////// إدارة الحاله التأمينية /////////////////////////
    window.saveStatus = function () {
      const code = document.getElementById("statusCode").value.trim();
      const desc = document.getElementById("statusDesc").value.trim();

      if (!code || !desc) return alert("⚠️ يجب إدخال الكود والوصف");

      let statuses = JSON.parse(localStorage.getItem("insuranceStatuses") || "[]");

      const existingIndex = statuses.findIndex(s => s.code === code);
      if (existingIndex >= 0) {
        statuses[existingIndex].desc = desc;
      } else {
        statuses.push({ code, desc });
      }

      localStorage.setItem("insuranceStatuses", JSON.stringify(statuses));
      loadStatuses();
      clearStatusForm();
      alert("✅ تم الحفظ");
    };

    window.loadStatuses = function () {
      const statuses = JSON.parse(localStorage.getItem("insuranceStatuses") || "[]");
      const tableBody = document.getElementById("statusTableBody");

      if (tableBody) tableBody.innerHTML = "";

      statuses.forEach(s => {
        if (tableBody) {
          const row = document.createElement("tr");

          const codeCell = document.createElement("td");
          codeCell.textContent = s.code;
          row.appendChild(codeCell);

          const descCell = document.createElement("td");
          descCell.textContent = s.desc;
          row.appendChild(descCell);

          tableBody.appendChild(row);
        }
      });
    };

    window.clearStatusForm = function () {
      document.getElementById("statusCode").value = "";
      document.getElementById("statusDesc").value = "";
    };

    window.onload = loadStatuses;
    function loadInsuranceStatusOptions() {
      const select = document.getElementById("basicInsuranceStatus");
      if (!select) return;

      const statuses = JSON.parse(localStorage.getItem("insuranceStatuses") || "[]");

      select.innerHTML = "<option value=''>-- اختر الحالة التأمينية --</option>";

      statuses.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.code;
        opt.textContent = `${s.desc}`;
        select.appendChild(opt);
      });
    }

    window.onload = function () {
      loadStatuses();
      loadInsuranceStatusOptions();
      loadOffices();
      loadInsuranceOffices();

    };

    ////////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////////////////// إدارة  مكاتب التأمين /////////////////////////
    window.addOffice = function () {
      const code = document.getElementById("officeNumber").value.trim();
      const desc = document.getElementById("officeName").value.trim();

      if (!code || !desc) return alert("⚠️ اكتب الاسم والرقم!");

      let statuses = JSON.parse(localStorage.getItem("insuranceOffices") || "[]");

      const existingIndex = statuses.findIndex(s => s.code === code);
      if (existingIndex >= 0) {
        statuses[existingIndex].desc = desc;
      } else {
        statuses.push({ code, desc });
      }

      localStorage.setItem("insuranceOffices", JSON.stringify(statuses));
      loadOffices();
      clearOfficesForm();
      alert("✅ تم الحفظ");
    };

    window.loadOffices = function () {
      const statuses = JSON.parse(localStorage.getItem("insuranceOffices") || "[]");
      const tableBody = document.getElementById("officesTable");

      if (tableBody) tableBody.innerHTML = "";

      statuses.forEach(s => {
        if (tableBody) {
          const row = document.createElement("tr");

          const codeCell = document.createElement("td");
          codeCell.textContent = s.code;
          row.appendChild(codeCell);

          const descCell = document.createElement("td");
          descCell.textContent = s.desc;
          row.appendChild(descCell);

          tableBody.appendChild(row);
        }
      });
    };

    window.clearOfficesForm = function () {
      document.getElementById("officeNumber").value = "";
      document.getElementById("officeName").value = "";
    };

    function loadInsuranceOffices() {
      const officesRef = ref(database, "insuranceOffices");
      onValue(officesRef, snapshot => {
        const select = document.getElementById("linkedInsuranceOffice");
        select.innerHTML = '<option value="">-- اختر مكتب التأمين --</option>';
        if (snapshot.exists()) {
          snapshot.forEach(child => {
            const office = child.val();
            const option = document.createElement("option");
            option.value = office.id;
            option.textContent = office.name;
            option.setAttribute("data-number", office.number);
            select.appendChild(option);
          });
        }
      });
    }

    function updateInsuranceOffice(selectEl) {
      const selectedOption = selectEl.options[selectEl.selectedIndex];
      const officeNumber = selectedOption.getAttribute("data-number") || "";
      document.getElementById("linkedInsuranceOfficeNumber").value = officeNumber;
    }
    window.updateInsuranceOffice = updateInsuranceOffice;

    loadInsuranceOffices();
    ////////////////////////////////////////////////////////////////////////
    ////////////////////////////// التامينات //////////////////////////////
    ///////////////////////////////////////////////////////////////////////
    function calcContribution() {
      let salary = parseFloat(document.getElementById('insuranceSalary').value);
      let employeeShare = parseFloat(document.getElementById('employeeShare').value);
      let companyShare = parseFloat(document.getElementById('companyShare').value);

      if (!isNaN(salary) && !isNaN(employeeShare) && !isNaN(companyShare)) {
        let employeeContribution = salary * (employeeShare / 100);
        let companyContribution = salary * (companyShare / 100);
        let total = employeeContribution + companyContribution;

        document.getElementById('employeeDeduction').value = employeeContribution.toFixed(2);
        document.getElementById('totalContribution').value = total.toFixed(2);
      } else {
        document.getElementById('employeeDeduction').value = '';
        document.getElementById('totalContribution').value = '';
      }
    }

    function syncSalaryFromFinance() {
      let baseSalary = parseFloat(document.getElementById('salary').value) || 0;
      document.getElementById('insuranceSalary').value = baseSalary;
      calcContribution();
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('salary').addEventListener('input', syncSalaryFromFinance);
      document.getElementById('insuranceSalary').addEventListener('input', calcContribution);
      document.getElementById('employeeShare').addEventListener('input', calcContribution);
      document.getElementById('companyShare').addEventListener('input', calcContribution);
    });
    ////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////// الهيكل الوظيفي ////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////////////////////////////////////////
    let orgData = { id: "ROOT", name: "الشركة", title: "المؤسسة", dept: "الرئيسي", children: [], employees: [] };

    const deptForm = document.getElementById('deptForm');
    const empForm = document.getElementById('empForm');
    const parentDept = document.getElementById('parentDept');
    const empDept = document.getElementById('empDept');
    const treeEl = document.getElementById('tree');

    function renderTree() {
      treeEl.innerHTML = '';
      treeEl.appendChild(createBranch(orgData));
      refreshDeptLists();
    }

    function createBranch(node) {
      const wrapper = document.createElement('div'); wrapper.className = 'branch';
      const card = document.createElement('div'); card.className = 'node';

      card.innerHTML = `
      <div class="title">${node.name}</div>
      <div class="subtitle">${node.title ?? ''}</div>
      <div class="chip">كود: ${node.id}</div>
      <div class="ctrl">–</div>`;

      const ctrl = card.querySelector('.ctrl');
      ctrl.onclick = (e) => { e.stopPropagation(); toggle(wrapper); };

      wrapper.appendChild(card);

      if (node.employees.length) {
        const list = document.createElement('div'); list.className = 'hrEmployees';
        node.employees.forEach(emp => {
          const e = document.createElement('div'); e.className = 'hrEmployees';
          e.textContent = `${emp.name} (${emp.code}) - ${emp.title}`;
          e.onclick = () => loadJobData(emp.code);
          list.appendChild(e);
        });
        wrapper.appendChild(list);
      }

      if (node.children.length) {
        const connector = document.createElement('div'); connector.className = 'connector'; wrapper.appendChild(connector);
        const children = document.createElement('div'); children.className = 'children';
        node.children.forEach(ch => children.appendChild(createBranch(ch)));
        wrapper.appendChild(children);
      }
      return wrapper;
    }

    function toggle(branch) {
      const children = branch.querySelector('.children');
      const ctrl = branch.querySelector('.ctrl');
      if (!children) return;
      if (children.classList.contains('hidden')) {
        children.classList.remove('hidden'); ctrl.textContent = '–';
      } else {
        children.classList.add('hidden'); ctrl.textContent = '+';
      }
    }

    function refreshDeptLists() {
      parentDept.innerHTML = '<option value="">-- رئيسي --</option>';
      empDept.innerHTML = '<option value="">اختر قسم</option>';
      jobDept.innerHTML = '<option value="">اختر قسم</option>'; // ✅ إضافة

      function addOptions(node, prefix = "") {
        if (node.id !== "ROOT") {
          const opt1 = new Option(prefix + node.name, node.id);
          parentDept.add(opt1.cloneNode(true));
          const opt2 = new Option(prefix + node.name, node.id);
          empDept.add(opt2.cloneNode(true));
          const opt3 = new Option(prefix + node.name, node.id);
          jobDept.add(opt3.cloneNode(true));
        }
        node.children.forEach(ch => addOptions(ch, prefix + "- "));
      }
      addOptions(orgData);
    }

    function findDept(id, node) {
      if (node.id === id) return node;
      for (const ch of node.children) { const f = findDept(id, ch); if (f) return f; }
      return null;
    }

    deptForm.onsubmit = async e => {
      e.preventDefault();
      const code = deptForm.deptCode.value.trim();
      const name = deptForm.deptName.value.trim();
      const parent = deptForm.parentDept.value;
      if (!code || !name) return alert("❌ أدخل كود واسم القسم");

      const snap = await get(ref(database, "departments/" + code));
      if (snap.exists()) {
        return alert("⚠️ هذا الكود مستخدم من قبل");
      }
      const newDept = { id: code, name, dept: name, title: "", children: [], employees: [] };
      if (parent) { findDept(parent, orgData).children.push(newDept); }
      else { orgData.children.push(newDept); }
      set(ref(database, "departments/" + code), { code, name, parent: parent || "ROOT" });
      alert("✅ تم إضافة القسم");

      deptForm.reset(); renderTree();
    };

    empForm.onsubmit = async e => {
      e.preventDefault();
      let code = empForm.empCode.value.trim();
      let name = empForm.empName.value.trim();
      const title = empForm.empTitle.value.trim();
      const deptId = empForm.empDept.value;
      if (!deptId) return alert("اختر القسم");

      if (!code) {
        alert("❌ لازم تدخل كود الموظف يدويًا!");
        return;
      }

      const hrSnap = await get(ref(database, "hrEmployees/" + code));
      if (hrSnap.exists()) {
        name = hrSnap.val().fullName || name;
      }

      findDept(deptId, orgData).employees.push({ code, name, title });
      set(ref(database, "employees/" + code), { code, name, title, deptId });
      alert("✅ تم إضافة الموظف");

      empForm.reset(); renderTree();
    };

    async function listenData() {
      const dbRef = ref(database);
      onValue(dbRef, (snapshot) => {
        orgData = { id: "ROOT", name: "الشركة", title: "المؤسسة", dept: "الرئيسي", children: [], employees: [] };
        if (snapshot.exists()) {
          const data = snapshot.val();
          if (data.departments) {
            for (const code in data.departments) {
              const dept = data.departments[code];
              const newDept = { id: dept.code, name: dept.name, title: "", dept: dept.name, children: [], employees: [] };
              if (dept.parent && dept.parent !== "ROOT") {
                findDept(dept.parent, orgData)?.children.push(newDept);
              } else {
                orgData.children.push(newDept);
              }
            }
          }
          if (data.employees) {
            for (const code in data.employees) {
              const emp = data.employees[code];
              findDept(emp.deptId, orgData)?.employees.push({ code: emp.code, name: emp.name, title: emp.title });
            }
          }
        }
        renderTree();
      });
    }

    listenData();


    document.getElementById("empCode").addEventListener("blur", async function () {
      const code = this.value.trim();
      if (!code) return;

      try {
        const snap = await get(ref(database, "hrEmployees/" + code));
        if (snap.exists()) {
          const emp = snap.val();
          document.getElementById("empName").value = emp.fullName || "";
          if (emp.job && emp.job.jobTitle) {
            document.getElementById("empTitle").value = emp.job.jobTitle;
          } else {
            document.getElementById("empTitle").value = "";
          }
        } else {
          document.getElementById("empName").value = "";
          document.getElementById("empTitle").value = "";
        }
      } catch (err) {
        console.error("❌ خطأ في جلب بيانات الموظف:", err);
      }
    });

    window.generateOrgChartPDF = async function () {
      const { jsPDF } = window.jspdf;

      // العنصر بتاع الشجرة
      const chart = document.getElementById("tree");

      // ناخد لقطة للشجرة
      const canvas = await html2canvas(chart, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");

      // إعداد الـ PDF
      const pdf = new jsPDF("p", "mm", "a4");

      // أبعاد الصفحة
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // أبعاد الصورة
      const imgWidth = pageWidth - 20;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let position = 20;

      // نضيف عنوان أعلى الصفحة
      pdf.setFontSize(18);
      pdf.text("📑 الهيكل الوظيفي", pageWidth / 2, 10, { align: "center" });

      // لو الصورة أطول من صفحة
      if (imgHeight > pageHeight - 30) {
        let heightLeft = imgHeight;
        let y = position;

        while (heightLeft > 0) {
          pdf.addImage(imgData, "PNG", 10, y, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          if (heightLeft > 0) {
            pdf.addPage();
            y = 10;
          }
        }
      } else {
        pdf.addImage(imgData, "PNG", 10, position, imgWidth, imgHeight);
      }

      // حفظ الملف
      pdf.save("الهيكل_الوظيفي.pdf");
    }
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////// تعرفات اساسيه ///////////////////////////////////////////////////////////
    ///////////////////////////////////////////////////////////////////////////////////////////////////////////
    const companiesRef2 = ref(database, 'companies');

    function loadCompaniesList() {
      const companySelect = document.getElementById("companySelect3");
      onValue(companiesRef2, (snapshot) => {
        companySelect2.innerHTML = `<option value="">-- اختر الشركة --</option>`;
        snapshot.forEach((childSnapshot) => {
          const data = childSnapshot.val();
          const option = document.createElement("option");
          option.value = data.code;
          option.textContent = data.name;
          companySelect2.appendChild(option);
        });
      });
    }

    window.loadBasicDefinitions = function () {
      const companyCode = document.getElementById("companySelect2").value;
      if (!companyCode) return;

      const basicDefinitionsRef = ref(database, "basicDefinitions/" + companyCode);
      get(basicDefinitionsRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          document.getElementById("start_time").value = data.start_time || "08:00";
          document.getElementById("end_time").value = data.end_time || "16:00";
          document.getElementById("max_in").value = data.max_in || 10;
          document.getElementById("max_out").value = data.max_out || 10;
          document.getElementById("break_time").value = data.break_time || 60;
          document.getElementById("overtime").value = data.overtime || 60;
        } else {
          document.getElementById("start_time").value = "08:00";
          document.getElementById("end_time").value = "16:00";
          document.getElementById("max_in").value = 10;
          document.getElementById("max_out").value = 10;
          document.getElementById("break_time").value = 60;
          document.getElementById("overtime").value = 60;
        }
      });
    };

    window.saveBasicDefinitions = function () {
      const companyCode = document.getElementById("companySelect2").value;
      if (!companyCode) {
        alert("⚠️ يرجى اختيار الشركة أولاً");
        return;
      }

      const basicDefinitionsRef = ref(database, "basicDefinitions/" + companyCode);

      const data = {
        companyCode,
        start_time: document.getElementById("start_time").value,
        end_time: document.getElementById("end_time").value,
        max_in: document.getElementById("max_in").value,
        max_out: document.getElementById("max_out").value,
        break_time: document.getElementById("break_time").value,
        overtime: document.getElementById("overtime").value,
      };

      set(basicDefinitionsRef, data)
        .then(() => {
          alert("✅ تم حفظ التعريفات الأساسية للشركة");
        })
        .catch((error) => {
          alert("❌ خطأ أثناء الحفظ: " + error);
        });
    };

    loadCompaniesList();

    /////////////////////////////////////////////////////////////////////////////////////////////////////////
    ///////////////////////////////// لاصول ولاهلاك //////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////////////
    const $ = (id) => document.getElementById(id);
    const assetIdEl = $("assetId");
    const assetCodeEl = $("assetCode");
    const descriptionEl = $("description");
    const assetCostCenterEl = $("assetCostCenter");
    const deviceTypeEl = $("deviceType");
    const linkedDeviceEl = $("linkedDevice");
    const costEl = $("cost");
    const residualEl = $("residual");
    const purchaseDateEl = $("purchaseDate");
    const usefulLifeEl = $("usefulLife");
    const depMethodEl = $("depMethod");
    const depRateEl = $("depRate");
    const outAccumEl = $("outAccum");
    const outNBVEl = $("outNBV");
    const outAsOfEl = $("outAsOf");
    const filterCostCenterEl = $("filterCostCenter");
    const filterDeviceTypeEl = $("filterDeviceType");
    const searchAssetEl = $("searchAsset");
    const linkedHintEl = $("linkedHint");

    function refreshAssetPermissions() {
      return {
        AssetSave: localStorage.getItem('AssetSave') === 'true',
        AssetEdit: localStorage.getItem('AssetEdit') === 'true'
      };
    }

    async function loadCostCentersZ() {
      const snap = await get(ref(database, "costCenters"));

      assetCostCenterEl.innerHTML = '<option value="">— اختر —</option>';
      filterCostCenterEl.innerHTML = '<option value="">كل مراكز التكلفة</option>';

      if (snap.exists()) {
        const arr = [];
        snap.forEach(ch => {
          const val = ch.val();
          arr.push({ code: ch.key, ...val }); // نضيف المفتاح + البيانات
        });

        // ترتيب بالأكواد تصاعدي
        arr.sort((a, b) => Number(a.code) - Number(b.code));

        for (const c of arr) {
          const label = `${c.code} - ${c.name}`;
          assetCostCenterEl.insertAdjacentHTML("beforeend", `<option value="${c.code}">${label}</option>`);
          filterCostCenterEl.insertAdjacentHTML("beforeend", `<option value="${c.code}">${label}</option>`);
        }
      }
    }
    async function getUsedLinkedCodes() {
      const snap = await get(ref(database, "fixedAssets"));
      if (!snap.exists()) return new Set();
      const used = new Set();
      snap.forEach(ch => {
        const v = ch.val();
        if (v.linkedCode) {
          used.add(String(v.linkedCode).trim()); // 🔑 نخزنها كنص بدون مسافات
        }
      });
      return used;
    }

    async function loadLinkedDevicesFor(type, currentLinked = "") {
      linkedDeviceEl.innerHTML = '<option value="">— لا يوجد —</option>';
      let path = null, label = (v) => v;

      if (type === "كمبيوتر") {
        path = "computers";
        label = v => `${v.pcNum || ""} - ${v.deviceModel || ""}`;
      } else if (type === "شاشة") {
        path = "screens";
        label = v => `${v.documentNumberScreen || ""} - ${v.screenType || ""}`;
      } else if (type === "طابعة") {
        path = "printers";
        label = v => `${v.doc_number || ""} - ${v.printer_model || ""}`;
      } else {
        linkedHintEl.textContent = "اختر 'أخرى' في حال عدم وجود كيان مرتبط.";
        return;
      }

      const snap = await get(ref(database, path));
      if (!snap.exists()) return;

      const used = await getUsedLinkedCodes();

      snap.forEach(ch => {
        const v = ch.val();
        const code = String(
          v.pcNum ?? v.documentNumberScreen ?? v.doc_number ?? v.code ?? ch.key
        ).trim();

        // ✅ منع ظهور الأجهزة المستخدمة إلا لو هو الحالي
        if (used.has(code) && code !== currentLinked) {
          return;
        }

        linkedDeviceEl.insertAdjacentHTML(
          "beforeend",
          `<option value="${code}">${label(v)}</option>`
        );
      });

      if (currentLinked) linkedDeviceEl.value = currentLinked;
    }

    async function loadDeviceTypes() {
      const types = ["كمبيوتر", "شاشة", "طابعة", "كاميرا", "راوتر", "خط هاتف", "أخرى"];
      deviceTypeEl.innerHTML = '<option value="">— اختر نوع الجهاز —</option>';
      types.forEach(type => {
        deviceTypeEl.insertAdjacentHTML("beforeend", `<option value="${type}">${type}</option>`);
      });
    }
    // ====== تحميل البيانات الأولية عند فتح الصفحة ======
    await loadCostCentersZ();
    await loadDeviceTypes();
    await loadLinkedDevicesFor("أخرى");
    // ====== تحميل الأصول عند البحث أو التصفية ======
    deviceTypeEl.addEventListener('change', (e) => {
      const type = e.target.value.trim();
      loadLinkedDevicesFor(type);
    });


    // ====== توليد كود أصل يبدأ من FA-100 ======
    async function generateAssetCode() {
      const snap = await get(ref(database, "fixedAssets"));
      let max = 99; // حتى يكون أول كود FA-100
      if (snap.exists()) {
        snap.forEach(ch => {
          const v = ch.val();
          // يدعم صيغ FA-100 أو 100 (نأخذ الرقم فقط)
          const num = parseInt(String(v.assetCode || "").replace(/^\D+/, ''));
          if (!isNaN(num) && num > max) max = num;
        });
      }
      return `FA-${max + 1}`;
    }

    // ====== حساب نسبة القسط الثابت تلقائيًا ======
    function updateRate() {
      const years = parseFloat(usefulLifeEl.value);
      if (!isNaN(years) && years > 0) {
        depRateEl.value = (100 / years).toFixed(2);
      } else {
        depRateEl.value = "";
      }
    }
    usefulLifeEl.addEventListener('input', updateRate);

    // مثال قابل للاستخدام: 'completed' | 'includePartialAsFull' | 'prorated'
    const prorationMode = 'prorated';

    function parseDateOnly(dateStr) {
      if (!dateStr) return null;
      const [y, m, d] = dateStr.split('-').map(Number);
      if (!y || isNaN(m) || isNaN(d)) return null;
      return new Date(y, m - 1, d); // يمنع مشاكل الـ timezone
    }

    function daysInMonth(date) {
      return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    }

    function monthsElapsedWhole(start, end) {
      // عدد الأشهر المكتملة (بدون جزئيات)
      if (end < start) return 0;
      return (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
    }

    function monthsWithFraction(start, end) {
      // عدد الأشهر مع جزء الشهر كنسبة (0..1)
      if (end < start) return 0;
      let months = monthsElapsedWhole(start, end);
      let anchor = new Date(start.getFullYear(), start.getMonth() + months, start.getDate());
      let diffDays = Math.floor((end - anchor) / (1000 * 60 * 60 * 24));
      if (diffDays < 0) {
        months -= 1;
        anchor = new Date(start.getFullYear(), start.getMonth() + months, start.getDate());
        diffDays = Math.floor((end - anchor) / (1000 * 60 * 60 * 24));
      }
      const dim = daysInMonth(anchor);
      const fraction = Math.max(0, Math.min(1, diffDays / dim));
      return months + fraction;
    }

    function formatDateLocal(d) {
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function round2(v) {
      return Math.round((v + Number.EPSILON) * 100) / 100;
    }

    function calcDepPreview() {
      const cost = parseFloat(costEl.value) || 0;
      const residualInput = parseFloat(residualEl.value);
      const residual = isNaN(residualInput) ? 0 : Math.min(residualInput, cost);
      const lifeYears = parseFloat(usefulLifeEl.value) || 0;
      const method = depMethodEl.value;
      const start = purchaseDateEl.value ? parseDateOnly(purchaseDateEl.value) : null;
      const today = new Date();

      if (!cost || !lifeYears || !start || method !== 'straight-line') {
        outAccumEl.textContent = '0.00';
        outNBVEl.textContent = cost.toFixed(2);
        outAsOfEl.textContent = '—';
        return { accum: 0, nbv: cost, asOf: null };
      }

      // حساب الأشهر طبق الوضع المختار
      const wholeMonths = monthsElapsedWhole(start, today);
      let monthsCount;
      if (prorationMode === 'completed') {
        monthsCount = Math.max(0, wholeMonths);
      } else if (prorationMode === 'includePartialAsFull') {
        // إذا فيه بقايا أيام من الشهر الحالي نعتبره شهرًا كاملاً
        const anchor = new Date(start.getFullYear(), start.getMonth() + wholeMonths, start.getDate());
        const hasPartial = (today - anchor) > 0;
        monthsCount = Math.max(0, wholeMonths + (hasPartial ? 1 : 0));
      } else { // 'prorated'
        monthsCount = monthsWithFraction(start, today);
      }

      const depreciableBase = cost - residual;
      const totalMonthsLife = lifeYears * 12;
      if (totalMonthsLife <= 0) {
        outAccumEl.textContent = '0.00';
        outNBVEl.textContent = cost.toFixed(2);
        outAsOfEl.textContent = formatDateLocal(today);
        return { accum: 0, nbv: cost, asOf: formatDateLocal(today) };
      }

      const monthly = depreciableBase / totalMonthsLife;
      let accum = monthly * monthsCount;
      accum = Math.min(depreciableBase, Math.max(0, round2(accum)));
      const nbv = Math.max(residual, round2(cost - accum));

      outAccumEl.textContent = accum.toFixed(2);
      outNBVEl.textContent = nbv.toFixed(2);
      outAsOfEl.textContent = formatDateLocal(today);

      return { accum, nbv, asOf: formatDateLocal(today) };
    }

    // ====== حفظ / تحديث أصل ======
    async function saveAsset() {
      const { AssetSave, AssetEdit } = refreshAssetPermissions();

      const editingId = assetIdEl.value;
      if (!editingId && !AssetSave) return alert("❌ ليس لديك صلاحية إضافة أصل جديد.");
      if (editingId && !AssetEdit) return alert("❌ ليس لديك صلاحية تعديل أصل.");

      // تحقق أساسي
      // تحقق أساسي
      if (!descriptionEl.value.trim() || !assetCostCenterEl.value || !purchaseDateEl.value || !usefulLifeEl.value || !costEl.value) {
        return alert("⚠️ يرجى ملء الحقول الأساسية (الوصف، مركز التكلفة، التكلفة، تاريخ الشراء، العمر الإنتاجي).");
      }

      // ✅ تحقق من أن الجهاز المرتبط تم اختياره
      if (!linkedDeviceEl.value) {
        return alert("⚠️ يجب اختيار جهاز مرتبط قبل الحفظ.");
      }
      if (!deviceTypeEl.value) {
        return alert("⚠️ يرجى اختيار نوع الجهاز.");
      }
      if (!purchaseDateEl.value) {
        return alert("⚠️ يرجى إدخال تاريخ الشراء.");
      }
      if (!usefulLifeEl.value || isNaN(parseFloat(usefulLifeEl.value)) || parseFloat(usefulLifeEl.value) <= 0) {
        return alert("⚠️ يرجى إدخال العمر الإنتاجي بشكل صحيح.");
      }
      if (!costEl.value || isNaN(parseFloat(costEl.value)) || parseFloat(costEl.value) <= 0) {
        return alert("⚠️ يرجى إدخال التكلفة بشكل صحيح.");
      }

      if (!depMethodEl.value) {
        return alert("⚠️ يرجى اختيار طريقة الإهلاك.");
      }
      if (!depRateEl.value || isNaN(parseFloat(depRateEl.value)) || parseFloat(depRateEl.value) <= 0) {
        return alert("⚠️ يرجى إدخال نسبة الإهلاك بشكل صحيح.");
      }
      if (depMethodEl.value === "straight-line" && (!usefulLifeEl.value || isNaN(parseFloat(usefulLifeEl.value)) || parseFloat(usefulLifeEl.value) <= 0)) {
        return alert("⚠️ يرجى إدخال العمر الإنتاجي بشكل صحيح.");
      }
      if (depMethodEl.value === "declining-balance" && (!depRateEl.value || isNaN(parseFloat(depRateEl.value)) || parseFloat(depRateEl.value) <= 0)) {
        return alert("⚠️ يرجى إدخال نسبة الإهلاك بشكل صحيح.");
      }

      // تحقق من الجهاز المرتبط (ما يتكرر)
      const linked = linkedDeviceEl.value || "";
      if (linked) {
        const used = await getUsedLinkedCodes();
        if (used.has(linked) && !editingId) {
          return alert("⚠️ هذا الجهاز مرتبط بالفعل بأصل آخر ولا يمكن ربطه مرة ثانية.");
        }
        if (editingId) {
          const snap = await get(ref(database, "fixedAssets"));
          let linkedByOther = false;
          snap.forEach(ch => {
            if (ch.key !== editingId && ch.val().linkedCode === linked) {
              linkedByOther = true;
            }
          });
          if (linkedByOther) {
            return alert("⚠️ هذا الجهاز مرتبط بالفعل بأصل آخر ولا يمكن ربطه مرة ثانية.");
          }
        }
      }

      // حساب الكود
      let code = assetCodeEl.value.trim();
      if (!code) code = await generateAssetCode();

      // معاينة/حساب الإهلاك الآن
      const { accum, nbv, asOf } = calcDepPreview();

      const data = {
        assetCode: code,
        description: descriptionEl.value.trim(),
        costCenter: assetCostCenterEl.value,
        deviceType: deviceTypeEl.value || "أخرى",
        linkedCode: linked,
        cost: parseFloat(costEl.value) || 0,
        residual: parseFloat(residualEl.value) || 0,
        purchaseDate: purchaseDateEl.value,
        usefulLife: parseFloat(usefulLifeEl.value) || 0,
        depreciationMethod: depMethodEl.value,
        depreciationRate: parseFloat(depRateEl.value) || (100 / (parseFloat(usefulLifeEl.value) || 1)),
        accumulatedDep: Number(accum.toFixed(2)),
        netBookValue: Number(nbv.toFixed(2)),
        lastCalcDate: asOf || null,
        deleted: false,
        updatedAt: new Date().toISOString()
      };

      if (editingId) {
        await update(ref(database, "fixedAssets/" + editingId), data);
        alert("✅ تم التحديث");
      } else {
        await set(push(ref(database, "fixedAssets")), data);
        alert("✅ تم الحفظ");
      }

      clearAssetForm();
      await loadAssets();

      // ✅ بعد الحفظ → إعادة تحميل الأجهزة حسب النوع الحالي
      if (deviceTypeEl.value) {
        await loadLinkedDevicesFor(deviceTypeEl.value);
      }
    }

    $("btnSave").addEventListener('click', saveAsset);

    // ====== تحميل وعرض الأصول ======
    async function loadAssets() {
      const snap = await get(ref(database, "fixedAssets"));
      const body = $("assetsBody");
      body.innerHTML = "";
      const items = [];
      if (snap.exists()) {
        snap.forEach(ch => {
          const v = ch.val();
          if (!v.deleted) items.push({ id: ch.key, ...v });
        });
      }

      const qText = (searchAssetEl.value || "").toLowerCase().trim();
      const fCC = filterCostCenterEl.value;
      const fType = filterDeviceTypeEl.value;

      const filtered = items.filter(x => {
        const okText = !qText || (String(x.assetCode).toLowerCase().includes(qText) || String(x.description).toLowerCase().includes(qText));
        const okCC = !fCC || x.costCenter == fCC;
        const okType = !fType || x.deviceType == fType;
        return okText && okCC && okType;
      });

      filtered.sort((a, b) => {
        const na = parseInt(String(a.assetCode).replace(/^\D+/, ''));
        const nb = parseInt(String(b.assetCode).replace(/^\D+/, ''));
        return na - nb;
      });

      for (const x of filtered) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${x.assetCode || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${x.description || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${x.deviceType || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${x.costCenter || ""}</td>
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${(x.cost ?? 0).toFixed ? x.cost.toFixed(2) : Number(x.cost || 0).toFixed(2)}</td>
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${(x.accumulatedDep ?? 0).toFixed ? x.accumulatedDep.toFixed(2) : Number(x.accumulatedDep || 0).toFixed(2)}</td>
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${(x.netBookValue ?? 0).toFixed ? x.netBookValue.toFixed(2) : Number(x.netBookValue || 0).toFixed(2)}</td>
        <td style="padding:10px;border-bottom:1px solid #f2f2f2">${x.depreciationRate || ""}</td>
      `;
        body.appendChild(tr);
      }

    }

    // ====== تحرير سجل للأصل ======
    async function editAsset(id) {
      const snap = await get(ref(database, "fixedAssets/" + id));
      if (!snap.exists()) return alert("❌ الأصل غير موجود");
      const v = snap.val();

      assetIdEl.value = id;
      assetCodeEl.value = v.assetCode || "";
      descriptionEl.value = v.description || "";
      assetCostCenterEl.value = v.costCenter || "";
      deviceTypeEl.value = v.deviceType || "";
      await loadLinkedDevicesFor(deviceTypeEl.value || "");
      linkedDeviceEl.value = v.linkedCode || "";
      costEl.value = v.cost ?? "";
      residualEl.value = v.residual ?? "";
      purchaseDateEl.value = v.purchaseDate || "";
      usefulLifeEl.value = v.usefulLife ?? "";
      depMethodEl.value = v.depreciationMethod || "straight-line";
      updateRate();
      depRateEl.value = v.depreciationRate ?? depRateEl.value;

      outAccumEl.textContent = (v.accumulatedDep ?? 0).toFixed ? v.accumulatedDep.toFixed(2) : Number(v.accumulatedDep || 0).toFixed(2);
      outNBVEl.textContent = (v.netBookValue ?? 0).toFixed ? v.netBookValue.toFixed(2) : Number(v.netBookValue || 0).toFixed(2);
      outAsOfEl.textContent = v.lastCalcDate || "—";
    }

    // ====== حذف (ناعم) ======
    async function deleteAsset(id) {
      const ok = confirm("هل تريد حذف الأصل؟ سيتم وسمه كمحذوف.");
      if (!ok) return;
      await update(ref(database, "fixedAssets/" + id), { deleted: true, deletedAt: new Date().toISOString() });
      await loadAssets();
    }

    // ====== أحداث الفلاتر/البحث ======
    $("btnRefreshAssets").addEventListener('click', loadAssets);
    filterCostCenterEl.addEventListener('change', loadAssets);
    filterDeviceTypeEl.addEventListener('change', loadAssets);
    searchAssetEl.addEventListener('input', () => {
      // بحث فوري
      loadAssets();
    });

    // ====== تهيئة الصفحة ======
    async function init() {
      updateRate();
      await loadCostCentersZ();
      await loadAssets();

      // توليد كود تلقائي عند فتح النموذج لأول مرة/عند التفريغ
      const code = await generateAssetCode();
      assetCodeEl.value = code;
    }

    // إنشاء Toast message
    function showToast(message, type = "info", duration = 3000) {
      let toast = document.createElement("div");
      toast.textContent = message;
      toast.style.position = "fixed";
      toast.style.bottom = "20px";
      toast.style.left = "50%";
      toast.style.transform = "translateX(-50%)";
      toast.style.padding = "10px 20px";
      toast.style.borderRadius = "8px";
      toast.style.color = "#fff";
      toast.style.fontWeight = "bold";
      toast.style.zIndex = 9999;
      toast.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";

      if (type === "success") toast.style.backgroundColor = "#4CAF50";
      else if (type === "error") toast.style.backgroundColor = "#f44336";
      else if (type === "warning") toast.style.backgroundColor = "#ff9800";
      else toast.style.backgroundColor = "#2196F3";

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.transition = "opacity 0.5s";
        toast.style.opacity = 0;
        setTimeout(() => toast.remove(), 500);
      }, duration);
    }

    $("btnCalc").addEventListener('click', calcDepPreview);

    // ====== تفريغ النموذج ======
    function clearAssetForm() {
      assetIdEl.value = "";
      assetCodeEl.value = "";
      descriptionEl.value = "";
      assetCostCenterEl.value = "";
      deviceTypeEl.value = "";
      linkedDeviceEl.innerHTML = '<option value="">— لا يوجد —</option>';
      costEl.value = "";
      residualEl.value = "";
      purchaseDateEl.value = "";
      usefulLifeEl.value = "";
      depRateEl.value = "";
      outAccumEl.textContent = "0.00";
      outNBVEl.textContent = "0.00";
      outAsOfEl.textContent = "—";
    }
    $("btnClear").addEventListener('click', clearAssetForm);
    //////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////// الحضور ولانصراف /////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
/* ===================== عناصر الواجهة ===================== */
const bigClock = document.getElementById('bigClock');
const bigDate = document.getElementById('bigDate');
const manualCode = document.getElementById('manualCode');
const btnIn = document.getElementById('btnIn');
const btnOut = document.getElementById('btnOut');
const empPreview = document.getElementById('employeePreview');
const empPhoto = document.getElementById('empPhoto');
const empName = document.getElementById('empName');
const empJob = document.getElementById('empJob');
const empStatusLine = document.getElementById('empStatusLine');
const recentList = document.getElementById('recentList');
const companySelect = document.getElementById('companySelect');
const reportBody = document.getElementById('reportBody');
const todayLabel = document.getElementById('todayLabel');
const statPresent = document.getElementById('statPresent');
const statLate = document.getElementById('statLate');
const statOut = document.getElementById('statOut');
const statEarly = document.getElementById('statEarly');
const exportCSV = document.getElementById('exportCSV');
const flash = document.getElementById('flash');
const qrCanvas = document.getElementById('qrCanvas');

const ctx1 = document.getElementById('chart').getContext('2d');
let chart = new Chart(ctx1, {
  type: 'bar',
  data: { labels: [], datasets: [{ label: 'حضور يومي', data: [], borderRadius: 6 }] },
  options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
});

function showFlash(msg, timeout = 2200) { flash.innerText = msg; flash.classList.add('show'); setTimeout(() => flash.classList.remove('show'), timeout); }
function nowISODate() { return new Date().toISOString().split('T')[0]; }
function nowTime24() { return new Date().toLocaleTimeString('en-GB', { hour12: false }); }
function parseTime(t) { if (!t) return null; const p = t.trim().split(':'); if (p.length >= 2) { const hh = +p[0] || 0, mm = +p[1] || 0, ss = +p[2] || 0; return hh * 3600 + mm * 60 + ss; } return null; }
function compareTimeStrings(a, b) { const pa = parseTime(a), pb = parseTime(b); return pa - pb; }
function escapeHtml(s) { if (!s) return ''; return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }

function tickClock() {
  const d = new Date();
  bigClock.textContent = d.toLocaleTimeString('ar-EG', { hour12: false });
  bigDate.textContent = d.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
}
setInterval(tickClock, 1000); tickClock();

/* ===================== تحميل الشركات ===================== */
onValue(ref(database, 'companies'), snap => {
  companySelect.innerHTML = '<option value="">-- اختر الشركة --</option>';
  if (!snap.exists()) return;
  snap.forEach(ch => {
    const d = ch.val();
    const opt = document.createElement('option');
    opt.value = d.code || ch.key;
    opt.textContent = d.name || d.code || ch.key;
    companySelect.appendChild(opt);
  });
});

/* ===================== أوقات الشركة ===================== */
async function getCompanyTimes(companyCode) {
  if (!companyCode) return { start: '08:00:00', end: '17:00:00' };
  const s = await get(ref(database, `basicDefinitions/${companyCode}`));
  if (!s.exists()) return { start: '08:00:00', end: '17:00:00' };
  const v = s.val();
  const sT = (v.start_time || '08:00'); const eT = (v.end_time || '17:00');
  return { start: sT.length <= 5 && sT.includes(':') ? sT + ':00' : sT, end: eT.length <= 5 && eT.includes(':') ? eT + ':00' : eT };
}

/* ===================== تحميل بيانات الموظف ===================== */
/* ====== loadEmployee: add image fallback (data-SVG) ====== */
async function loadEmployee(code) {
  if (!code) { empPreview.style.display = 'none'; return; }
  const s = await get(ref(database, `hrEmployees/${code}`));
  const defaultSvg = `data:image/svg+xml;utf8,` + encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'>
       <rect width='100%' height='100%' fill='#e9e9e9'/>
       <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='18' fill='#777'>EMP</text>
     </svg>`
  );

  if (s.exists()) {
    const emp = s.val();
    empPreview.style.display = 'flex';
    empPhoto.src = emp.photoURL || emp.photo || defaultSvg;
    empPhoto.onerror = () => { empPhoto.src = defaultSvg; };
    empName.textContent = emp.fullName || emp.name || '---';
    empJob.textContent = (emp.job?.jobTitle && emp.job?.dept) ? `${emp.job.jobTitle} • ${emp.job.dept}` : (emp.job?.jobTitle || emp.job?.dept || 'غير محدد');
  } else {
    empPreview.style.display = 'flex';
    empPhoto.src = defaultSvg;
    empName.textContent = `كود: ${code}`;
    empJob.textContent = 'لم يتم العثور على بيانات';
  }
}
/* ===================== دالة Haversine للمسافة (بالمتر) ===================== */
function getDistanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000; // نصف قطر الأرض بالمتر
  const toRad = v => v * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

/* ===================== تسجيل الحضور (محدث مع تخزين distance/accuracy وتصوير على الخريطة) ===================== */
async function saveAttendance(code, companyCode, type) {
  if (!code) return showFlash(' ادخل كود الموظف');
  if (!companyCode) return showFlash(' اختر الشركة');

  const empSnap = await get(ref(database, `hrEmployees/${code}`));
  if (!empSnap.exists()) {
    showFlash(' كود الموظف غير صحيح');
    empPreview.style.display = 'none';
    return;
  }

  const emp = empSnap.val();
  if (!emp.regionCode) {
    return showFlash(' ❌ الموظف غير مربوط بأي منطقة');
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const latNum = pos.coords.latitude;
    const lngNum = pos.coords.longitude;
    const latStr = latNum.toFixed(6);
    const lngStr = lngNum.toFixed(6);
    const accuracy = typeof pos.coords.accuracy === 'number' ? pos.coords.accuracy : null;

    console.log(`GPS: lat=${latStr}, lng=${lngStr}, accuracy=${accuracy}`);

    await loadEmployee(code);

    const regSnap = await get(ref(database, `Region/${emp.regionCode}`));
    if (!regSnap.exists()) return showFlash(' ❌ لم يتم العثور على بيانات المنطقة');
    const region = regSnap.val();

    const regionLat = parseFloat(region.Lat);
    const regionLng = parseFloat(region.Lng);
    let regionRadius = parseFloat(region.Radius);

    if (isNaN(regionLat) || isNaN(regionLng) || isNaN(regionRadius)) {
      console.error('Invalid region coords or radius', region);
      return showFlash(' ❌ بيانات المنطقة غير صحيحة');
    }
    if (regionRadius <= 0) regionRadius = 50;

    // حساب المسافة
    const distance = getDistanceMeters(latNum, lngNum, regionLat, regionLng);
    console.log('Distance to region center (m):', distance);

    // Visualization debug: device marker, accuracy circle, region circle, line
    try {
      if (window.debugLayer) { try { map.removeLayer(window.debugLayer); } catch(e){} window.debugLayer = null; }
      const devMarker = L.marker([latNum, lngNum]).bindPopup(`جهاز: ${latStr}, ${lngStr}<br>accuracy: ${accuracy ? Math.round(accuracy)+' م' : 'N/A'}`);
      const accuracyCircle = (accuracy && !isNaN(accuracy)) ? L.circle([latNum, lngNum], { radius: accuracy, color: 'red', fillOpacity: 0.05 }) : null;
      const regMarker = L.marker([regionLat, regionLng]).bindPopup(`منطقة: ${regionLat.toFixed(6)}, ${regionLng.toFixed(6)}<br>نصف القطر: ${Math.round(regionRadius)} م`);
      const regCircle = L.circle([regionLat, regionLng], { radius: regionRadius, color: 'blue', fillOpacity: 0.08 });
      const line = L.polyline([[latNum, lngNum], [regionLat, regionLng]]);
      const layers = [regCircle, regMarker, line, devMarker];
      if (accuracyCircle) layers.push(accuracyCircle);
      window.debugLayer = L.layerGroup(layers).addTo(map);
      map.fitBounds(line.getBounds().pad(0.3), { maxZoom: 15 });
      showFlash(`المسافة: ${Math.round(distance)} م — دقة GPS: ${accuracy ? Math.round(accuracy)+' م' : 'N/A'}`, 4000);
    } catch (e) { console.error('visualize error', e); }

    // قواعد قبول الموقع:
    // 1) إذا الدقة كبيرة جداً (مثلاً > 500 م) نعطي تحذير ونطلب إعادة المحاولة
    // 2) يمكن السماح بالـ override إذا أردت (زر تأكيد)
    const accuracyThresholdWarn = 300; // لو أكبر من هالقيمة نحذّر
    const toleranceMeters = 15; // سماحية صغيرة

    if (accuracy && accuracy > accuracyThresholdWarn) {
      const ok = confirm(`دقة GPS ضعيفة (${Math.round(accuracy)} م). هل تريد المحاولة مرة أخرى بالخروج لمكان مفتوح؟ اضغط موافق لإعادة المحاولة، إلغاء للاستمرار مع هذا الموقع.`);
      if (!ok) {
        // المستخدم اختار الاستمرار — نستمر لكن نظهر تحذيراً واضحاً
        showFlash('تراجع: تم المتابعة مع دقة ضعيفة — تحقق يدوياً إذا لزم الأمر', 4000);
      } else {
        // طلب إعادة المحاولة: نعيد محاولة الحصول على الموقع (recursive call)
        return saveAttendance(code, companyCode, type);
      }
    }

    // حالة عدم التطابق (خارج المحيط)
    if (distance > regionRadius + toleranceMeters) {
      // إذا الدقة أكبر من المسافة أو كبيرة جداً، نعرض رسالة مختلفة توضح سبب المحتمل
      if (accuracy && accuracy > Math.max(regionRadius, distance)) {
        return showFlash(`❌ خارج المحيط — المسافة ${Math.round(distance)} م (نصف القطر ${Math.round(regionRadius)} م). ملاحظة: دقة الموقع كبيرة (${Math.round(accuracy)} م) — الموقع قد يكون غير دقيق.`);
      }
      // نعرض خيار تجاوز (للمشرف)
      const override = confirm(`الموقع يبعد ${Math.round(distance)} م عن مركز المنطقة (نصف القطر ${Math.round(regionRadius)} م). اضغط موافق لتسجيل الحضور يدوياً كمشرف، إلغاء للرفض.`);
      if (!override) return showFlash(` ❌ خارج المحيط — المسافة ${Math.round(distance)} م`);
      // لو تجاوز المشرف، نتابع التسجيل مع وسم "manualOverride: true"
      var manualOverrideFlag = true;
    }

    // تسجيل الحضور فعلياً
    const today = nowISODate();
    const time = nowTime24();
    const times = await getCompanyTimes(companyCode);

    const recSnap = await get(ref(database, `attendance/${today}/${code}`));
    if (recSnap.exists()) {
      const rec = recSnap.val();
      if (type === 'checkIn' && rec.checkIn) return showFlash(' تم تسجيل الحضور مسبقاً');
      if (type === 'checkOut' && rec.checkOut) return showFlash(' تم تسجيل الانصراف مسبقاً');
    }

    let status = '';
    if (type === 'checkIn') {
      status = compareTimeStrings(time, times.start) > 0 ? ' متأخر' : ' في الميعاد';
    } else {
      status = compareTimeStrings(time, times.end) < 0 ? ' انصراف مبكر' : ' عادي';
    }

    const base = `attendance/${today}/${code}`;
    const payload = {};
    payload[`${base}/${type}`] = {
      time,
      status,
      companyCode,
      lat: latStr,
      lng: lngStr,
      lat_full: latNum,
      lng_full: lngNum,
      distance_m: Math.round(distance),
      accuracy_m: accuracy !== null ? Math.round(accuracy) : null,
      regionCode: emp.regionCode,
      regionLat: regionLat,
      regionLng: regionLng,
      regionRadius_m: Math.round(regionRadius),
      manualOverride: !!manualOverrideFlag
    };
    payload[`${base}/lastUpdate`] = { time, type, status, ts: Date.now(), lat: latStr, lng: lngStr, distance_m: Math.round(distance), accuracy_m: accuracy !== null ? Math.round(accuracy) : null, manualOverride: !!manualOverrideFlag };

    await update(ref(database), payload);

    showFlash(`✅ ${status} • ${code} • ${time}`, 2000);
    playTone(type);
    loadEmployee(code);
    empStatusLine.textContent = `${type === 'checkIn' ? 'دخول' : 'خروج'}: ${time} — ${status}`;

  }, err => {
    console.error('geolocation error', err);
    // اعرض رسالة أو اقتراحات إصلاح
    showFlash(' ❌ لم يتم الحصول على الموقع — تحقق من سماح المتصفح/تشغيل GPS وكون الصفحة عبر HTTPS');
  }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
}

/* ===================== ربط الأحداث ===================== */
manualCode.addEventListener('keydown', async (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const code = manualCode.value.trim();
    await saveAttendance(code, companySelect.value, 'checkIn');
    manualCode.value = '';
  }
});

btnIn.addEventListener('click', async () => {
  const code = manualCode.value.trim();
  await saveAttendance(code, companySelect.value, 'checkIn');
  manualCode.value = '';
});
btnOut.addEventListener('click', async () => {
  const code = manualCode.value.trim();
  await saveAttendance(code, companySelect.value, 'checkOut');
  manualCode.value = '';
});
document.getElementById('clearPreview').addEventListener('click', () => {
  manualCode.value = ''; empPreview.style.display = 'none'; empStatusLine.textContent = '';
});

function playTone(type) {
  try {
    const audio = new Audio(type === 'checkIn'
      ? 'https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg'
      : 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg');
    audio.volume = .6; audio.play();
  } catch (e) { }
}

/* ===================== تحديث واجهة اليوم ===================== */
async function refreshTodayView() {
  const today = nowISODate();
  const s = await get(ref(database, `attendance/${today}`));

  if (!s.exists()) {
    recentList.innerHTML = '<div style="opacity:.8">لا توجد بيانات لليوم</div>';
    reportBody.innerHTML = '';
    statPresent.innerText = '0'; statLate.innerText = '0'; statOut.innerText = '0'; statEarly.innerText = '0';
    chart.data.labels = []; chart.data.datasets[0].data = []; chart.update();
    return;
  }

  const data = s.val();
  const rows = [];
  let present = 0, late = 0, out = 0, early = 0;

  for (const [code, rec] of Object.entries(data)) {
    const cin = rec.checkIn?.time || '-';
    const cins = rec.checkIn?.status || '-';
    const cout = rec.checkOut?.time || '-';
    const couts = rec.checkOut?.status || '-';
    rows.push({ code, cin, cins, cout, couts });
    if (cin && cin !== '-') present++;
    if (cins && cins.includes('متأخر')) late++;
    if (cout && cout !== '-') out++;
    if (couts && couts.includes('مبكر')) early++;
  }

  const recent = Object.entries(data).map(([code, rec]) => {
    const lu = rec.lastUpdate;
    return {
      code,
      in: rec.checkIn?.time || '-',
      out: rec.checkOut?.time || '-',
      lu: lu?.ts || 0,
      status: lu?.status || ''
    };
  }).sort((a, b) => b.lu - a.lu).slice(0, 8);

  const namesMap = {};
  await Promise.all(recent.map(async r => {
    const sn = await get(ref(database, `hrEmployees/${r.code}/fullName`));
    namesMap[r.code] = sn.exists() ? sn.val() : r.code;
  }));

  recentList.innerHTML = recent.map(r => (
    `<div style="padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.03)">
    ${escapeHtml(namesMap[r.code] || r.code)} — دخول: ${r.in} — خروج: ${r.out}
    <div style="opacity:.85">${r.status}</div>
    </div>`
  )).join('');

  async function getName(code) {
    const sn = await get(ref(database, `hrEmployees/${code}/fullName`));
    return sn.exists() ? sn.val() : code;
  }
  await Promise.all(rows.map(async r => { namesMap[r.code] = await getName(r.code); }));

  reportBody.innerHTML = rows.map(r => (
    `<tr>
      <td>${escapeHtml(namesMap[r.code] || r.code)}</td>
      <td>${r.code}</td>
      <td>${r.cin}</td>
      <td style="color:${r.cins.includes('متأخر') ? 'var(--red)' : 'var(--green)'}">${r.cins}</td>
      <td>${r.cout}</td>
      <td style="color:${r.couts.includes('مبكر') ? 'var(--orange)' : 'var(--green)'}">${r.couts}</td>
    </tr>`
  )).join('');

  statPresent.innerText = present;
  statLate.innerText = late;
  statOut.innerText = out;
  statEarly.innerText = early;

  const labels = []; const counts = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    labels.push(d.toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' }));
    const sday = await get(ref(database, `attendance/${key}`));
    counts.push(sday.exists() ? Object.keys(sday.val()).length : 0);
  }
  chart.data.labels = labels; chart.data.datasets[0].data = counts; chart.update();
}

exportCSV.addEventListener('click', async () => {
  const today = nowISODate();
  const s = await get(ref(database, `attendance/${today}`));
  if (!s.exists()) { showFlash('لا توجد بيانات للتصدير'); return; }
  const data = s.val();
  const rows = [];
  rows.push(['employeeCode', 'employeeName', 'checkIn', 'checkInStatus', 'checkOut', 'checkOutStatus', 'company'].join(','));
  for (const [code, rec] of Object.entries(data)) {
    const sn = await get(ref(database, `hrEmployees/${code}/fullName`));
    const name = sn.exists() ? sn.val() : code;
    const cin = rec.checkIn?.time || '';
    const cins = rec.checkIn?.status || '';
    const cout = rec.checkOut?.time || '';
    const couts = rec.checkOut?.status || '';
    const comp = rec.checkIn?.companyCode || rec.checkOut?.companyCode || '';
    rows.push([code, `"${String(name).replace(/"/g, '""')}"`, cin, `"${cins}"`, cout, `"${couts}"`, comp].join(','));
  }
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `attendance_${today}.csv`; a.click();
  URL.revokeObjectURL(url);
  showFlash(' تم تنزيل CSV');
});

/* ===================== QR & Helpers ===================== */
async function handleScanned(payload) {
  let code = payload;
  let companyFromQr = null;
  try {
    const parsed = JSON.parse(payload);
    if (parsed.code) code = parsed.code;
    if (parsed.company) companyFromQr = parsed.company;
  } catch (e) { }
  manualCode.value = code;
  if (companyFromQr) companySelect.value = companyFromQr;
  await loadEmployee(code);
  showFlash('تم قراءة QR → ' + code, 1800);
}

setInterval(refreshTodayView, 5000);
refreshTodayView();

manualCode.addEventListener('input', () => loadEmployee(manualCode.value.trim()));

companySelect.addEventListener('change', () => {
  const c = companySelect.options[companySelect.selectedIndex]?.text || '';
  todayLabel.innerText = `اليوم - ${c || 'جميع الشركات'}`;
  refreshTodayView();
});

let qrInterval = null;

function generateDynamicQR(employeeCode) {
  const profileUrl = `${window.location.origin}/attendance.html?emp=${encodeURIComponent(employeeCode)}`;
  QRCode.toCanvas(qrCanvas, profileUrl, { width: 160 }, (err) => { if (err) console.error(err); });
}

function startEmployeeQR(code) {
  if (!code) { showFlash(' أدخل كود الموظف أولاً'); return; }
  if (qrInterval) clearInterval(qrInterval);
  generateDynamicQR(code);
  qrInterval = setInterval(() => generateDynamicQR(code), 30000);
  showFlash(' تم توليد باركود ديناميكي للموظف (يُحدث كل 30 ثانية)');
}

document.getElementById('btnQrProfile')?.addEventListener('click', () => {
  const code = manualCode.value.trim();
  if (!code) { showFlash(' أدخل كود الموظف أولاً'); return; }
  const profileUrl = `https://seif784.github.io/seifiif/index.html?emp=${encodeURIComponent(code)}`;
  QRCode.toCanvas(qrCanvas, profileUrl, { width: 160 }, err => {
    if (err) console.error(err); else showFlash(' تم توليد باركود للموظف');
  });
});
  </script>
</head>
<style>
  :root {
    --main-color: #ffffffcc;
    --hover-color: #f1f1f1cc;
    --light-bg: #ffffff1a;
    --box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    --radius: 5px;
    --transition: all 0.2s ease-in-out;
    --text-color: #222;
    --accent-color: #007bff;
    --accent-hover: #0056b3;
    --border-color: #ddd;
    --error-color: #ff4d4f;
    --success-color: #52c41a;
    --warning-color: #faad14;
    --info-color: #1890ff;
  }

  body {
    display: flex;
    flex-direction: row;
    min-height: 100vh;
    margin: 0;
    padding: 0;
    font-family: 'Arial', "Tahoma", sans-serif;
    font-size: 17px;
    line-height: 1.7;
    color: var(--text-color);
    background: linear-gradient(120deg, #f5f5f5 0%, #ffffff 100%);
    overflow-x: hidden;
    scroll-behavior: smooth;
    direction: rtl;
    text-align: center;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 65px;
    padding: 0 25px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    z-index: 1000;
    border-bottom-left-radius: var(--radius);
    border-bottom-right-radius: var(--radius);
    direction: rtl;
    text-align: center;
  }

  .header.scrolled {
    height: 55px;
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .sidebar {
    position: fixed;
    top: 70px;
    left: 0;
    bottom: 0;
    width: 230px;
    padding: 15px;
    background: var(--main-color);
    border-right: 1px solid rgba(200, 200, 200, 0.15);
    border-top-right-radius: var(--radius);
    border-bottom-right-radius: var(--radius);
    box-shadow: 2px 0 12px rgba(0, 0, 0, 0.05);
    overflow-y: auto;
    z-index: 900;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    flex-direction: column;
    gap: 2px;
    align-items: stretch;
    direction: rtl;
  }

  .sidebar button {
    width: 100%;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.05);
    border: none;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
    border-radius: 8px;
    cursor: pointer;
    box-sizing: border-box;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: all 0.25s ease;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }

  .sidebar button i {
    font-size: 20px;
    flex-shrink: 0;
    color: var(--accent-color);

  }

  .sidebar button span {
    flex: 1;
    text-align: right;

  }

  .sidebar button:hover {
    background: var(--hover-color);
    color: var(--accent-color);
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);

  }

  .search-box {
    width: 100%;
    padding: 10px 15px 10px 40px;
    border-radius: 30px;
    border: 1px solid transparent;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: var(--box-shadow-light);
    box-sizing: border-box;
    margin: 10px 0;
    text-align: right;
    direction: rtl;
    letter-spacing: 0.3px;
    font-family: 'Segoe UI', 'Arial', sans-serif, "Tahoma";
    background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjNjY2Ij48cGF0aCBkPSJNMTUuNSAxNGgtMS4yOGwtLjQ1LS40NWMuOTItMS4xMiAxLjQ3LTIuNTIgMS40Ny00LjA1IDAtMy4zMS0yLjY5LTYtNi02cy02IDIuNjktNiA2IDIuNjkgNiA2IDZjMS41MyAwIDMuMzk1LS41NSA0LjUxLTEuNDVsLjQ1LjQ1VjE1LjVsNSAxLjV6bS02LjUtMTRDMTAuMjMgMCAxMyAydS41NSA1LTEgNXMtNS0yLjIzLTUtNSAyLjIzLTUgNXoiLz48L3N2Zz4=');
    background-repeat: no-repeat;
    background-size: 18px;
    background-position: 12px center;
    transition: all 0.3s ease;

  }

  .search-box::placeholder {
    color: #66666600;
    font-size: 13px;
    opacity: 0.8;
  }

  .search-box:focus {
    border-color: rgba(100, 100, 255, 0.5);
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 0 8px rgba(100, 100, 255, 0.25);
    outline: none;
    transform: scale(1.02);
  }

  .logo img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    object-fit: cover;
  }

  .logo img:hover {
    transform: rotate(5deg) scale(1.05);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
  }

  .content {
    padding: 70px 20px 20px;
    width: calc(100% - 230px);
    display: none;
    margin-left: 230px;
    text-align: start;

  }

  .content.active {
    display: block;
  }

  .form-container {
    background: var(--main-color);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--box-shadow);
    backdrop-filter: blur(6px);
  }

  .grid-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    background: var(--main-color);
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: var(--box-shadow);
  }

  .grid-item {
    display: flex;
    flex-direction: column;
    padding: 16px;
    background: var(--main-color);
    border-radius: var(--radius);
    border: 1px solid rgba(200, 200, 200, 0.2);
    margin-bottom: 20px;
  }

  label {
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 14px;
    color: var(--text-color);
  }

  input,
  select {
    padding: 10px;
    font-size: 15px;
    border: 1px solid rgba(99, 98, 98, 0.3);
    border-radius: 6px;
    background: var(--light-bg);
    color: var(--text-color);
    transition: var(--transition);
  }

  input:focus,
  select:focus {
    border-color: rgba(100, 100, 255, 0.5);
    background: rgba(255, 255, 255, 0.6);
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
    outline: none;
  }

  .full-width {
    grid-column: span 2;
  }

  .table-container {
    max-height: 400px;
    overflow: auto;
    border: 2px solid var(--main-color);
    border-radius: var(--radius);
    box-shadow: var(--box-shadow);
    background: var(--main-color);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  thead {
    position: sticky;
    top: 0;
    background-color: var(--main-color);
    color: #000;
    z-index: 1;
  }

  th,
  td {
    padding: 10px;
    border: 1px solid rgba(77, 77, 77, 0.1);
    text-align: center;
    word-wrap: break-word;
    color: var(--text-color);
    min-width: 120px;
    max-width: 200px;
  }

  td input {
    border: none;
    background: transparent;
    width: 100%;
    text-align: center;
    color: inherit;
  }

  td input:focus {
    border-bottom: 2px solid rgba(100, 100, 255, 0.4);
    outline: none;
  }

  button {
    background: var(--main-color);
    color: var(--text-color);
    padding: 8px 18px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    letter-spacing: 0.3px;
    transition: all 0.3s ease;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  }

  button:hover {
    background: var(--hover-color);
    color: var(--accent-color);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  button:active {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  button:disabled {
    background: #ccc;
    color: #777;
    cursor: not-allowed;
    box-shadow: none;
  }


  #columnFilterBox {
    max-height: 400px;
    max-width: 300px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 15px;
    margin: 10px 0;
    position: absolute;
    right: 10px;
    z-index: 100;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  #columnFilterBox label {
    display: block;
    margin: 5px 0;
  }

  #columnFilterBox button {
    margin-top: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
  }

  #computerDetails,
  #LaptopDetails {
    background-color: var(--light-bg);
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: var(--radius);
    transition: var(--transition);
    grid-column: span 2;
  }

  .hidden {
    display: none !important;
  }

  table thead {
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 10;
  }

  .custom-link {
    display: inline-block;
    color: #0d6efd;
    font-size: 1.1rem;
    font-weight: 500;
    text-decoration: none;
    border-bottom: 2px solid transparent;
    padding-bottom: 2px;
    transition: all 0.2s ease;
  }

  .custom-link:hover {
    color: #0a58ca;
    border-bottom: 2px solid #0a58ca;
  }


  #queryResultsMaintenance {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #ccc;
  }


  #queryResultsMaintenance th,
  #queryResultsMaintenance td {
    padding: 8px;
    border: 1px solid #ccc;
    text-align: center;
  }

  #queryResultsMaintenance th {
    position: sticky;
    top: 0;
    background-color: #f9f9f9;
    z-index: 1;
    font-weight: bold;
  }

  #columnFilterBox {
    max-height: 400px;
    max-width: 300px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #ccc;
    background-color: #f9f9f9;
    padding: 15px;
    margin: 10px 0;
    position: absolute;
    right: 10px;
    z-index: 100;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  #columnFilterBox label {
    display: block;
    margin: 5px 0;
  }

  #columnFilterBox button {
    margin-top: 10px;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
  }

  #columnFilterBoxRouter {
    max-height: 400px;
    max-width: 300px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #ddd;
    background-color: #ffffff;
    padding: 20px;
    margin: 10px 0;
    position: absolute;
    right: 10px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  #columnFilterBoxRouter label {
    display: block;
    margin: 8px 0;
    font-size: 14px;
    color: #333;
  }

  #columnFilterBoxRouter button {
    margin-top: 15px;
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s ease;
    font-size: 14px;
  }

  #columnFilterBoxRouter button:hover {
    background-color: #218838;
  }

  #columnFilterBoxLine {
    max-height: 400px;
    max-width: 300px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #ddd;
    background-color: #ffffff;
    padding: 20px;
    margin: 10px 0;
    position: absolute;
    right: 10px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  #columnFilterBoxLine label {
    display: block;
    margin: 8px 0;
    font-size: 14px;
    color: #333;
  }

  #columnFilterBoxLine button {
    margin-top: 15px;
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s ease;
    font-size: 14px;
  }

  #columnFilterBoxLine button:hover {
    background-color: #218838;
  }

  #columnFilterBoxGps {
    max-height: 400px;
    max-width: 300px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #ddd;
    background-color: #ffffff;
    padding: 20px;
    margin: 10px 0;
    position: absolute;
    right: 10px;
    z-index: 100;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  #columnFilterBoxGps label {
    display: block;
    margin: 8px 0;
    font-size: 14px;
    color: #333;
  }

  #columnFilterBoxGps button {
    margin-top: 15px;
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 14px;
    cursor: pointer;
    border-radius: 5px;
    transition: background-color 0.3s ease;
    font-size: 14px;
  }

  #columnFilterBoxGps button:hover {
    background-color: #218838;
  }

  #loginScreen,
  #mainContent {
    display: none;
  }

  #loader {
    display: none;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: rgba(255, 255, 255, 0.7);
    z-index: 9999;
    justify-content: center;
    align-items: center;
  }

  .user-info img {
    object-fit: cover;
    border: 1px solid #ccc;
  }

  #powerManagement input[type="text"] {
    border: 2px solid #ced4da;
    transition: border-color 0.3s ease;
  }

  #powerManagement input[type="text"]:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }

  #powerManagement button {
    font-weight: bold;
  }

  .dashboard-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 15px;
    background: linear-gradient(135deg, #007bff00, #0057b300);
    border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0);
  }

  .dashboard-header h2 {
    margin: 0;
    color: #ffffff00;
    font-weight: 800;
    font-size: 26px;
    letter-spacing: 1px;
  }

  .dashboard-header p {
    color: rgba(255, 255, 255, 0);
    font-size: 15px;
  }

  #map {
    height: 350px;
    border: 1px solid #ccc;
    margin-top: 10px;
  }

  .tabs {
    display: flex;
    background: #334155;
    overflow-x: auto;
  }

  .tabs button {
    flex: 1;
    background: #334155;
    color: #fff;
    border: none;
    padding: 12px;
    cursor: pointer;
    font-size: 14px;
  }

  .tabs button.active {
    background: #2563eb;
    font-weight: bold;
  }

  .tabs button:hover {
    background: #1e40af;
  }

  .tab-content {
    display: none;
    padding: 20px;
    background: #fff;
    min-height: 400px;
  }

  .tab-content.active {
    display: block;
  }

  .chart {
    flex: 3;
    background: #ffffff00;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 4px 12px rgb(0, 0, 0);
    overflow: auto;
    margin: auto;
    text-align: center
  }

  .tree {
    display: inline-block;
    padding: 24px;
  }

  .node {
    display: inline-block;
    background: #fff4e6;
    border: 2px solid #f59e0b;
    border-radius: 12px;
    padding: 12px 16px;
    min-width: 200px;
    position: relative;
    margin: 10px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: transform .2s, background .3s;
  }

  .node:hover {
    transform: translateY(-3px);
    background: #ffedd5;
  }

  .node .title {
    font-weight: 700;
    font-size: 15px;
    color: #78350f;
  }

  .node .subtitle {
    color: #a16207;
    font-size: 12px;
  }

  .chip {
    display: inline-block;
    font-size: 11px;
    border: 1px solid #f59e0b;
    padding: 2px 6px;
    border-radius: 999px;
    margin-top: 6px;
    color: #b45309;
    background: #fef3c7;
    box-shadow: 0 1px 3px rgba(0, 0, 0, .1);
    user-select: none;
    transition: background .3s, color .3s;
  }

  .employees {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    justify-content: center;
  }

  .employee {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 4px 6px;
    font-size: 12px;
    min-width: 100px;
    color: #374151;
    transition: .2s;
  }

  .employee:hover {
    background: #f59e0b;
    color: #fff;
  }

  .children {
    display: flex;
    gap: 30px;
    justify-content: center;
    margin-top: 25px;
    transition: max-height .3s ease;
  }

  .branch {
    position: relative;
  }

  .branch::before {
    content: "";
    position: absolute;
    top: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 20px;
    background: #d6d3d1;
  }

  .connector {
    position: absolute;
    top: -20px;
    left: 0;
    right: 0;
    height: 20px;
  }

  .connector::before,
  .connector::after {
    content: "";
    position: absolute;
    top: 10px;
    width: 50%;
    height: 2px;
    background: #d6d3d1;
  }

  .connector::before {
    left: 0
  }

  .connector::after {
    right: 0
  }

  .ctrl {
    position: absolute;
    top: -12px;
    inset-inline-start: -12px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #f59e0b;
    color: #fff;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0, 0, 0, .2);
  }

  .hidden {
    display: none;
  }

  button.save-btn {
    background: #5d5e5d;
    color: #fff;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  .settings-scroll {
    max-height: 250px;
    overflow-y: auto;
  }

  .settings-scroll::-webkit-scrollbar {
    width: 6px;
  }

  .settings-scroll::-webkit-scrollbar-thumb {
    background: #17a2b8;
    border-radius: 10px;
  }

  .tabs {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .tab {
    padding: 10px 14px;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
  }

  .tab.active {
    background: #222;
    color: #fff;
    border-color: #222;
  }

  main {
    flex: 1;
    display: flex;
    gap: 20px;
    padding: 20px;
    box-sizing: border-box;
  }

  .kiosk {
    flex: 1;
    background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
    border-radius: 14px;
    padding: 14px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    box-shadow: 0 8px 30px rgba(0, 0, 0, .4);
  }

  .kiosk-top {
    display: flex;
    gap: 18px;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .clock-box {
    flex: 0 0 260px;
    background: var(--card);
    padding: 18px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #fff;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, .1);
    box-sizing: border-box;
    user-select: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;

  }

  .clock-time {
    font-size: 40px;
    font-weight: 700;
    letter-spacing: 1px;
    margin: 0;
    font-family: 'Courier New', Courier, monospace;
    text-shadow: 0 0 8px rgba(0, 0, 0, 0);
    color: #2e1616;
    transition: color 0.3s ease;
  }

  .clock-date {
    opacity: .9;
    margin-top: 8px;
    font-size: 16px;
    color: #290f0f;
    transition: color 0.3s ease;
  }

  .kiosk-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
    justify-content: space-between;
    min-width: 0;
  }

  .scanner-card {
    background: var(--glass);
    border-radius: 12px;
    padding: 12px;
    display: flex;
    gap: 12px;
    align-items: center;
  }

  #video {
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, .08);
    max-width: 260px;
  }

  .scanner-info {
    flex: 1;
  }

  .kiosk-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-top: 8px;
    justify-content: flex-end;
  }

  .btn {
    transition: transform 0.15s ease, background 0.3s ease;
  }

  .btn:active {
    transform: scale(0.95);
  }

  .emp-photo {
    width: 88px;
    height: 88px;
    border-radius: 12px;
    background: #111;
    flex-shrink: 0;
    object-fit: cover;
  }

  .emp-meta {
    flex: 1;
    text-align: right;
  }

  .emp-meta h3 {
    margin: 0;
    font-size: 18px;
  }

  .emp-meta p {
    margin: 3px 0;
    opacity: .95;
    font-size: 14px;
  }

  .list {
    max-height: 260px;
    overflow: auto;
  }

  .stats {
    display: flex;
    gap: 12px;
  }

  .stat {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    color: #000000;
  }

  .stat h4 {
    margin: 0;
    font-size: 22px;
  }

  .stat p {
    margin: 6px 0 0;
    opacity: .9;
  }

  #statPresent {
    color: #4CAF50;
  }

  #statLate {
    color: #FF9800;
  }

  #statOut {
    color: #2196F3;
  }

  #statEarly {
    color: #F44336;
  }

  .app {
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .employee-card {
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 12px;
    border-radius: 10px;
    background: linear-gradient(90deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
  }

  footer {
    padding: 10px 20px;
    text-align: center;
    color: rgba(255, 255, 255, .6);
    font-size: 13px;
  }

  @media(max-width:980px) {
    main {
      flex-direction: column;
      padding: 12px;
    }

    .dashboard {
      width: 100%
    }
  }

  @media(max-width:600px) {
    .clock-box {
      flex: 1 1 100%;
    }

    #video {
      width: 100%;
    }
  }

  #reportTable th,
  #reportTable td {
    padding: 8px;
    text-align: center;
    font-size: 13px;
  }

  #reportTable tbody tr:nth-child(even) {
    background: rgba(255, 255, 255, .03);
  }

  .flash {
    position: fixed;
    left: 50%;
    top: 18%;
    transform: translateX(-50%);
    padding: 18px 24px;
    border-radius: 12px;
    font-weight: 700;
    background: rgba(0, 0, 0, .6);
    color: #fff;
    z-index: 9999;
    box-shadow: 0 8px 24px rgba(0, 0, 0, .6);
    display: none;
  }

  .flash.show {
    display: block;
    animation: pop .45s ease, fadeOut 2s 2s forwards;
  }

  @keyframes pop {
    from {
      transform: translateX(-50%) scale(.9);
      opacity: 0
    }

    to {
      transform: translateX(-50%) scale(1);
      opacity: 1
    }
  }

  @keyframes fadeOut {
    to {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }
  }

  .chart-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(0px, 3fr));
    gap: 20px;
  }

  .chart-card {
    background: var(--main-color);
    border-radius: var(--radius);
    box-shadow: var(--box-shadow);
    padding: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    animation: fadeUp 0.6s ease both;
  }

  .chart-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  @keyframes fadeUp {
    0% {
      opacity: 0;
      transform: translateY(20px);
    }

    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .dashboard {
    width: 600px;
    display: flex;
    flex-direction: column;
    gap: 16px
  }
</style>

<body>
  <div id="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
  </div>
  <div class="header d-flex align-items-center p-3 bg-light border-bottom">
    <div class="d-flex align-items-center">

      <div class="dropdown me-3">
        <div class="user-info d-flex align-items-center dropdown-toggle" id="userMenu" data-bs-toggle="dropdown"
          aria-expanded="false" style="cursor: pointer;">
          <img id="userAvatar" src="default-avatar.png" alt="User Avatar" class="rounded-circle me-2"
            style="width: 40px; height: 40px;">
          <span id="userDisplayName" class="fw-bold">اسم المستخدم</span>
        </div>
        <ul class="dropdown-menu" aria-labelledby="userMenu">
          <li><a class="dropdown-item" href="#" onclick="changePassword()">🔑 تغيير كلمة المرور</a></li>
          <li><a class="dropdown-item text-danger" href="#" onclick="logout()">🔓 تسجيل الخروج</a></li>
        </ul>
      </div>

      <button class="btn btn-outline-secondary btn-sm me-2" onclick="toggleLanguage()">🌐 English / عربي</button>
    </div>

    <div class="d-flex align-items-center">
      <button class="btn btn-outline-secondary btn-sm me-3" onclick="fetchData()">🔄 تحديث</button>
      <button class="btn btn-outline-secondary btn-sm me-2" id="deleteButton" onclick="deleteDocument()">🗑️
        حذف</button>
      <button class="btn btn-outline-secondary btn-sm me-2" onclick="showSection('Dashboard')">🏠 الرئيسية</button>
    </div>

  </div>



  <div class="sidebar p-3 bg-body-tertiary" id="sidebar">
    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#settingsDropdown">
        ⚙️ <span class="button-text"> تعريفات النظام </span>
      </button>
      <div id="settingsDropdown" class="collapse">
        <div class="card-body settings-scroll">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#BasicDefinitions" onclick="showSection('BasicDefinitions')"> تعريفات أساسية
              </a></li>
            <li><a class="nav-link" href="#PageSettings" onclick="showSection('PageSettings')"> تعريف الصفحة </a></li>
            <li><a class="nav-link" href="#definitionCompanies" onclick="showSection('definitionCompanies')"> تعريف
                الشريكات </a></li>
            <li><a class="nav-link" href="#companySettingsForm" onclick="showSection('companySettingsForm')"> تعريف
                الفاتوره </a></li>
            <li><a class="nav-link" href="#costCenters" onclick="showSection('costCenters')"> تعريف مراكز التكلفة </a>
            </li>
            <li><a class="nav-link" href="#addItemForm" onclick="showSection('addItemForm')">تعريف الاصناف </a></li>
            <li><a class="nav-link" href="#addARegionForm" onclick="showSection('addARegionForm')">تعريف المناطق </a>
            </li>
            <li><a class="nav-link" href="#addAResourceForm" onclick="showSection('addAResourceForm')"> تعريف الموردين
              </a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#HrDropdown">
        👥 <span class="button-text">الموارد البشرية</span>
      </button>
      <div id="HrDropdown" class="collapse">
        <div class="card-body settings-scroll">
          <ul class="nav nav-pills flex-column">
            <li class="nav-item"><a class="nav-link" href="#FunctionalStructure"
                onclick="showSection('FunctionalStructure')" target="_blank">الهيكل الوظيفي</a></li>
            <li class="nav-item"><a class="nav-link" href="#HrForm" onclick="showSection('HrForm')"
                target="_blank">بيانات الموظفين</a></li>
            <li class="nav-item"><a class="nav-link" href="#AttendancDeeparts"
                onclick="showSection('AttendancDeeparts')" target="_blank">تسجيل الحضور ولانصراف</a></li>
            <li class="nav-item"><a class="nav-link" href="#InsuranceCases" onclick="showSection('InsuranceCases')"
                target="_blank"> إدارة الحالات التأمينية</a></li>
            <li class="nav-item"><a class="nav-link" href="#InsuranceOffices" onclick="showSection('InsuranceOffices')"
                target="_blank">إدارة مكاتب التأمين</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#computerDropdown">
        💻 <span class="button-text">خيارات الكمبيوتر</span>
      </button>
      <div id="computerDropdown" class="collapse">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li class="nav-item"><a class="nav-link" href="#computerForm" onclick="showSection('computerForm')">إضافة
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#computerQuery"
                onclick="showSection('computerQuery')">استعلام جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#computerSettings"
                onclick="showSection('computerSettings')">اعدادات جهاز</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#phoneDropdown">
        📱 <span class="button-text">خيارات الهاتف</span>
      </button>
      <div id="phoneDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li class="nav-item"><a class="nav-link" href="#phoneForm" onclick="showSection('phoneForm')">إضافة جهاز</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="#phoneQuery" onclick="showSection('phoneQuery')">استعلام
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#phoneSettings"
                onclick="showSection('phoneSettings')">اعدادات جهاز</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#screenDropdown">
        🖥️ <span class="button-text">خيارات الشاشات</span>
      </button>
      <div id="screenDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li class="nav-item"><a class="nav-link" href="#screenForm" onclick="showSection('screenForm')">إضافة
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#screenQuery" onclick="showSection('screenQuery')">استعلام
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#screenSettings"
                onclick="showSection('screenSettings')">اعدادات جهاز</a></li>

          </ul>
        </div>
      </div>
    </div>
    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#cameraDropdown">
        📷 <span class="button-text">خيارات الكاميرات</span>
      </button>
      <div id="cameraDropdown" class="collapse">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li class="nav-item"><a class="nav-link" href="#cameraForm" onclick="showSection('cameraForm')">إضافة
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#cameraQuery" onclick="showSection('cameraQuery')">استعلام
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#cameraSettings"
                onclick="showSection('cameraSettings')">اعدادات جهاز</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#printDropdown">
        🖨️ <span class="button-text">خيارات الطباعات </span>
      </button>
      <div id="printDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills nav-stacked">
            <li class="nav-item"><a class="nav-link" href="#printForm" onclick="showSection('printForm')">إضافة جهاز</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="#printQuery" onclick="showSection('printQuery')">استعلام
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#printerSettings"
                onclick="showSection('printerSettings')">اعدادات جهاز</a></li>

          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#RouterDropdown">
        🌐 <span class="button-text">خيارات الرواتر </span>
      </button>
      <div id="RouterDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li class="nav-item"><a class="nav-link" href="#RouterForm" onclick="showSection('RouterForm')">إضافة
                جهاز</a></li>
            <li class="nav-item"><a class="nav-link" href="#RouterQuery" onclick="showSection('RouterQuery')">استعلام
                جهاز</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#lineDropdown">
        📶 <span class="button-text">إدارة الخطوط</span>
      </button>
      <div id="lineDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#lineForm" onclick="showSection('lineForm')">إضافة خط </a></li>
            <li><a class="nav-link" href="#lineQuery" onclick="showSection('lineQuery')">استعلام عن الخطوط</a></li>
            <li><a class="nav-link" href="#lineSettings" onclick="showSection('lineSettings')"> عدادات الخطوط</a></li>

          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#gpsDropdown">
        🛰️ <span class="button-text">قسم GPS</span>
      </button>
      <div id="gpsDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#gpsForm" onclick="showSection('gpsForm')"> إضافة جهاز GPS </a></li>
            <li><a class="nav-link" href="#gpsQuery" onclick="showSection('gpsQuery')">استعلام GPS</a></li>
            <li><a class="nav-link" href="#gpsSettings" onclick="showSection('gpsSettings')"> عدادات GPS</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#orderDropdown">
        📝 <span class="button-text">طلب شراء</span>
      </button>
      <div id="orderDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#orderForm" onclick="showSection('orderForm')">طلب شراء</a></li>
            <li><a class="nav-link" href="#orderQuery" onclick="showSection('orderQuery')">استعلام طلب شراء</a></li>
            <li><a class="nav-link" href="#orderAmendment" onclick="showSection('orderAmendment')">تعديل طلب الشراء</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#deliveryDropdown">
        📑 <span class="button-text">طلب موافقة تسليم</span>
      </button>
      <div id="deliveryDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#deliveryForm" onclick="showSection('deliveryForm')">طلب موافقة تسليم</a></li>
            <li><a class="nav-link" href="#deliveryQuery" onclick="showSection('deliveryQuery')">استعلام طلب موافقة
                تسليم</a></li>
            <li><a class="nav-link" href="#deliveryAmendment" onclick="showSection('deliveryAmendment')">تعديل طلب
                موافقة تسليم</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#maintenanceDropdown">
        🔧 <span class="button-text">إدارة طلب الصيانة</span>
      </button>
      <div id="maintenanceDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#maintenanceForm" onclick="showSection('maintenanceForm')">إضافة طلب صيانة</a>
            </li>
            <li><a class="nav-link" href="#maintenanceQuery" onclick="showSection('maintenanceQuery')">استعلام عن طلب
                الصيانة</a></li>
            <li><a class="nav-link" href="#maintenanceAmendment" onclick="showSection('maintenanceAmendment')">تعديل طلب
                الصيانة</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#storeDropdown">
        📦 <span class="button-text">إدارة مخازن</span>
      </button>
      <div id="storeDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#AddAProductAdditionForm" onclick="showSection('AddAProductAdditionForm')">إذن
                إضافة</a></li>
            <li><a class="nav-link" href="#InquiryAProductAdditionForm"
                onclick="showSection('InquiryAProductAdditionForm')">استعلام عن إذن إضافة</a></li>
            <li><a class="nav-link" href="#AddProductDisbursement" onclick="showSection('AddProductDisbursement')">إذن
                صرف</a></li>
            <li><a class="nav-link" href="#InquiryAProductDisbursement"
                onclick="showSection('InquiryAProductDisbursement')">استعلام عن إذن صرف</a></li>
            <li><a class="nav-link" href="#DisbursementQuery" onclick="showSection('DisbursementQuery')">استعلام عن
                المخازن</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#temporaryDropdown">
        ⏳ <span class="button-text">عهده مؤقته</span>
      </button>
      <div id="temporaryDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#addTemporaryForm" onclick="showSection('addTemporaryForm')">إضافة عهده مؤقته
              </a></li>
            <li><a class="nav-link" href="#InquiryTemporaryForm" onclick="showSection('InquiryTemporaryForm')">
                استعلامات عن عهد مؤقته </a></li>
            <li><a class="nav-link" href="#editTemporaryForm" onclick="showSection('editTemporaryForm')"> تعديل عن عهد
                مؤقته </a></li>
            <li><a class="nav-link" href="#TemporaryFormInquiry" onclick="showSection('TemporaryFormInquiry')">استعلام
                عن عهده موظف</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="card mb-3">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#fixedDropdown">
        🏢 <span class="button-text"> اداره الاصول </span>
      </button>
      <div id="fixedDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li><a class="nav-link" href="#fixedAssetsDepreciation" onclick="showSection('fixedAssetsDepreciation')">
                الأصول الثابتة والإهلاك </a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card mb-3 admin-only d-none" id="userSettingsCard">
      <button class="btn btn-info w-100 text-start" data-bs-toggle="collapse" data-bs-target="#userSettingsDropdown">
        👤 <span class="button-text">إعدادات المستخدم</span>
      </button>
      <div id="userSettingsDropdown" class="collapse ">
        <div class="card-body">
          <ul class="nav nav-pills flex-column">
            <li>
            <li><a class="nav-link" href="#createUserForm" onclick="showSection('createUserForm')">إنشاء مستخدم</a></li>
            <li><a class="nav-link" href="#editUserSection" onclick="showSection('editUserSection')">تعديل بيانات
                مستخدم</a></li>
            <li><a class="nav-link" href="#powerManagement" onclick="showSection('powerManagement')"> إدارة الصلاحيات
              </a></li>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>


  <div class="content" id="AttendancDeeparts">
    <div class="card">
      <div class="card-header text-center">
        نظام الحضور والإنصراف الذكي
        <span style="float:left;font-size:12px;opacity:.7">
          <select id="companySelect"
            style="padding:8px;border-radius:8px;background:var(--secondary);color:var(--text);border:none">
            <option value="">-- اختر الشركة --</option>
          </select>
        </span>
      </div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;padding:12px">
        <div style="flex:1;min-width:260px;text-align:center">
          <div id="bigClock" class="clock-time">00:00:00</div>
          <div id="bigDate" class="clock-date">-- -- ----</div>
          <div style="margin-top:8px;font-size:12px;opacity:.9">
            حالة النظام: <span id="systemStatus">جاهز</span>
          </div>
        </div>
        <div style="flex:1;min-width:260px;text-align:center">
          <input id="manualCode" placeholder="ادخل كود الموظف يدوياً"
            style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgb(0,0,0);color:var(--text);width:80%;max-width:280px;text-align:right" />
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
            <button class="btn btn-primary" id="btnIn">تسجيل الحضور</button>
            <button class="btn btn-primary" id="btnOut">تسجيل الانصراف</button>
            <button class="btn btn-secondary" id="btnQrProfile"> توليد باركود</button>

          </div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:center">
            <canvas id="qrCanvas" width="120" height="120" style="background:#fff;border-radius:8px"></canvas>
            <div style="opacity:.85;font-size:12px">QR تجريبي (يتحدّث كل 3 ث)</div>
          </div>
        </div>
      </div>
      <div id="employeePreview" class="employee-card" style="margin:12px auto;display:none;max-width:400px">
        <img id="empPhoto" class="emp-photo" src="" alt="صورة الموظف" />
        <div class="emp-meta">
          <h3 id="empName">اسم الموظف</h3>
          <p id="empJob">المسمى الوظيفي • القسم</p>
          <p id="empStatusLine" style="margin-top:6px"></p>
        </div>
      </div>
      <div style="text-align:center;margin:12px 0">
        <button class="btn btn-secondary" id="clearPreview">مسح</button>
        <button class="btn btn-secondary" id="toggleStats">إظهار/إخفاء الإحصائيات</button>
      </div>
      <div class="last-records card" style="margin:16px 0;padding:12px">
        <h3 style="margin:0 0 8px 0;text-align:right">آخر الحركات (اليوم)</h3>
        <div id="recentList" style="text-align:right;direction:rtl" class="list"></div>
      </div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;padding:12px">
        <div style="flex:1;min-width:260px" class="card">
          <div class="card-header text-center">الإحصائيات اللحظية</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;padding:0 8px">
            <button class="btn btn-primary" id="exportCSV"> تصدير CSV</button>
            <div style="text-align:right">
              <div style="font-weight:800;font-size:18px" id="todayLabel">اليوم</div>
            </div>
          </div>
          <div class="stats" style="display:flex;justify-content:space-around;text-align:center;margin:12px 0">
            <div class="stat">
              <h4 id="statPresent">0</h4>
              <p>حضور</p>
            </div>
            <div class="stat">
              <h4 id="statLate">0</h4>
              <p>متأخرين</p>
            </div>
            <div class="stat">
              <h4 id="statOut">0</h4>
              <p>انصراف</p>
            </div>
            <div class="stat">
              <h4 id="statEarly">0</h4>
              <p>انصراف مبكر</p>
            </div>
          </div>
        </div>
        <div style="flex:2;min-width:320px" class="card">
          <div class="card-header text-center">قائمة الحضور اليومي</div>
          <div style="overflow:auto;max-height:320px">
            <table id="reportTable" style="width:100%">
              <thead>
                <tr>
                  <th>الموظف</th>
                  <th>كود</th>
                  <th>دخول</th>
                  <th>حالة الدخول</th>
                  <th>خروج</th>
                  <th>حالة الخروج</th>
                </tr>
              </thead>
              <tbody id="reportBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="card" style="margin:16px 0;padding:12px">
        <div class="card-header text-center">حضور آخر 7 أيام</div>
        <div style="height:200px">
          <canvas id="chart"></canvas>
        </div>
      </div>
      <div id="flash" class="flash"></div>
    </div>
  </div>

  <div class="content" id="BasicDefinitions">
    <div class="card">
      <div class="card-header text-center"> تعريفات أساسية </div>

      <div class="grid-container">
        <div class="grid-item">
          <label>اسم الشركة</label>
          <select id="companySelect3" onchange="loadBasicDefinitions()">
            <option value="">-- اختر الشركة --</option>
          </select>
        </div>
      </div>

      <div class="grid-container">
        <div class="grid-item" iv>
          <label>وقت الحضور</label>
          <input type="time" id="start_time" value="08:00">
        </div>
        <div class="grid-item">
          <label>وقت الانصراف</label>
          <input type="time" id="end_time" value="16:00">
        </div>
      </div>

      <div class="grid-container">
        <div class="grid-item">
          <label>أقصى وقت للحضور</label>
          <input type="number" id="max_in" value="10">
        </div>
        <div class="grid-item">
          <label>أقصى وقت للانصراف</label>
          <input type="number" id="max_out" value="10">
        </div>
      </div>

      <div class="grid-container">
        <div class="grid-item">
          <label>مدة الاستراحة (بالدقائق)</label>
          <input type="number" id="break_time" value="60">
        </div>
        <div class="grid-item">
          <label>مدة العمل الإضافي (بالدقائق)</label>
          <input type="number" id="overtime" value="60">
        </div>
      </div>
      <div class="card-footer">
        <button class="save-btn" onclick="saveBasicDefinitions()">💾 حفظ التعريفات الأساسية</button>
      </div>
    </div>
  </div>

  <div class="content" id="InsuranceCases">
    <div class="card">
      <div class="card-header text-center">إدارة الحاله التأمينية</div>

      <form id="statusForm" class="grid-container">
        <div class="grid-item">
          <label>كود الحالة</label>
          <input id="statusCode" type="text" placeholder="مثال: S01">
        </div>
        <div class="grid-item">
          <label>الوصف</label>
          <input id="statusDesc" type="text" placeholder="أدخل وصف الحالة التأمينية">
        </div>
      </form>
      <button type="button" onclick="saveStatus()">💾 إضافة/تعديل</button>

      <div class="list-container">
        <div class="card-header text-center">الحالات المسجلة</div>
        <table border="1" width="100%">
          <thead>
            <tr>
              <th>الكود</th>
              <th>الوصف</th>
            </tr>
          </thead>
          <tbody id="statusTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="content" id="InsuranceOffices">
    <div class="card">
      <div class="card-header text-center">إدارة مكاتب التأمين</div>

      <form id="statusForm" class="grid-container">
        <div class="grid-item">
          <label> اسم المكتب</label>
          <input id="officeName" type="text" placeholder="اسم مكتب التأمين">
        </div>
        <div class="grid-item">
          <label>رقم المكتب</label>
          <input id="officeNumber" type="text" placeholder="رقم المكتب">
        </div>
      </form>
      <button type="button" onclick="addOffice()">💾 إضافة/تعديل</button>

      <div class="list-container">
        <div class="card-header text-center">الحالات المسجلة</div>
        <table border="1" width="100%">
          <thead>
            <tr>
              <th>اسم المكتب</th>
              <th>رقم المكتب</th>
            </tr>
          </thead>
          <tbody id="officesTable">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="content" id="FunctionalStructure">
    <div class="card">
      <div class="card-header text-center"> الهيكل الوظيفي</div>
      <div class="grid-container">
        <form id="deptForm" class="grid-item">
          <div class="card-header text-center"> إضافة قسم</div>
          <label>كود القسم</label>
          <input type="text" id="deptCode" required>
          <label>اسم القسم</label>
          <input type="text" id="deptName" required>
          <label>القسم التابع له</label>
          <select id="parentDept"></select>
          <button type="submit">💾 إضافة قسم</button>
        </form>

        <form id="empForm" class="grid-item">
          <div class="card-header text-center"> إضافة موظف</div>
          <label>كود الموظف</label>
          <input type="text" id="empCode">
          <label>اسم الموظف</label>
          <input type="text" id="empName" required>
          <label>المسمى الوظيفي</label>
          <input type="text" id="empTitle" required>
          <label>القسم التابع له</label>
          <select id="empDept"></select>
          <button type="submit"> 💾 إضافة موظف</button>
        </form>
      </div>
      <button onclick="generateOrgChartPDF()">📑 تحميل الهيكل PDF</button>
    </div>
    <div class="card-header text-center"> شجره الهيكل الوظيفي </div>
    <div class="chart">
      <div id="tree" class="tree"></div>
    </div>
  </div>


  <div class="content" id="HrForm">
    <div class="card">
      <div class="card-header text-center">بيانات الموظفين</div>
      <div class="tabs">
        <button class="active" onclick="openTab(event, 'personal')">البيانات الشخصية</button>
        <button onclick="openTab(event, 'education')">التعليم</button>
        <button onclick="openTab(event, 'skills')">المهارات</button>
        <button onclick="openTab(event, 'finance')">الخزينة</button>
        <button onclick="openTab(event, 'social')">التفاصيل الاجتماعية</button>
        <button onclick="openTab(event, 'job')">بيانات الوظيفة</button>
        <button onclick="openTab(event, 'Justifications')">مسوغات التعين</button>
        <button onclick="openTab(event, 'reports')">استعلام عن الموظفين</button>
      </div>

      <div id="personal" class="tab-content active">
        <h2>البيانات الشخصية</h2>
        <form id="employeeForm" class="grid-container">
          <div class="grid-item">
            <label>كود الموظف</label>
            <input id="employeeCode" type="text" placeholder="اتركه فارغ لتوليد كود تلقائي">
          </div>

          <div class="grid-item">
            <label>الاسم الكامل</label>
            <input id="fullName" type="text" placeholder="ادخل الاسم">
          </div>

          <div class="grid-item">
            <label>المحافظة</label>
            <select id="governorate">
              <option>-- اختر المحافظة --</option>
              <option>القاهرة</option>
              <option>الجيزة</option>
              <option>الإسكندرية</option>
            </select>
          </div>

          <div class="grid-item">
            <label>المدينة</label>
            <input id="city" type="text" placeholder="ادخل المدينة">
          </div>

          <div class="grid-item">
            <label>الشارع</label>
            <input id="street" type="text" placeholder="ادخل الشارع">
          </div>

          <div class="grid-item">
            <label>تاريخ الميلاد</label>
            <input id="dob" type="date">
          </div>

          <div class="grid-item">
            <label>محل الميلاد</label>
            <input id="birthPlace" type="text" placeholder="ادخل محل الميلاد">
          </div>

          <div class="grid-item">
            <label>رقم البطاقة</label>
            <input id="nid" type="text" placeholder="ادخل الرقم القومي">
          </div>

          <div class="grid-item">
            <label>الديانة</label>
            <select id="religion">
              <option>-- اختر --</option>
              <option>مسلم</option>
              <option>مسيحي</option>
              <option>أخرى</option>
            </select>
          </div>

          <div class="grid-item">
            <label>الحالة الاجتماعية</label>
            <select id="maritalStatus">
              <option>-- اختر --</option>
              <option>أعزب</option>
              <option>متزوج</option>
              <option>مطلق</option>
              <option>أرمل</option>
            </select>
          </div>

          <div class="grid-item">
            <label>النوع</label>
            <select id="gender">
              <option>-- اختر --</option>
              <option>ذكر</option>
              <option>أنثى</option>
            </select>
          </div>
          <div class="grid-item">
            <label>رقم هاتف الموظف </label>
            <input id="numberEmployess" type="number" placeholder="ادخل رقم هاتف الموظف ">
          </div>
        </form>
      </div>

      <div id="education" class="tab-content">
        <h2>المؤهلات التعليمية</h2>
        <form id="educationForm" class="grid-container">

          <div class="grid-item">
            <label>المؤهل الدراسي</label>
            <select id="qualification">
              <option>-- اختر المؤهل --</option>
              <option>ابتدائي</option>
              <option>إعدادي</option>
              <option>ثانوي</option>
              <option>دبلوم</option>
              <option>بكالوريوس / ليسانس</option>
              <option>ماجستير</option>
              <option>دكتوراه</option>
            </select>
          </div>

          <div class="grid-item">
            <label>التخصص</label>
            <input id="specialization" type="text" placeholder="ادخل التخصص">
          </div>

          <div class="grid-item">
            <label>الجامعة / المعهد</label>
            <input id="university" type="text" placeholder="ادخل اسم الجامعة أو المعهد">
          </div>

          <div class="grid-item">
            <label>سنة التخرج</label>
            <input id="graduationYear" type="number" placeholder="ادخل سنة التخرج">
          </div>

          <div class="grid-item">
            <label>التقدير العام</label>
            <select id="grade">
              <option>-- اختر --</option>
              <option>مقبول</option>
              <option>جيد</option>
              <option>جيد جدا</option>
              <option>امتياز</option>
            </select>
          </div>

          <div class="grid-item">
            <label>دورات تدريبية</label>
            <textarea id="courses" placeholder="ادخل الدورات التدريبية إن وجدت"></textarea>
          </div>

        </form>
      </div>

      <div id="skills" class="tab-content">
        <h2>المهارات</h2>
        <form id="skillsForm" class="grid-container">
          <div class="grid-item"><label>اسم المهارة</label><input id="skillName" type="text"></div>
          <div class="grid-item"><label>المستوى</label><select id="skillLevel">
              <option>-- اختر --</option>
              <option>مبتدئ</option>
              <option>متوسط</option>
              <option>متقدم</option>
            </select></div>
        </form>
      </div>

      <div id="finance" class="tab-content">
        <h2>الخزينة</h2>
        <form id="financeForm" class="grid-container">
          <div class="grid-item">
            <label>مركز التكلفة</label>
            <select id="employeeCostCenter">
              <option value="">-- اختر مركز تكلفة --</option>
            </select>
          </div>
          <div class="grid-item"><label>الحساب البنكي</label><input id="allowances" type="number"></div>
          <div class="grid-item"><label>اراتب الاساسي</label><input id="salary" type="number"></div>
          <div class="grid-item"><label>حوافز</label><input id="salary2" type="number"></div>
        </form>
      </div>

      <div id="social" class="tab-content">
        <div class="card">
          <div class="card-header">بيانات التأمين الاجتماعي</div>
          <form id="insuranceForm" class="grid-container">

            <div class="grid-item">
              <label>رقم التأمين</label>
              <input id="insuranceNumber" type="text" placeholder="أدخل رقم التأمين">
            </div>

            <div class="grid-item">
              <label>الحالة التأمينية</label>
              <select id="basicInsuranceStatus">
                <option value="">-- اختر الحالة التأمينية --</option>
              </select>
            </div>

            <div class="grid-item">
              <label>تاريخ بداية الاشتراك</label>
              <input id="insuranceStart" type="date">
            </div>

            <div class="grid-item">
              <label>الراتب التأميني (أساسي فقط)</label>
              <input id="insuranceSalary" type="number" placeholder="الراتب التأميني" oninput="calcContribution()">
            </div>

            <div class="grid-item">
              <label>نسبة حصة الموظف (%)</label>
              <input id="employeeShare" type="number" value="14" oninput="calcContribution()">
            </div>

            <div class="grid-item">
              <label>نسبة حصة الشركة (%)</label>
              <input id="companyShare" type="number" value="26" oninput="calcContribution()">
            </div>

            <div class="grid-item">
              <label>خصم الموظف من الراتب</label>
              <input id="employeeDeduction" type="number" readonly>
            </div>

            <div class="grid-item">
              <label>إجمالي الاشتراك الشهري</label>
              <input id="totalContribution" type="number" readonly>
            </div>

            <div class="grid-item">
              <label>مكتب التأمين</label>
              <select id="linkedInsuranceOffice" onchange="updateInsuranceOffice(this)">
                <option value="">-- اختر مكتب التأمين --</option>
              </select>
            </div>

            <div class="grid-item">
              <label>رقم مكتب التأمين</label>
              <input id="linkedInsuranceOfficeNumber" type="text" readonly>
            </div>
          </form>
        </div>
      </div>

      <div id="job" class="tab-content">
        <div class="card">
          <div class="card-header"> بيانات الوظيفة</div>
          <form id="jobForm" class="grid-container">

            <fieldset class="group">
              <div class="card-header">التوزيع التنظيمي</div>
              <div class="grid-item">
                <label>القسم / الإدارة</label>
                <select id="jobDept"></select>
              </div>
              <div class="grid-item">
                <label>المسمى الوظيفي</label>
                <input id="jobTitle" type="text">
              </div>

            </fieldset>

            <fieldset class="group">
              <div class="card-header">الوضع الوظيفي</div>
              <div class="grid-item">
                <label>الحالة</label>
                <select id="jobStatus">
                  <option value="active">نشط</option>
                  <option value="suspended">موقوف</option>
                  <option value="resigned">مستقيل</option>
                  <option value="retired">متقاعد</option>
                </select>
              </div>
              <div class="grid-item">
                <label>نوع التوظيف</label>
                <select id="employmentType">
                  <option>دوام كامل</option>
                  <option>دوام جزئي</option>
                  <option>عقد</option>
                  <option>متدرب</option>
                  <option>استشاري</option>
                </select>
              </div>
              <div class="grid-item">
                <label>الدرجة</label>
                <select id="jobGrade">
                  <option>أولى</option>
                  <option>ثانية</option>
                  <option>مدير</option>
                  <option>إدارة عليا</option>
                </select>
              </div>
            </fieldset>

            <fieldset class="group">
              <div class="card-header">التواريخ</div>
              <div class="grid-item"><label>تاريخ التعيين</label><input id="hireDate" type="date"></div>
              <div class="grid-item"><label>بداية العقد</label><input id="contractStart" type="date"></div>
              <div class="grid-item"><label>نهاية العقد</label><input id="contractEnd" type="date"></div>
            </fieldset>

            <fieldset class="group">
              <div class="card-header">التدرج الوظيفي</div>
              <div class="grid-item"><label>الوظيفة السابقة</label><input id="previousJob" type="text"></div>
              <div class="grid-item"><label>الوظيفة الحالية</label><input id="currentJob" type="text"></div>
              <div class="grid-item"><label>تاريخ آخر ترقية</label><input id="lastPromotionDate" type="date"></div>
            </fieldset>

            <fieldset class="group">
              <div class="card-header">تفاصيل إضافية</div>
              <div class="grid-item"><label>ساعات العمل</label><input id="workHours" type="number"></div>
              <div class="grid-item"><label>نظام الورديات</label>
                <select id="shiftType">
                  <option>صباحي</option>
                  <option>مسائي</option>
                  <option>مناوبات</option>
                </select>
              </div>
              <div class="grid-item">
                <label>المنطقة</label>
                <select id="employeeRegion">
                  <option value="">-- اختر المنطقة --</option>
                </select>
              </div>
        </div>
        </fieldset>
        </form>
      </div>
      <div id="Justifications" class="tab-content">
        <div class="card">
          <div class="card-header"> مسوغات التعين الوظيفة</div>
          <form id="JustificationsForm" class="grid-container">

          </form>
        </div>
      </div>

      <div id="reports" class="tab-content">
        <h2>التقارير</h2>
        <p>تقارير الموظف.</p>
      </div>
      <div class="card-footer">
        <button class="save-btn" onclick="saveAll()">💾 حفظ البيانات</button>
      </div>
    </div>
  </div>

  <div id="gpsForm" class="content">
    <div class="card">
      <div class="card-header text-center">
        إدارة أجهزة GPS
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="docNumberGPS">رقم مستند الجهاز </label>
          <input type="text" id="docNumberGPS" name="docNumberGPS" required placeholder="أدخل رقم مستند الجهاز">

          <label for="companySelect2">اختر الشركة:</label>
          <select id="companySelect2" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeGps">

          <label for="locationGPS">موقع الجهاز</label>
          <select id="locationGPS" name="locationGPS" required>
            <option value="">- Location -</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="installDateGPS">تاريخ التركيب</label>
          <input type="date" id="installDateGPS" class="form-control">

          <label for="carLicenseGPS">رخصه المركبه</label>
          <input type="text" id="carLicenseGPS" class="form-control" placeholder="أدخل رقم لوحة المركبة">

          <label for="carTypeGPS">نوع المركبة</label>
          <input type="text" id="carTypeGPS" class="form-control" placeholder="أدخل نوع المركبة">
        </div>

        <div class="grid-item">
          <label for="imeiGPS">IMEI</label>
          <input type="text" id="imeiGPS" class="form-control" placeholder="أدخل IMEI">

          <label for="GPSType">نوع الجهاز</label>
          <select id="GPSType">
            <option value="">-- Select the device --</option>
          </select>

          <label for="GPSModel">موديل الجهاز</label>
          <select id="GPSModel">
            <option value="">-- Device type --</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="employeeNameGPS">اسم الموظف المسؤول</label>
          <input type="text" id="employeeNameGPS" class="form-control" placeholder="مثال: م/ أحمد علي">

          <label for="lineNumberGPS">رقم الخط</label>
          <input type="text" id="lineNumberGPS" class="form-control" placeholder="أدخل رقم الخط">

          <label for="simNumberGPS">رقم الشريحة (SIM)</label>
          <input type="text" id="simNumberGPS" class="form-control" placeholder="أدخل رقم الشريحة">
        </div>

        <div class="grid-item">
          <label for="statusGPS">الحالة</label>
          <select id="statusGPS" class="form-select">
            <option value="active">نشط</option>
            <option value="inactive">غير نشط</option>
            <option value="maintenance">صيانة</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="notesGPS">ملاحظات</label>
          <textarea id="notesGPS" class="form-control" rows="3" placeholder="أدخل أي ملاحظات إضافية..."></textarea>
        </div>

      </div>
      <button onclick="saveDataGPS()">💾 حفظ</button>
    </div>
  </div>


  <div id="gpsQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        البحث عن جهاز GPS
      </div>
      <div class="grid-container">

        <div class="grid-item">
          <label for="queryCompanySelectGps">اختر الشركة:</label>
          <select id="queryCompanySelectGps" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeGps">
        </div>
        <div class="grid-item">
          <label>: تاريخ </label>
          <input type="date" id="querydateAddedGPS">
        </div>
        <div class="grid-item">
          <label>: رقم مستند الجهاز </label>
          <input type="text" id="queryGPS">
        </div>
        <div class="grid-item">
          <label>: المستخدم </label>
          <input type="text" id="queryGPSUser">
        </div>
        <div class="grid-item">
          <label> : نوع الجهاز </label>
          <select id="queryGpsType">
            <option value="">-- Select the device --</option>
          </select>
        </div>
        <div class="grid-item">
          <label>: موقع الجهاز </label>
          <select id="queryLocationGPS" name="Location" required>
            <option value="">- Location -</option>
          </select>
        </div>
      </div>
    </div>
    <hr>
    <div class="card">
      <div class="toolbar">
        <div class="button-group">
          <button onclick="printTableGPS()">🖨️ طباعة</button>
          <button onclick="exportToExcelGPS()">📥 تحميل كملف Excel</button>
          <button id="toggleColumnBtn" onclick="toggleColumnFilter()">🔽 اختيار الأعمدة</button>
          <button onclick="searchDataGPS()">🔍 بحث</button>
        </div>
        <div class="search-box">
          <label for="generalSearchGPS">بحث : </label>
          <input type="text" id="generalSearchGPS" placeholder="اكتب كلمة للبحث..." oninput="searchData()"
            style="width: 100%; padding: 6px;">
        </div>
        <div id="columnFilterBoxGps" style="display: none;">
          <div id="columnCheckboxesGps"></div>
          <button onclick="applyColumnFilterGPS()">✔ تطبيق</button>
        </div>
      </div>
      <div id="queryResultsGps"
        style="overflow-y: auto; height: 400px; border: 1px solid #cccccc00; padding: 10px; margin-top: 10px;">
      </div>
    </div>
  </div>

  <div id="gpsSettings" class="content" style="display: none;">

    <div class="card mb-3">
      <div class="card-header text-center">
        GPS إضافة نوع جهاز وموديلات
      </div>
      <label for="GPSTypeInput">نوع الجهاز:</label>
      <input type="text" id="GPSTypeInput" placeholder="مثال: كمبيوتر مكتبي">

      <label for="GPSModelsInput">الموديلات (افصل بينها بفاصلة):</label>
      <input type="text" id="GPSModelsInput" placeholder="مثال: Dell, HP, Lenovo">
      <hr>
      <button onclick="addGPSData()">💾 حفظ الإعدادات</button>

      <div class="card mb-3">

        <div class="card-header text-center" id="createUserTitle">
          أنواع الأجهزة والموديلات
        </div>

        <table id="GPSTable">
          <thead>
            <tr>
              <th>نوع الجهاز</th>
              <th>الموديلات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="content" id="fixedAssetsDepreciation">
    <div class="card">
      <div class="card-header text-center">الأصول الثابتة والإهلاك</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
        <input id="searchAsset" placeholder="بحث (الكود/الوصف)..."
          style="padding:8px 10px;flex:1;min-width:180px;border:1px solid #ddd;border-radius:8px">
        <select id="filterCostCenter" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:220px">
          <option value="">كل مراكز التكلفة</option>
        </select>
        <select id="filterDeviceType" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;min-width:180px">
          <option value="">كل الأنواع</option>
          <option>كمبيوتر</option>
          <option>شاشة</option>
          <option>طابعة</option>
          <option>أخرى</option>
        </select>
        <button id="btnRefreshAssets"
          style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fafafa;cursor:pointer">تحديث</button>
      </div>

      <form id="assetForm" onsubmit="return false"
        style="background:#fff;border:1px solid #eee;border-radius:12px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.04)">
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:12px">
          <input id="assetId" type="hidden"> <!-- لحفظ مفتاح السجل عند التعديل -->

          <div style="grid-column:span 3">
            <label>كود الأصل</label>
            <input id="assetCode" placeholder="FA-100 (تلقائي)"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
          </div>

          <div style="grid-column:span 5">
            <label>الوصف</label>
            <input id="description" placeholder="مثال: كمبيوتر HP Core i7"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
          </div>

          <div style="grid-column:span 4">
            <label>مركز التكلفة</label>
            <select id="assetCostCenter" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
              <option value="">— اختر —</option>
            </select>
          </div>

          <div style="grid-column:span 3">
            <label>نوع الأصل</label>
            <select id="deviceType" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
              <option value="">— اختر —</option>
              <option>كمبيوتر</option>
              <option>شاشة</option>
              <option>طابعة</option>
              <option>أخرى</option>
            </select>
          </div>

          <div style="grid-column:span 4">
            <label>جهاز مرتبط</label>
            <select id="linkedDevice" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
              <option value="">— لا يوجد —</option>
            </select>
            <small id="linkedHint" style="color:#777">سيتم تحميل الأجهزة حسب النوع</small>
          </div>

          <div style="grid-column:span 2">
            <label>التكلفة (جنيه)</label>
            <input id="cost" type="number" step="0.01" min="0" placeholder="0.00"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
          </div>

          <div style="grid-column:span 2">
            <label>قيمة متبقية (اختياري)</label>
            <input id="residual" type="number" step="0.01" min="0" placeholder="0.00"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
          </div>

          <div style="grid-column:span 3">
            <label>تاريخ الشراء</label>
            <input id="purchaseDate" type="date" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
          </div>

          <div style="grid-column:span 2">
            <label>العمر الإنتاجي (سنوات)</label>
            <input id="usefulLife" type="number" min="1" placeholder="5"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
          </div>

          <div style="grid-column:span 2">
            <label>طريقة الإهلاك</label>
            <select id="depMethod" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px">
              <option value="straight-line" selected>القسط الثابت</option>
            </select>
          </div>

          <div style="grid-column:span 2">
            <label>نسبة سنوية (٪)</label>
            <input id="depRate" type="number" min="0" step="0.01" placeholder="يُحسب تلقائياً"
              style="width:100%;padding:8px;border:1px solid #ddd;border-radius:8px" readonly>
          </div>

          <div style="grid-column:span 12;display:flex;gap:8px;flex-wrap:wrap;margin-top:4px">
            <button id="btnCalc" type="button"
              style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;cursor:pointer;background:#f6f6f6">حساب
              الإهلاك الآن</button>
            <button id="btnSave" type="button"
              style="padding:8px 12px;border:1px solid #1a7f37;border-radius:8px;cursor:pointer;background:#1f8f42;color:#fff">حفظ
              / تحديث</button>
            <button id="btnClear" type="button"
              style="padding:8px 12px;border:1px solid #ddd;border-radius:8px;cursor:pointer;background:#fafafa">تفريغ</button>
          </div>

          <div style="grid-column:span 12;display:flex;gap:16px;flex-wrap:wrap;margin-top:6px;color:#444">
            <div>مجمع الإهلاك: <b id="outAccum">0.00</b></div>
            <div>القيمة الدفترية: <b id="outNBV">0.00</b></div>
            <div>حتى تاريخ: <b id="outAsOf">—</b></div>
          </div>
        </div>
      </form>

      <div style="margin-top:14px;border:1px solid #eee;border-radius:12px;overflow:auto">
        <table id="assetsTable" style="width:100%;border-collapse:collapse;min-width:880px">
          <thead style="background:#fafafa">
            <tr>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">الكود</th>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">الوصف</th>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">النوع</th>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">مركز التكلفة</th>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">التكلفة</th>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">مجمع الإهلاك</th>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">القيمة الدفترية</th>
              <th style="text-align:right;padding:10px;border-bottom:1px solid #eee">معدل الإهلاك</th>

            </tr>
          </thead>
          <tbody id="assetsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="content" id="costCenters">
    <div class="card">
      <div class="card-header text-center">تكويد مراكز التكلفة</div>
      <div class="card">

        <div style="display:flex; gap:20px;">
          <div style="flex:1;">
            <div class="grid-item">
              <label>رقم المركز:</label>
              <input type="text" id="costCenterCode" readonly><br>
            </div>

            <div class="grid-item">
              <label>اسم المركز:</label>
              <input type="text" id="costCenterName"><br>
            </div>

            <div class="grid-item">
              <label>المستوى:</label>
              <input type="number" id="costCenterLevel" readonly><br>
            </div>

            <div class="grid-item">
              <label>المركز الرئيسي:</label>
              <select id="parentCostCenter"></select><br>
            </div>
            <div class="grid-item">
              <label>الوصف:</label>
              <input type="text" id="costCenterDesc"><br>
            </div>

            <button onclick="window.saveCostCenter()">💾 حفظ</button>
          </div>

          <div style="flex:2; border:1px solid #ccc; padding:10px; max-height:400px; overflow:auto;">
            <h3>📂 شجرة مراكز التكلفة</h3>
            <ul id="costCenterTree"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="content active" id="Dashboard">
    <div class="card">
      <div class="card-header text-center">📊 Dashboard</div>

      <div class="chart-row">
        <div class="chart-card">
          <h4>الإحصائيات المجمعة</h4>
          <canvas id="combinedChart"></canvas>
        </div>
      </div>

      <div class="chart-row">
        <div class="chart-card">
          <h4>الإحصائيات حسب الموقع</h4>
          <canvas id="locationChart"></canvas>
        </div>
        <div class="chart-card">
          <h4>الإحصائيات حسب الصنف</h4>
          <canvas id="itemChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div id="PageSettings" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">إعدادات الصفحة</div>
      <div class="grid-container p-3">
        <div class="grid-item mb-3">
          <label>اسم الصفحة:</label>
          <input type="text" id="pageName" class="form-control">
        </div>

        <div class="grid-item mb-3">
          <label>شعار الصفحة (لوجو):</label>
          <input type="file" id="logoFile" class="form-control">
          <img id="logoPreview" src="" alt="شعار" width="100" style="display:none; margin-top: 10px;">
        </div>

        <button id="saveButton" class="btn btn-success">💾 حفظ الإعدادات</button>
      </div>
    </div>
  </div>

  <div id="computerForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        إضافة جهاز كمبيوتر
      </div>
      <div class="grid-container">


        <div class="grid-item">
          <label for="companySelect">اختر الشركة:</label>
          <select id="companySelect" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCode">
        </div>


        <div class="grid-item">
          <label>: رقم مستند الجهاز </label>
          <input type="number" id="pcNum">
        </div>

        <div class="grid-item">
          <label>: تاريخ </label>
          <input type="date" id="dateAdded">
        </div>

        <div class="grid-item">
          <label>: حاله الجهاز </label>
          <select id="pcStatus">
            <option value=""> - status -</option>
            <option value="In Services">In Services</option>
            <option value="Out Of Services">Out Of Services</option>
            <option value="Maintenance">Maintenance</option>
            <option value="working">working</option>
          </select>
        </div>


        <div class="grid-item">
          <label>: موقع الجهاز </label>
          <select id="pcLocation" name="pcLocation" required>
            <option value=""> - Location -</option>
          </select>
        </div>

        <div class="grid-item">
          <label> : مستخدم الجهاز </label>
          <input type="text" id="pcUserCode" placeholder="مثال: 791">
          <input list="usersList" type="text" id="pcUser" placeholder="اسم المستخدم">
          <datalist id="usersList"></datalist>
        </div>

        <div class="grid-item">
          <label for="deviceType1">: نوع الجهاز </label>
          <select id="deviceType1">
            <option value="">-- Select the device --</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="deviceModel">: موديل </label>
          <select id="deviceModel">
            <option value="">-- Device type --</option>
          </select>
        </div>
        <div class="grid-item full-width">
          <div class="card">
            <div class="card-header text-center">
              PC CONFIGURATION
            </div>
            <table>
              <tr>
                <th>UNIT</th>
                <th>BRAND</th>
                <th>CONFIGURATION</th>
                <th>S/N</th>
              </tr>
              <tr>
                <td>M/B</td>
                <td><input type="text" id="brandMB"></td>
                <td><input type="text" id="configMB"></td>
                <td><input type="text" id="snMB"></td>
              </tr>
              <tr>
                <td>PROCESSOR</td>
                <td><input type="text" id="PROCESSOR"></td>
                <td><input type="text" id="configPROCESSOR"></td>
                <td><input type="text" id="snPROCESSOR"></td>
              </tr>
              <tr>
                <td>H.D.D</td>
                <td><input type="text" id="H.D.D"></td>
                <td><input type="text" id="configH.D.D"></td>
                <td><input type="text" id="snH.D.D"></td>
              </tr>
              <tr>
                <td>S.D.D</td>
                <td><input type="text" id="S.D.D"></td>
                <td><input type="text" id="configS.D.D"></td>
                <td><input type="text" id="snS.D.D"></td>
              </tr>
              <tr>
                <td>DVD</td>
                <td><input type="text" id="DVD"></td>
                <td><input type="text" id="configDVD"></td>
                <td><input type="text" id="snDVD"></td>
              </tr>
              <tr>
                <td>MONITOE</td>
                <td><input type="text" id="MONITOE"></td>
                <td><input type="text" id="configMONITOE"></td>
                <td><input type="text" id="snMONITOE"></td>
              </tr>
              <tr>
                <td>KEYBORD</td>
                <td><input type="text" id="KEYBORD"></td>
                <td><input type="text" id="configKEYBORD"></td>
                <td><input type="text" id="snKEYBORD"></td>
              </tr>
              <tr>
                <td>MOUSE</td>
                <td><input type="text" id="MOUSE"></td>
                <td><input type="text" id="configMOUSE"></td>
                <td><input type="text" id="snMOUSE"></td>
              </tr>
              <tr>
                <td>USB MODEM</td>
                <td><input type="text" id="USBMODEM"></td>
                <td><input type="text" id="configUSBMODEM"></td>
                <td><input type="text" id="snUSBMODEM"></td>
              </tr>
              <tr>
                <td>ACCESSORIES</td>
                <td><input type="text" id="ACCESSORIES"></td>
                <td><input type="text" id="configACCESSORIES"></td>
                <td><input type="text" id="snACCESSORIES"></td>
              </tr>
              <tr>
                <td>SYS & APPS</td>
                <td><input type="text" id="SYSAPPS"></td>
                <td><input type="text" id="configSYSAPPS"></td>
                <td><input type="text" id="snSYSAPPS"></td>
              </tr>

            </table>
            <div class="grid-item">
              <label>: ملاحظات </label>
              <input type="text" id="note">
            </div>
          </div>
        </div>
      </div>
      <hr>
      <button onclick="saveData()">💾 حفظ مستند الجهاز </button>
    </div>
  </div>

  <div id="computerQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        البحث عن جهاز كمبيوتر او لابتوب
      </div>
      <div class="grid-container">

        <div class="grid-item">
          <label for="queryCompanySelect">اختر الشركة:</label>
          <select id="queryCompanySelect" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCode">
        </div>
        <div class="grid-item">
          <label>: تاريخ </label>
          <input type="date" id="querydateAdded">
        </div>
        <div class="grid-item">
          <label>: رقم مستند الجهاز </label>
          <input type="text" id="queryPcNum">
        </div>
        <div class="grid-item">
          <label>: المستخدم </label>
          <input type="text" id="queryPcUser">
        </div>
        <div class="grid-item">
          <label> : نوع الجهاز </label>
          <select id="queryDeviceType">
            <option value="">-- Select the device --</option>
          </select>
        </div>
        <div class="grid-item">
          <label>: موقع الجهاز </label>
          <select id="queryPcLocation" name="Location" required>
            <option value="">- Location -</option>
          </select>
        </div>
      </div>
    </div>
    <hr>
    <div class="card">
      <div class="toolbar">
        <div class="button-group">
          <button onclick="printTable()">🖨️ طباعة</button>
          <button onclick="exportToExcel()">📥 تحميل كملف Excel</button>
          <button id="toggleColumnBtn" onclick="toggleColumnFilter()">🔽 اختيار الأعمدة</button>
          <button onclick="searchData()">🔍 بحث</button>
        </div>
        <div class="search-box">
          <label for="generalSearch">بحث : </label>
          <input type="text" id="generalSearch" placeholder="اكتب كلمة للبحث..." oninput="searchData()"
            style="width: 100%; padding: 6px;">
        </div>
        <div id="columnFilterBox" style="display: none;">
          <div id="columnCheckboxes"></div>
          <button onclick="applyColumnFilter()">✔ تطبيق</button>
        </div>
      </div>
      <div id="queryResults"
        style="overflow-y: auto; height: 400px; border: 1px solid #cccccc00; padding: 10px; margin-top: 10px;">
      </div>
    </div>
  </div>

  <div id="computerSettings" class="content" style="display: none;">

    <div class="card mb-3">
      <div class="card-header text-center">
        PC إضافة نوع جهاز وموديلات
      </div>
      <label for="deviceTypeInput">نوع الجهاز:</label>
      <input type="text" id="deviceTypeInput" placeholder="مثال: كمبيوتر مكتبي">

      <label for="deviceModelsInput">الموديلات (افصل بينها بفاصلة):</label>
      <input type="text" id="deviceModelsInput" placeholder="مثال: Dell, HP, Lenovo">
      <hr>
      <button onclick="addDeviceData()">💾 حفظ الإعدادات</button>

      <div class="card mb-3">

        <div class="card-header text-center" id="createUserTitle">
          أنواع الأجهزة والموديلات
        </div>

        <table id="deviceTable">
          <thead>
            <tr>
              <th>نوع الجهاز</th>
              <th>الموديلات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="phoneForm" class="content" style="display: none;">

    <div class="card">
      <div class="card-header text-center">
        تسجيل بيانات الهاتف
      </div>
      <form class="grid-container">
        <div class="grid-item">
          <label for="companySelectPhone">اختر الشركة:</label>
          <select id="companySelectPhone" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodePhone">
          <label for="documentNumber"> رقم مستند الجهاز:</label>
          <input type="number" id="documentNumberPhone" name="documentNumber" required>
          <label for="employeeName"> اسم الموظف:</label>
          <input type="text" id="employeeNamePhone" name="employeeName" required>
          <label for="location"> الموقع:</label>
          <select id="locationPhone" name="Location" required>
            <option value=""> - Location -</option>
          </select>
          <label for="date"> التاريخ:</label>
          <input type="date" id="datePhone" name="date" required>
        </div>

        <div class="grid-item">
          <label for="phoneType"> نوع الهاتف:</label>
          <select id="phoneType" name="phoneType" required>
            <option value="">اختر نوع الهاتف</option>
          </select>
          <label for="phoneModel"> موديل الهاتف:</label>
          <select id="phoneModel" name="phoneModel" required>
            <option value="">اختر موديل الهاتف</option>
          </select>
          <label for="ram"> الرام (RAM):</label>
          <select id="ram" name="ram" required>
            <option value="">اختر حجم الرام</option>
            <option value="4GB">4GB</option>
            <option value="6GB">6GB</option>
            <option value="8GB">8GB</option>
            <option value="12GB">12GB</option>
            <option value="16GB">16GB</option>
          </select>

          <label for="storage"> المساحة التخزينية (Storage):</label>
          <select id="storage" name="storage" required>
            <option value="">اختر سعة التخزين</option>
            <option value="64GB">64GB</option>
            <option value="128GB">128GB</option>
            <option value="256GB">256GB</option>
            <option value="512GB">512GB</option>
            <option value="1TB">1TB</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="imeiNumber"> رقم IMEI:</label>
          <input type="text" id="imeiNumber" name="imeiNumber" pattern="[0-9]{15}" placeholder="مثال: 123456789012345"
            required>

          <label for="simNumberPhone"> رقم SIM:</label>
          <input type="text" id="simNumberPhone" name="simNumberPhone" pattern="[0-9]{10,20}"
            placeholder="مثال: 89014103211118510720" required>
        </div>
        <div class="grid-item">

          <label for="phoneStatus">حالة الهاتف:</label>
          <select id="phoneStatus" name="phoneStatus" required>
            <option value="New">New</option>
            <option value="Used">Used</option>
            <option value="Harmony">Harmony</option>
            <option value="Maintenance">Maintenance</option>
            <option value="working">working</option>
          </select>
          <label for="notes"> ملاحظات إضافية:</label>
          <textarea id="notesPhone" name="notes" rows="3"></textarea>
        </div>

      </form>
      <hr>
      <button onclick="savePhone()">💾 حفظ</button>
    </div>
  </div>

  <div id="phoneQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        استعلام عن بيانات الهاتف
      </div>
      <div class="grid-container">

        <div class="grid-item">
          <label for="queryCompanySelectPhone">اختر الشركة:</label>
          <select id="queryCompanySelectPhone" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodePhone">
        </div>

        <div class="grid-item">
          <label for="searchDocumentNumber"> رقم مستند الجهاز:</label>
          <input type="text" id="searchDocumentNumber" placeholder="أدخل رقم المستند">
        </div>
        <div class="grid-item">
          <label for="searchDatePhone"> التاريخ:</label>
          <input type="date" id="searchDatePhone">
        </div>
        <div class="grid-item">
          <label for="searchLocationPhone"> المنطقه:</label>
          <select id="searchLocationPhone">
            <option value="">اختر المنطقه</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="searchPhoneStatus"> حالة الهاتف:</label>
          <select id="searchPhoneStatus">
            <option value="">اختر حالة الهاتف</option>
            <option value="New">New</option>
            <option value="Used">Used</option>
            <option value="Harmony">Harmony</option>
            <option value="Maintenance">Maintenance</option>
            <option value="working">working</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="phoneType"> نوع الهاتف:</label>
          <select id="searchphoneType" name="phoneType" required>
            <option value="">اختر نوع الهاتف</option>
            <option value="iPhone">iPhone</option>
            <option value="Samsung">Samsung</option>
            <option value="Huawei">Huawei</option>
            <option value="Oppo">Oppo</option>
            <option value="Xiaomi">Xiaomi</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="toolbar">
          <div class="button-group">
            <button onclick="printTablePhone()">🖨️ طباعة</button>
            <button onclick="exportToExcelPhone()">📥 تحميل كملف Excel</button>
            <button onclick="searchPhone()">🔍 تحديث </button>
          </div>
          <div class="search-box">
            <label for="generalSearchPhone">Search: </label>
            <input type="text" id="generalSearchPhone" placeholder="اكتب كلمة للبحث..." oninput="searchPhone()"
              style="width: 100%; padding: 6px;">
          </div>
        </div>
        <div id="queryResultsPhone"
          style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"></div>
      </div>
    </div>
  </div>

  <div id="phoneSettings" class="content" style="display: none;">

    <div class="card mb-3">
      <div class="card-header text-center" id="createUserTitle">
        إضافة نوع جهاز وموديلات
      </div>
      <label for="deviceTypePhone">نوع الجهاز:</label>
      <input type="text" id="deviceTypePhone" placeholder="مثال:  سامسونج">

      <label for="deviceModelsPhone">الموديلات (افصل بينها بفاصلة):</label>
      <input type="text" id="deviceModelsPhone" placeholder="مثال: S22, not10, A51">
      <hr>
      <button onclick="addDeviceDataPhone()">إضافة</button>

      <div class="card mb-3">

        <div class="card-header text-center" id="createUserTitle">
          أنواع الأجهزة والموديلات
        </div>

        <table id="deviceTablePhone">
          <thead>
            <tr>
              <th>نوع الجهاز</th>
              <th>الموديلات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>


  <div id="lineForm" class="content" style="display: none;">

    <div class="card">
      <div class="card-header text-center">
        تسجيل بيانات الخط
      </div>
      <form class="grid-container">
        <div class="grid-item">
          <label for="companySelectLine">اختر الشركة:</label>
          <select id="companySelectLine" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeLine">

          <label for="documentNumber">رقم مستند الجهاز:</label>
          <input type="number" id="documentNumberLine" name="documentNumber" required>

          <label for="employeeName">اسم الموظف:</label>
          <input type="text" id="employeeNameLine" name="employeeName" required>

          <label for="phoneNumber">رقم الخط:</label>
          <input type="tel" id="phoneNumberLine" name="phoneNumber" pattern="[0-9]{11}" placeholder="مثال: 01012345678"
            required>
        </div>
        <div class="grid-item">
          <label for="date">التاريخ:</label>
          <input type="date" id="dateLine" name="date" required>

          <label for="location">المنطقة:</label>
          <select id="locationLine" name="Location" required>
            <option value=""> - Location -</option>
          </select>

          <label for="company"> شركة الاتصالات:</label>
          <select id="companyLine" name="companyLine" onchange="updatePlans()">
            <option value="">اختر الشركة</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="plans"> الباقات المتاحة:</label>
          <select id="plansLine" name="plansLine">
            <option value="">اختر الباقة</option>
          </select>


          <label for="packageType">نوع الباقة:</label>
          <select id="packageTypeLine" name="packageTypeLine" required>
            <option value="">اختر نوع الباقة</option>
            <option value="مكالمات">مكالمات</option>
            <option value="إنترنت">إنترنت</option>
            <option value="مزدوج">مزدوج (مكالمات + إنترنت)</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="packageSize">حجم الباقة:</label>
          <select id="packageSize" name="packageSize" required>
            <option value="">اختر حجم الباقة</option>
            <option value="4GB">4GB</option>
            <option value="8GB">8GB</option>
            <option value="12GB">12GB</option>
            <option value="20GB">20GB</option>
            <option value="40GB">40GB</option>
          </select>
          <label for="simNumber">رقم SIM:</label>
          <input type="text" id="simNumberLine" name="simNumber" pattern="[0-9]{10,20}"
            placeholder="مثال: 89014103211118510720" required>
        </div>
      </form>


      <div class="grid-item full-width">
        <div class="card">
          <div class="card-header text-center">
            حساب مدة الباقة
          </div>
          <div class="grid-container">
            <div class="grid-item">
              <label for="startDate"> تاريخ بدء الباقة:</label>
              <input type="date" id="startDateLine" required>

              <label for="packageDuration"> مدة الباقة:</label>
              <select id="packageDuration" onchange="calculateEndDate()">
                <option value="">اختر مدة الباقة</option>
                <option value="30">شهر (30 يوم)</option>
                <option value="7"> اسبوعي </option>
              </select>
            </div>
            <div class="grid-item">
              <label for="endDate"> تاريخ انتهاء الباقة:</label>
              <input type="text" id="endDate" readonly>

              <div class="result" id="result"></div>
              <label for="notes">ملاحظات إضافية:</label>
              <textarea id="notesLine" name="notes" rows="3"></textarea>
            </div>
          </div>
        </div>
        <hr>
        <button type="button" onclick="saveLine()">💾 حفظ البيانات</button>
      </div>
    </div>
  </div>

  <div id="lineQuery" class="content" style="display: none;">

    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        استعلام عن بيانات الخطوط
      </div>

      <div class="grid-container">

        <div class="grid-item">
          <label for="queryCompanySelectLine">اختر الشركة:</label>
          <select id="queryCompanySelectLine" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeLine">
          <label for="locationLineSearch"> المنطقه:</label>
          <select id="locationLineSearch">
            <option value="">اختر المنطقه</option>
          </select>
        </div>

        <div class="grid-item">
          <label for=""> رقم مستند الجهاز:</label>
          <input type="text" id="documentNumberSearchLine" placeholder="أدخل رقم المستند">
          <label for="searchDatePhone"> التاريخ:</label>
          <input type="date" id="searchDateLine">
        </div>
        <div class="grid-item">
          <label for="company"> شركة الاتصالات:</label>
          <select id="companySearchLine" name="company" required onchange="updatePlans()">
            <option value="">اختر شركة الاتصالات</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="toolbar">
          <div class="button-group">
            <button onclick="printTableLine()">🖨️ طباعة</button>
            <button onclick="exportToExcelLine()">📥 تحميل كملف Excel</button>
            <button id="toggleColumnBtnLine" onclick="toggleColumnFilterLine()">🔽 اختيار الأعمدة</button>
            <button onclick="searchLine()">🔍 تحديث</button>
          </div>
          <div class="search-box">
            <label for="generalSearchLine">Search: </label>
            <input type="text" id="generalSearchLine" placeholder="اكتب كلمة للبحث..." oninput="searchLine()"
              style="width: 100%; padding: 6px;">
          </div>
          <div id="columnFilterBoxLine" style="display: none;">
            <div id="columnCheckboxesLine"></div>
            <button onclick="applyColumnFilterLine()">✔ تطبيق</button>
          </div>
        </div>
        <div id="queryResultsLine"
          style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"></div>
      </div>
    </div>
  </div>

  <div id="lineSettings" class="content">
    <div class="card">
      <div class="card-header text-center">إضافة شركة وباقات</div>

      <label for="companyInput">اسم الشركة:</label>
      <input type="text" id="companyInput" placeholder="مثال: فودافون">

      <label for="plansInput">الباقات (افصل بينها بفاصلة):</label>
      <input type="text" id="plansInput" placeholder="مثال: فليكس 30, فليكس 50, فليكس 70">
      <hr>

      <button onclick="addCompanyPlans()">إضافة</button>
    </div>
    <hr>

    <div class="card mt-3">
      <div class="card-header text-center">الشركات والباقات</div>
      <table id="companyTable">
        <thead>
          <tr>
            <th>الشركة</th>
            <th>الباقات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="RouterForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">تسجيل بيانات الراوتر</div>

      <form class="grid-container" id="routerForm">

        <div class="grid-item">
          <label for="CompanySelectRouter">اختر الشركة:</label>
          <select id="CompanySelectRouter" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeRouter">


          <label for="docNumberRouter">: رقم مستند الجهاز </label>
          <input type="text" id="docNumberRouter" name="docNumber" required>

          <label for="date">التاريخ</label>
          <input type="date" id="date" name="date" required>

          <label for="locationRouter">موقع التركيب</label>
          <select id="locationRouter" name="location" required>
            <option value="">اختر موقع التركيب</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="deviceStatusRouter">حالة الجهاز</label>
          <select id="deviceStatusRouter" name="deviceStatus" required>
            <option value="">-- اختر الحالة --</option>
            <option value="New">New</option>
            <option value="Used">Used</option>
            <option value="Harmony">Harmony</option>
            <option value="Maintenance">Maintenance</option>
            <option value="working">working</option>
          </select>

          <label for="deviceTypeRouter">نوع الجهاز</label>
          <select id="deviceTypeRouter" name="deviceTypeRouter" required>
            <option value="">اختر نوع الجهاز</option>
            <option value="متنقل">متنقل</option>
            <option value="ثابت">ثابت</option>
            <option value="ثابت"></option>
            <option value="آخر">آخر</option>
          </select>

          <label for="providerCompany">الشركة التابع لها الراوتر</label>
          <select id="providerCompany" name="providerCompany" required>
            <option value="">اختر الشركة</option>
            <option value="WE">WE</option>
            <option value="Orange">Orange</option>
            <option value="Vodafone">Vodafone</option>
            <option value="Etisalat">Etisalat</option>
          </select>

          <label for="routerModel">موديل الراوتر</label>
          <select id="routerModel" name="routerModel" required>
            <option value="">اختر الموديل</option>
            <option value="Huawei B315">Huawei B315</option>
            <option value="Huawei B525">Huawei B525</option>
            <option value="Huawei B535">Huawei B535</option>
            <option value="Huawei AX3">Huawei AX3</option>
            <option value="TP-Link MR6400">TP-Link MR6400</option>
            <option value="TP-Link Archer C6">TP-Link Archer C6</option>
            <option value="ZTE MF286">ZTE MF286</option>
            <option value="ZTE H168N">ZTE H168N</option>
            <option value="D-Link DSL-224">D-Link DSL-224</option>
            <option value="Linksys EA7500">Linksys EA7500</option>
            <option value="آخر">آخر</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="ipAddress">عنوان IP</label>
          <input type="text" id="ipAddress" name="ipAddress">

          <label for="serialNumber">الرقم التسلسلي</label>
          <input type="text" id="serialNumber" name="serialNumber" required>
        </div>

        <div class="grid-item">
          <label for="ssid">اسم الشبكة (SSID)</label>
          <input type="text" id="ssid" name="ssid">

          <label for="wifiPassword">كلمة مرور الشبكة</label>
          <input type="text" id="wifiPassword" name="wifiPassword">
        </div>

        <div class="grid-item">
          <label for="geoLocation">رابط الموقع (Google Maps)</label>
          <input type="url" id="geoLocation" name="geoLocation" placeholder="https://maps.google.com/...">
        </div>

        <div class="grid-item">
          <label for="notes">ملاحظات إضافية</label>
          <textarea id="notes" name="notes" rows="3"></textarea>
        </div>

        <div id="mobileFieldsRouter" style="display: none;" class="grid-container full-width">
          <div class="card">
            <div class="card-header text-center">متنقل</div>
            <div class="grid-item">
              <label for="userNameRouter"> اسم المستخدم </label>
              <input type="text" id="userNameRouter" name="userNameRouter" list="userSuggestions">
              <datalist id="userSuggestions"></datalist>
              <label for="phoneNumberRouter">رقم الهاتف</label>
              <input type="text" id="phoneNumberRouter" name="phoneNumberRouter">

              <label for="simNumberRouter">رقم الشريحة (SIM)</label>
              <input type="text" id="simNumberRouter" name="simNumberRouter">
            </div>
          </div>
        </div>
        <div id="customRouterModelRouter" style="display: none; margin-top: 10px;" class="grid-container full-width">
          <div class="card">
            <div class="card-header text-center">نوع الموديل</div>
            <label for="otherRouterModel">أدخل اسم الموديل</label>
            <input type="text" id="otherRouterModel" name="otherRouterModel">
          </div>
        </div>
        <div id="fixedFieldsRouter" style="display: none; margin-top: 15px;" class="grid-container full-width">
          <div class="card">
            <div class="card-header text-center"> تابت </div>
            <label for="macAddress">عنوان MAC</label>
            <input type="text" id="macAddress" name="macAddress">

            <label for="landlineNumber">رقم الهاتف الأرضي</label>
            <input type="text" id="landlineNumber" name="landlineNumber">
          </div>
        </div>

        <div id="otherFieldsRouter" style="display: none; margin-top: 15px;" class="grid-container full-width">
          <div class="card">
            <div class="card-header text-center"> نوع الجهاز </div>
            <label for="deviceDescription">وصف الجهاز</label>
            <input type="text" id="deviceDescription" name="deviceDescription">
          </div>
        </div>
      </form>
      <hr>
      <button type="button" onclick="saveDataRouter()">💾 حفظ البيانات</button>
    </div>
  </div>

  <div id="RouterQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        استعلام عن بيانات الرواتر
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="queryCompanySelectRouter">اختر الشركة:</label>
          <select id="queryCompanySelectRouter" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeRouter">
        </div>

        <div class="grid-item">
          <label for="searchDocumentNumber"> : رقم مستند الجهاز</label>
          <input type="text" id="searchDocNumRouter" placeholder="أدخل رقم المستند">
        </div>
        <div class="grid-item">
          <label for="searchDateRouter"> التاريخ:</label>
          <input type="date" id="searchDateRouter">
        </div>
        <div class="grid-item">
          <label for="searchLocationRouter">موقع التركيب</label>
          <select id="searchLocationRouter" name="searchLocationRouter" required>
            <option value="">اختر موقع التركيب</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="searchRouterStatus"> حالة الرواتر :</label>
          <select id="searchRouterStatus">
            <option value="">-- اختر الحالة --</option>
            <option value="New">New</option>
            <option value="Used">Used</option>
            <option value="Harmony">Harmony</option>
            <option value="Maintenance">Maintenance</option>
            <option value="working">working</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="phoneType"> نوع الرواتر :</label>
          <select id="searchRouterType" name="phoneType" required>
            <option value="">اختر نوع الرواتر </option>
            <option value="متنقل">متنقل</option>
            <option value="ثابت">ثابت</option>
            <option value="آخر">آخر</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="searchProviderCompany">الشركة التابع لها الراوتر</label>
          <select id="searchProviderCompany" name="searchProviderCompany" required>
            <option value="">اختر الشركة</option>
            <option value="WE">WE</option>
            <option value="Orange">Orange</option>
            <option value="Vodafone">Vodafone</option>
            <option value="Etisalat">Etisalat</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="toolbar">
          <div class="button-group">
            <button onclick="printTableRouter()">🖨️ طباعة</button>
            <button onclick="exportToExcelRouter()">📥 تحميل كملف Excel</button>
            <button id="toggleColumnBtnRouter" onclick="toggleColumnFilterRouter()">🔽 اختيار الأعمدة</button>
            <button onclick="searchRouter()">🔍 تحديث </button>
          </div>
          <div class="search-box">
            <label for="generalSearchRouter">Search: </label>
            <input type="text" id="generalSearchRouter" placeholder="اكتب كلمة للبحث..." oninput="searchRouter()"
              style="width: 100%; padding: 6px;">
          </div>
          <div id="columnFilterBoxRouter" style="display: none;">
            <div id="columnCheckboxesRouter"></div>
            <button onclick="applyColumnFilterRouter()">✔ تطبيق</button>
          </div>
        </div>
        <div id="queryResultsRouter"
          style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"></div>
      </div>
    </div>
  </div>

  <div id="screenForm" class="content">
    <div class="card">
      <div class="card-header text-center">نموذج تسجيل بيانات الشاشة</div>

      <div class="grid-container">
        <div class="grid-item">

          <label for="screenCompanySelect">اختر الشركة:</label>
          <select id="screenCompanySelect" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeScreen">

          <label for="documentNumberScreen">: رقم مستند الجهاز</label>
          <input type="text" id="documentNumberScreen" name="documentNumberScreen">
        </div>
        <div class="grid-item">
          <label>الموقع:</label>
          <select id="screenLocation" name="screenLocation" required>
            <option value=""> - Location -</option>
          </select>
          <label for="dateScreen">التاريخ:</label>
          <input type="date" id="dateScreen" name="dateScreen">

        </div>
        <div class="grid-item">
          <label for="screen"> الشاشات:</label>
          <select id="screen" name="screen">
            <option value="">--اختر الشاشات --</option>
            <option value="عادية">شاشة عادية</option>
            <option value="كمبيوتر">شاشة كمبيوتر</option>
          </select>
          <label for="screenModel">موديل الشاشة:</label>
          <select id="screenModel" name="screenModel" required>
            <option value="">-- اختر الموديل --</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="screenType">نوع الشاشه :</label>
          <select id="screenType" name="screenType" required>
            <option value="">-- اختر النوع --</option>
          </select>

          <label for="serial">الرقم التسلسلي:</label>
          <input type="text" id="serial" name="serial">
        </div>
        <div class="grid-item">
          <label for="size">حجم الشاشة (بالبوصة):</label>
          <input type="number" id="size" name="size" min="10">

          <label for="resolution">الدقة:</label>
          <input type="text" id="resolution" name="resolution">
        </div>
        <div class="grid-item">
          <label for="ports">عدد المنافذ:</label>
          <input type="text" id="ports" name="ports" placeholder="مثال: 2 HDMI، 1 VGA">

          <label for="condition">حالة الشاشة:</label>
          <select id="condition" name="condition">
            <option value="">-- اختر الحالة --</option>
            <option value="جديدة">جديدة</option>
            <option value="مستخدمة">مستخدمة</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="notesScreen">ملاحظات إضافية:</label>
          <textarea id="notesScreen" name="notesScreen" rows="4"></textarea>
        </div>

        <div id="pcFields" style="display: none;">
          <div class="card">
            <div class="card-header text-center"> بيانات الكمبيوتر </div>

            <label for="screenPCName">رقم مستند الجهاذ الكمبيوتر:</label>
            <input type="text" id="screenPCName" name="screenPCName">

            <label for="linkedEmployeeName">اسم الموظف المرتبط:</label>
            <input type="text" id="linkedEmployeeName" name="linkedEmployeeName" readonly>

            <label for="linkedDeviceType">نوع الجهاز:</label>
            <input type="text" id="linkedDeviceType" name="linkedDeviceType" readonly>
            <label for="linkedDeviceModel">موديل الجهاز:</label>
            <input type="text" id="linkedDeviceModel" name="linkedDeviceType" readonly>
          </div>
        </div>

      </div>
      <hr>
      <button onclick="SaveScreen()">💾 حفظ البيانات </button>
    </div>
  </div>

  <div id="screenQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        البحث عن جهاز
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="queryCompanySelectScreen">اختر الشركة:</label>
          <select id="queryCompanySelectScreen" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeScreen">
        </div>

        <div class="grid-item">
          <label>: date</label>
          <input type="date" id="querydateAddedScreen">
        </div>
        <div class="grid-item">
          <label>: رقم مستند الجهاز</label>
          <input type="text" id="queryScreenNum">
        </div>
        <div class="grid-item">
          <label> : screenTyp</label>
          <select id="queryscreenType">
            <option value="">-- Select the device --</option>
          </select>
        </div>
        <div class="grid-item">
          <label>: PcLocation </label>
          <select id="queryScreenLocation" name="Location" required>
            <option value="">- Location -</option>
          </select>
        </div>
        <div class="grid-item">
          <label>: screen </label>
          <select id="queryScreen" name="screen">
            <option value="">--اختر الشاشات --</option>
            <option value="عادية">شاشة عادية</option>
            <option value="كمبيوتر">شاشة كمبيوتر</option>
            <option value="أخرى">أخرى</option>
          </select>
        </div>
      </div>
    </div>
    <hr>
    <div class="card">
      <div class="toolbar">
        <div class="button-group">
          <button onclick="printTableScreen()">🖨️ طباعة</button>
          <button onclick="exportToExcelScreen()">📥 تحميل كملف Excel</button>
          <button onclick="searchDataScreen()">🔍 تحديث</button>
        </div>
        <div class="search-box">
          <label for="generalSearchScreen">Search: </label>
          <input type="text" id="generalSearchScreen" placeholder="اكتب كلمة للبحث..." oninput="searchDataScreen()"
            style="width: 100%; padding: 6px;">
        </div>

      </div>
      <div id="queryResultsScreen"
        style="overflow-y: auto; height: 400px; border: 1px solid #cccccc00; padding: 10px; margin-top: 10px;">
      </div>
    </div>
  </div>

  <div id="screenSettings" class="content" style="display: none;">

    <div class="card mb-3">
      <div class="card-header text-center" id="createUserTitle">
        إضافة نوع جهاز وموديلات للشاشات
      </div>
      <label for="screenTypeInput">نوع الجهاز:</label>
      <input type="text" id="screenTypeInput" placeholder="مثال:  Dell">

      <label for="screenModelsInput">الموديلات (افصل بينها بفاصلة):</label>
      <input type="text" id="screenModelsInput" placeholder="مثال: HP EliteDisplay , HP Omen  ">
      <hr>
      <button onclick="addScreenData()">إضافة</button>

      <div class="card mb-3">

        <div class="card-header text-center" id="createUserTitle">
          أنواع الأجهزة والموديلات
        </div>

        <table id="screenTable">
          <thead>
            <tr>
              <th>نوع الجهاز</th>
              <th>الموديلات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="printForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        إضافة جهاز طباعة جديد
      </div>
      <form id="printerForm" class="grid-container">

        <div class="grid-item">
          <label for="printerCompanySelect">اختر الشركة:</label>
          <select id="printerCompanySelect" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodePrinter">

          <label for="doc_number">: رقم مستند الجهاز</label>
          <input type="text" id="doc_number" name="doc_number" required>

          <label for="doc_date">تاريخ الإدخال</label>
          <input type="date" id="doc_date" name="doc_date" required>
        </div>
        <div class="grid-item">
          <label for="location">المنطقه :</label>
          <select id="locationPrint" name="Location" required>
            <option value=""> - Location -</option>
          </select>

          <label for="printer_name">نوع الطابعة</label>
          <select id="printer_name" name="printer_name" required>
            <option value="">-- اختر النوع --</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="printer_model">موديل الطابعة</label>
          <select id="printer_model" name="printer_model" required>
            <option value="">-- اختر الموديل --</option>
          </select>

          <label for="printer_type">وصف الطابعة</label>
          <select id="printer_type" name="printer_type" required>
            <option value="">-- اختر الوصف --</option>
            <option value="ليزر">ليزر</option>
            <option value="حبر">حبر</option>
            <option value="شبكية">شبكية</option>
            <option value="حرارية">حرارية</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="ip_address">عنوان IP</label>
          <input type="text" id="ip_address" name="ip_address">
          <label for="serial_number">الرقم التسلسلي</label>
          <input type="text" id="serial_number" name="serial_number" required>

        </div>
        <div class="grid-item">
          <label for="status">الحالة</label>
          <select id="statusPrint" name="status">
            <option value="">-- اختر الحالة --</option>
            <option value="New">New</option>
            <option value="Used">Used</option>
            <option value="Harmony">Harmony</option>
            <option value="Maintenance">Maintenance</option>
            <option value="working">working</option>
          </select>

        </div>
        <div class="grid-item">
          <label for="notes">ملاحظات إضافية</label>
          <textarea id="notesPrint" name="notes" rows="3"></textarea>
        </div>
      </form>
      <hr>
      <button type="button" onclick="saveDataPrint()">حفظ البيانات 💾</button>
    </div>
  </div>

  <div id="printQuery" class="content" style="display: none;">

    <div class="card">
      <div class="card-header text-center">
        استعلامات الطابعات
      </div>
      <form class="grid-container">
        <div class="grid-item">
          <label for="queryCompanySelectPrinter">اختر الشركة:</label>
          <select id="queryCompanySelectPrinter" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodePrinter">
        </div>


        <div class="grid-item">
          <label for="filter_doc_number">: رقم مستند الجهاز</label>
          <input type="number" id="filter_doc_number">
        </div>

        <div class="grid-item">
          <label for="filter_doc_date">تاريخ المستند:</label>
          <input type="date" id="filter_doc_date">
        </div>

        <div class="grid-item">
          <label for="filter_LocationPrinter"> المنطقه:</label>
          <select id="filter_LocationPrinter">
            <option value="">اختر المنطقه</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="filter_printer_type">نوع الطابعة:</label>
          <select id="filter_printer_type" name="filter_printer_type">
            <option value="">-- اختر النوع --</option>
            <option value="HP">HP</option>
            <option value="Canon">Canon</option>
            <option value="Xerox">Xerox</option>
            <option value="Brother">Brother</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="filter_status">الحالة:</label>
          <select id="filter_status" name="filter_status">
            <option value="">-- اختر الحالة --</option>
            <option value="New">New</option>
            <option value="Used">Used</option>
            <option value="Harmony">Harmony</option>
            <option value="Maintenance">Maintenance</option>
            <option value="working">working</option>

          </select>
        </div>
      </form>
      <div class="card">
        <div class="toolbar">
          <div class="button-group">
            <button onclick="printTablePrint()">🖨️ طباعة</button>
            <button onclick="exportToExcelPrint()">📥 تحميل كملف Excel</button>
            <button onclick="searchPrinters()">🔍 تحديث</button>
          </div>
          <div class="search-box"> <label for="generalSearchPrint">Search: </label>
            <input type="text" id="generalSearchPrint" placeholder="اكتب كلمة للبحث..." oninput="searchPrinters()"
              style="width: 100%; padding: 6px;">
          </div>
        </div>
        <div id="resultsTable"
          style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"></div>
      </div>
    </div>
  </div>

  <div id="printerSettings" class="content" style="display: none;">

    <div class="card mb-3">
      <div class="card-header text-center" id="createUserTitle">
        إضافة نوع جهاز وموديلات طابعات
      </div>

      <label for="deviceTypeInputPrint">نوع الجهاز:</label>
      <input type="text" id="deviceTypeInputPrint" placeholder="مثال: Xerox  ">

      <label for="deviceModelsInputPrinter">الموديلات (افصل بينها بفاصلة):</label>
      <input type="text" id="deviceModelsInputPrinter" placeholder="مثال:Xerox Phaser 3020, Xerox WorkCentre 6515">
      <hr>
      <button onclick="addPrinterData()">إضافة</button>
      <div class="card mb-3">
        <div class="card-header text-center" id="createUserTitle">
          أنواع الأجهزة والموديلات
        </div>

        <table id="PrinterTable">
          <thead>
            <tr>
              <th>نوع الجهاز</th>
              <th>الموديلات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="cameraForm" class="content">
    <div class="card">
      <div class="card-header text-center">نموذج تسجيل بيانات الكاميرا</div>

      <div class="grid-container">

        <div class="grid-item">
          <label for="cameraCompanySelect">اختر الشركة:</label>
          <select id="cameraCompanySelect" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeCamera">

          <label for="dateCamera">تاريخ المستند:</label>
          <input type="date" id="dateCamera" name="dateCamera" required>
        </div>

        <div class="grid-item">
          <label for="documentNumberCamera">: رقم مستند الجهاز</label>
          <input type="text" id="documentNumberCamera" name="documentNumberCamera" required>

          <label for="cameraLocation">الموقع:</label>
          <select id="cameraLocation" name="cameraLocation" required>
            <option value="">-- اختر الموقع --</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="cameraType">نوع الكاميرا:</label>
          <select id="cameraType" name="cameraType" required>
            <option value="">-- اختر النوع --</option>
          </select>

          <label for="cameraModel">موديل الكاميرا:</label>
          <select id="cameraModel" name="cameraModel" required>
            <option value="">-- اختر الموديل --</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="cameraCondition">حالة الكاميرا:</label>
          <select id="cameraCondition" name="cameraCondition">
            <option value="">-- اختر الحالة --</option>
            <option value="جديدة">جديدة</option>
            <option value="مستخدمة">مستخدمة</option>
            <option value="بحالة جيدة">بحالة جيدة</option>
          </select>

          <label for="cameraLens">نوع العدسة:</label>
          <input type="text" id="cameraLens" name="cameraLens" placeholder="مثال: 2.8mm، Varifocal">
        </div>

        <div class="grid-item">
          <label for="serialCamera">الرقم التسلسلي:</label>
          <input type="text" id="serialCamera" name="serialCamera" required>

          <label for="cameraResolution">الدقة (ميغابيكسل):</label>
          <input type="text" id="cameraResolution" name="cameraResolution" placeholder="مثال: 2MP، 4K">
        </div>

        <div class="grid-item">
          <label for="infrared">رؤية ليلية (IR):</label>
          <select id="infrared" name="infrared">
            <option value="">-- اختر --</option>
            <option value="نعم">نعم</option>
            <option value="لا">لا</option>
          </select>

          <label for="connectionType">نوع الاتصال:</label>
          <select id="connectionType" name="connectionType" required>
            <option value="">-- اختر --</option>
            <option value="IP">IP</option>
            <option value="Analog">Analog</option>
            <option value="Hybrid">Hybrid</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="notesCamera">ملاحظات إضافية:</label>
          <textarea id="notesCamera" name="notesCamera" rows="4" placeholder="أدخل أي معلومات إضافية هنا..."></textarea>
        </div>
      </div>
      <hr>
      <button onclick="SaveCamera()">💾 حفظ البيانات</button>
    </div>
  </div>

  <div id="cameraQuery" class="content" style="display: none;">

    <div class="card">
      <div class="card-header text-center">
        استعلامات الكاميرات
      </div>
      <form class="grid-container">
        <div class="grid-item">
          <label for="queryCompanySelectCamera">اختر الشركة:</label>
          <select id="queryCompanySelectCamera" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeCamera">
        </div>


        <div class="grid-item">
          <label for="filter_doc_number_camera">: رقم مستند الجهاز</label>
          <input type="number" id="filter_doc_number_camera">
        </div>

        <div class="grid-item">
          <label for="filter_doc_date_camera">تاريخ المستند:</label>
          <input type="date" id="filter_doc_date_camera">
        </div>

        <div class="grid-item">
          <label for="filter_Location_camera"> المنطقه:</label>
          <select id="filter_Location_camera">
            <option value="">اختر المنطقه</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="filter_camera_type">نوع الكاميرا</label>
          <select id="filter_camera_type" name="filter_camera_type">
            <option value="">-- اختر النوع --</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="filter_status_camera">الحالة:</label>
          <select id="filter_status_camera" name="filter_status_camera">
            <option value="">-- اختر الحالة --</option>
            <option value="جديدة">جديدة</option>
            <option value="مستخدمة">مستخدمة</option>
            <option value="بحالة جيدة">بحالة جيدة</option>
          </select>
        </div>
      </form>
      <div class="card">
        <div class="toolbar">
          <div class="button-group">
            <button onclick="printTableCamera()">🖨️ طباعة</button>
            <button onclick="exportToExcelCamera()">📥 تحميل كملف Excel</button>
            <button onclick="searchCamera()">🔍 تحديث</button>
          </div>
          <div class="search-box">
            <label for="generalSearchPrint">Search: </label>
            <input type="text" id="generalSearchCamera" placeholder="اكتب كلمة للبحث..." oninput="searchCamera()"
              style="width: 100%; padding: 6px;">
          </div>
        </div>
        <div id="resultsTableCamera"
          style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"></div>
      </div>
    </div>
  </div>

  <div id="cameraSettings" class="content" style="display: none;">
    <div class="card mb-3">
      <div class="card-header text-center" id="createUserTitle">
        إضافة نوع جهاز وموديلات
      </div>
      <label for="cameraTypeInput">نوع الجهاز:</label>
      <input type="text" id="cameraTypeInput" placeholder=" مثال : Hikvision">

      <label for="cameraModelsInput">الموديلات (افصل بينها بفاصلة):</label>
      <input type="text" id="cameraModelsInput" placeholder=" مثال : DS-2CD2143G0-I, DS-2CE16D0T-IRF, DS-2DE4425IW-DE">
      <hr>
      <button onclick="addCameraData()">إضافة</button>

      <div class="card mb-3">
        <div class="card-header text-center" id="createUserTitle">أنواع الأجهزة والموديلات </div>

        <table id="cameraTable">
          <thead>
            <tr>
              <th>نوع الجهاز</th>
              <th>الموديلات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="orderForm" class="content" style="display: none;">
    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">طلب شراء</div>

      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label for="CompanySelectOrder">اختر الشركة:</label>
            <select id="CompanySelectOrder" class="form-control"></select>
            <input type="hidden" id="selectedCompanyCodeOrder">
          </div>

          <div class="col-md-3">
            <label for="purchaseDate22">التاريخ:</label>
            <input type="date" id="purchaseDate22" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="purchaseLocation">الموقع:</label>
            <select id="purchaseLocation" class="form-control">
              <option value="">- اختر الموقع -</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="purchaseReason">سبب الطلب:</label>
            <input type="text" id="purchaseReason" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="purchaseRequester">مقدم الطلب:</label>
            <input type="text" id="purchaseRequester" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="purchaseNotes">ملاحظات:</label>
            <input type="text" id="purchaseNotes" class="form-control">
          </div>
        </div>

        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label for="supplierCodeOrder">كود المورد:</label>
            <input type="text" id="supplierCodeOrder" class="form-control" placeholder=" كود المورد"
              oninput="fetchResourceDetailsOrder('code')">
          </div>
          <div class="col-md-4">
            <label for="SupplierNameOrder">اسم المورد:</label>
            <input list="resourceSuggestionsOrder" type="text" id="SupplierNameOrder" class="form-control"
              placeholder=" اسم المورد" oninput="fetchResourceDetailsOrder('name')">
            <datalist id="resourceSuggestionsOrder"></datalist>
          </div>
        </div>

        <div class="row g-3 align-items-end">
          <div class="col-md-2">
            <label for="itemCodeOrder">كود الصنف:</label>
            <input type="text" id="itemCodeOrder" class="form-control" placeholder=" كود الصنف"
              oninput="fetchItemDetailsOrder('code')">
          </div>
          <div class="col-md-2">
            <label for="itemNameOrder">اسم الصنف:</label>
            <input list="itemSuggestionsOrder" type="text" id="itemNameOrder" class="form-control"
              placeholder=" اسم الصنف" oninput="fetchItemDetailsOrder('name')">
            <datalist id="itemSuggestionsOrder"></datalist>
          </div>
          <div class="col-md-2">
            <label for="purchaseItemQuantity">الكمية:</label>
            <input type="number" id="purchaseItemQuantity" class="form-control">
          </div>
          <div class="col-md-2">
            <label for="purchaseItemUnitPrice">سعر الوحدة:</label>
            <input type="number" id="purchaseItemUnitPrice" class="form-control" step="any">
          </div>
          <div class="col-md-2">
            <label for="purchaseItemNotes">ملاحظات:</label>
            <input type="text" id="purchaseItemNotes" class="form-control">
          </div>
          <div class="col-md-2 d-grid">
            <hr>
            <button type="button" onclick="addItemToPurchase()">➕ إضافة صنف</button>
          </div>
        </div>
        <hr>
        <div class="table-responsive">
          <table class="table table-bordered text-center mt-3">
            <thead class="table-dark">
              <tr>
                <th>كود الصنف</th>
                <th>اسم الصنف</th>
                <th>الكمية</th>
                <th>سعر الوحدة</th>
                <th>الإجمالي</th>
                <th>ملاحظات</th>
                <th>حذف</th>
              </tr>
            </thead>
            <tbody id="purchaseItemsTable">
              <tr>
                <td colspan="7">لا توجد أصناف مضافة</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="text-center mt-3">
          <hr>
          <button type="button" onclick="saveOrder()">💾 حفظ الطلب</button>
        </div>
      </div>
    </div>
  </div>

  <div id="orderAmendment" class="content" style="display: none;">
    <datalist id="itemSuggestionsOrderAmendment"></datalist>
    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">طلب شراء
      </div>
      <div class="card-body">

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label for="documentNumberOrder">رقم المستند:</label>
            <input type="number" id="documentNumberOrder" class="form-control" placeholder="أدخل رقم المستند للبحث">
          </div>
          <div class="col-md-3 d-grid align-self-end">
            <button onclick="postToAddition()">ترحيل</button>
          </div>
        </div>
        <hr>

        <div class="row g-3 mb-3">

          <div class="col-md-3">
            <label for="purchaseCompanySelectOrder">اختر الشركة:</label>
            <select id="purchaseCompanySelectOrder" class="form-control"></select>
            <input type="hidden" id="selectedCompanyCodeOrder">
          </div>
          <div class="col-md-3">
            <label for="purchaseDate">التاريخ:</label>
            <input type="date" id="purchaseDateOrder" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="purchaseLocationOrder">الموقع:</label>
            <select id="purchaseLocationOrder" class="form-control">
              <option value="">- اختر الموقع -</option>
              <option value="الرياض">الرياض</option>
              <option value="جدة">جدة</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="purchaseReasonOrder">سبب الطلب:</label>
            <input type="text" id="purchaseReasonOrder" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="purchaseRequesterOrder">مقدم الطلب:</label>
            <input type="text" id="purchaseRequesterOrder" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="purchaseNotesOrder">ملاحظات:</label>
            <input type="text" id="purchaseNotesOrder" class="form-control">
          </div>
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <label for="supplierCodeOrder2">كود المورد:</label>
              <input type="text" id="supplierCodeOrder2" class="form-control" placeholder=" كود المورد"
                oninput="fetchResourceDetailsOrder2('code')">
            </div>
            <div class="col-md-4">
              <label for="SupplierNameOrder2">اسم المورد:</label>
              <input list="resourceSuggestionsOrder2" type="text" id="SupplierNameOrder2" class="form-control"
                placeholder=" اسم المورد" oninput="fetchResourceDetailsOrder2('name')">
              <datalist id="resourceSuggestionsOrder2"></datalist>
            </div>
          </div>

        </div>

        <hr>
        <div class="row g-3 align-items-end">
          <div class="col-md-2">
            <label for="itemCodeOrder2">كود الصنف:</label>
            <input type="text" id="itemCodeOrder2" class="form-control" placeholder="كود الصنف"
              oninput="fetchItemDetailsOrder2('code')">
          </div>
          <div class="col-md-2">
            <label for="itemNameOrder2">اسم الصنف:</label>
            <input list="itemSuggestionsOrder2" type="text" id="itemNameOrder2" class="form-control"
              placeholder="اسم الصنف" oninput="fetchItemDetailsOrder2('name')">
          </div>
          <div class="col-md-2">
            <label for="purchaseItemQuantity2">الكمية:</label>
            <input type="number" id="purchaseItemQuantity2" class="form-control">
          </div>
          <div class="col-md-2">
            <label for="purchaseItemUnitPrice2">سعر الوحدة:</label>
            <input type="number" id="purchaseItemUnitPrice2" class="form-control" step="any">
          </div>
          <div class="col-md-2">
            <label for="purchaseItemNotes2">ملاحظات:</label>
            <input type="text" id="purchaseItemNotes2" class="form-control">
          </div>
          <div class="col-md-2 d-grid">
            <hr>
            <button type="button" onclick="addItemToPurchase2()">➕ إضافة صنف</button>
          </div>
        </div>

        <hr>

        <div class="table-responsive">
          <table class="table table-bordered text-center mt-3">
            <thead class="table-dark">
              <tr>
                <th>كود الصنف</th>
                <th>اسم الصنف</th>
                <th>الكمية</th>
                <th>سعر الوحدة</th>
                <th>الإجمالي</th>
                <th>ملاحظات</th>
                <th>حذف</th>
              </tr>
            </thead>
            <tbody id="purchaseItemsTable2">
              <tr>
                <td colspan="7">لا توجد أصناف مضافة</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="text-center mt-3">
          <hr>
          <button type="button" onclick="updateOrder()">💾 حفظ الطلب</button>
        </div>
      </div>
    </div>
  </div>

  <div id="orderQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        البحث عن طلب
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="queryCompanySelectOrder">اختر الشركة:</label>
          <select id="queryCompanySelectOrder" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeOrder">
          <label> رقم المستند:</label>
          <input type="text" id="queryDocNum">
        </div>
        <div class="grid-item">
          <label for="location">المنطقة:</label>
          <select id="queryLocation" name="Location" required>
            <option value=""> - Location -</option>
          </select>
          <label> التاريخ:</label>
          <input type="date" id="queryDate">
        </div>
        <div class="grid-item">
          <label> المنتج:</label>
          <input type="text" id="queryItme">
          <label for="filterItemOrder">الصنف:</label>
          <select id="filterItemOrder" required>
            <option value="">- اختر الصنف -</option>
          </select>
        </div>
        <div class="grid-item">
          <label for="filterSupplierOrder">المورد:</label>
          <select id="filterSupplierOrder" required>
            <option value="">- اختر المورد -</option>
          </select>
        </div>
      </div>
      <div class="card">
        <div class="toolbar">
          <div class="button-group">
            <button onclick="printTableOrder()">🖨️ طباعة</button>
            <button onclick="exportToExcelOeder()">📥 تحميل كملف Excel</button>
            <button onclick="searchDataOrder()">🔍 تحديث </button>
            <div class="grid-item" style="grid-column: span 5; margin-bottom: 10px;">
              <label for="generalSearchOrder">Search: </label>
              <input type="text" id="generalSearchOrder" placeholder="اكتب كلمة للبحث..." oninput="searchDataOrder()"
                style="width: 100%; padding: 6px;">
            </div>
          </div>

        </div>
      </div>
      <div id="queryResultsOrder"
        style="overflow-y: auto; height: 400px; border: 1px solid #cccccc00; padding: 10px; margin-top: 10px;">
      </div>
    </div>
  </div>

  <div id="deliveryForm" class="content" style="display: none;">
    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">طلب موافقة تسليم - قسم IT</div>

      <div class="card-body">
        <div class="col-md-3">
          <label for="CompanySelectDelivery">اختر الشركة:</label>
          <select id="CompanySelectDelivery" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeDelivery">
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label for="approvalDateDelivery">تاريخ الموافقة:</label>
            <input type="date" id="approvalDateDelivery" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label for="LocationDelivery">الموقع:</label>
            <select id="LocationDelivery" class="form-control" required>
              <option value="">- اختر الموقع -</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="reasonDelivery">سبب الاحتياج:</label>
            <input type="text" id="reasonDelivery" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label for="requestDelivery">طالب التسليم:</label>
            <input type="text" id="requestDelivery" class="form-control" required>
          </div>
        </div>

        <div class="row g-3 align-items-end mb-3">
          <div class="col-md-2">

            <label for="ItemCodeDelivery">كود الصنف:</label>
            <input type="text" id="ItemCodeDelivery" class="form-control" placeholder=" كود الصنف"
              oninput="fetchItemDetailsDelivery('code')">
          </div>
          <div class="col-md-2">

            <label for="ItemNameDelivery">اسم الصنف:</label>
            <input list="itemSuggestionsDelivery" type="text" id="ItemNameDelivery" class="form-control"
              placeholder=" اسم الصنف" oninput="fetchItemDetailsDelivery('name')">
            <datalist id="itemSuggestionsDelivery"></datalist>
          </div>
          <div class="col-md-2">
            <label>الكمية:</label>
            <input type="number" class="form-control" id="newQuantityDelivery" placeholder="الكمية">
          </div>
          <div class="col-md-2">
            <label>المستفيد:</label>
            <input type="text" class="form-control" id="newBeneficiary" placeholder="المستفيد">
          </div>
          <div class="col-md-2">
            <label>ملاحظات:</label>
            <input type="text" class="form-control" id="newNotesDelivery" placeholder="ملاحظات">
          </div>
          <div class="col-md-2 d-grid">
            <hr>
            <button type="button" onclick="addRowDelivery()">➕ إضافة صف</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered text-center mt-3" id="orderTableDelivery">
            <thead class="table-dark">
              <tr>
                <th>كود الصنف</th>
                <th>اسم الصنف</th>
                <th>الكمية</th>
                <th>المستفيد</th>
                <th>ملاحظات</th>
                <th>حذف</th>
              </tr>
            </thead>
            <tbody id="deliveryItemsBody">
              <tr>
                <td colspan="7">لا توجد أصناف مضافة</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="text-center mt-3">
          <hr>
          <button type="button" onclick="savedelivery()">💾 حفظ الطلب</button>
        </div>
      </div>
    </div>
  </div>

  <div id="deliveryAmendment" class="content" style="display: none;">
    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        تعديل طلب موافقة تسليم بقسم IT
      </div>

      <div class="card-body">
        <form id="deliveryForm">

          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label for="documentNumberDelivery">رقم المستند:</label>
              <input type="number" id="documentNumberDelivery" class="form-control"
                placeholder="أدخل رقم المستند للبحث">
            </div>
            <div class="col-md-3 d-grid align-self-end">

              <button type="button" onclick="postToDisbursement()">POST</button>
            </div>
          </div>

          <hr>
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label for="CompanySelectDelivery2">اختر الشركة:</label>
              <select id="CompanySelectDelivery2" class="form-control"></select>
              <input type="hidden" id="selectedCompanyCodeDelivery">
            </div>
            <div class="col-md-3">
              <label for="approvalDateDelivery2">تاريخ الموافقة:</label>
              <input type="date" id="approvalDateDelivery2" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label for="LocationDelivery2">الموقع:</label>
              <select id="LocationDelivery2" class="form-control" required>
                <option value="">- اختر الموقع -</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="reasonDelivery2">سبب الاحتياج:</label>
              <input type="text" id="reasonDelivery2" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label for="requestDelivery2">طالب الموافقة:</label>
              <input type="text" id="requestDelivery2" class="form-control" required>
            </div>
          </div>

          <hr>
          <div class="row g-3 align-items-end mb-3">
            <div class="col-md-2">
              <label for="itemCodeDelivery2">كود الصنف:</label>
              <input type="text" id="itemCodeDelivery2" class="form-control" placeholder="كود الصنف"
                oninput="fetchItemDetailsDelivery2('code')">
            </div>
            <div class="col-md-2">
              <label for="itemNameDelivery2">اسم الصنف:</label>
              <input list="itemSuggestionsDelivery2" type="text" id="itemNameDelivery2" class="form-control"
                placeholder="اسم الصنف" oninput="fetchItemDetailsDelivery2('name')">
              <datalist id="itemSuggestionsDelivery2"></datalist>
            </div>
            <div class="col-md-2">
              <label for="QuantityDelivery2">الكمية:</label>
              <input type="number" id="QuantityDelivery2" class="form-control">
            </div>
            <div class="col-md-2">
              <label for="beneficiary2">المستفيد:</label>
              <input type="text" id="beneficiary2" class="form-control">
            </div>
            <div class="col-md-2">
              <label for="notesDelivery2">ملاحظات:</label>
              <input type="text" id="notesDelivery2" class="form-control">
            </div>
            <div class="col-md-2 d-grid">
              <hr>
              <button type="button" onclick="addItemToDelivery2()">➕ إضافة صنف</button>
            </div>
          </div>

          <hr>
          <div class="table-responsive">
            <table class="table table-bordered text-center mt-3">
              <thead class="table-dark">
                <tr>
                  <th>كود الصنف</th>
                  <th>اسم الصنف </th>
                  <th>الكمية</th>
                  <th>المستفيد</th>
                  <th>ملاحظات</th>
                  <th>حذف</th>
                </tr>
              </thead>
              <tbody id="deliveryItemsTable">
                <tr>
                  <td colspan="6">لا توجد أصناف مضافة</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="text-center mt-3">
            <hr>
            <button type="button" onclick="updateDelivery()">💾 حفظ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="deliveryQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        البحث عن طلب موافقه التسليم
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="queryCompanySelectDelivery">اختر الشركة:</label>
          <select id="queryCompanySelectDelivery" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeDelivery">

          <label> رقم المستند:</label>
          <input type="text" id="queryDocNumDelivery">

        </div>
        <div class="grid-item">
          <label for="locationdelivery2">المنطقة:</label>
          <select id="locationdelivery2" name="Location" required>
            <option value=""> - Location -</option>
          </select>
          <label> التاريخ:</label>
          <input type="date" id="queryDateDelivery">
        </div>
        <div class="grid-item">
          <label for="filterItemDelivery">الصنف:</label>
          <select id="filterItemDelivery" required>
            <option value="">- اختر الصنف -</option>
          </select>
        </div>

      </div>
      <div class="card">
        <div class="toolbar">
          <div class="button-group">
            <button onclick="printTableDelivery()">🖨️ طباعة</button>
            <button onclick="exportToExceDlelivery()">📥 تحميل كملف Excel</button>
            <button onclick="searchDatadelivery()">🔍 تحديث</button>
            <div class="grid-item" style="grid-column: span 5; margin-bottom: 10px;">
              <label for="generalSearchDelivery">Search: </label>
              <input type="text" id="generalSearchDelivery" placeholder="اكتب كلمة للبحث..."
                oninput="searchDatadelivery()" style="width: 100%; padding: 6px;">
            </div>
          </div>
        </div>
      </div>
      <div id="queryResultsDelivery"
        style="overflow-y: auto; height: 400px; border: 1px solid #cccccc00; padding: 10px; margin-top: 10px;">
      </div>
    </div>
  </div>

  <div id="AddAProductAdditionForm" class="content" style="display: none;">
    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        إذن اضافه
      </div>
      <div class="grid-container">
        <div class="row g-3 align-items-end mb-3">
          <div class="col-md-4">
            <label for="CompanySelectAddition">اختر الشركة:</label>
            <select id="CompanySelectAddition" class="form-control"></select>
            <input type="hidden" id="selectedCompanyCodeAddition">
          </div>
          <div class="col-md-4">
            <label for="documentDate">التاريخ:</label>
            <input type="date" id="documentDateAddition" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="documentNumber">رقم المستند:</label>
            <input type="text" id="documentNumberAddition" class="form-control" placeholder="أدخل رقم المستند">
          </div>
          <div class="col-md-4">
            <label for="location">المنطقه :</label>
            <select id="locationAddition" class="form-control" name="Location">
              <option value=""> - Location -</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="notes">ملاحظات:</label>
            <input type="text" id="notesAddition" class="form-control" placeholder="أدخل أي ملاحظات">
          </div>
        </div>
      </div>
    </div>

    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        إضافة مورد
      </div>
      <div class="card-body">

        <div class="row">
          <div class="col-md-3">
            <label for="supplierCode">كود المورد:</label>
            <input type="text" id="supplierCode" class="form-control" placeholder=" كود المورد"
              oninput="fetchResourceDetails('code')">
          </div>
          <div class="col-md-3">
            <label for="SupplierName">اسم المورد:</label>
            <input list="resourceSuggestions" type="text" id="SupplierName" class="form-control"
              placeholder=" اسم المورد" oninput="fetchResourceDetails('name')">
            <datalist id="resourceSuggestions"></datalist>
          </div>
        </div>
      </div>
    </div>

    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        إضافة صنف جديد
      </div>
      <div class="card-body">

        <div class="row">
          <div class="col-md-3">
            <label for="itemCode">كود الصنف:</label>
            <input type="text" id="itemCode2" class="form-control" placeholder=" كود الصنف"
              oninput="fetchItemDetails('code')">
          </div>
          <div class="col-md-3">
            <label for="itemName">اسم الصنف:</label>
            <input list="itemSuggestions" type="text" id="itemName2" class="form-control" placeholder=" اسم الصنف"
              oninput="fetchItemDetails('name')">
            <datalist id="itemSuggestions"></datalist>
          </div>

          <div class="col-md-3">
            <label for="itemQuantity">الكمية:</label>
            <input type="number" id="itemQuantity" class="form-control" placeholder="أدخل الكمية"
              oninput="calculateTotalPrice()">
          </div>
          <div class="col-md-2">
            <label for="itemPrice">السعر:</label>
            <input type="number" id="itemPrice" class="form-control" placeholder="أدخل السعر"
              oninput="calculateTotalPrice()">
          </div>
          <div class="col-md-2">
            <label for="itemTotalPrice">الإجمالي:</label>
            <input type="number" id="itemTotalPrice" class="form-control" placeholder="الإجمالي" readonly>
          </div>
          <div class="col-md-3 d-grid">
            <hr>
            <button type="button" onclick="addItems()">💾 اضافه الصنف </button>
          </div>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="card border shadow-sm mb-4">
        <div class="card-header text-center">
          الأصناف المضافة
        </div>
        <table class="table table-bordered text-center">
          <thead class="table-dark">
            <thead class="table-dark">
              <tr>
                <th>كود الصنف</th>
                <th>اسم الصنف</th>
                <th>الكمية</th>
                <th>السعر</th>
                <th>الإجمالي</th>
                <th>إجراء</th>
              </tr>
            </thead>
          </thead>
          <tbody id="itemsTableBody">
            <tr>
              <td colspan="4">لا توجد أصناف مضافة</td>
            </tr>
          </tbody>
        </table>
        <hr>
        <button type="button" onclick="saveAddItemsAll()">💾 حفظ اذن لاضافه </button>
      </div>
    </div>

  </div>

  <div id="InquiryAProductAdditionForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        استعلام إذون الإضافة
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="filterCompanySelectAddition">اختر الشركة:</label>
          <select id="filterCompanySelectAddition" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeAddition">
          <label>المنطقة:</label>
          <select id="filterRegion">
            <option value="">الكل</option>
          </select>
        </div>

        <div class="grid-item">
          <label>من تاريخ:</label>
          <input type="date" id="filterDateFrom">
          <label>إلى تاريخ:</label>
          <input type="date" id="filterDateTo">
        </div>

        <div class="grid-item">
          <label>رقم المستند من:</label>
          <input type="number" id="filterDocIdFrom" placeholder="مثال: 1">
          <label>إلى:</label>
          <input type="number" id="filterDocIdTo" placeholder="مثال: 100">
        </div>

        <div class="grid-item">
          <label>المورد:</label>
          <input list="suppliers" id="filterSupplier" placeholder="اختر أو اكتب اسم المورد">
          <label>الصنف:</label>
          <input list="items" id="filterItem" placeholder="اسم أو كود الصنف">
        </div>

      </div>
      <datalist id="suppliers"></datalist>
      <datalist id="items"></datalist>
      <div class="card">
        <div class="grid-container">
          <button onclick="generateAdditionReport()">🔍 عرض الإذون</button>
          <button onclick="downloadReportAsExcel()">⬇️ تحميل كـ Excel</button>
        </div>
        <div id="additionResultsContainer"
          style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
          <table id="additionTable" border="1" style="width: 100%; border-collapse: collapse; text-align: center;">
            <thead></thead>
            <tbody id="additionBody">
              <tr>
                <td colspan="9">اضغط على "عرض الإذون" للبدء</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="AddProductDisbursement" class="content" style="display: none;">
    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        إذن صرف
      </div>
      <div class="grid-container">
        <div class="row g-3 align-items-end mb-3">
          <div class="col-md-4">
            <label for="CompanySelectDisbursement">اختر الشركة:</label>
            <select id="CompanySelectDisbursement" class="form-control"></select>
            <input type="hidden" id="selectedCompanyCodeDisbursement">
          </div>
          <div class="col-md-4">
            <label for="documentDate">التاريخ:</label>
            <input type="date" id="documentDateDisbursement" class="form-control">
          </div>
          <div class="col-md-4">
            <label for="documentNumber">رقم المستند:</label>
            <input type="text" id="documentNumberDisbursement" class="form-control" placeholder="أدخل رقم المستند">
          </div>
          <div class="col-md-4">
            <label for="location">المنطقه :</label>
            <select id="locationDisbursement" class="form-control" name="Location" required>
              <option value=""> - Location -</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="notes">ملاحظات:</label>
            <input type="text" id="notesDisbursement" class="form-control" placeholder="أدخل أي ملاحظات">
          </div>
        </div>
      </div>
    </div>

    <div class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        إضافة صنف
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <label for="itemCode">كود الصنف:</label>
            <input type="text" id="itemCode3" class="form-control" placeholder=" كود الصنف"
              oninput="fetchItemDetailsDisbursement('code');">
          </div>
          <div class="col-md-3">
            <label for="itemName">اسم الصنف:</label>
            <input list="itemSuggestions" type="text" id="itemName3" class="form-control" placeholder=" اسم الصنف"
              oninput="handleItemNameInput()">
            <datalist id="itemSuggestions"></datalist>
          </div>
          <div class="col-md-3">
            <label for="itemQuantity">الكمية:</label>
            <input type="number" id="itemQuantityDisbursement" class="form-control" placeholder="أدخل الكمية">
            <div class="col-md-3">
              <label for="itemPriceDisbursement">السعر:</label>
              <input type="text" id="itemPriceDisbursement" placeholder="سعر الصنف" readonly>
            </div>
          </div>
          <div class="col-md-3 d-grid">
            <hr>
            <button type="button" onclick="addItemsDisbursement()">💾 اضافه الصنف </button>
          </div>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="card border shadow-sm mb-4">
        <div class="card-header text-center">
          الأصناف المضافة
        </div>
        <table class="table table-bordered text-center">
          <thead class="table-dark">
            <tr>
              <th>كود الصنف</th>
              <th>اسم الصنف</th>
              <th>الكمية</th>
              <th>السعر</th>
              <th>الإجمالي</th>
              <th>إجراء</th>
            </tr>
          </thead>
          <tbody id="itemsTableBodyDisbursement">
            <tr>
              <td colspan="4">لا توجد أصناف مضافة</td>
            </tr>
          </tbody>
        </table>
        <hr>
        <button type="button" onclick="saveAddItemsAllDisbursement()">💾 حفظ اذن صرف </button>
      </div>
    </div>
  </div>

  <div id="InquiryAProductDisbursement" class="content" style="display: none;">
    <h2>استعلام إذون صرف</h2>
    <div class="card">
      <div class="card-header text-center">
        استعلام إذون صرف
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="filterCompanySelectDisbursement">اختر الشركة:</label>
          <select id="filterCompanySelectDisbursement" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeDisbursement">

          <label>المنطقة:</label>
          <select id="filterRegionDisbursement">
            <option value="">الكل</option>
          </select>
        </div>

        <div class="grid-item">
          <label>من تاريخ:</label>
          <input type="date" id="filterDateFromDisbursement">
          <label>إلى تاريخ:</label>
          <input type="date" id="filterDateToDisbursement">
        </div>

        <div class="grid-item">
          <label>رقم المستند من:</label>
          <input type="number" id="filterDocIdFromDisbursement" placeholder="مثال: 1">
          <label>إلى:</label>
          <input type="number" id="filterDocIdToDisbursement" placeholder="مثال: 100">
        </div>

        <div class="grid-item">
          <label>الصنف:</label>
          <input list="items" id="filterItemDisbursement" placeholder="اسم أو كود الصنف">
        </div>
      </div>


      <datalist id="suppliers"></datalist>
      <datalist id="items"></datalist>
    </div>
    <div class="card">
      <div class="grid-container">
        <button onclick="generateAdditionReportDisbursement()">🔍 عرض الإذون</button>
        <button onclick="downloadReportAsExcelDisbursement()">⬇️ تحميل كـ Excel</button>
      </div>
      <div id="additionResultsContainerDisbursement"
        style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
        <table id="additionTableDisbursement" border="1"
          style="width: 100%; border-collapse: collapse; text-align: center;">
          <thead></thead>
          <tbody id="additionBodyDisbursement">
            <tr>
              <td colspan="9">اضغط على "عرض الإذون" للبدء</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="DisbursementQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        رصيد الأصناف في المخزون
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="itemCode">كود الصنف:</label>
          <input type="text" id="filterCode" placeholder="مثال: 1001">
        </div>
        <div class="grid-item">
          <label for="filterItemName">الصنف:</label>
          <input type="text" id="filterItemName">
        </div>
      </div>

      <div class="card">
        <div class="grid-container">
          <button onclick="generateStockReport()">🔍</button>
          <button onclick="exportToExcelStore()">📥 تحميل كملف Excel</button>
        </div>
      </div>

      <table class="table table-bordered">
        <thead>
          <tr>
            <th>كود الصنف</th>
            <th>اسم الصنف</th>
            <th>الكمية المضافة</th>
            <th>قيمة الإضافة</th>
            <th>الكمية المصروفة</th>
            <th>قيمة الصرف</th>
            <th>الكمية المتبقية</th>
            <th>قيمة الباقي</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>
    </div>
  </div>

  <div id="maintenanceForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        طلب صيانة IT
      </div>
      <form class="grid-container">
        <div class="grid-item">
          <label for="CompanySelectMaintenance">اختر الشركة:</label>
          <select id="CompanySelectMaintenance" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeMaintenance">

          <label for="maintenanceDate">تاريخ العطل:</label>
          <input type="date" id="maintenanceDate" name="date" required>
          <label for="description">وصف العطل:</label>
          <textarea id="description" name="description" rows="3" required></textarea>
        </div>

        <div class="grid-item">
          <label for="device">الجهاز المطلوب صيانته:</label>
          <select id="device" name="device" required>
            <option value="">- اختر الجهاز -</option>
            <option value="computer">كمبيوتر</option>
            <option value="laptop">لابتوب</option>
            <option value="phone">هاتف</option>
            <option value="printer">طابعة</option>
            <option value="Router">راوتر</option>
            <option value="screen">شاشات</option>
            <option value="camera">كاميرا</option>
            <option value="another">أخرى</option>
          </select>

          <label for="name">اسم طالب الصيانة:</label>
          <input type="text" id="name" name="name" required>

        </div>
        <div class="grid-item">
          <hr>
          <button type="button" onclick="SaveTheMaintenanceRequest()">💾 حفظ البيانات</button>
        </div>
      </form>
    </div>
    <div id="computerDetails" style="display: none;" class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        كمبيوتر
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="pcNumMaintenanc">رقم مستند الجهاز:</label>
          <input type="text" id="pcNumMaintenanc" name="pcNumMaintenanc" placeholder="مثال: 101">
        </div>
        <div class="grid-item">
          <label for="pcUserMaintenanc">اسم المستخدم:</label>
          <input type="text" id="pcUserMaintenanc" name="pcUserMaintenanc" readonly>
        </div>
        <div class="grid-item">
          <label for="pcLocationMaintenanc">الموقع:</label>
          <input type="text" id="pcLocationMaintenanc" name="pcLocationMaintenanc" readonly>
        </div>
        <div class="grid-item">
          <label for="deviceModelMaintenanc">نوع الجهاز :</label>
          <input type="text" id="deviceModelMaintenanc" name="deviceModelMaintenanc" readonly>
        </div>
      </div>
    </div>
    <div id="phoneDetails" style="display: none;" class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        الهواتف
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="docNumberPhoneMaintenanc">رقم مستند الجهاز:</label>
          <input type="text" id="docNumberPhoneMaintenanc" name="docNumberPhoneMaintenanc" placeholder="مثال: 101">
        </div>
        <div class="grid-item">
          <label for="employeNamePhoneMaintenanc">اسم المستخدم:</label>
          <input type="text" id="employeNamePhoneMaintenanc" name="employeNamePhoneMaintenanc" readonly>
        </div>
        <div class="grid-item">
          <label for="locationPhoneMaintenanc">الموقع:</label>
          <input type="text" id="locationPhoneMaintenanc" name="locationPhoneMaintenanc" readonly>
        </div>
        <div class="grid-item">
          <label for="phoneTypeMaintenanc">نوع الجهاز :</label>
          <input type="text" id="phoneTypeMaintenanc" name="phoneTypeMaintenanc" readonly>
        </div>
      </div>
    </div>

    <div id="laptopDetails" style="display: none;" class="card border shadow-sm mb-4">
      <div class="card-header text-center">
        لابتوب
      </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="pcNumMaintenanc2">رقم مستند الجهاز:</label>
          <input type="text" id="pcNumMaintenanc2" name="pcNumMaintenanc2" placeholder="مثال: 101">
        </div>
        <div class="grid-item">
          <label for="pcUserMaintenanc2">اسم المستخدم:</label>
          <input type="text" id="pcUserMaintenanc2" name="pcUserMaintenanc2" readonly>
        </div>
        <div class="grid-item">
          <label for="pcLocationMaintenanc2">الموقع:</label>
          <input type="text" id="pcLocationMaintenanc2" name="pcLocationMaintenanc2" readonly>
        </div>
        <div class="grid-item">
          <label for="deviceModelMaintenanc2">نوع الجهاز :</label>
          <input type="text" id="deviceModelMaintenanc2" name="deviceModelMaintenanc2" readonly>
        </div>
      </div>
    </div>
    <div id="screenDetails" style="display: none;" class="card border shadow-sm mb-4">
      <div class="card-header text-center">شاشات</div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="screenMaintenancDoc">رقم مستند الجهاز:</label>
          <input type="text" id="screenMaintenancDoc" name="screenMaintenancDoc" placeholder="مثال: 101">
        </div>

        <div class="grid-item">
          <label for="screenMaintenanc">نوع الشاشة:</label>
          <select id="screenMaintenanc">
            <option value="">--اختر نوع الشاشة--</option>
            <option value="عادية">شاشة عادية</option>
            <option value="كمبيوتر">شاشة كمبيوتر</option>
          </select>
        </div>

        <div id="CommonFields" style="display: none;">
          <div class="grid-item">
            <label for="screenLocationMaintenanc">الموقع:</label>
            <input type="text" id="screenLocationMaintenanc" name="screenLocationMaintenanc" readonly>
          </div>

          <div class="grid-item">
            <label for="deviceModelMaintenancScreen">نوع الجهاز:</label>
            <input type="text" id="deviceModelMaintenancScreen" name="deviceModelMaintenancScreen" readonly>
          </div>

        </div>

        <div id="MobileFields" style="display: none;">
          <div class="grid-item">
            <label for="linkedEmployeeNameMaintenanc">اسم الموظف المرتبط:</label>
            <input type="text" id="linkedEmployeeNameMaintenanc" name="linkedEmployeeNameMaintenanc" readonly>
          </div>
        </div>
      </div>
    </div>
    <div id="printerDetails" style="display: none;" class="card border shadow-sm mb-4">
      <div class="card-header text-center">طابعات</div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="printerNumMaintenanc">رقم مستند الجهاز:</label>
          <input type="text" id="printerNumMaintenanc" name="printerNumMaintenanc" placeholder="مثال: 101">
        </div>

        <div class="grid-item">
          <label for="printerLocationMaintenanc">الموقع:</label>
          <input type="text" id="printerLocationMaintenanc" name="printerLocationMaintenanc" readonly>
        </div>

        <div class="grid-item">
          <label for="printerdeviceModelMaintenanc">نوع الجهاز :</label>
          <input type="text" id="printerdeviceModelMaintenanc" name="printerdeviceModelMaintenanc" readonly>
        </div>

        <div class="grid-item">
          <label for="printerModelDetails">موديل الطابعة:</label>
          <input type="text" id="printerModelDetails" name="printerModelDetails" readonly>
        </div>

        <div class="grid-item">
          <label for="previousCounter">عداد سابق:</label>
          <input type="number" id="previousCounter" name="previousCounter" placeholder="أدخل العداد السابق">
        </div>

        <div class="grid-item">
          <label for="currentCounter">عداد حالي:</label>
          <input type="number" id="currentCounter" name="currentCounter" placeholder="أدخل العداد الحالي">
        </div>

        <div class="grid-item">
          <label for="totalCounter">إجمالي الطابعات:</label>
          <input type="number" id="totalCounter" name="totalCounter" readonly>
        </div>
      </div>
    </div>
    <div id="cameraDetails" style="display: none;" class="card border shadow-sm mb-4">
      <div class="card-header text-center">كاميرات </div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="cameraNumMaintenanc">رقم مستند الجهاز:</label>
          <input type="text" id="cameraNumMaintenanc" name="cameraNumMaintenanc" placeholder="مثال: 101">
        </div>

        <div class="grid-item">
          <label for="cameraLocationMaintenanc">الموقع:</label>
          <input type="text" id="cameraLocationMaintenanc" name="cameraLocationMaintenanc" readonly>
        </div>

        <div class="grid-item">
          <label for="cameradeviceModelMaintenanc">نوع الجهاز :</label>
          <input type="text" id="cameradeviceModelMaintenanc" name="cameradeviceModelMaintenanc" readonly>
        </div>

        <div class="grid-item">
          <label for="cameraModelDetails">موديل الطابعة:</label>
          <input type="text" id="cameraModelDetails" name="cameraModelDetails" readonly>
        </div>
      </div>
    </div>

    <div id="RouterDetails" style="display: none;" class="card border shadow-sm mb-4">
      <div class="card-header text-center">راوتر</div>
      <div class="grid-container">
        <div class="grid-item">
          <label for="RouterNumMaintenanc">رقم مستند الجهاز:</label>
          <input type="text" id="RouterNumMaintenanc" name="RouterNumMaintenanc" placeholder="مثال: 101">
        </div>

        <div class="grid-item">
          <label for="routerType">نوع الراوتر:</label>
          <select id="routerType">
            <option value="">اختر النوع</option>
            <option value="fixed">ثابت</option>
            <option value="mobile">متنقل</option>
          </select>
        </div>

        <div id="routerCommonFields" style="display: none;">
          <div class="grid-item">
            <label for="RouterCompanyMaintenanc">الشركة:</label>
            <input type="text" id="RouterCompanyMaintenanc" name="RouterCompanyMaintenanc" readonly>
          </div>
          <div class="grid-item">
            <label for="RouterLocationMaintenanc">الموقع:</label>
            <input type="text" id="RouterLocationMaintenanc" name="RouterLocationMaintenanc" readonly>
          </div>
          <div class="grid-item">
            <label for="RouterdeviceModelMaintenanc">نوع الجهاز :</label>
            <input type="text" id="RouterdeviceModelMaintenanc" name="RouterdeviceModelMaintenanc" readonly>
          </div>
        </div>

        <div id="routerMobileFields" style="display: none;">
          <div class="grid-item">
            <label for="RouterUserNameMaintenanc">اسم المستخدم:</label>
            <input type="text" id="RouterUserNameMaintenanc" name="RouterUserNameMaintenanc" readonly>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header text-center">
        طلبات الصيانة
      </div>
      <div class="grid-item" class="content">
        <div style="overflow-y: auto; max-height: 400px; border: 1px solid #ccc; border-radius: 5px;">
          <table id="maintenanceTable">
            <thead>
              <tr>
                <th>رقم الطلب</th>
                <th>اسم الشركه</th>
                <th>اسم الموظف</th>
                <th>رقم مستند الجهاز</th>
                <th>الموقع</th>
                <th>نوع الجهاز</th>
                <th>التصنيف</th>
                <th>تاريخ الطلب</th>
                <th>الحالة</th>
                <th>تاريخ الإصلاح</th>
                <th>التعديل</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <div id="editForm"
          style="display: none; padding: 10px; border: 1px solid #ccc; margin-top: 10px; border-radius: 5px;">
          <h2 class="text-center">تعديل طلب الصيانة</h2>
          <form id="maintenanceEditForm">
            <label for="editPrice">سعر الصيانة:</label>
            <input type="number" id="editPrice" required>

            <label for="editFixDetails">ما تم إصلاحه:</label>
            <textarea id="editFixDetails" rows="4" required></textarea>

            <button type="button" onclick="saveMaintenanceDetails()">💾 حفظ التعديلات</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div id="maintenanceQuery" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">الاستعلام عن الصيانات </div>
      <div class="grid-container">

        <div class="grid-item">
          <label for="searchCompanySelectMaintenance">اختر الشركة:</label>
          <select id="searchCompanySelectMaintenance" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeMaintenance">

          <label for=""> رقم مستند :</label>
          <input type="text" id="maintenanceId" placeholder="أدخل رقم المستند">
          <label for="searchDateMaintenance"> التاريخ:</label>
          <input type="date" id="searchDateMaintenance">
        </div>
        <div class="grid-item">
          <label for="Location">المنطقة:</label>
          <select id="locationMaintenanceSearch" name="Location" required>
            <option value=""> - Location -</option>
          </select>

          <label for="device">الجهاز المطلوب صيانته:</label>
          <select id="companySearchMaintenance" name="device2" required onchange="updatePlans()">
            <option value="">- maintenance -</option>
            <option value="computer">pc</option>
            <option value="printer">Printer</option>
            <option value="Router">Router</option>
            <option value="phone">phone</option>
            <option value="camera">camera</option>
            <option value="Another">Another</option>
          </select>
        </div>
      </div>
      <button onclick="searchMaintenance()">🔍 بحث</button>
      <div id="queryResultsMaintenance"
        style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"></div>
      </table>
    </div>
  </div>

  <div id="maintenanceAmendment" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        Modify maintenance request
      </div>
      <form class="grid-container">

        <div class="grid-item">
          <label for="editDocumentNumber">Order number:</label>
          <input type="text" id="editDocumentNumber" name="editDocumentNumber">

          <label for="CompanySelectMaintenance2"> Company:</label>
          <select id="CompanySelectMaintenance2" class="form-control"></select>
          <input type="hidden" id="selectedCompanyCodeMaintenance">

        </div>

        <div class="grid-item">
          <label for="editMaintenanceDate">Malfunction Date:</label>
          <input type="date" id="editMaintenanceDate" name="editMaintenanceDate" disabled>
          <label for="editDevice">Device to be serviced:</label>
          <select id="editDevice" name="editDevice" required onchange="handleEditDeviceChange()" disabled>
            <option value="">- Select the device -</option>
            <option value="computer">Computer</option>
            <option value="printer">Printer</option>
            <option value="Router">Router</option>
            <option value="phone">Phone</option>
            <option value="camera">Camera</option>
            <option value="Laptop">Laptop</option>
            <option value="Another">Another</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="editName">Name of applicant:</label>
          <input type="text" id="editName" name="editName" required>

          <label for="editDescription">Malfunction description:</label>
          <textarea id="editDescription" name="editDescription" rows="3" required></textarea>
        </div>

        <div class="grid-item">
          <label for="editPrice2">Maintenance price:</label>
          <input type="number" id="editPrice2" name="editPrice" required>

          <label for="editFixDetails2">What was fixed:</label>
          <textarea id="editFixDetails2" name="editFixDetails" rows="3" required></textarea>
        </div>

        <div class="grid-item">
          <label for="editFixDate2">Repair day:</label>
          <input type="date" id="editFixDate2" name="editFixDate" required>
        </div>

        <div class="grid-item">
          <label for="status2">Status:</label>
          <input type="text" id="status2" name="status" readonly>
        </div>
      </form>
      <hr>
      <button type="button" onclick="SaveTheMaintenanceRequestModification()">💾 Save modifications</button>
    </div>
  </div>

  <div id="definitionCompanies" class="content">
    <div class="card">
      <div class="card-header text-center">
        تعريف شركة
      </div>

      <label for="companyCode1">كود الشركة:</label>
      <input type="text" id="companyCode1" required>

      <label for="name1">اسم الشركة:</label>
      <input type="text" id="name1" required>

      <label for="field1">المجال:</label>
      <input type="text" id="field1" required>

      <label for="description1">نبذة عن الشركة:</label>
      <textarea id="description1" rows="3" required></textarea>

      <label for="website1">الموقع الإلكتروني:</label>
      <input type="text" id="website1">

      <hr>
      <button onclick="addSaveCompanies()">💾 حفظ الشركة</button>
    </div>
    <div class="card">
      <div class="card-header text-center">
        جدول الشركات
      </div>
      <table id="CompaniesTable">

        <thead>
          <tr>
            <th>كود الشركة</th>
            <th>اسم الشركة</th>
            <th>المجال</th>
            <th>نبذة</th>
            <th>الموقع الإلكتروني</th>
          </tr>
        </thead>
        <tbody id="companiesBody">
        </tbody>
      </table>
    </div>
  </div>

  <div id="powerManagement" class="content" style="margin-top: 20px;">
    <div class="card shadow-sm border-0">
      <div class="card-header text-center">
        إدارة الصلاحيات
      </div>

      <div class="card-body">
        <div class="row g-3 align-items-center mb-4">
          <div class="col-md-6 col-sm-12">
            <label for="powerManagementUser" class="form-label">اسم المستخدم:</label>
            <input type="text" id="powerManagementUser" class="form-control text-center" placeholder="أدخل اسم المستخدم"
              onkeyup="if(event.key === 'Enter') loadUserPermissions()">
          </div>
          <div class="col-md-6 col-sm-12 d-flex align-items-end justify-content-center gap-2 mt-2">
            <button onclick="loadUserPermissions()">
              🔍 تحميل الصلاحيات
            </button>
            <button onclick="updatePowerManagemen()">
              💾 حفظ
            </button>
            <button onclick="grantAllPermissions()">
              🔓 فتح كل الصلاحيات
            </button>
          </div>
        </div>

        <div class="card border-0">
          <div class="card-header bg-light text-center fw-bold">
            بيانات الصلاحيات
          </div>
          <div id="powerManagementResults"
            style="overflow-y: auto; height: 400px; border: 1px solid #dee2e6; padding: 15px; margin-top: 10px; background-color: #f9f9f9;">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="companySettingsForm" class="content">
    <div class="card card-body">
      <div class="card-header text-center"> إعدادات الفاتوره </div>

      <div class="grid-container">
        <div class="grid-item">
          <div class="form-group">
            <label for="invoiceCompanyCode"> كود الشركة:</label>
            <input type="text" id="invoiceCompanyCode" class="form-control" onblur="fetchCompanyByCode()">
          </div>
          <div class="form-group">
            <label> اسم الشركة:</label>
            <input type="text" id="invoiceCompanyName" class="form-control" readonly>
          </div>
          <label>العنوان:</label>
          <input type="text" id="inputCompanyAddress" class="form-control">
        </div>
        <div class="grid-item">
          <label>تليفون:</label>
          <input type="text" id="inputCompanyPhone" class="form-control">

          <label>الإيميل:</label>
          <input type="text" id="inputCompanyEmail" class="form-control">

          <label>العلامة المائية:</label>
          <input type="text" id="inputCompanyWatermark" class="form-control">
        </div>
        <div class="grid-item">
          <label>شعار الشركة:</label>
          <input type="file" id="inputCompanyLogoFile" class="form-control" accept="image/*"
            onchange="previewLogo(event)">
          <img id="logoPreview" src="" style="max-height: 80px; margin-top: 10px;">
        </div>
      </div>
      <button onclick="updateCompanySettings()">💾 حفظ التعديلات</button>
    </div>
    <div class="card">
      <div class="card-header text-center"> بيانات الشركة الحالية: </div>

      <table class="table table-bordered text-center">
        <thead class="table-light">
          <tr>
            <th>الاسم</th>
            <th>العنوان</th>
            <th>التليفون</th>
            <th>الإيميل</th>
            <th>العلامة المائية</th>
            <th>الشعار</th>
          </tr>
        </thead>
        <tbody id="companySettingsTableBody">
          <tr>
            <td colspan="1">جاري التحميل...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="createUserForm" class="content admin-only" style="display: none;">
    <div class="card mb-3 admin-only">
      <div class="card-header text-center" id="createUserTitle">
        إنشاء مستخدم جديد
      </div>
      <div class="card-body">
        <form onsubmit="createUser(event)">
          <div class="mb-3">
            <label for="username" class="form-label" id="createUsernameLabel">اسم المستخدم</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label" id="createPasswordLabel">كلمة المرور</label>
            <input type="password" class="form-control" id="password" required>
          </div>
          <div class="mb-3">
            <label for="role" class="form-label">نوع المستخدم</label>
            <select class="form-control" id="role" required>
              <option value="user">مستخدم عادي</option>
              <option value="admin">مدير (أدمن)</option>
            </select>
          </div>
          <hr>
          <button type="submit" id="createUserBtn">💾 إنشاء</button>
        </form>
      </div>
    </div>
  </div>

  <div id="editUserSection" class="content admin-only" style="display: none;">
    <div class="card mb-3 admin-only">
      <div class="card-header text-center">تعديل بيانات مستخدم</div>
      <div class="card-body">
        <table class="table table-bordered" id="usersTable">
          <thead class="table-light">
            <tr>
              <th>اسم المستخدم</th>
              <th>كلمة المرور</th>
              <th>الصلاحية</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
          </tbody>
        </table>
      </div>
      <hr>
      <form onsubmit="updateUser(event)">
        <input type="hidden" id="editUserId">

        <div class="mb-3">
          <label class="form-label">اسم المستخدم</label>
          <input type="text" class="form-control" id="editUsername" required>
        </div>

        <div class="mb-3">
          <label class="form-label">كلمة المرور</label>
          <input type="password" class="form-control" id="editPassword" required>
        </div>

        <div class="mb-3">
          <label class="form-label">الصلاحية</label>
          <select class="form-control" id="editRole" required>
            <option value="user">مستخدم</option>
            <option value="admin">مدير</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">الحالة</label>
          <select class="form-control" id="editActive" required>
            <option value="true">مفعّل</option>
            <option value="false">معطل</option>
          </select>
        </div>
        <hr>
        <button type="submit">💾 حفظ التعديلات</button>
      </form>
    </div>
  </div>

  <div id="TemporaryFormInquiry" class="content" style="display: none;">
    <div class="card ">
      <div class="card-header text-center">
        استعلام عن عهدة موظف
      </div>

      <div class="card-body">
        <div class="row g-3 align-items-center justify-content-center mb-3">
          <div class="col-md-6 col-sm-12">
            <input type="text" id="employeeNameSearch" class="form-control text-center" placeholder=" أدخل اسم الموظف">
          </div>
          <div class="col-auto">
            <button onclick="searchAllAssets()" id="employeeSearchBtn">
              🔍 استعلام
            </button>
          </div>
        </div>

        <hr class="mb-4">
        <div id="computersResult" class="mb-4"></div>
        <div id="phonesResult" class="mb-4"></div>
        <div id="linesResult" class="mb-4"></div>
        <div id="routersResult" class="mb-4"></div>
        <div id="screensResult" class="mb-4"></div>
      </div>
    </div>
  </div>

  <div id="addItemForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        إدارة الأصناف
      </div>
      <ul class="nav nav-tabs mb-3 mt-3">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="showSubSection('codingSection')">التكويد</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSubSection('querySection')">الاستعلام</a>
        </li>
      </ul>

      <div id="codingSection" class="grid-container">
        <form>
          <h3>إضافة صنف جديد</h3>
          <div class="grid-item">
            <label for="itemCode">كود الصنف:</label>
            <input type="number" id="itemCode" onblur="fetchItemByCode()" placeholder="رقم الصنف (اختياري أو تلقائي)">
          </div>
          <div class="grid-item">
            <label for="itemName">اسم الصنف:</label>
            <input type="text" class="form-control" id="itemName" placeholder="أدخل اسم الصنف">
          </div>
          <hr>
          <button type="button" onclick="saveAddItems()">💾 حفظ التكويد</button>
        </form>
      </div>

      <div id="querySection" style="display: none;" class="grid-container">
        <h3>جدول الأصناف</h3>
        <div class="mb-3">
          <input type="text" id="searchInput" class="form-control" placeholder="🔍 ابحث باسم الصنف">
          <button class="btn btn-primary mt-2" onclick="searchItems()">بحث</button>
        </div>
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>كود الصنف</th>
              <th>اسم الصنف</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="addARegionForm" class="content">
    <div class="card">
      <div class="card-header text-center">إدارة المناطق</div>
      <ul class="nav nav-tabs mb-3 mt-3">

        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="showSubRegion('codingRegion')">التكويد</a>
        </li>
        <li li class="nav-item">
          <a class="nav-link active" href="#" onclick="showSubRegion('queryRegion')">الاستعلام</a>
        </li>
      </ul>

      <div id="codingRegion" class="p-3">
        <form onsubmit="event.preventDefault(); saveAddRegion();">
          <h3>إضافة منطقه جديد</h3>
          <div class="mb-3">
            <label for="RegionCode">كود المنطقه</label>
            <input type="text" id="RegionCode" onblur="fetchRegionByCode()" placeholder="أدخل رقم المنطقة" />
          </div>
          <div class="mb-3">
            <label for="RegionName">اسم المنطقة</label>
            <input type="text" class="form-control" id="RegionName" placeholder="أدخل اسم المنطقة">
          </div>
          <div class="row mb-2">
            <div class="col"><input type="text" id="lat" class="form-control" placeholder="خط العرض (Lat)"></div>
            <div class="col"><input type="text" id="lng" class="form-control" placeholder="خط الطول (Lng)"></div>
            <div class="col"><input type="number" id="radius" class="form-control" placeholder="المحيط (متر)"></div>
          </div>
          <div id="map"></div>
          <hr>
          <button type="button" onclick="saveAddRegion()">💾 حفظ التكويد</button>
        </form>
      </div>

      <div id="queryRegion" style="display: none;" class="grid-container">
        <h3>جدول المنطقه</h3>
        <div class="mb-3">
          <input type="text" id="searchRegion" class="form-control" placeholder="🔍 ابحث باسم الصنف">
          <button class="btn btn-primary mt-2" onclick="searchRegion()">بحث</button>
        </div>
        <table class="table table-borderedRegion">
          <thead>
            <tr>
              <th>كود الصنف</th>
              <th>اسم الصنف</th>
              <th>خط العرض (Lat)</th>
              <th>خط الطول (Lng)</th>
              <th> لمحيط (متر)</th>
              <th>الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="addAResourceForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center">
        إدارة الموردين
      </div>
      <ul class="nav nav-tabs mb-3 mt-3">
        <li class="nav-item">
          <a class="nav-link active" href="#" onclick="showSubResource('codingResource')">التكويد</a>
        </li>
        <li><a class="nav-link active" href="#" onclick="showSubResource('queryResource')">الاستعلام</a></li>
      </ul>

      <div id="codingResource">
        <div class="card border shadow-sm mb-4">
          <div class="card-header text-center">
            إضافة مورد
          </div>
          <form class="grid-container">
            <div class="grid-item">
              <label>كود المورد:</label>
              <input type="text" id="ResourceCode" onblur="fetchResourceByCode()" placeholder="مثال: RSC-0001" />
            </div>
            <div class="grid-item">
              <label for="ResourceName">اسم المورد</label>
              <input type="text" class="form-control" id="ResourceName" placeholder="أدخل اسم المورد">
            </div>
            <div class="grid-item">
              <label for="ResourcePhone">هاتف المورد</label>
              <input type="text" class="form-control" id="ResourcePhone" placeholder="أدخل هاتف المورد ">
            </div>
          </form>
        </div>

        <div class="card border shadow-sm mb-4">
          <div class="card-header text-center">
            إضافة عنوان
          </div>
          <form class="grid-container">
            <div class="grid-item">
              <label for="ResourceCountries">الدوله</label>
              <input type="text" class="form-control" id="ResourceCountries" placeholder="أدخل الدوله">
              <label for="ResourceGovernorate"> المحافظه</label>
              <input type="text" class="form-control" id="ResourceGovernorate" placeholder="أدخل المحافظه">
            </div>
            <div class="grid-item">
              <label for="ResourceCity">المدينه </label>
              <input type="text" class="form-control" id="ResourceCity" placeholder="أدخل  المدينه">
              <label for="ResourceAddress"> العنوان </label>
              <input type="text" class="form-control" id="ResourceAddress" placeholder="أدخل  العنوان">
            </div>
          </form>
        </div>

        <div class="card border shadow-sm mb-4">
          <div class="card-header text-center">
            إضافة بيانات الضريبيه
          </div>
          <form class="grid-container">
            <div class="grid-item">
              <label for="ResourceDestination">نوع الجهة</label>
              <select id="ResourceDestination" class="form-control" name="Entity type" required>
                <option value="">- Entity type -</option>
                <option value="شركه"> شركه </option>
                <option value="شخص"> شخص </option>
              </select>
              <label for="ResourceCard"> رقم البطاقة / المعرف الضريبي</label>
              <input type="text" class="form-control" id="ResourceCard"
                placeholder="أدخل  رقم البطاقة / المعرف الضريبي">
            </div>
            <div class="grid-item">
              <label for="ResourceCommercial">السجل التجاري</label>
              <input type="text" class="form-control" id="ResourceCommercial" placeholder="أدخل السجل التجاري">
            </div>

          </form>
          <hr>
          <button type="button" onclick="saveAddResource()">💾 حفظ التكويد</button>
        </div>
      </div>

      <div id="queryResource" style="display: none;" class="grid-container">
        <div class="card border shadow-sm mb-4">
          <div class="card-header text-center">
            جدول الموردين
          </div>
          <div class="mb-3">
            <input type="text" id="searchResource" class="form-control" placeholder="🔍 ابحث باسم الصنف">
            <button class="btn btn-primary mt-2" onclick="searchResource()">بحث</button>
          </div>
          <table class="table table-borderedResource">
            <thead>
              <tr>
                <th>كود المورد</th>
                <th>اسم المورد</th>
                <th>هاتف المورد</th>
                <th>المحافظه</th>
                <th>المدينه</th>
                <th>العنوان</th>
                <th>نوع الجهة</th>
                <th> رقم البطاقة / المعرف الضريبي</th>
                <th>السجل التجاري</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              <tr>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="addTemporaryForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center" id="addTemporaryTitle">نموذج تسجيل عهدة مؤقتة</div>

      <form class="grid-container" id="temporaryForm">
        <div class="grid-item">
          <label for="employeeName">اسم الموظف</label>
          <input type="text" id="employeeName" required />

          <label for="handoverDate">تاريخ التسليم</label>
          <input type="date" id="handoverDate" required />
        </div>

        <div class="grid-item">
          <label for="equipmentType">نوع العهدة</label>
          <select id="equipmentType" required>
            <option value="">-- اختر نوع العهدة --</option>
          </select>

          <label for="notesTemporary">ملاحظات إضافية</label>
          <textarea id="notesTemporary" rows="4"></textarea>
        </div>
      </form>

      <hr />
      <button type="button" onclick="saveTemporaryForm()" id="btnSaveTemporary">💾 حفظ واستلام العهدة</button>
    </div>

    <div class="card" style="margin-top: 20px;">
      <div class="card-header text-center" id="temporaryTableTitle">العهد المؤقتة</div>
      <div id="temporaryTableContainer" style="overflow-x: auto;"></div>
    </div>
  </div>

  <div id="editTemporaryForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center" id="editTemporaryTitle">تعديل عهدة مؤقتة</div>
      <form class="grid-container" id="editForm">
        <input type="hidden" id="editRecordId">

        <div class="grid-item">
          <label id="labelEditDocNum">رقم المستند</label>
          <input type="text" id="editDocumentNumberTemporary" required>

          <label id="labelEditHandoverDate">تاريخ التسليم</label>
          <input type="date" id="editHandoverDate" disabled>


          <label id="labelEditEmployeeName">اسم الموظف</label>
          <input type="text" id="editEmployeeName" required>

          <label id="labelEditReturnDate">تاريخ الاسترجاع</label>
          <input type="date" id="editReturnDate">
        </div>

        <div class="grid-item">
          <label id="labelEditEquipmentType">نوع العهدة</label>
          <select id="editEquipmentType" required>
            <option value="">-- اختر نوع العهدة --</option>
          </select>

          <label id="labelEditNotes">ملاحظات إضافية</label>
          <textarea id="editNotesTemporary" rows="4"></textarea>
        </div>
      </form>
      <hr>
      <button onclick="updateTemporaryForm()" id="btnEditSave">💾 حفظ التعديلات</button>
    </div>
  </div>

  <div id="InquiryTemporaryForm" class="content" style="display: none;">
    <div class="card">
      <div class="card-header text-center" id="temporaryCustodyInquiry">
        استعلام العهدة المؤقتة
      </div>
      <form class="grid-container">
        <div class="grid-item">
          <label for="filter_temp_doc_number" id="labelDocNumber">رقم المستند:</label>
          <input type="number" id="filter_temp_doc_number">
        </div>

        <div class="grid-item">
          <label for="filter_employee_name" id="labelEmployeeName">اسم الموظف:</label>
          <input type="text" id="filter_employee_name">
        </div>

        <div class="grid-item">
          <label for="filter_equipment_type" id="labelEquipmentType">نوع العهدة:</label>
          <select id="filter_equipment_type">
            <option value="">-- اختر النوع --</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="filter_condition" id="labelCondition">حالة الجهاز:</label>
          <select id="filter_condition">
            <option value="" id="optionSelectCondition">-- اختر الحالة --</option>
            <option value="جديد" id="optionNew">جديد</option>
            <option value="مستعمل" id="optionUsed">مستعمل</option>
          </select>
        </div>

        <div class="grid-item">
          <label for="filter_handover_date" id="labelHandoverDate">تاريخ التسليم:</label>
          <input type="date" id="filter_handover_date">
        </div>
      </form>

      <div class="card">
        <div class="grid-container">
          <button onclick="searchTemporaryForms()" id="searchBtnTemp">🔍 بحث</button>
          <button onclick="exportToExcelTemporary()" id="downloadExcelBtn">📥 تحميل Excel</button>
          <div class="grid-item" style="grid-column: span 5; margin-bottom: 10px;">
            <label for="generalSearchTemporary" id="labelGeneralSearch">بحث عام: </label>
            <input type="text" id="generalSearchTemporary" placeholder="اكتب كلمة للبحث..."
              oninput="searchTemporaryForms()" style="width: 100%; padding: 6px;">
          </div>
        </div>
        <div id="resultsTableTemporary"
          style="overflow-y: auto; height: 400px; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"></div>
      </div>
    </div>
  </div>

  <div id="loginScreen"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(253, 253, 253, 0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;"
    style="display: flex;">

    <div class="card p-4" style="width: 400px;">
      <h4 class="text-center mb-4">🔐 تسجيل الدخول</h4>
      <form onsubmit="login(event)">
        <div class="mb-3">
          <label class="form-label">اسم المستخدم</label>
          <input type="text" class="form-control" id="loginUsername" placeholder="أدخل اسم المستخدم" required>
        </div>
        <div class="mb-3">
          <label class="form-label">كلمة المرور</label>
          <input type="password" class="form-control" id="loginPassword" placeholder="********" required>
        </div>
        <div class="d-grid">
          <button type="submit" class="btn btn-primary">دخول</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ============ Collapse Panels (Bootstrap 5 native) ============
      document.querySelectorAll('.btn[data-bs-toggle="collapse"]').forEach(button => {
        button.addEventListener('click', () => {
          const targetSelector = button.getAttribute('data-bs-target');
          const targetEl = document.querySelector(targetSelector);
          // Hide all open panels except the target
          document.querySelectorAll('.panel-collapse.show').forEach(panel => {
            if (panel !== targetEl) {
              const collapseInstance = bootstrap.Collapse.getInstance(panel);
              collapseInstance.hide();
            }
          });
          // Toggle the clicked panel
          bootstrap.Collapse.getOrCreateInstance(targetEl).toggle();
        });
      });

      // ============ Set Default Dates ============
      const today = new Date();
      const toISOStringDate = date => date.toISOString().split('T')[0];
      const defaults = {
        dateAdded: today,
        filterDateFrom: today,
        filterDateTo: new Date(today.getFullYear(), today.getMonth() + 1, 0),
        filterDateFromDisbursement: today,
        filterDateToDisbursement: new Date(today.getFullYear(), today.getMonth() + 1, 0)
      };

      Object.entries(defaults).forEach(([id, date]) => {
        const el = document.getElementById(id);
        if (el) el.value = toISOStringDate(date);
      });

      // ============ Toggle Router Fields Based on Type ============
      const deviceType = document.getElementById('deviceTypeRouter');
      const sections = {
        'متنقل': { sectionId: 'mobileFieldsRouter', fields: ['phoneNumber', 'simNumber'] },
        'ثابت': { sectionId: 'fixedFieldsRouter', fields: ['macAddress', 'landlineNumber'] },
        'آخر': { sectionId: 'otherFieldsRouter', fields: ['deviceDescription'] }
      };

      const hideAllSections = () => {
        document.querySelectorAll('#mobileFieldsRouter, #fixedFieldsRouter, #otherFieldsRouter').forEach(sec => sec.style.display = 'none');
        Object.values(sections).flatMap(s => s.fields).forEach(id => {
          const field = document.getElementById(id);
          if (field) field.removeAttribute('required');
        });
      };

      if (deviceType) {
        deviceType.addEventListener('change', () => {
          hideAllSections();
          const config = sections[deviceType.value];
          if (config) {
            const sec = document.getElementById(config.sectionId);
            if (sec) sec.style.display = 'block';
            config.fields.forEach(id => {
              const field = document.getElementById(id);
              if (field) field.required = true;
            });
          }
        });
      }

      // ============ Custom Router Model Input ============
      const routerModel = document.getElementById('routerModel');
      const customModelWrapper = document.getElementById('customRouterModelRouter');
      const otherInput = document.getElementById('otherRouterModel');

      if (routerModel && customModelWrapper && otherInput) {
        routerModel.addEventListener('change', () => {
          if (routerModel.value === 'آخر') {
            customModelWrapper.style.display = 'block';
            otherInput.required = true;
          } else {
            customModelWrapper.style.display = 'none';
            otherInput.removeAttribute('required');
          }
        });
      }
    });

    function HomeDocument() {
      showSection('Dashboard');
    }

    // ============ أدوات إظهار وإخفاء وتحكم عام ============

    const hideElements = (selectors) =>
      selectors.forEach(sel =>
        document.querySelectorAll(sel).forEach(el => el.style.display = 'none')
      );

    const resetForm = (section) => {
      const form = section.querySelector('form');
      if (form) form.reset();

      section.querySelectorAll('input, select, textarea').forEach(el => {
        el.value = '';
        if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
      });

      const result = section.querySelector('.result');
      if (result) result.textContent = '';
    };

    const clearDataAttrs = (ids) =>
      ids.forEach(id => document.getElementById(id)?.removeAttribute('data-id'));

    // ============ عرض قسم + تحديث داخلي ============

    function showSection(sectionId) {
      history.pushState(null, '', `?section=${sectionId}`);

      const loader = document.getElementById('loader');
      const section = document.getElementById(sectionId);
      const dataIds = [
        'pcNum', 'documentNumberPhone', 'deviceTypeInput', 'cameraTypeInput', 'costCenterCode',
        'documentNumberScreen', 'editDocumentNumberTemporary', 'documentNumberCamera',
        'deviceTypeInputPrint', 'doc_number', 'screenTypeInput', 'docNumberRouter',
        'companyInput', 'documentNumberLine', 'deviceTypePhone', 'deptCode', 'empCode', 'employeeCode', 'docNumberGPS', 'queryGPS', 'GPSTypeInput', 'assetCode'
      ];

      if (!section) return;

      hideElements(['.content']);
      loader.style.display = 'flex';
      loader.style.opacity = '1';

      setTimeout(() => {
        loader.style.opacity = '0';
        setTimeout(() => loader.style.display = 'none', 300);

        resetForm(section);
        clearDataAttrs(dataIds);
        window.currentDocumentId = null;

        const queryResults = section.querySelector('#queryResults');
        if (queryResults) queryResults.innerHTML = '';

        const resultsTable = section.querySelector('#resultsTable');
        if (resultsTable) resultsTable.innerHTML = '';

        section.style.display = 'block';
        section.classList.remove('show');
        void section.offsetWidth;
        section.classList.add('show');

        if (sectionId.toLowerCase().includes('query') && typeof fetchAndDisplayData === 'function') {
          fetchAndDisplayData();
        }

      }, 1000);
    }

    // ============ عرض الأقسام الفرعية ============

    const showToggle = (group, targetId, loadCallback) => {
      hideElements(group.map(id => `#${id}`));
      const target = document.getElementById(targetId);
      if (target) {
        resetForm(target);
        target.style.display = 'block';
      }
      if (loadCallback) loadCallback();
    };

    function showSubSection(id) {
      showToggle(['codingSection', 'querySection'], id);
    }
    function showSubRegion(id) {
      showToggle(['codingRegion', 'queryRegion'], id);
    }
    function showSubResource(id) {
      showToggle(['codingResource', 'queryResource'], id, id === 'queryResource' ? loadResources : null);
    }

    // ============ تشغيل تلقائي عبر رابط ============

    window.addEventListener('DOMContentLoaded', () => {
      const sectionId = new URLSearchParams(window.location.search).get('section');
      if (sectionId) showSection(sectionId);
    });

    // ============ تصدير البيانات إلى Excel ============

    function exportToExcel() {
      const table = document.getElementById("resultsTable");
      if (!table || table.rows.length < 2) {
        alert("⚠️ لا توجد بيانات قابلة للتصدير!");
        return;
      }

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(table);
      XLSX.utils.book_append_sheet(wb, ws, "Computers Data");
      XLSX.writeFile(wb, "Computers_Data.xlsx");
    }

    // ============ تنظيف النموذج ============ //
    function clearForm() {
      const form = document.getElementById("myForm");
      if (!form) return;

      form.reset();

      form.querySelectorAll("input, select, textarea").forEach(el => {
        if (el.type !== "checkbox" && el.type !== "radio") {
          el.value = "";
        } else {
          el.checked = false;
        }
      });

      // إعادة تعيين حالة الجهاز إذا كانت موجودة
      const pcStatus = document.getElementById("pcStatus");
      if (pcStatus) pcStatus.value = "IN SERVICES";
    }

    // ============ حساب تاريخ الانتهاء ============ //
    function calculateEndDate() {
      const startDateVal = document.getElementById("startDateLine")?.value;
      const durationVal = parseInt(document.getElementById("packageDuration")?.value || 0);
      const endDateField = document.getElementById("endDate");
      const resultDiv = document.getElementById("result");

      if (startDateVal && durationVal > 0) {
        const startDate = new Date(startDateVal);
        startDate.setDate(startDate.getDate() + durationVal);

        const finalDate = startDate.toISOString().split("T")[0];
        if (endDateField) endDateField.value = finalDate;
        if (resultDiv) resultDiv.innerHTML = `📅 تنتهي الباقة في: <strong>${finalDate}</strong>`;
      } else {
        if (endDateField) endDateField.value = "";
        if (resultDiv) resultDiv.innerHTML = "";
      }
    }

    // ============ تبديل الشريط الجانبي ============ //
    function toggleSidebar() {
      document.getElementById("sidebar")?.classList.toggle("active");
    }

    // ============ عرض الأقسام بناءً على الـ Hash ============ //
    function hideAllSections() {
      document.querySelectorAll(".content-section").forEach(el => el.style.display = "none");
    }

    function showSectionByHash(hash) {
      if (!hash || hash === "#") {
        hash = "#home";
      }

      const section = document.querySelector(hash);
      if (section) {
        hideAllSections();
        section.style.display = "block";
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    // ============ تفعيل عند تحميل الصفحة ============ //
    window.addEventListener("load", () => {
      const hash = window.location.hash.replace("#", "");
      if (hash) {
        showSection(hash);
        const target = document.getElementById(hash);
        if (target) {
          const collapseParent = target.closest(".collapse");
          if (collapseParent) {
            new bootstrap.Collapse(collapseParent, { toggle: true });
          }
        }
      }
    });

    // ============ تفعيل التنقل داخل الصفحة عبر الروابط ============ //
    document.querySelectorAll('a[href^="#"]').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const hash = this.getAttribute('href');
        history.pushState(null, '', hash);
        showSectionByHash(hash);
      });
    });

    // ============ حساب عدد الطباعات ============ //
    function calculateTotalPrints() {
      const prev = parseInt(document.getElementById("previousCounter")?.value || 0);
      const curr = parseInt(document.getElementById("currentCounter")?.value || 0);
      const total = Math.max(curr - prev, 0);
      const totalInput = document.getElementById("totalCounter");
      if (totalInput) totalInput.value = total;
    }

    ["previousCounter", "currentCounter"].forEach(id => {
      document.getElementById(id)?.addEventListener("input", calculateTotalPrints);
    });

    // ============ دعم اللغة (عربي ↔ إنجليزي) ============ //
    let currentLang = 'ar';

    function toggleLanguage() {
      currentLang = currentLang === 'ar' ? 'en' : 'ar';
      applyLanguage();
    }

    const textMap = {
      buttons: {
        "fetchData()": ["🔄 تحديث", "🔄 Refresh"],
        "deleteDocument()": ["🗑️ حذف", "🗑️ Delete"],
        "changePassword()": ["🔑 تغيير كلمة المرور", "🔑 Change password"],
        "logout()": ["🔓 تسجيل الخروج", "🔓 Log out"],
        "showSection('Dashboard')": ["🏠 الرئيسية", "🏠 Home"],
      },

      navLinks: {
        'إضافة جهاز': 'Add Device',
        'استعلام جهاز': 'Device Query',
        'اعدادات جهاز': 'Device Settings',
        'إضافة خط': 'Add Line',
        'استعلام عن الخطوط': 'Line Query',
        'عدادات الخطوط': 'Line Settings',
        'طلب شراء': 'Purchase Order',
        'استعلام طلب شراء': 'Order Query',
        'تعديل طلب الشراء': 'Edit Order',
        'طلب موافقة تسليم': 'Delivery Approval',
        'استعلام طلب موافقة تسليم': 'Delivery Query',
        'تعديل طلب موافقة تسليم': 'Edit Delivery',
        'إضافة طلب صيانة': 'Add Maintenance',
        'استعلام عن طلب الصيانة': 'Maintenance Query',
        'تعديل طلب الصيانة': 'Edit Maintenance',
        'إذن إضافة': 'Add Permission',
        'استعلام عن إذن إضافة': 'Add Permission Query',
        'إذن صرف': 'Disbursement',
        'استعلام عن إذن صرف': 'Disbursement Query',
        'استعلام عن المخازن': 'Store Inventory',
        'إضافة عهده مؤقته': 'Add Temporary Custody',
        'استعلامات عن عهد مؤقته': 'Temporary Custody Queries',
        'تعديل عن عهد مؤقته': 'Edit Temporary Custody',
        'استعلام عن عهده موظف': 'Employee Custody',
        'إنشاء مستخدم': 'Create User',
        'تعديل بيانات مستخدم': 'Edit User',
        'إدارة الصلاحيات': 'Power Management',
        'إعدادات الصفحة': 'Page Settings',
        'تعريف الشريكات': 'Company Definition',
        'اعدادت الفاتوره': 'Invoice Settings',
        'إضافة صنف': 'Add Item',
        'إضافة منطقة': 'Add Region',
        'إضافة مورد': 'Add Supplier'
      },

      sections: {
        'الإحصائيات المجمعة': 'Combined Statistics',
        'الإحصائيات حسب الموقع': 'Statistics by Location',
        'الإحصائيات حسب الصنف': 'Statistics by Item',
        'إعدادات الصفحة': 'Page Settings',
        'اسم الصفحة:': 'Page Name:',
        'شعار الصفحة (لوجو):': 'Page Logo:',
        '💾 حفظ الإعدادات': '💾 Save Settings',
        'إضافة جهاز كمبيوتر': 'Add Computer',
        'اختر الشركة:': 'Select Company:',
        ': رقم مستند الجهاز': 'Device Document No:',
        ': تاريخ': 'Date:',
        ': حاله الجهاز': 'Device Status:',
        ': موقع الجهاز': 'Device Location:',
        ': مستخدم الجهاز': 'Device User:',
        ': نوع الجهاز': 'Device Type:',
        ':  موديل': 'Model:',
        'PC CONFIGURATION': 'PC CONFIGURATION',
        ': ملاحظات': 'Notes:',
        ':  المستخدم ': ':user',
        '🖨️ طباعة': '🖨️ Print',
        '📥 تحميل كملف Excel': '📥 Download as an Excel file ',
        ' 🔽 اختيار الأعمدة': '🔽 Select columns ',
        '🔍 بحث': ' 🔍 Search ',
        'بحث :': 'research :',
        'PC إضافة نوع جهاز وموديلات': 'PC Add device type and models',
        'الموديلات (افصل بينها بفاصلة):': ' Models (separate by comma):',
        'البحث عن جهاز كمبيوتر او لابتوب': 'Search for a computer or laptop',
        'أنواع الأجهزة والموديلات': 'Device types and models',
        'الموديلات': 'Models',
        'نوع الجهاز': 'Device type',
        '💾 حفظ مستند الجهاز': '💾 Save Device Document'

      },

      placeholders: {
        'username': ['اسم المستخدم', 'Username'],
        'password': ['كلمة المرور', 'Password'],
      }
    };

    const normalize = s => (s || '')
      .replace(/\s+/g, ' ')
      .replace(/[؛:]/g, '')
      .trim();

    const sectionPairs = Object.entries(textMap.sections).map(([ar, en]) => ({
      ar, en, nar: normalize(ar), nen: normalize(en)
    }));

    function applyLanguage() {
      document.documentElement.lang = currentLang;

      Object.entries(textMap.buttons).forEach(([fn, [ar, en]]) => {
        const btn = document.querySelector(`button[onclick="${fn}"]`);
        if (btn) btn.textContent = currentLang === 'ar' ? ar : en;
      });

      document.querySelectorAll('input[placeholder]').forEach(input => {
        const key = input.getAttribute('name') || input.id;
        if (textMap.placeholders[key]) {
          input.placeholder = currentLang === 'ar'
            ? textMap.placeholders[key][0]
            : textMap.placeholders[key][1];
        }
      });

      const sectionSelectors = 'h1,h2,h3,h4,.card-header,label,th,button,#saveButton';
      document.querySelectorAll(sectionSelectors).forEach(el => {
        const orig = (el.textContent || '').trim();
        const nt = normalize(orig);
        const hit = sectionPairs.find(p => p.nar === nt || p.nen === nt);
        if (hit) {
          el.textContent = currentLang === 'ar' ? hit.ar : hit.en;
        }
      });

      document.querySelectorAll('.nav-link').forEach(link => {
        const t = (link.textContent || '').trim();
        const nt = normalize(t);
        let found = false;
        for (const [ar, en] of Object.entries(textMap.navLinks)) {
          if (normalize(ar) === nt || normalize(en) === nt) {
            link.textContent = currentLang === 'ar' ? ar : en;
            found = true;
            break;
          }
        }
        if (!found) { /* no-op */ }
      });

      if (typeof updateCustomSections === 'function') {
        updateCustomSections();
      }
    }
    document.getElementById('langToggle')?.addEventListener('click', toggleLanguage);
    applyLanguage();
    function openTab(evt, tabId) {
      let contents = document.querySelectorAll(".tab-content");
      contents.forEach(c => c.classList.remove("active"));
      let buttons = document.querySelectorAll(".tabs button");
      buttons.forEach(b => b.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

  </script>
</body>

</html>